<?xml version="1.0" encoding="UTF-8"?>
<task id="5" priority="medium" agent="rex">
    <meta>
        <title>Build real-time notifications with WebSocket and push integration</title>
        <priority>medium</priority>
        <dependencies>4</dependencies>
        <agent_hint>rex</agent_hint>
    </meta>

    <role>You are a Senior Rust Engineer with expertise in systems programming and APIs. Implement Task 5 with production-quality code.</role>

    <context>
        <overview>Implement WebSocket connections for live updates, FCM push notifications, email notifications, and user preference controls</overview>
        <background>Review PRD and architecture in .tasks/docs/ for full context.</background>
    </context>

    <requirements>
        <description>1. Setup WebSocket endpoint with axum::extract::ws for 1000 concurrent connections
2. Implement Redis pub/sub for broadcasting task updates across instances
3. Create notification preferences table and user controls
4. Integrate FCM for mobile push notifications
5. Add email notification system for mentions and due date reminders
6. Build connection management with user authentication

```rust
use axum::extract::ws::{WebSocket, WebSocketUpgrade};
use redis::aio::PubSub;

struct NotificationService {
    redis_pubsub: PubSub,
    fcm_client: fcm::Client,
    email_client: lettre::SmtpTransport,
}

#[derive(Serialize, Deserialize)]
enum NotificationType {
    TaskCreated,
    TaskUpdated,
    TaskAssigned,
    DueDateReminder,
    Mention,
}

// WebSocket handler
async fn websocket_handler(ws: WebSocketUpgrade, auth: AuthUser) -&gt; Response {
    ws.on_upgrade(|socket| handle_socket(socket, auth.user_id))
}

// Redis pub/sub message
async fn broadcast_task_update(task_id: Uuid, notification_type: NotificationType)
```</description>
        <constraints>
            <constraint>Match existing codebase patterns</constraint>
            <constraint>Create PR with atomic commits</constraint>
            <constraint>Include unit tests</constraint>
            <constraint>PR title: feat(task-5): Build real-time notifications with WebSocket and push integration</constraint>
        </constraints>
    </requirements>

    <acceptance_criteria>
        <criterion>All requirements implemented</criterion>
        <criterion>Tests passing with adequate coverage</criterion>
        <criterion>Code follows project conventions</criterion>
        <criterion>WebSocket connection tests with 1000+ concurrent connections, Redis pub/sub message delivery verification, FCM integration tests, email notification delivery tests, user preference filtering validation</criterion>
    </acceptance_criteria>

    <validation>
        <command>cargo test (Rust)</command>
        <command>cargo clippy -- -D warnings (Rust)</command>
        <command>go test ./... (Go)</command>
        <command>npm test (Node.js)</command>
    </validation>

    <deliverables>
        <deliverable>Working implementation</deliverable>
        <deliverable>Unit tests</deliverable>
        <deliverable>Pull request</deliverable>
    </deliverables>
</task>
