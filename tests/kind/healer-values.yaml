---
# Healer Server - Kind Local Values
# Based on: infra/gitops/applications/cto/healer.yaml

replicaCount: 1
revisionHistoryLimit: 5

image:
  repository: ghcr.io/5dlabs/healer
  pullPolicy: IfNotPresent
  tag: "kind-local"

# No image pull secrets needed for local images
imagePullSecrets: []

fullnameOverride: healer

serviceAccount:
  create: false
  automount: true
  name: healer

podAnnotations:
  logs.platform.5dlabs.io/collect: "true"
  logs.platform.5dlabs.io/service: healer

podLabels:
  app.kubernetes.io/component: monitor
  platform.5dlabs.io/log-collection: enabled

podSecurityContext:
  fsGroup: 65532

securityContext:
  capabilities:
    drop:
      - ALL
    add:
      - DAC_OVERRIDE
  readOnlyRootFilesystem: false
  runAsNonRoot: false
  runAsUser: 0

service:
  type: ClusterIP
  port: 8080

ingress:
  enabled: false

terminationGracePeriodSeconds: 30

resources:
  limits:
    cpu: 500m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 256Mi

# Healer HTTP server probes
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 30
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 10
  failureThreshold: 3

autoscaling:
  enabled: false

volumes:
  - name: healer-workspace
    persistentVolumeClaim:
      claimName: healer-workspace
  - name: healer-config
    configMap:
      name: healer-config

volumeMounts:
  - name: healer-workspace
    mountPath: /workspace/watch
  - name: healer-config
    mountPath: /app/healer-config.json
    subPath: healer-config.json

nodeSelector: {}
tolerations: []
affinity: {}
configureDefaultAffinity: false

updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

env:
  - name: LOG_LEVEL
    value: info
  - name: RUST_LOG
    value: healer=debug,info
  # Optional: Set these if you have the secrets
  # - name: ANTHROPIC_API_KEY
  #   valueFrom:
  #     secretKeyRef:
  #       name: cto-secrets
  #       key: ANTHROPIC_API_KEY
  # - name: GITHUB_TOKEN
  #   valueFrom:
  #     secretKeyRef:
  #       name: tools-github-secrets
  #       key: GITHUB_PERSONAL_ACCESS_TOKEN

envFrom: []

configMap:
  enabled: false

persistence:
  enabled: false

networkPolicy:
  enabled: false

command:
  - /usr/local/bin/healer

args:
  - server
  - --addr
  - "0.0.0.0:8080"
  - --config
  - /app/healer-config.json

# Skip default claude-config init (not needed for healer)
skipDefaultInitContainers: true

# Fix PVC permissions on startup
extraInitContainers:
  - name: fix-pvc-permissions
    image: busybox:latest
    command:
      - /bin/sh
      - -c
      - |
        echo "Fixing PVC permissions for shared workspace..."
        mkdir -p /workspace/watch/logs /workspace/watch/alerts /workspace/watch/completion /workspace/watch/locks
        chmod -R 777 /workspace/watch
        echo "Permissions fixed."
    volumeMounts:
      - name: healer-workspace
        mountPath: /workspace/watch

extraContainers:
  - name: filebrowser
    image: filebrowser/filebrowser:latest
    args:
      - --noauth
      - --root=/srv
      - --address=0.0.0.0
      - --port=8081
    ports:
      - containerPort: 8081
        name: filebrowser
        protocol: TCP
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    volumeMounts:
      - name: healer-workspace
        mountPath: /srv
  - name: log-tailer
    image: busybox:latest
    command:
      - /bin/sh
      - -c
      - |
        echo "Waiting for log directory..."
        mkdir -p /workspace/watch/logs
        while true; do
          if ls /workspace/watch/logs/*.log 1>/dev/null 2>&1; then
            tail -F /workspace/watch/logs/*.log 2>/dev/null || sleep 5
          else
            echo "No logs yet, waiting..."
            sleep 10
          fi
        done
    volumeMounts:
      - name: healer-workspace
        mountPath: /workspace/watch





