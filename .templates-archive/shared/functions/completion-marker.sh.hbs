{{!--
  Agent Completion Marker
  
  Creates a completion marker file to signal successful task completion.
  This is used by the controller to detect when an agent has finished.
  
  Required context:
    - github_app: The agent name (e.g., "Rex", "Cleo")
    - task_id: The task identifier
  
  Optional context:
    - completion_marker_path: Custom path for marker (default: /workspace/.agent_done)
--}}

# =========================================================================
# Completion Marker
# =========================================================================

create_completion_marker() {
  local marker_path="${1:-/workspace/.agent_done}"
  local agent_name="{{github_app}}"
  local task_id="{{task_id}}"
  
  echo "ğŸ“ Creating completion marker at $marker_path"
  
  cat > "$marker_path" <<EOF
agent=${agent_name}
task_id=${task_id}
completed_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
status=success
EOF

  echo "âœ… Completion marker created for $agent_name (task: $task_id)"
}

# Helper to check if a completion marker exists
check_completion_marker() {
  local marker_path="${1:-/workspace/.agent_done}"
  
  if [ -f "$marker_path" ]; then
    echo "âœ“ Completion marker exists at $marker_path"
    cat "$marker_path"
    return 0
  else
    echo "âœ— No completion marker at $marker_path"
    return 1
  fi
}

# Clean up completion marker from previous runs
cleanup_completion_marker() {
  local marker_path="${1:-/workspace/.agent_done}"
  
  if [ -f "$marker_path" ]; then
    echo "ğŸ§¹ Cleaning up previous completion marker"
    rm -f "$marker_path"
  fi
}

