apiVersion: orchestrator.platform/v1
kind: CodeRun
metadata:
  name: test-templates-system
  namespace: orchestrator
spec:
  # Test repository and task
  repositoryUrl: "git@github.com:5dlabs/orchestrator-code-test.git"
  githubUser: "pm0-5dlabs"
  taskId: 5

  # Service configuration
  service: "simple-api"
  workingDirectory: "."

  # Documentation repository (docs service)
  docsRepositoryUrl: "git@github.com:5dlabs/platform.git"
  docsProjectDirectory: "_projects/simple-api"
  docsBranch: "feature/example-project-and-cli"

  # Model configuration
  model: "claude-sonnet-4-20250514"

  # Tool configuration - test the basic setup
  toolConfig: "default"

  # Template testing flags - CONTINUE SESSION TEST
  overwriteMemory: false
  continueSession: true
  contextVersion: 2

  # NEW FEATURE: Environment Variables & Secrets
  env:
    NODE_ENV: "development"
    API_BASE_URL: "https://api.example.com"
    DEBUG_LEVEL: "verbose"
    CUSTOM_FEATURE_FLAG: "true"

  envFromSecrets:
    - name: "DATABASE_PASSWORD"
      secretName: "db-credentials"
      secretKey: "password"
    - name: "API_SECRET_KEY"
      secretName: "api-secrets"
      secretKey: "secret"
    - name: "REDIS_PASSWORD"
      secretName: "redis-creds"
      secretKey: "redis-pass"

  # Test our updated templates:
  # - CLAUDE.md with @ pointers
  # - GitHub guidelines with PR submission requirements
  # - System prompt with verification requirements
  # - SSH-only authentication

  # This should test:
  # 1. Template copying (prompt.hbs, coding-guidelines.md, github-guidelines.md)
  # 2. @ pointer system in CLAUDE.md
  # 3. --append-system-prompt functionality
  # 4. Debug prompt printing
  # 5. SSH authentication setup
  # 6. Progress commit requirements
  # 7. PR submission workflow
  # 8. CONTINUE SESSION with enhanced Task 5 requirements
  # 9. NEW: Custom environment variables and secret references