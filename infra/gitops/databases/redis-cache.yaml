---
apiVersion: databases.spotahome.com/v1
kind: RedisFailover
metadata:
  name: redis-cache
  namespace: databases
  labels:
    team: platform
    app.kubernetes.io/name: redis-cache
    app.kubernetes.io/component: cache
    purpose: cache
spec:
  sentinel:
    replicas: 3  # Higher availability for cache
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi
    customConfig:
      - "down-after-milliseconds 3000"  # Faster failover for cache
      - "failover-timeout 8000"
      - "parallel-syncs 2"
  redis:
    replicas: 3  # Higher availability for cache
    resources:
      requests:
        cpu: 200m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 4Gi
    image: redis:7.2-alpine
    imagePullPolicy: IfNotPresent
    customConfig:
      - "maxmemory 3072mb"                    # Higher memory for cache
      - "maxmemory-policy allkeys-lru"        # LRU eviction for cache
      - "save \"\""                           # Disable persistence for pure cache
      - "appendonly no"                       # No persistence for cache
      - "tcp-keepalive 60"
      - "tcp-backlog 511"
      - "timeout 300"
      - "databases 16"
      - "slowlog-log-slower-than 5000"       # Faster slow log threshold
      - "slowlog-max-len 256"                # More slow log entries
      - "rename-command FLUSHDB \"\""
      - "rename-command FLUSHALL \"\""
      - "rename-command KEYS \"\""
    # No persistent storage for cache instance
