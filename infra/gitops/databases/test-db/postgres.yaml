---
apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: test-db
  namespace: databases
  labels:
    team: platform
    app.kubernetes.io/name: test-db
    app.kubernetes.io/component: database
spec:
  teamId: platform
  numberOfInstances: 1

  postgresql:
    version: "16"
    parameters:
      max_connections: "50"
      shared_buffers: "128MB"
      effective_cache_size: "512MB"
      maintenance_work_mem: "64MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "50"
      work_mem: "4MB"
      min_wal_size: "80MB"
      max_wal_size: "1GB"
      log_statement: "ddl"
      log_connections: "on"
      log_disconnections: "on"
      log_lock_waits: "on"
      statement_timeout: "30s"
      lock_timeout: "10s"

  volume:
    size: 10Gi
    storageClass: local-path

  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  users:
    test_app_user:
      - NOSUPERUSER
      - INHERIT
      - CREATEDB
      - NOCREATEROLE
      - NOREPLICATION
    readonly:
      - NOSUPERUSER
      - INHERIT
      - NOCREATEDB
      - NOCREATEROLE
      - NOREPLICATION

  databases:
    test_db: test_app_user
    test_db_readonly: readonly

  preparedDatabases:
    test_db:
      defaultUsers: true
      extensions:
        pg_stat_statements: "public"
        uuid-ossp: "public"
        pgcrypto: "public"

  enableConnectionPooler: false

