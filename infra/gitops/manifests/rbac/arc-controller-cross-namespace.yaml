---
# Cross-namespace RBAC for ARC Controller
# The ARC controller needs to manage resources in arc-runners and arc-systems namespaces
# but the Helm chart's default Role only applies to the infra namespace.
# This ClusterRole provides the necessary permissions across all namespaces.

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: arc-controller-cross-namespace
  labels:
    app.kubernetes.io/name: arc-controller
    app.kubernetes.io/part-of: platform
    app.kubernetes.io/component: ci-cd
rules:
  # Service accounts - needed to manage runner service accounts
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  # Secrets - needed for listener config and GitHub PAT
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  # Pods - needed to manage runner and listener pods
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["create", "delete", "get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/status"]
    verbs: ["get"]
  # Roles and RoleBindings - needed for runner RBAC setup
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["roles", "rolebindings"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: arc-controller-cross-namespace
  labels:
    app.kubernetes.io/name: arc-controller
    app.kubernetes.io/part-of: platform
    app.kubernetes.io/component: ci-cd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: arc-controller-cross-namespace
subjects:
  - kind: ServiceAccount
    name: arc-controller-gha-rs-controller
    namespace: infra


