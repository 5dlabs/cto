---
# ExternalSecrets for Mayastor storage
# These secrets are automatically synced from OpenBao when it's unsealed

# =============================================================================
# mayastor-etcd-jwt-token - JWT token for etcd authentication
# =============================================================================
# To store the initial secret in OpenBao (after unsealing):
#   JWT_VALUE=$(kubectl get secret mayastor-etcd-jwt-token -n mayastor -o jsonpath='{.data.jwt-token-root}' | base64 -d)
#   kubectl exec -n openbao openbao-0 -- bao kv put secret/mayastor jwt-token-root="$JWT_VALUE" jwt-token-sign-key="$JWT_VALUE"
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mayastor-etcd-jwt-token
  namespace: mayastor
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/part-of: mayastor
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: openbao
    kind: ClusterSecretStore
  target:
    name: mayastor-etcd-jwt-token
    creationPolicy: Owner
  data:
    - secretKey: jwt-token-root  # pragma: allowlist secret
      remoteRef:
        key: mayastor
        property: jwt-token-root
    - secretKey: jwt-token-sign-key  # pragma: allowlist secret
      remoteRef:
        key: mayastor
        property: jwt-token-sign-key
    # jwt-token.pem is required by etcd when JWT auth is enabled
    # The path /opt/bitnami/etcd/certs/token/jwt-token.pem is configured in ETCD_AUTH_TOKEN
    - secretKey: jwt-token.pem  # pragma: allowlist secret
      remoteRef:
        key: mayastor
        property: jwt-token-sign-key
