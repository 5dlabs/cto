---
# ExternalSecrets for Headscale namespace
# Manages Tailscale subnet router authentication

# =============================================================================
# tailscale-auth - Auth key for Tailscale subnet router to connect to Headscale
# =============================================================================
# Required OpenBao path: secret/tailscale-auth
# Properties: TS_AUTHKEY (preauth key from Headscale)
#
# To populate this secret in OpenBao:
# 1. Create auth key: kubectl exec -n headscale deploy/headscale -- headscale preauthkeys create --user admin --reusable --expiration 8760h
# 2. Store in Bao: bao kv put secret/tailscale-auth TS_AUTHKEY=<key-from-above>
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tailscale-auth
  namespace: headscale
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: networking
    app.kubernetes.io/instance: external-secrets-config
  annotations:
    argocd.argoproj.io/tracking-id: external-secrets-config:external-secrets.io/ExternalSecret:headscale/tailscale-auth
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: openbao
    kind: ClusterSecretStore
  target:
    name: tailscale-auth
    creationPolicy: Owner
  data:
    - secretKey: TS_AUTHKEY
      remoteRef:
        key: tailscale-auth
        property: TS_AUTHKEY
