---
# Stitch PR Review Sensor
# Triggers Stitch to review PRs on pull_request events
# Phase 1: PR opened/synchronized/reopened only

apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: stitch-pr-review
  namespace: automation
  labels:
    app.kubernetes.io/name: stitch-pr-review-sensor
    app.kubernetes.io/part-of: argo-events
    agent: stitch
    event-type: github-pr-review
spec:
  replicas: 1
  template:
    serviceAccountName: argo-events-sa
    container:
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi
  dependencies:
    - name: pr-event
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value:
              - pull_request
          - path: body.action
            type: string
            value:
              - opened
              - synchronize
              - reopened
  triggers:
    - template:
        name: stitch-review-pr
        conditions: pr-event
        argoWorkflow:
          operation: submit
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: stitch-review-
                namespace: cto
                labels:
                  agent: stitch
                  workflow-type: pr-review
              spec:
                serviceAccountName: cto
                entrypoint: review
                arguments:
                  parameters:
                    - name: pr-number
                    - name: repo-url
                    - name: head-sha
                    - name: repo-slug
                    - name: base-branch
                    - name: head-branch
                    - name: pr-title
                    - name: pr-author
                    - name: trigger
                      value: pull_request
                ttlStrategy:
                  secondsAfterCompletion: 300
                  secondsAfterFailure: 3600
                  secondsAfterSuccess: 300
                volumes:
                  - name: agent-templates
                    configMap:
                      name: cto-controller-agent-templates-factory
                      items:
                        - key: review_factory_agents.md.hbs
                          path: agents.md
                  - name: github-app-key
                    secret:
                      secretName: github-app-5dlabs-stitch
                      items:
                        - key: private-key
                          path: private-key.pem
                  - name: factory-home
                    emptyDir: {}
                templates:
                  - name: review
                    container:
                      image: ghcr.io/5dlabs/factory:latest
                      command: ["/bin/sh"]
                      args:
                        - "-c"
                        - |
                          set -e
                          echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                          echo '‚ïë           STITCH PR REVIEW (FACTORY) STARTING                ‚ïë'
                          echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                          echo "üéØ Agent: 5DLabs-Stitch"
                          echo "üî¢ PR Number: $PR_NUMBER"
                          echo "üìÇ Repository: $REPO_SLUG"
                          echo "üîç Review Mode: review"
                          echo "‚ö° Trigger: $TRIGGER"
                          echo "üìù Head SHA: $HEAD_SHA"
                          echo "üìå Title: $PR_TITLE"
                          echo "üë§ Author: $PR_AUTHOR"
                          echo ""

                          # Generate GitHub App installation token
                          echo "üîê Generating GitHub App installation token..."
                          APP_ID="${GITHUB_APP_ID}"
                          PRIVATE_KEY_PATH="${GITHUB_APP_PRIVATE_KEY_PATH}"

                          # Generate JWT
                          NOW=$(date +%s)
                          IAT=$((NOW - 60))
                          EXP=$((NOW + 600))

                          HEADER=$(echo -n '{"alg":"RS256","typ":"JWT"}' | base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
                          PAYLOAD=$(echo -n "{\"iat\":${IAT},\"exp\":${EXP},\"iss\":\"${APP_ID}\"}" | base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
                          UNSIGNED="${HEADER}.${PAYLOAD}"
                          SIGNATURE=$(echo -n "${UNSIGNED}" | openssl dgst -sha256 -sign "${PRIVATE_KEY_PATH}" | \
                            base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
                          JWT="${HEADER}.${PAYLOAD}.${SIGNATURE}"

                          # Get installation ID for the org
                          INSTALL_ID=$(curl -s -H "Authorization: Bearer ${JWT}" \
                            -H "Accept: application/vnd.github+json" \
                            "https://api.github.com/app/installations" | \
                            grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)

                          if [ -z "$INSTALL_ID" ]; then
                            echo "‚ùå Failed to get installation ID"
                            exit 1
                          fi
                          echo "üìç Installation ID: $INSTALL_ID"

                          # Generate installation access token
                          TOKEN_RESPONSE=$(curl -s -X POST \
                            -H "Authorization: Bearer ${JWT}" \
                            -H "Accept: application/vnd.github+json" \
                            "https://api.github.com/app/installations/${INSTALL_ID}/access_tokens")

                          export GH_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)

                          if [ -z "$GH_TOKEN" ]; then
                            echo "‚ùå Failed to generate installation token"
                            echo "Response: $TOKEN_RESPONSE"
                            exit 1
                          fi
                          echo "‚úÖ GitHub App token generated successfully"
                          echo ""

                          # Create check run (in_progress)
                          echo "üìä Creating check run..."
                          OWNER=$(echo "$REPO_SLUG" | cut -d'/' -f1)
                          REPO=$(echo "$REPO_SLUG" | cut -d'/' -f2)
                          START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

                          CHECK_RUN_RESPONSE=$(curl -s -X POST \
                            -H "Authorization: Bearer ${GH_TOKEN}" \
                            -H "Accept: application/vnd.github+json" \
                            -H "X-GitHub-Api-Version: 2022-11-28" \
                            "https://api.github.com/repos/${REPO_SLUG}/check-runs" \
                            -d "{
                              \"name\": \"Stitch PR Review\",
                              \"head_sha\": \"${HEAD_SHA}\",
                              \"status\": \"in_progress\",
                              \"started_at\": \"${START_TIME}\",
                              \"output\": {
                                \"title\": \"Stitch is reviewing your PR\",
                                \"summary\": \"AI-powered code review in progress...\"
                              }
                            }")

                          CHECK_RUN_ID=$(echo "$CHECK_RUN_RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
                          if [ -z "$CHECK_RUN_ID" ]; then
                            echo "‚ö†Ô∏è Failed to create check run (continuing anyway)"
                            echo "Response: $CHECK_RUN_RESPONSE"
                          else
                            echo "‚úÖ Check run created: $CHECK_RUN_ID"
                          fi
                          echo ""

                          # Load agent prompt
                          AGENT_PROMPT="/task-files/agents.md"
                          if [ ! -f "${AGENT_PROMPT}" ]; then
                              echo "‚ùå Agent prompt not found at ${AGENT_PROMPT}"
                              # Update check run to failure if it exists
                              if [ -n "$CHECK_RUN_ID" ]; then
                                curl -s -X PATCH \
                                  -H "Authorization: Bearer ${GH_TOKEN}" \
                                  -H "Accept: application/vnd.github+json" \
                                  "https://api.github.com/repos/${REPO_SLUG}/check-runs/${CHECK_RUN_ID}" \
                                  -d '{"status":"completed","conclusion":"failure"}'
                              fi
                              exit 1
                          fi

                          echo "üìã Agent prompt loaded from ${AGENT_PROMPT}"
                          echo ""
                          echo "üöÄ Starting Factory CLI (droid exec)..."
                          echo ""

                          # Run Factory with the review agent prompt
                          # Capture exit code to update check run
                          set +e
                          droid exec \
                              --auto high \
                              --model "${MODEL}" \
                              --output-format stream-json \
                              "$(cat ${AGENT_PROMPT})"
                          DROID_EXIT=$?
                          set -e

                          # Update check run with result
                          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                          if [ -n "$CHECK_RUN_ID" ]; then
                            if [ $DROID_EXIT -eq 0 ]; then
                              CONCLUSION="success"
                              TITLE="Stitch review complete"
                              SUMMARY="PR review completed successfully."
                            else
                              CONCLUSION="failure"
                              TITLE="Stitch review failed"
                              SUMMARY="PR review encountered an error."
                            fi

                            curl -s -X PATCH \
                              -H "Authorization: Bearer ${GH_TOKEN}" \
                              -H "Accept: application/vnd.github+json" \
                              -H "X-GitHub-Api-Version: 2022-11-28" \
                              "https://api.github.com/repos/${REPO_SLUG}/check-runs/${CHECK_RUN_ID}" \
                              -d "{
                                \"status\": \"completed\",
                                \"conclusion\": \"${CONCLUSION}\",
                                \"completed_at\": \"${END_TIME}\",
                                \"output\": {
                                  \"title\": \"${TITLE}\",
                                  \"summary\": \"${SUMMARY}\"
                                }
                              }"
                            echo "‚úÖ Check run updated: ${CONCLUSION}"
                          fi

                          exit $DROID_EXIT
                      env:
                        - name: PR_NUMBER
                          value: "{{workflow.parameters.pr-number}}"
                        - name: REPOSITORY_URL
                          value: "{{workflow.parameters.repo-url}}"
                        - name: REPO_SLUG
                          value: "{{workflow.parameters.repo-slug}}"
                        - name: HEAD_SHA
                          value: "{{workflow.parameters.head-sha}}"
                        - name: BASE_BRANCH
                          value: "{{workflow.parameters.base-branch}}"
                        - name: HEAD_BRANCH
                          value: "{{workflow.parameters.head-branch}}"
                        - name: PR_TITLE
                          value: "{{workflow.parameters.pr-title}}"
                        - name: PR_AUTHOR
                          value: "{{workflow.parameters.pr-author}}"
                        - name: TRIGGER
                          value: "{{workflow.parameters.trigger}}"
                        - name: REVIEW_MODE
                          value: "review"
                        - name: MODEL
                          value: "claude-opus-4-5-20251101"
                        - name: GITHUB_APP_ID
                          value: "1794583"
                        - name: GITHUB_APP_PRIVATE_KEY_PATH
                          value: "/secrets/github-app/private-key.pem"
                        - name: FACTORY_API_KEY
                          valueFrom:
                            secretKeyRef:
                              name: cto-secrets
                              key: FACTORY_API_KEY
                        - name: ANTHROPIC_API_KEY
                          valueFrom:
                            secretKeyRef:
                              name: cto-secrets
                              key: ANTHROPIC_API_KEY
                      resources:
                        limits:
                          cpu: 4000m
                          memory: 8Gi
                        requests:
                          cpu: 1000m
                          memory: 2Gi
                      volumeMounts:
                        - name: agent-templates
                          mountPath: /task-files
                          readOnly: true
                        - name: github-app-key
                          mountPath: /secrets/github-app
                          readOnly: true
                        - name: factory-home
                          mountPath: /home/node/.factory
          parameters:
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.number
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: pr-event
                dataKey: body.repository.html_url
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.head.sha
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: pr-event
                dataKey: body.repository.full_name
              dest: spec.arguments.parameters.3.value
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.base.ref
              dest: spec.arguments.parameters.4.value
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.head.ref
              dest: spec.arguments.parameters.5.value
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.title
              dest: spec.arguments.parameters.6.value
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.user.login
              dest: spec.arguments.parameters.7.value
