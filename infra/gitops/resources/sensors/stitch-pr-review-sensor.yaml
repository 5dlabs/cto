---
# Stitch PR Review Sensor
# Triggers Stitch to review PRs on pull_request events
# Creates a CodeRun CRD with runType: "review" which the controller processes
# Pod naming: review-pr{pr}-stitch-{model}-{uid}-v{version}

apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: stitch-pr-review
  namespace: automation
  labels:
    app.kubernetes.io/name: stitch-pr-review-sensor
    app.kubernetes.io/part-of: argo-events
    agent: stitch
    event-type: github-pr-review
spec:
  replicas: 1
  template:
    serviceAccountName: argo-events-sa
    container:
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi
  dependencies:
    - name: pr-event
      eventSourceName: github
      eventName: org
      filters:
        # Logical operator for combining filters (default is AND)
        exprLogicalOperator: "and"
        data:
          - path: body.X-GitHub-Event
            type: string
            value:
              - pull_request
          - path: body.action
            type: string
            value:
              - opened
              - synchronize
              - reopened
        # Expression filters to exclude automated PRs
        exprs:
          # Exclude bot users (github-actions, dependabot, renovate, etc.)
          - expr: >-
              !(
                body.pull_request.user.login contains "[bot]" ||
                body.pull_request.user.login == "github-actions" ||
                body.pull_request.user.login == "dependabot" ||
                body.pull_request.user.login == "renovate"
              )
            fields:
              - name: body.pull_request.user.login
                path: body.pull_request.user.login
          # Exclude release-please branches
          - expr: >-
              !(body.pull_request.head.ref contains "release-please")
            fields:
              - name: body.pull_request.head.ref
                path: body.pull_request.head.ref
          # Exclude auto-release/dependency PR titles
          - expr: >-
              !(
                body.pull_request.title startsWith "chore: release" ||
                body.pull_request.title startsWith "chore(deps)" ||
                body.pull_request.title startsWith "chore(release)" ||
                body.pull_request.title contains "[skip review]" ||
                body.pull_request.title contains "[no review]"
              )
            fields:
              - name: body.pull_request.title
                path: body.pull_request.title
  triggers:
    - template:
        name: stitch-review-coderun
        conditions: pr-event
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform/v1
              kind: CodeRun
              metadata:
                generateName: stitch-review-
                namespace: cto
                labels:
                  agent: stitch
                  run-type: review
                  pr-number: ""  # Will be filled by parameter
              spec:
                runType: review
                service: stitch-review
                repositoryUrl: ""  # Will be filled by parameter
                docsRepositoryUrl: ""  # Will be filled by parameter (same as repo)
                docsBranch: main
                model: claude-opus-4-5-20251101
                githubApp: 5DLabs-Stitch
                contextVersion: 1
                continueSession: false
                overwriteMemory: false
                enableDocker: false
                env:
                  PR_NUMBER: ""
                  HEAD_SHA: ""
                  BASE_BRANCH: ""
                  HEAD_BRANCH: ""
                  PR_TITLE: ""
                  PR_AUTHOR: ""
                  TRIGGER: pull_request
                  REVIEW_MODE: review
                  REPO_SLUG: ""
                envFromSecrets:
                  - name: FACTORY_API_KEY
                    secretName: cto-secrets
                    secretKey: FACTORY_API_KEY
                  - name: ANTHROPIC_API_KEY
                    secretName: cto-secrets
                    secretKey: ANTHROPIC_API_KEY
                cliConfig:
                  cliType: factory
                  model: claude-opus-4-5-20251101
                  settings:
                    template: review/factory
                    autoLevel: high
          parameters:
            # PR number - used in labels and env
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.number
              dest: metadata.labels.pr-number
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.number
              dest: spec.env.PR_NUMBER
            # Repository URL
            - src:
                dependencyName: pr-event
                dataKey: body.repository.html_url
              dest: spec.repositoryUrl
            - src:
                dependencyName: pr-event
                dataKey: body.repository.html_url
              dest: spec.docsRepositoryUrl
            # Head SHA
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.head.sha
              dest: spec.env.HEAD_SHA
            # Repo slug (owner/repo)
            - src:
                dependencyName: pr-event
                dataKey: body.repository.full_name
              dest: spec.env.REPO_SLUG
            # Base branch
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.base.ref
              dest: spec.env.BASE_BRANCH
            # Head branch
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.head.ref
              dest: spec.env.HEAD_BRANCH
            # PR title
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.title
              dest: spec.env.PR_TITLE
            # PR author
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.user.login
              dest: spec.env.PR_AUTHOR
