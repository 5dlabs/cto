---
# Stitch PR Review Sensor
# Triggers Stitch to review PRs on pull_request events
# Phase 1: PR opened/synchronized/reopened only

apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: stitch-pr-review
  namespace: automation
  labels:
    app.kubernetes.io/name: stitch-pr-review-sensor
    app.kubernetes.io/part-of: argo-events
    agent: stitch
    event-type: github-pr-review
spec:
  replicas: 1
  template:
    serviceAccountName: argo-events-sa
    container:
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi
  dependencies:
    - name: pr-event
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value:
              - pull_request
          - path: body.action
            type: string
            value:
              - opened
              - synchronize
              - reopened
  triggers:
    - template:
        name: stitch-review-pr
        conditions: pr-event
        argoWorkflow:
          operation: submit
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: stitch-review-
                namespace: cto
                labels:
                  agent: stitch
                  workflow-type: pr-review
              spec:
                serviceAccountName: cto-controller
                entrypoint: review
                arguments:
                  parameters:
                    - name: pr-number
                    - name: repo-url
                    - name: head-sha
                    - name: repo-slug
                    - name: trigger
                      value: pull_request
                ttlStrategy:
                  secondsAfterCompletion: 300
                  secondsAfterFailure: 3600
                  secondsAfterSuccess: 300
                volumes:
                  - name: agent-templates
                    configMap:
                      name: cto-controller-agent-templates-factory
                      items:
                        - key: review_factory_agents.md.hbs
                          path: agents.md
                        - key: review_factory_container.sh.hbs
                          path: container.sh
                templates:
                  - name: review
                    container:
                      image: ghcr.io/5dlabs/factory:latest
                      command: ["/bin/sh"]
                      args:
                        - "-c"
                        - |
                          echo "üîç Stitch PR Review"
                          echo "PR: #{{workflow.parameters.pr-number}}"
                          echo "Repo: {{workflow.parameters.repo-slug}}"
                          echo "SHA: {{workflow.parameters.head-sha}}"
                          echo "Trigger: {{workflow.parameters.trigger}}"
                          echo ""
                          echo "üìã This is a test run - full review logic coming soon"
                          # TODO: Execute actual review via droid exec
                      env:
                        - name: PR_NUMBER
                          value: "{{workflow.parameters.pr-number}}"
                        - name: REPOSITORY_URL
                          value: "{{workflow.parameters.repo-url}}"
                        - name: REPO_SLUG
                          value: "{{workflow.parameters.repo-slug}}"
                        - name: HEAD_SHA
                          value: "{{workflow.parameters.head-sha}}"
                        - name: TRIGGER
                          value: "{{workflow.parameters.trigger}}"
                      resources:
                        limits:
                          cpu: 2000m
                          memory: 4Gi
                        requests:
                          cpu: 500m
                          memory: 1Gi
                      volumeMounts:
                        - name: agent-templates
                          mountPath: /task-files
                          readOnly: true
          parameters:
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.number
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: pr-event
                dataKey: body.repository.html_url
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: pr-event
                dataKey: body.pull_request.head.sha
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: pr-event
                dataKey: body.repository.full_name
              dest: spec.arguments.parameters.3.value
