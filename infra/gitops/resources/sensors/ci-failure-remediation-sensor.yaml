---
# CI Failure Remediation Sensor
#
# Routes CI failures to the Healer service for intelligent remediation.
# Healer classifies failures and dispatches to specialized agents:
# - Rex: Rust failures (clippy, tests, builds)
# - Blaze: Frontend failures (TypeScript, ESLint, npm)
# - Bolt: Infrastructure failures (Docker, Helm, K8s)
# - Cipher: Security alerts (Dependabot, code scanning)
# - Atlas: Git/GitHub issues (merge conflicts, workflows)
#
# The sensor forwards the raw GitHub webhook payload to Healer's HTTP API,
# which handles classification, context gathering, and CodeRun creation.
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: ci-failure-remediation
  namespace: automation
  labels:
    app: ci-remediation
    component: failure-sensor
spec:
  replicas: 1
  deploymentStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    serviceAccountName: argo-events-sa
    container:
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "256Mi"
          cpu: "300m"
  dependencies:
    - name: workflow-failure
      eventSourceName: github
      eventName: org
      filters:
        data:
          # Only workflow_run events
          - path: body.X-GitHub-Event
            type: string
            value: ["workflow_run"]
          # Only completed workflows
          - path: body.action
            type: string
            value: ["completed"]
          # Only failures
          - path: body.workflow_run.conclusion
            type: string
            value: ["failure"]
          # Only 5dlabs/cto repository
          - path: body.repository.full_name
            type: string
            value: ["5dlabs/cto"]
        exprs:
          # Exclude workflows with skip-ci-remediation in commit message
          - expr: '!(body.workflow_run.head_commit.message contains "[skip-ci-remediation]")'
            fields:
              - name: skip_check
                path: body.workflow_run.head_commit.message
          # Additional validation
          - expr: 'body.workflow_run.id != ""'
            fields:
              - name: workflow_run_id
                path: body.workflow_run.id
          - expr: 'body.workflow_run.head_branch != ""'
            fields:
              - name: head_branch
                path: body.workflow_run.head_branch

    # Also listen for workflow_job events (more granular failure info)
    - name: job-failure
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value: ["workflow_job"]
          - path: body.action
            type: string
            value: ["completed"]
          - path: body.workflow_job.conclusion
            type: string
            value: ["failure"]
          - path: body.repository.full_name
            type: string
            value: ["5dlabs/cto"]

    # Security alerts
    - name: security-alert
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value: ["dependabot_alert", "code_scanning_alert", "secret_scanning_alert"]
          - path: body.action
            type: string
            value: ["created", "reopened"]
          - path: body.repository.full_name
            type: string
            value: ["5dlabs/cto"]

  triggers:
    # Route workflow failures to Healer
    - template:
        name: healer-workflow-failure
        conditions: "workflow-failure"
        http:
          url: http://healer.cto.svc.cluster.local:8080/api/remediate/ci-failure
          method: POST
          headers:
            Content-Type: application/json
          payload:
            - src:
                dependencyName: workflow-failure
                dataKey: body
              dest: ""
          timeout: 30
        retryStrategy:
          steps: 3
          duration: "10s"
          factor: 2
          jitter: 0.1

    # Route job failures to Healer (more detailed)
    - template:
        name: healer-job-failure
        conditions: "job-failure"
        http:
          url: http://healer.cto.svc.cluster.local:8080/api/remediate/ci-failure
          method: POST
          headers:
            Content-Type: application/json
          payload:
            - src:
                dependencyName: job-failure
                dataKey: body
              dest: ""
          timeout: 30
        retryStrategy:
          steps: 3
          duration: "10s"
          factor: 2
          jitter: 0.1

    # Route security alerts to Healer
    - template:
        name: healer-security-alert
        conditions: "security-alert"
        http:
          url: http://healer.cto.svc.cluster.local:8080/api/remediate/security-alert
          method: POST
          headers:
            Content-Type: application/json
          payload:
            - src:
                dependencyName: security-alert
                dataKey: body
              dest: ""
          timeout: 30
        retryStrategy:
          steps: 3
          duration: "10s"
          factor: 2
          jitter: 0.1

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ci-remediation-strategy
  namespace: automation
data:
  remediation-strategy.md: |
    # CI Failure Remediation Strategy

    ## Architecture
    The CI remediation system uses a sensor → Healer → agent architecture:

    1. **Sensor** (this resource): Captures GitHub webhook events
    2. **Healer**: Central intelligence hub that:
       - Classifies failure types
       - Gathers context (logs, files, ArgoCD status)
       - Routes to specialist agents
       - Manages retry loops
       - Escalates to humans after failures
    3. **Agents**: Specialist CodeRuns for different failure types

    ## Agent Specializations
    - **Rex**: Rust (clippy, cargo test, build errors)
    - **Blaze**: Frontend (TypeScript, ESLint, npm/pnpm)
    - **Bolt**: Infrastructure (Docker, Helm, K8s, ArgoCD)
    - **Cipher**: Security (Dependabot, code scanning, secrets)
    - **Atlas**: Git/GitHub (merge conflicts, workflows, general)

    ## Event Types Captured
    - `workflow_run.completed.failure`: Full workflow failures
    - `workflow_job.completed.failure`: Individual job failures
    - `dependabot_alert.created/reopened`: Dependency vulnerabilities
    - `code_scanning_alert.created/reopened`: Code security issues
    - `secret_scanning_alert.created/reopened`: Exposed secrets

    ## Deduplication
    Healer prevents duplicate remediations via:
    - Workflow run ID tracking
    - Branch + time window checks
    - Existing CodeRun label queries

    ## Retry Strategy
    - Max 3 attempts per failure
    - Different agent on each retry if appropriate
    - Historical context from OpenMemory on retries
    - Human escalation after max attempts

    ## Exclusions
    - Commits with `[skip-ci-remediation]` in message
    - Already-remediated workflow runs
