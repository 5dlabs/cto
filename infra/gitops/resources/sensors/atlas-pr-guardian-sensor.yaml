---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: atlas-pr-guardian
  namespace: argo
spec:
  template:
    serviceAccountName: argo-events-sa

  dependencies:
    - name: pr-events
      eventSourceName: github
      eventName: org
      filters:
        data:
          # Only 5dlabs/cto repository
          - path: body.repository.full_name
            type: string
            value:
              - "5dlabs/cto"
          # NOTE: app_slug filter removed to allow Atlas to monitor ALL PR activity
          # (from humans, bots, other apps). Deduplication workflow + rate limiting
          # prevents duplicate Atlas instances per PR.
          # Accept both pull_request and issue_comment events
          - path: body.X-GitHub-Event
            type: string
            value:
              - pull_request
              - issue_comment
              - pull_request_review
          # Filter PR actions to relevant ones only
          - path: body.action
            type: string
            value:
              - opened
              - reopened
              - synchronize
              - ready_for_review
              - created
              - submitted
        exprs:
          # CRITICAL: Only process issue_comment events that are on pull requests
          # Regular GitHub issues also use issue_comment events, but we only want PR comments
          # This prevents the workflow from treating issue numbers as PR numbers
          - expr: 'body.X-GitHub-Event != "issue_comment" || has(body.issue.pull_request)'
            fields:
              - name: body.X-GitHub-Event
                path: body.X-GitHub-Event
              - name: body.issue.pull_request
                path: body.issue.pull_request

  triggers:
    - template:
        name: create-or-resume-atlas-guardian
        conditions: "pr-events"
        # Rate limiting to prevent runaway workflow creation
        # Max 10 workflows per minute across all PR events
        rateLimit:
          unit: Minute
          requestsPerUnit: 10
        argoWorkflow:
          operation: submit
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: atlas-dedup-
                namespace: agent-platform
              spec:
                entrypoint: deduplicate-and-create
                serviceAccountName: argo-workflow
                templates:
                  - name: deduplicate-and-create
                    script:
                      image: alpine/k8s:1.31.0
                      command: [bash]
                      source: |
                        #!/bin/bash
                        set -e

                        # Ensure jq is available
                        if ! command -v jq >/dev/null 2>&1; then
                          if command -v apk >/dev/null 2>&1; then
                            apk add --no-cache jq
                          fi
                        fi

                        echo "=== Atlas PR Guardian Deduplication ==="
                        echo "Event: {{ .Input.body.X-GitHub-Event }}"
                        echo "Action: {{ .Input.body.action }}"

                        # Extract PR number based on event type
                        EVENT_TYPE="{{ .Input.body.X-GitHub-Event }}"

                        if [ "$EVENT_TYPE" = "issue_comment" ]; then
                          # For issue_comment: verify it's on a PR, not a regular issue
                          IS_PR="{{ .Input.body.issue.pull_request }}"
                          if [ -z "$IS_PR" ] || [ "$IS_PR" = "null" ]; then
                            echo "ℹ️ Issue comment on regular issue (not PR) - skipping"
                            exit 0
                          fi
                          PR_NUMBER="{{ .Input.body.issue.number }}"
                        else
                          # For pull_request/pull_request_review events
                          PR_NUMBER="{{ .Input.body.pull_request.number }}"
                        fi

                        echo "PR Number: $PR_NUMBER"

                        # Validate PR_NUMBER is not empty (prevents edge cases in GitHub webhooks)
                        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
                          echo "❌ No PR number found in webhook event - skipping"
                          exit 0
                        fi

                        # Check for existing CodeRun for this PR
                        EXISTING=$(kubectl get coderuns -n agent-platform \
                          -l agent=atlas,pr-number="$PR_NUMBER" \
                          -o json 2>/dev/null || echo '{"items":[]}')

                        COUNT=$(echo "$EXISTING" | jq '.items | length')
                        echo "Found $COUNT existing CodeRun(s) for PR #$PR_NUMBER"

                        if [ "$COUNT" -gt 0 ]; then
                          # Check for active CodeRuns:
                          # 1. Running or Pending phase (normal cases)
                          # 2. No status yet (newly created, not reconciled) - check if created within last 30 seconds
                          ACTIVE=$(echo "$EXISTING" | jq -r '.items[] | select(
                            (.status.phase == "Running" or .status.phase == "Pending") or
                            (.status == null and (now - (.metadata.creationTimestamp | fromdateiso8601) < 30))
                          ) | .metadata.name' | head -1)

                          if [ -n "$ACTIVE" ]; then
                            echo "✅ CodeRun already active: $ACTIVE"
                            echo "   Session continuity will handle this event"
                            exit 0
                          fi

                          echo "⚠️  Existing CodeRun(s) are not active (likely Completed/Failed)"
                          echo "   Creating new CodeRun for PR #$PR_NUMBER"
                        fi

                        # Create new CodeRun
                        cat <<EOF | kubectl create -f - 2>&1 | tee /tmp/create-output.txt
                        apiVersion: agents.platform/v1
                        kind: CodeRun
                        metadata:
                          generateName: coderun-atlas-pr-
                          namespace: agent-platform
                          labels:
                            agent: atlas
                            role: pr-guardian
                            pr-number: "$PR_NUMBER"
                            repository: "cto"
                        spec:
                          taskId: 0
                          service: "atlas-pr-guardian"
                          githubApp: "5DLabs-Atlas"
                          model: "claude-sonnet-4-5-20250929"
                          repositoryUrl: "{{ .Input.body.repository.clone_url }}"
                          docsRepositoryUrl: "{{ .Input.body.repository.clone_url }}"
                          docsProjectDirectory: "docs"
                          workingDirectory: "."
                          continueSession: true
                          overwriteMemory: false
                          cliConfig:
                            cliType: "claude"
                            model: "claude-sonnet-4-5-20250929"
                            maxTokens: 8192
                            temperature: 0.3
                          env:
                            PR_NUMBER: "$PR_NUMBER"
                            PR_URL: "{{ .Input.body.pull_request.html_url | default .Input.body.issue.html_url }}"
                            REPOSITORY_FULL_NAME: "{{ .Input.body.repository.full_name }}"
                            GUARDIAN_MODE: "active"
                            TARGET_REPOSITORY: "5dlabs/cto"
                            MERGE_STRATEGY: "squash"
                        EOF

                        if grep -q "created" /tmp/create-output.txt; then
                          CODERUN_NAME=$(grep "created" /tmp/create-output.txt | awk '{print $1}' | cut -d'/' -f2)
                          echo "✅ Created new CodeRun: $CODERUN_NAME"
                        else
                          echo "⚠️  CodeRun creation output:"
                          cat /tmp/create-output.txt
                        fi
      retryStrategy:
        steps: 3
        duration: "10s"
        factor: 2

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: atlas-pr-guardian-strategy
  namespace: argo
data:
  guardian-strategy.md: |
    # Atlas PR Guardian Strategy

    ## Mission
    Atlas acts as a **per-PR guardian** that watches a pull request from creation to merge,
    ensuring it stays clean, passes CI, and has no Bugbot comments before auto-merging.

    ## Deduplication Logic (NEW)
    - Before creating a CodeRun, check if one already exists for the PR
    - If Running: Skip creation (session continuity handles new events)
    - If Completed/Failed: Create new CodeRun for fresh start
    - If none exist: Create new CodeRun
    - **Result**: One Atlas instance per PR, no duplicates

    ## Activation
    - **Trigger**: PR opened, reopened, synchronized, or new comments added
    - **Scope**: Only 5dlabs/cto repository
    - **Lifecycle**: One Atlas instance per PR, stays active until PR is merged or closed

    ## Responsibilities

    ### 1. Bugbot Comment Resolution
    - Monitor for comments from Cursor Bugbot (https://github.com/apps/cursor)
    - Analyze Bugbot feedback and apply fixes
    - Push fixes to PR branch
    - Verify Bugbot is satisfied (no open threads)

    ### 2. CI Failure Recovery
    - Watch for failing status checks and CI runs
    - Analyze failure logs
    - Apply minimal fixes to get CI green
    - Re-run checks if needed

    ### 3. Merge Conflict Resolution
    - Detect when PR becomes unmergeable
    - Rebase or merge main into PR branch
    - Resolve conflicts intelligently
    - Ensure clean merge state

    ### 4. Auto-Merge When Ready
    - **Merge Criteria**:
      - ✅ No open Bugbot comment threads
      - ✅ All CI checks passing
      - ✅ No merge conflicts
      - ✅ PR is mergeable
    - **Merge Strategy**: Always squash merge
    - **Post-Merge**: Comment with summary and close Atlas session

    ### 5. Blocked State Handling
    - If Atlas cannot resolve issues after 3 attempts:
      - Add `blocked` label to PR
      - Post detailed comment explaining blockers
      - Tag PR author for human intervention
      - Suspend Atlas session until new activity
