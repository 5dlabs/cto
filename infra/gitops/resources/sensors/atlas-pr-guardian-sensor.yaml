---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: atlas-pr-guardian
  namespace: argo
spec:
  # Legacy sensor replaced by atlas-pr-monitor in github-webhooks (kept for rollback)
  replicas: 0
  template:
    serviceAccountName: argo-events-sa

  dependencies:
    - name: pr-events
      eventSourceName: github
      eventName: org
      filters:
        data:
          # Only 5dlabs/cto repository
          - path: body.repository.full_name
            type: string
            value:
              - "5dlabs/cto"
          # NOTE: app_slug filter removed to allow Atlas to monitor ALL PR activity
          # (from humans, bots, other apps). Deduplication workflow + rate limiting
          # prevents duplicate Atlas instances per PR.
          # Accept both pull_request and issue_comment events
          - path: body.X-GitHub-Event
            type: string
            value:
              - pull_request
              - issue_comment
              - pull_request_review
              - workflow_run
          # Filter PR actions to relevant ones only
          - path: body.action
            type: string
            value:
              - opened
              - reopened
              - synchronize
              - ready_for_review
              - created
              - submitted
              - completed
              - requested
        # NOTE: Atlas self-filtering moved to workflow script due to Argo Events expr limitations
        # The expr filter "!(body.sender.login contains 'atlas-5dlabs')" was causing 100% event discard
        # with error: "Unable to access unexported field 'sender' in token 'body.sender.login'"
        # Now handled as first step in workflow: exit early if sender is atlas-5dlabs

  triggers:
    - template:
        name: create-or-resume-atlas-guardian
        conditions: "pr-events"
        # Rate limiting to prevent runaway workflow creation
        # Max 10 workflows per minute across all PR events
        rateLimit:
          unit: Minute
          requestsPerUnit: 10
        argoWorkflow:
          operation: submit
          parameters:
            - src:
                dependencyName: pr-events
                dataKey: body.X-GitHub-Event
              dest: spec.templates.0.script.env.0.value
            - src:
                dependencyName: pr-events
                dataTemplate: |
                  {{- if .Input.body.pull_request -}}
                    {{ .Input.body.pull_request.number }}
                  {{- else if and .Input.body.issue .Input.body.issue.pull_request -}}
                    {{ .Input.body.issue.number }}
                  {{- else if and .Input.body.workflow_run (gt (len .Input.body.workflow_run.pull_requests) 0) -}}
                    {{ (index .Input.body.workflow_run.pull_requests 0).number }}
                  {{- else -}}
                  {{""}}
                  {{- end -}}
              dest: spec.templates.0.script.env.1.value
            - src:
                dependencyName: pr-events
                dataKey: body.action
              dest: spec.templates.0.script.env.2.value
            - src:
                dependencyName: pr-events
                dataKey: body.repository.clone_url
              dest: spec.templates.0.script.env.3.value
            - src:
                dependencyName: pr-events
                dataTemplate: |
                  {{- if .Input.body.pull_request -}}
                    true
                  {{- else if and .Input.body.issue .Input.body.issue.pull_request -}}
                    true
                  {{- else if and .Input.body.workflow_run (gt (len .Input.body.workflow_run.pull_requests) 0) -}}
                    true
                  {{- else -}}
                    false
                  {{- end -}}
              dest: spec.templates.0.script.env.4.value
            - src:
                dependencyName: pr-events
                dataTemplate: "{{ .Input.body.workflow_run.id | default \"\" }}"
              dest: spec.templates.0.script.env.5.value
            - src:
                dependencyName: pr-events
                dataTemplate: "{{ .Input.body.workflow_run.conclusion | default \"\" }}"
              dest: spec.templates.0.script.env.6.value
            - src:
                dependencyName: pr-events
                dataTemplate: "{{ .Input.body.workflow_run.name | default \"\" }}"
              dest: spec.templates.0.script.env.7.value
            - src:
                dependencyName: pr-events
                dataTemplate: "{{ .Input.body.workflow_run.run_attempt | default \"\" }}"
              dest: spec.templates.0.script.env.8.value
            - src:
                dependencyName: pr-events
                dataTemplate: "{{ .Input.body.workflow_run.html_url | default \"\" }}"
              dest: spec.templates.0.script.env.9.value
            - src:
                dependencyName: pr-events
                dataKey: body.sender.login
              dest: spec.templates.0.script.env.10.value
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: atlas-dedup-
                namespace: agent-platform
              spec:
                entrypoint: deduplicate-and-create
                serviceAccountName: argo-workflow
                # Auto-cleanup after completion (5 minutes for success, 1 hour for failure)
                ttlStrategy:
                  secondsAfterCompletion: 300  # 5 minutes
                  secondsAfterFailure: 3600    # 1 hour
                templates:
                  - name: deduplicate-and-create
                    script:
                      image: alpine/k8s:1.31.0
                      command: [bash]
                      env:
                        - name: EVENT_TYPE
                          value: ""
                        - name: PR_NUMBER
                          value: ""
                        - name: ACTION
                          value: ""
                        - name: REPO_URL
                          value: ""
                        - name: IS_PR
                          value: ""
                        - name: WORKFLOW_RUN_ID
                          value: ""
                        - name: WORKFLOW_RUN_CONCLUSION
                          value: ""
                        - name: WORKFLOW_RUN_NAME
                          value: ""
                        - name: WORKFLOW_RUN_ATTEMPT
                          value: ""
                        - name: WORKFLOW_RUN_URL
                          value: ""
                        - name: SENDER_LOGIN
                          value: ""
                      source: |
                        #!/bin/bash
                        set -e

                        # CRITICAL: Prevent infinite loops - Atlas should NOT monitor its own PRs
                        # Use exact match to avoid false positives with usernames containing "atlas-5dlabs"
                        if [[ "${SENDER_LOGIN:-}" == "atlas-5dlabs[bot]" ]] || [[ "${SENDER_LOGIN:-}" == "atlas-5dlabs" ]]; then
                          echo "üõë Event from Atlas itself (sender: $SENDER_LOGIN) - skipping to prevent infinite loop"
                          exit 0
                        fi

                        # Ensure jq is available
                        if ! command -v jq >/dev/null 2>&1; then
                          if command -v apk >/dev/null 2>&1; then
                            apk add --no-cache jq
                          fi
                        fi

                        echo "=== Atlas PR Guardian Deduplication ==="
                        echo "Sender: ${SENDER_LOGIN:-unknown}"
                        echo "Event: $EVENT_TYPE"
                        echo "Action: $ACTION"
                        echo "PR Number: $PR_NUMBER"
                        if [ -n "$WORKFLOW_RUN_ID" ]; then
                          echo "Workflow Run ID: $WORKFLOW_RUN_ID"
                          echo "Workflow Name: ${WORKFLOW_RUN_NAME:-unknown}"
                          echo "Workflow Conclusion: ${WORKFLOW_RUN_CONCLUSION:-pending}"
                          echo "Workflow Attempt: ${WORKFLOW_RUN_ATTEMPT:-1}"
                        fi
                        echo "Is PR: $IS_PR"

                        # Validate this is a PR-related event (not a regular issue)
                        if [ "$EVENT_TYPE" = "issue_comment" ] && [ "$IS_PR" != "true" ]; then
                          echo "‚ÑπÔ∏è Issue comment on regular issue (not PR) - skipping"
                          exit 0
                        fi

                        # Validate PR_NUMBER is not empty (prevents edge cases in GitHub webhooks)
                        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
                          echo "‚ùå No PR number found in webhook event - skipping"
                          exit 0
                        fi

                        # Use ConfigMap as distributed lock to prevent race conditions
                        # Multiple concurrent workflows will try to create this - only one succeeds
                        LOCK_NAME="atlas-pr-lock-$PR_NUMBER"
                        echo "üîí Attempting to acquire lock: $LOCK_NAME"

                        if kubectl create configmap "$LOCK_NAME" \
                          --from-literal=pr-number="$PR_NUMBER" \
                          --from-literal=created-at="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                          --from-literal=workflow="{{workflow.name}}" \
                          -n agent-platform \
                          -o yaml --dry-run=client | kubectl create -f - 2>/dev/null; then
                          echo "‚úÖ Lock acquired - this workflow will create CodeRun"
                          trap "kubectl delete configmap $LOCK_NAME -n agent-platform --ignore-not-found=true 2>/dev/null || true" EXIT
                        else
                          echo "üîí Lock already held by another workflow - skipping to prevent duplicate"
                          # Check if CodeRun was created by lock holder
                          sleep 2
                          EXISTING=$(kubectl get coderuns -n agent-platform \
                            -l agent=atlas,pr-number="$PR_NUMBER" \
                            -o json 2>/dev/null || echo '{"items":[]}')
                          COUNT=$(echo "$EXISTING" | jq '.items | length')
                          if [ "$COUNT" -gt 0 ]; then
                            echo "‚úÖ CodeRun created by lock holder"
                          else
                            echo "‚ö†Ô∏è No CodeRun yet, lock holder may still be processing"
                          fi
                          exit 0
                        fi

                        # Check for existing CodeRun for this PR (belt-and-suspenders with lock)
                        EXISTING=$(kubectl get coderuns -n agent-platform \
                          -l agent=atlas,pr-number="$PR_NUMBER" \
                          -o json 2>/dev/null || echo '{"items":[]}')

                        COUNT=$(echo "$EXISTING" | jq '.items | length')
                        echo "Found $COUNT existing CodeRun(s) for PR #$PR_NUMBER"

                        if [ "$COUNT" -gt 0 ]; then
                          # Check for active CodeRuns:
                          # 1. Running or Pending phase (normal cases)
                          # 2. No status yet (newly created, not reconciled) - check if created within last 30 seconds
                          ACTIVE=$(echo "$EXISTING" | jq -r '.items[] | select(
                            (.status.phase == "Running" or .status.phase == "Pending") or
                            (.status == null and (now - (.metadata.creationTimestamp | fromdateiso8601) < 30))
                          ) | .metadata.name' | head -1)

                          if [ -n "$ACTIVE" ]; then
                            echo "‚úÖ CodeRun already active: $ACTIVE"
                            echo "   Session continuity will handle this event"
                            exit 0
                          fi

                          echo "‚ö†Ô∏è  Existing CodeRun(s) are not active (likely Completed/Failed)"
                          echo "   Creating new CodeRun for PR #$PR_NUMBER"
                        fi

                        # Create new CodeRun
                        cat <<EOF | kubectl create -f - 2>&1 | tee /tmp/create-output.txt
                        apiVersion: agents.platform/v1
                        kind: CodeRun
                        metadata:
                          generateName: coderun-atlas-pr-
                          namespace: agent-platform
                          labels:
                            agent: atlas
                            role: pr-guardian
                            stage: guardian
                            pr-number: "$PR_NUMBER"
                            repository: "cto"
                        spec:
                          taskId: 0
                          service: "atlas-pr-guardian"
                          githubApp: "5DLabs-Atlas"
                          model: "claude-sonnet-4-5-20250929"
                          repositoryUrl: "$REPO_URL"
                          docsRepositoryUrl: "$REPO_URL"
                          docsProjectDirectory: "docs"
                          workingDirectory: "."
                          continueSession: true
                          overwriteMemory: false
                          env:
                            PR_NUMBER: "$PR_NUMBER"
                            PR_URL: "https://github.com/5dlabs/cto/pull/$PR_NUMBER"
                            REPOSITORY_FULL_NAME: "5dlabs/cto"
                            GUARDIAN_MODE: "active"
                            TARGET_REPOSITORY: "5dlabs/cto"
                            MERGE_STRATEGY: "squash"
                            TRIGGER_EVENT: "$EVENT_TYPE"
                            TRIGGER_ACTION: "$ACTION"
                            WORKFLOW_RUN_ID: "$WORKFLOW_RUN_ID"
                            WORKFLOW_RUN_CONCLUSION: "$WORKFLOW_RUN_CONCLUSION"
                            WORKFLOW_RUN_NAME: "$WORKFLOW_RUN_NAME"
                            WORKFLOW_RUN_ATTEMPT: "$WORKFLOW_RUN_ATTEMPT"
                            WORKFLOW_RUN_URL: "$WORKFLOW_RUN_URL"
                        EOF

                        if grep -q "created" /tmp/create-output.txt; then
                          CODERUN_NAME=$(grep "created" /tmp/create-output.txt | awk '{print $1}' | cut -d'/' -f2)
                          echo "‚úÖ Created new CodeRun: $CODERUN_NAME"
                        else
                          echo "‚ö†Ô∏è  CodeRun creation output:"
                          cat /tmp/create-output.txt
                        fi
      retryStrategy:
        steps: 3
        duration: "10s"
        factor: 2

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: atlas-pr-guardian-strategy
  namespace: argo
data:
  guardian-strategy.md: |
    # Atlas PR Guardian Strategy

    ## Mission
    Atlas acts as a **per-PR guardian** that watches a pull request from creation to merge,
    ensuring it stays clean, passes CI, and has no Bugbot comments before auto-merging.

    ## Deduplication Logic (NEW)
    - Before creating a CodeRun, check if one already exists for the PR
    - If Running: Skip creation (session continuity handles new events)
    - If Completed/Failed: Create new CodeRun for fresh start
    - If none exist: Create new CodeRun
    - **Result**: One Atlas instance per PR, no duplicates

    ## Activation
    - **Trigger**: PR opened, reopened, synchronized, or new comments added
    - **Scope**: Only 5dlabs/cto repository
    - **Lifecycle**: One Atlas instance per PR, stays active until PR is merged or closed

    ## Responsibilities

    ### 1. Bugbot Comment Resolution
    - Monitor for comments from Cursor Bugbot (https://github.com/apps/cursor)
    - Analyze Bugbot feedback and apply fixes
    - Push fixes to PR branch
    - Verify Bugbot is satisfied (no open threads)

    ### 2. CI Failure Recovery
    - Watch for failing status checks and CI runs
    - Analyze failure logs
    - Apply minimal fixes to get CI green
    - Re-run checks if needed

    ### 3. Merge Conflict Resolution
    - Detect when PR becomes unmergeable
    - Rebase or merge main into PR branch
    - Resolve conflicts intelligently
    - Ensure clean merge state

    ### 4. Auto-Merge When Ready
    - **Merge Criteria**:
      - ‚úÖ No open Bugbot comment threads
      - ‚úÖ All CI checks passing
      - ‚úÖ No merge conflicts
      - ‚úÖ PR is mergeable
    - **Merge Strategy**: Always squash merge
    - **Post-Merge**: Comment with summary and close Atlas session

    ### 5. Blocked State Handling
    - If Atlas cannot resolve issues after 3 attempts:
      - Add `blocked` label to PR
      - Post detailed comment explaining blockers
      - Tag PR author for human intervention
      - Suspend Atlas session until new activity
