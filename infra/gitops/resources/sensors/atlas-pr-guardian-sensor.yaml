---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: atlas-pr-guardian
  namespace: argo
spec:
  template:
    serviceAccountName: argo-events-sa

  dependencies:
    - name: pr-events
      eventSourceName: github
      eventName: org
      filters:
        data:
          # Only 5dlabs/cto repository
          - path: body.repository.full_name
            type: string
            value:
              - "5dlabs/cto"
          # Accept both pull_request and issue_comment events
          - path: body.X-GitHub-Event
            type: string
            value:
              - pull_request
              - issue_comment
              - pull_request_review
          # Filter PR actions to relevant ones only
          - path: body.action
            type: string
            value:
              - opened
              - reopened
              - synchronize
              - ready_for_review
              - created
              - submitted
        # Use exprs to ensure issue_comment events are only on PRs
        exprs:
          # For issue_comment events, verify it's on a PR (not a regular issue)
          - expr: 'body.X-GitHub-Event != "issue_comment" || body.issue.pull_request != null'
            fields:
              - name: is_pr_comment
                path: body.issue.pull_request

  triggers:
    - template:
        name: create-or-resume-atlas-guardian
        conditions: "pr-events"
        argoWorkflow:
          operation: submit
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: atlas-dedup-
                namespace: agent-platform
              spec:
                entrypoint: deduplicate-and-create
                serviceAccountName: argo-workflow
                templates:
                  - name: deduplicate-and-create
                    script:
                      image: alpine/k8s:1.31.0
                      command: [bash]
                      source: |
                        #!/bin/bash
                        set -e
                        
                        # Ensure jq is available
                        if ! command -v jq >/dev/null 2>&1; then
                          if command -v apk >/dev/null 2>&1; then
                            apk add --no-cache jq
                          fi
                        fi
                        
                        echo "=== Atlas PR Guardian Deduplication ==="
                        echo "PR Number: {{ .Input.body.pull_request.number | default .Input.body.issue.number }}"
                        echo "Event: {{ .Input.body.X-GitHub-Event }}"
                        echo "Action: {{ .Input.body.action }}"
                        
                        PR_NUMBER="{{ .Input.body.pull_request.number | default .Input.body.issue.number }}"
                        
                        # Check for existing CodeRun for this PR
                        EXISTING=$(kubectl get coderuns -n agent-platform \
                          -l agent=atlas,pr-number="$PR_NUMBER" \
                          -o json 2>/dev/null || echo '{"items":[]}')
                        
                        COUNT=$(echo "$EXISTING" | jq '.items | length')
                        echo "Found $COUNT existing CodeRun(s) for PR #$PR_NUMBER"
                        
                        if [ "$COUNT" -gt 0 ]; then
                          # Check status of existing CodeRuns
                          RUNNING=$(echo "$EXISTING" | jq -r '.items[] | select(.status.phase == "Running") | .metadata.name' | head -1)
                          
                          if [ -n "$RUNNING" ]; then
                            echo "✅ CodeRun already running: $RUNNING"
                            echo "   Session continuity will handle this event"
                            exit 0
                          fi
                          
                          echo "⚠️  Existing CodeRun(s) are not Running (likely Completed/Failed)"
                          echo "   Creating new CodeRun for PR #$PR_NUMBER"
                        fi
                        
                        # Create new CodeRun
                        cat <<EOF | kubectl create -f - 2>&1 | tee /tmp/create-output.txt
                        apiVersion: agents.platform.5dlabs.ai/v1alpha1
                        kind: CodeRun
                        metadata:
                          generateName: coderun-atlas-pr-
                          namespace: agent-platform
                          labels:
                            agent: atlas
                            role: pr-guardian
                            pr-number: "$PR_NUMBER"
                            repository: "cto"
                        spec:
                          taskId: 0
                          service: "atlas-pr-guardian"
                          githubApp: "5DLabs-Atlas"
                          repositoryUrl: "{{ .Input.body.repository.clone_url }}"
                          docsRepositoryUrl: "{{ .Input.body.repository.clone_url }}"
                          docsProjectDirectory: "docs"
                          workingDirectory: "."
                          continueSession: true
                          overwriteMemory: false
                          cliConfig:
                            cliType: "claude"
                            model: "claude-sonnet-4-20250514"
                            maxTokens: 8192
                            temperature: 0.3
                          env:
                            PR_NUMBER: "$PR_NUMBER"
                            PR_URL: "{{ .Input.body.pull_request.html_url | default .Input.body.issue.html_url }}"
                            REPOSITORY_FULL_NAME: "{{ .Input.body.repository.full_name }}"
                            GUARDIAN_MODE: "active"
                            TARGET_REPOSITORY: "5dlabs/cto"
                            MERGE_STRATEGY: "squash"
                        EOF
                        
                        if grep -q "created" /tmp/create-output.txt; then
                          CODERUN_NAME=$(grep "created" /tmp/create-output.txt | awk '{print $1}' | cut -d'/' -f2)
                          echo "✅ Created new CodeRun: $CODERUN_NAME"
                        else
                          echo "⚠️  CodeRun creation output:"
                          cat /tmp/create-output.txt
                        fi
      retryStrategy:
        steps: 3
        duration: "10s"
        factor: 2

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: atlas-pr-guardian-strategy
  namespace: argo
data:
  guardian-strategy.md: |
    # Atlas PR Guardian Strategy

    ## Mission
    Atlas acts as a **per-PR guardian** that watches a pull request from creation to merge,
    ensuring it stays clean, passes CI, and has no Bugbot comments before auto-merging.

    ## Deduplication Logic (NEW)
    - Before creating a CodeRun, check if one already exists for the PR
    - If Running: Skip creation (session continuity handles new events)
    - If Completed/Failed: Create new CodeRun for fresh start
    - If none exist: Create new CodeRun
    - **Result**: One Atlas instance per PR, no duplicates

    ## Activation
    - **Trigger**: PR opened, reopened, synchronized, or new comments added
    - **Scope**: Only 5dlabs/cto repository
    - **Lifecycle**: One Atlas instance per PR, stays active until PR is merged or closed

    ## Responsibilities

    ### 1. Bugbot Comment Resolution
    - Monitor for comments from Cursor Bugbot (https://github.com/apps/cursor)
    - Analyze Bugbot feedback and apply fixes
    - Push fixes to PR branch
    - Verify Bugbot is satisfied (no open threads)

    ### 2. CI Failure Recovery
    - Watch for failing status checks and CI runs
    - Analyze failure logs
    - Apply minimal fixes to get CI green
    - Re-run checks if needed

    ### 3. Merge Conflict Resolution
    - Detect when PR becomes unmergeable
    - Rebase or merge main into PR branch
    - Resolve conflicts intelligently
    - Ensure clean merge state

    ### 4. Auto-Merge When Ready
    - **Merge Criteria**:
      - ✅ No open Bugbot comment threads
      - ✅ All CI checks passing
      - ✅ No merge conflicts
      - ✅ PR is mergeable
    - **Merge Strategy**: Always squash merge
    - **Post-Merge**: Comment with summary and close Atlas session

    ### 5. Blocked State Handling
    - If Atlas cannot resolve issues after 3 attempts:
      - Add `blocked` label to PR
      - Post detailed comment explaining blockers
      - Tag PR author for human intervention
      - Suspend Atlas session until new activity
