---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: rex-remediation
  namespace: argo
spec:
  template:
    serviceAccountName: argo-events-sa
  dependencies:
    - name: rex-push-event
      eventSourceName: github
      eventName: org
      filters:
        data:
        # Filter for push events
        - path: headers.X-Github-Event
          type: string
          value: ["push"]
        # Verify push is from Rex
        - path: body.sender.login
          type: string
          value: ["5DLabs-Rex[bot]", "5DLabs-Rex"]
  triggers:
    # Trigger 1: Cancel running Cleo/Tess CodeRun CRDs
    - template:
        name: cancel-running-agents
        conditions: "rex-push-event"
        k8s:
          operation: delete
          source:
            resource:
              apiVersion: agents.platform/v1
              kind: CodeRun
              metadata:
                namespace: argo
          parameters:
            # Extract task ID from branch name (if it matches pattern)
            - src:
                dependencyName: rex-push-event
                dataTemplate: |
                  {{ $ref := .Input.body.ref }}
                  {{ if hasPrefix $ref "refs/heads/task-" }}
                    {{ $branch := trimPrefix "refs/heads/task-" $ref }}
                    {{ $parts := splitList "-" $branch }}
                    {{ if gt (len $parts) 0 }}
                      {{ index $parts 0 }}
                    {{ end }}
                  {{ else }}
                    0
                  {{ end }}
              dest: taskId
          # Delete CodeRuns for Cleo and Tess working on this task
          # Only if taskId is not 0 (meaning branch matched pattern)
          labelSelector:
            matchExpressions:
            - key: task-id
              operator: In
              values: ["{{taskId}}"]
            - key: github-app
              operator: NotIn
              values: ["5DLabs-Rex"]
      retryStrategy:
        steps: 3
        duration: "5s"
        factor: 2
        jitter: 0.1