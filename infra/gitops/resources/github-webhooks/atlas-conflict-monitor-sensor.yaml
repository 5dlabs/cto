---
# Atlas Conflict Monitor Sensor
# Ensures Atlas guardian sessions stay active when GitHub reports merge conflicts
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: atlas-conflict-monitor
  namespace: automation
  labels:
    task: "7"
    type: stage-management
    component: atlas-guardian
spec:
  template:
    serviceAccountName: argo-events-sa
  dependencies:
    - name: atlas-conflict-event
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.repository.full_name
            type: string
            value:
              - "5dlabs/cto"
          - path: body.X-GitHub-Event
            type: string
            value: ["pull_request"]
          - path: body.action
            type: string
            value:
              - opened
              - reopened
              - synchronize
              - ready_for_review
  triggers:
    - template:
        name: atlas-conflict-monitor
        conditions: "atlas-conflict-event"
        parameters:
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.pull_request.number
            dest: spec.arguments.parameters.0.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.pull_request.html_url
            dest: spec.arguments.parameters.1.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.repository.owner.login
            dest: spec.arguments.parameters.2.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.repository.name
            dest: spec.arguments.parameters.3.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.repository.clone_url
            dest: spec.arguments.parameters.4.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.pull_request.head.ref
            dest: spec.arguments.parameters.5.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.pull_request.title
            dest: spec.arguments.parameters.6.value
          - src:
              dependencyName: atlas-conflict-event
              dataTemplate: "{{ .Input.body.pull_request.labels | toJson }}"
            dest: spec.arguments.parameters.7.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.action
            dest: spec.arguments.parameters.8.value
          - src:
              dependencyName: atlas-conflict-event
              dataKey: body.sender.login
            dest: spec.arguments.parameters.9.value
          - src:
              dependencyName: atlas-conflict-event
              dataTemplate: "{{ .Input.body.pull_request.mergeable }}"
            dest: spec.arguments.parameters.10.value
          - src:
              dependencyName: atlas-conflict-event
              dataTemplate: "{{ .Input.body.pull_request.mergeable_state }}"
            dest: spec.arguments.parameters.11.value
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: atlas-conflict-monitor-
                namespace: cto
                labels:
                  type: atlas-guardian
                  trigger: conflict
              spec:
                entrypoint: ensure-conflict-guardian
                serviceAccountName: argo-workflow
                ttlStrategy:
                  secondsAfterCompletion: 300
                  secondsAfterFailure: 7200   # Keep failed workflows for 2 hours to allow log capture
                podGC:
                  strategy: OnPodCompletion
                  deleteDelayDuration: 60s    # Delay pod deletion to allow heal to capture logs
                arguments:
                  parameters:
                    - name: pr-number
                      value: ""
                    - name: pr-url
                      value: ""
                    - name: repo-owner
                      value: ""
                    - name: repo-name
                      value: ""
                    - name: repo-clone-url
                      value: ""
                    - name: pr-branch
                      value: ""
                    - name: pr-title
                      value: ""
                    - name: pr-labels
                      value: "[]"
                    - name: action
                      value: ""
                    - name: sender-login
                      value: ""
                    - name: mergeable
                      value: ""
                    - name: mergeable-state
                      value: ""
                templates:
                  - name: ensure-conflict-guardian
                    script:
                      image: alpine/k8s:1.31.0
                      command: [bash]
                      source: |-
                        #!/bin/bash
                        set -euo pipefail

                        ensure_jq() {
                          if command -v jq >/dev/null 2>&1; then
                            return 0
                          fi
                          if command -v apk >/dev/null 2>&1; then
                            apk add --no-cache jq >/dev/null 2>&1 && return 0
                          fi
                          echo "Failed to install jq"
                          return 1
                        }

                        ensure_jq

                        # Extract workflow parameters (populated by Argo Events sensor)
                        PR_NUMBER='{{workflow.parameters.pr-number}}'
                        PR_URL='{{workflow.parameters.pr-url}}'
                        REPO_OWNER='{{workflow.parameters.repo-owner}}'
                        REPO_NAME='{{workflow.parameters.repo-name}}'
                        REPO_URL='{{workflow.parameters.repo-clone-url}}'
                        PR_BRANCH='{{workflow.parameters.pr-branch}}'
                        PR_TITLE='{{workflow.parameters.pr-title}}'
                        PR_LABELS_JSON='{{workflow.parameters.pr-labels}}'
                        ACTION='{{workflow.parameters.action}}'
                        SENDER_LOGIN='{{workflow.parameters.sender-login}}'
                        MERGEABLE='{{workflow.parameters.mergeable}}'
                        MERGE_STATE='{{workflow.parameters.mergeable-state}}'

                        # Validate required parameters are present
                        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ] || [ "$PR_NUMBER" = "" ]; then
                          echo "ERROR: PR number not provided - parameters not interpolated correctly"
                          exit 1
                        fi

                        if [ "$SENDER_LOGIN" = "atlas-5dlabs" ] || [ "$SENDER_LOGIN" = "atlas-5dlabs[bot]" ]; then
                          echo "Event emitted by Atlas, skipping to avoid loops"
                          exit 0
                        fi

                        # Check conflict status - only skip if explicitly mergeable AND clean
                        NORMALIZED_STATE=$(echo "${MERGE_STATE:-}" | tr '[:upper:]' '[:lower:]')

                        echo "PR #$PR_NUMBER status: mergeable=${MERGEABLE:-null}, state=${NORMALIZED_STATE:-null}"

                        # Only skip if we're CERTAIN there are no conflicts
                        if [ "$MERGEABLE" = "true" ] && [ "$NORMALIZED_STATE" != "dirty" ] && \
                           [ "$NORMALIZED_STATE" != "unstable" ] && [ "$NORMALIZED_STATE" != "behind" ]; then
                          echo "PR is mergeable and clean, no conflict handling required"
                          exit 0
                        fi

                        # If mergeable is null/false OR state is dirty/unstable, proceed
                        if [ "$MERGEABLE" = "null" ] || [ -z "$MERGEABLE" ]; then
                          echo "Mergeable status is null - will create guardian to monitor"
                        elif [ "$MERGEABLE" = "false" ]; then
                          echo "PR has merge conflicts detected"
                        fi

                        REPO_FULL="${REPO_OWNER}/${REPO_NAME}"
                        REPO_LABEL=$(echo "$REPO_FULL" | tr '/' '-')

                        extract_task_id() {
                          echo "$1" | tr '[:upper:]' '[:lower:]' \
                            | grep -oE 'task[-_/ ]*([0-9]+)' | head -n1 \
                            | grep -oE '[0-9]+' || true
                        }

                        TASK_ID=""
                        if [ "$PR_LABELS_JSON" != "null" ] && [ -n "$PR_LABELS_JSON" ]; then
                          TASK_ID=$(echo "$PR_LABELS_JSON" | jq -er '.[]? | (.name // "") | ascii_downcase
                            | select(test("task-[0-9]+"))
                            | capture("task-(?<id>[0-9]+)") | .id' 2>/dev/null | head -n1 || true)
                        fi

                        if [ -z "$TASK_ID" ] && [ -n "$PR_BRANCH" ] && [ "$PR_BRANCH" != "null" ]; then
                          TASK_ID=$(extract_task_id "$PR_BRANCH")
                        fi

                        if [ -z "$TASK_ID" ] && [ -n "$PR_TITLE" ] && [ "$PR_TITLE" != "null" ]; then
                          TASK_ID=$(extract_task_id "$PR_TITLE")
                        fi

                        if [ -z "$TASK_ID" ]; then
                          TASK_ID="0"
                        fi

                        LOCK_NAME="atlas-guardian-lock-$PR_NUMBER"
                        if kubectl create configmap "$LOCK_NAME" \
                          --from-literal=pr-number="$PR_NUMBER" \
                          --from-literal=created-at="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                          --from-literal=workflow="{{workflow.name}}" \
                          -n cto \
                          -o yaml --dry-run=client | kubectl create -f - 2>/dev/null; then
                          echo "Acquired lock $LOCK_NAME"
                          trap "kubectl delete configmap $LOCK_NAME -n cto --ignore-not-found=true >/dev/null 2>&1 || true" EXIT
                        else
                          echo "Lock already held for PR #$PR_NUMBER, another workflow is handling conflicts"
                          exit 0
                        fi

                        EXISTING=$(kubectl get coderuns -n cto \
                          -l agent=atlas,role=guardian,pr-number="$PR_NUMBER" \
                          -o json 2>/dev/null || echo '{"items":[]}')

                        ACTIVE=$(echo "$EXISTING" | jq -r '.items[]? | select(
                          (.status.phase == "Running") or
                          (.status.phase == "Pending") or
                          (.status == null)
                        ) | .metadata.name' | head -n1)

                        if [ -n "$ACTIVE" ]; then
                          echo "Guardian already active ($ACTIVE); conflict will be handled there"
                          exit 0
                        fi

                        cat <<EOF_MANIFEST | sed 's/^ \{24\}//' | kubectl create -f - >/tmp/atlas-guardian.log 2>&1 || true
                        apiVersion: agents.platform/v1
                        kind: CodeRun
                        metadata:
                          generateName: coderun-atlas-guardian-
                          namespace: cto
                          labels:
                            agent: atlas
                            role: guardian
                            pr-number: "$PR_NUMBER"
                            repository: "$REPO_LABEL"
                        spec:
                          taskId: $TASK_ID
                          service: "atlas"
                          githubApp: "5DLabs-Atlas"
                          model: "claude-sonnet-4-5-20250929"
                          repositoryUrl: "$REPO_URL"
                          docsRepositoryUrl: "$REPO_URL"
                          docsProjectDirectory: "docs"
                          workingDirectory: "."
                          continueSession: true
                          overwriteMemory: false
                          env:
                            PR_NUMBER: "$PR_NUMBER"
                            PR_URL: "$PR_URL"
                            PR_BRANCH: "$PR_BRANCH"
                            REPOSITORY_OWNER: "$REPO_OWNER"
                            REPOSITORY_NAME: "$REPO_NAME"
                            REPOSITORY_SLUG: "$REPO_FULL"
                            TASK_ID: "$TASK_ID"
                            ATLAS_MODE: "guardian"
                            ATLAS_POLL_INTERVAL: "45"
                            ATLAS_MAX_CYCLES: "120"
                            TRIGGER_ACTION: "conflict-detected"
                            CONFLICT_SOURCE: "$NORMALIZED_STATE"
                        EOF_MANIFEST

                        if grep -qi "created" /tmp/atlas-guardian.log; then
                          echo "Started Atlas guardian for conflicted PR #$PR_NUMBER"
                          cat /tmp/atlas-guardian.log
                        else
                          echo "Unable to confirm CodeRun creation"
                          cat /tmp/atlas-guardian.log
                          exit 1
                        fi
      retryStrategy:
        steps: 3
        duration: "10s"
        factor: 2
