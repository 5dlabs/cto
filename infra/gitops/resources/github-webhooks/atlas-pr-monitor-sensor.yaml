---
# Atlas PR Monitor Sensor
# Creates or resumes Atlas guardian CodeRuns whenever PR lifecycle events occur
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: atlas-pr-monitor
  namespace: argo
  labels:
    task: "7"
    type: stage-management
    component: atlas-guardian
spec:
  template:
    serviceAccountName: argo-events-sa
  dependencies:
    - name: atlas-pr-event
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.repository.full_name
            type: string
            value:
              - "5dlabs/cto"
          - path: body.X-GitHub-Event
            type: string
            value: ["pull_request"]
          - path: body.action
            type: string
            value:
              - opened
              - reopened
              - ready_for_review
              - synchronize
  triggers:
    - template:
        name: atlas-guardian-launcher
        conditions: "atlas-pr-event"
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: atlas-guardian-
                namespace: agent-platform
                labels:
                  type: atlas-guardian
              spec:
                entrypoint: atlas-pr-monitor
                serviceAccountName: argo-workflow
                ttlStrategy:
                  secondsAfterCompletion: 300
                  secondsAfterFailure: 3600
                podGC:
                  strategy: OnPodCompletion
                templates:
                  - name: atlas-pr-monitor
                    script:
                      image: alpine/k8s:1.31.0
                      command: [bash]
                      source: |-
                        #!/bin/bash
                        set -euo pipefail

                        ensure_jq() {
                          if command -v jq >/dev/null 2>&1; then
                            return 0
                          fi

                          if command -v apk >/dev/null 2>&1; then
                            apk add --no-cache jq >/dev/null 2>&1 && return 0
                          elif command -v apt-get >/dev/null 2>&1; then
                            apt-get update >/dev/null 2>&1 && apt-get install -y jq >/dev/null 2>&1 && rm -rf /var/lib/apt/lists/* && return 0
                          elif command -v microdnf >/dev/null 2>&1; then
                            microdnf -y install jq >/dev/null 2>&1 && return 0
                          fi

                          echo "‚ùå Failed to install jq"
                          return 1
                        }

                        ensure_jq

                        PR_NUMBER='{{ .Input.body.pull_request.number }}'
                        PR_URL='{{ .Input.body.pull_request.html_url }}'
                        REPO_OWNER='{{ .Input.body.repository.owner.login }}'
                        REPO_NAME='{{ .Input.body.repository.name }}'
                        REPO_URL='{{ .Input.body.repository.clone_url }}'
                        PR_BRANCH='{{ .Input.body.pull_request.head.ref }}'
                        PR_TITLE='{{ .Input.body.pull_request.title }}'
                        PR_LABELS_JSON='{{ .Input.body.pull_request.labels | toJson }}'
                        ACTION='{{ .Input.body.action }}'
                        SENDER_LOGIN='{{ .Input.body.sender.login }}'

                        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
                          echo "‚ÑπÔ∏è No PR number in payload, skipping"
                          exit 0
                        fi

                        if [ "$SENDER_LOGIN" = "atlas-5dlabs" ] || [ "$SENDER_LOGIN" = "atlas-5dlabs[bot]" ]; then
                          echo "‚ÑπÔ∏è Event emitted by Atlas itself, skipping to avoid loops"
                          exit 0
                        fi

                        REPO_FULL="${REPO_OWNER}/${REPO_NAME}"
                        REPO_LABEL=$(echo "$REPO_FULL" | tr '/' '-')

                        extract_task_id() {
                          echo "$1" | tr '[:upper:]' '[:lower:]' \
                            | grep -oE 'task[-_/ ]*([0-9]+)' | head -n1 \
                            | grep -oE '[0-9]+' || true
                        }

                        TASK_ID=""
                        if [ "$PR_LABELS_JSON" != "null" ] && [ -n "$PR_LABELS_JSON" ]; then
                          TASK_ID=$(echo "$PR_LABELS_JSON" | jq -er '.[]? | (.name // "") | ascii_downcase
                            | select(test("task-[0-9]+"))
                            | capture("task-(?<id>[0-9]+)") | .id' 2>/dev/null | head -n1 || true)
                        fi

                        if [ -z "$TASK_ID" ] && [ -n "$PR_BRANCH" ] && [ "$PR_BRANCH" != "null" ]; then
                          TASK_ID=$(extract_task_id "$PR_BRANCH")
                        fi

                        if [ -z "$TASK_ID" ] && [ -n "$PR_TITLE" ] && [ "$PR_TITLE" != "null" ]; then
                          TASK_ID=$(extract_task_id "$PR_TITLE")
                        fi

                        if [ -z "$TASK_ID" ]; then
                          TASK_ID="0"
                        fi

                        echo "=== Atlas PR Monitor ==="
                        echo "PR #$PR_NUMBER ($ACTION) | Repo: $REPO_FULL | Task: $TASK_ID"

                        LOCK_NAME="atlas-guardian-lock-$PR_NUMBER"
                        if kubectl create configmap "$LOCK_NAME" \
                          --from-literal=pr-number="$PR_NUMBER" \
                          --from-literal=created-at="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                          --from-literal=workflow="{{workflow.name}}" \
                          -n agent-platform \
                          -o yaml --dry-run=client | kubectl create -f - 2>/dev/null; then
                          echo "‚úÖ Acquired lock $LOCK_NAME"
                          trap "kubectl delete configmap $LOCK_NAME -n agent-platform --ignore-not-found=true >/dev/null 2>&1 || true" EXIT
                        else
                          echo "üîí Lock already held for PR #$PR_NUMBER, skipping duplicate"
                          exit 0
                        fi

                        EXISTING=$(kubectl get coderuns -n agent-platform \
                          -l agent=atlas,role=guardian,pr-number="$PR_NUMBER" \
                          -o json 2>/dev/null || echo '{"items":[]}')

                        ACTIVE=$(echo "$EXISTING" | jq -r '.items[]? | select(
                          (.status.phase == "Running") or
                          (.status.phase == "Pending") or
                          (.status == null)
                        ) | .metadata.name' | head -n1)

                        if [ -n "$ACTIVE" ]; then
                          echo "‚ÑπÔ∏è Guardian already active ($ACTIVE), nothing to do"
                          exit 0
                        fi

                        TASK_LABEL_VALUE=""
                        if [ "$TASK_ID" != "0" ]; then
                          TASK_LABEL_VALUE="                        "
                          TASK_LABEL_VALUE="${TASK_LABEL_VALUE}    task-id: \"$TASK_ID\""
                        fi

                        cat <<EOF | sed 's/^                        //' | kubectl create -f - >/tmp/atlas-guardian.log 2>&1 || true
                        apiVersion: agents.platform/v1
                        kind: CodeRun
                        metadata:
                          generateName: coderun-atlas-guardian-
                          namespace: agent-platform
                          labels:
                            agent: atlas
                            role: guardian
                            pr-number: "$PR_NUMBER"
                            repository: "$REPO_LABEL"
                        ${TASK_LABEL_VALUE}
                        spec:
                          taskId: "$TASK_ID"
                          service: "atlas"
                          githubApp: "5DLabs-Atlas"
                          model: "claude-sonnet-4-5-20250929"
                          repositoryUrl: "$REPO_URL"
                          docsRepositoryUrl: "$REPO_URL"
                          docsProjectDirectory: "docs"
                          workingDirectory: "."
                          continueSession: true
                          overwriteMemory: false
                          env:
                            - name: PR_NUMBER
                              value: "$PR_NUMBER"
                            - name: PR_URL
                              value: "$PR_URL"
                            - name: PR_BRANCH
                              value: "$PR_BRANCH"
                            - name: REPOSITORY_OWNER
                              value: "$REPO_OWNER"
                            - name: REPOSITORY_NAME
                              value: "$REPO_NAME"
                            - name: REPOSITORY_SLUG
                              value: "$REPO_FULL"
                            - name: TASK_ID
                              value: "$TASK_ID"
                            - name: ATLAS_MODE
                              value: "guardian"
                            - name: ATLAS_POLL_INTERVAL
                              value: "60"
                            - name: ATLAS_MAX_CYCLES
                              value: "0"
                            - name: TRIGGER_ACTION
                              value: "$ACTION"
                        EOF

                        if grep -qi "created" /tmp/atlas-guardian.log; then
                          echo "‚úÖ Created new Atlas guardian for PR #$PR_NUMBER"
                          cat /tmp/atlas-guardian.log
                        else
                          echo "‚ö†Ô∏è Unable to confirm CodeRun creation"
                          cat /tmp/atlas-guardian.log
                          exit 1
                        fi
      retryStrategy:
        steps: 3
        duration: "10s"
        factor: 2

