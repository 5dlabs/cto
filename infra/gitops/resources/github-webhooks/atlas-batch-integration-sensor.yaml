---
# Atlas Batch / Final Integration Sensor
# Triggers Atlas integration checks when workflow comments announce batch or play completion
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: atlas-batch-integration
  namespace: argo
  labels:
    task: "7"
    type: stage-management
    component: atlas-integration
spec:
  template:
    serviceAccountName: argo-events-sa
  dependencies:
    - name: atlas-batch-event
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.repository.full_name
            type: string
            value:
              - "5dlabs/cto"
          - path: body.X-GitHub-Event
            type: string
            value: ["issue_comment"]
          - path: body.action
            type: string
            value: ["created"]
  triggers:
    - template:
        name: atlas-batch-integration
        conditions: "atlas-batch-event"
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: atlas-batch-integration-
                namespace: agent-platform
                labels:
                  type: atlas-integration
                  trigger: batch
              spec:
                entrypoint: launch-batch-integration
                serviceAccountName: argo-workflow
                ttlStrategy:
                  secondsAfterCompletion: 300
                  secondsAfterFailure: 3600
                podGC:
                  strategy: OnPodCompletion
                templates:
                  - name: launch-batch-integration
                    script:
                      image: alpine/k8s:1.31.0
                      command: [bash]
                      source: |-
                        #!/bin/bash
                        set -euo pipefail

                        ensure_jq() {
                          if command -v jq >/dev/null 2>&1; then
                            return 0
                          fi

                          if command -v apk >/dev/null 2>&1; then
                            apk add --no-cache jq >/dev/null 2>&1 && return 0
                          elif command -v apt-get >/dev/null 2>&1; then
                            apt-get update >/dev/null 2>&1 && apt-get install -y jq >/dev/null 2>&1 && rm -rf /var/lib/apt/lists/* && return 0
                          elif command -v microdnf >/dev/null 2>&1; then
                            microdnf -y install jq >/dev/null 2>&1 && return 0
                          fi

                          echo "‚ùå Failed to install jq"
                          return 1
                        }

                        ensure_jq

                        PR_NUMBER='{{ .Input.body.issue.number }}'
                        PR_URL='{{ .Input.body.issue.pull_request.html_url | default "" }}'
                        REPO_OWNER='{{ .Input.body.repository.owner.login }}'
                        REPO_NAME='{{ .Input.body.repository.name }}'
                        REPO_URL='{{ .Input.body.repository.clone_url }}'
                        COMMENT_BODY='{{ .Input.body.comment.body | default "" }}'
                        COMMENT_AUTHOR='{{ .Input.body.comment.user.login }}'

                        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
                          echo "‚ÑπÔ∏è Comment not tied to a PR, skipping"
                          exit 0
                        fi

                        if [ "$COMMENT_AUTHOR" = "atlas-5dlabs" ] || [ "$COMMENT_AUTHOR" = "atlas-5dlabs[bot]" ]; then
                          echo "‚ÑπÔ∏è Atlas emitted this comment, skipping"
                          exit 0
                        fi

                        NORMALIZED_COMMENT=$(echo "$COMMENT_BODY" | tr '[:upper:]' '[:lower:]')
                        if ! echo "$NORMALIZED_COMMENT" | grep -q "batch" && ! echo "$NORMALIZED_COMMENT" | grep -q "play workflow complete"; then
                          echo "‚ÑπÔ∏è Not an integration trigger comment, skipping"
                          exit 0
                        fi

                        BATCH_NUMBER=$(echo "$COMMENT_BODY" | grep -oE "Batch[[:space:]]+([0-9]+)" | grep -oE "[0-9]+" | head -n1 || true)
                        if [ -n "$BATCH_NUMBER" ]; then
                          INTEGRATION_TYPE="batch"
                        else
                          INTEGRATION_TYPE="final"
                          BATCH_NUMBER="0"
                        fi

                        REPO_FULL="${REPO_OWNER}/${REPO_NAME}"
                        REPO_LABEL=$(echo "$REPO_FULL" | tr '/' '-')

                        LOCK_NAME="atlas-integration-lock-${PR_NUMBER}-${BATCH_NUMBER}"
                        if kubectl create configmap "$LOCK_NAME" \
                          --from-literal=pr-number="$PR_NUMBER" \
                          --from-literal=batch="$BATCH_NUMBER" \
                          --from-literal=created-at="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                          --from-literal=workflow="{{workflow.name}}" \
                          -n agent-platform \
                          -o yaml --dry-run=client | kubectl create -f - 2>/dev/null; then
                          echo "‚úÖ Lock $LOCK_NAME acquired"
                          trap "kubectl delete configmap $LOCK_NAME -n agent-platform --ignore-not-found=true >/dev/null 2>&1 || true" EXIT
                        else
                          echo "üîí Lock $LOCK_NAME already held, skipping duplicate integration trigger"
                          exit 0
                        fi

                        cat <<EOF_INTEGRATION | sed 's/^ \{24\}//' | kubectl create -f - >/tmp/atlas-integration.log 2>&1 || true
                        apiVersion: agents.platform/v1
                        kind: CodeRun
                        metadata:
                          generateName: coderun-atlas-integration-
                          namespace: agent-platform
                          labels:
                            agent: atlas
                            role: integration
                            pr-number: "$PR_NUMBER"
                            repository: "$REPO_LABEL"
                            trigger: "$INTEGRATION_TYPE"
                        spec:
                          taskId: 0
                          service: "atlas"
                          githubApp: "5DLabs-Atlas"
                          model: "claude-sonnet-4-5-20250929"
                          repositoryUrl: "$REPO_URL"
                          docsRepositoryUrl: "$REPO_URL"
                          docsProjectDirectory: "docs"
                          workingDirectory: "."
                          continueSession: false
                          overwriteMemory: false
                          env:
                            PR_NUMBER: "$PR_NUMBER"
                            PR_URL: "$PR_URL"
                            REPOSITORY_OWNER: "$REPO_OWNER"
                            REPOSITORY_NAME: "$REPO_NAME"
                            REPOSITORY_SLUG: "$REPO_FULL"
                            INTEGRATION_TYPE: "$INTEGRATION_TYPE"
                            BATCH_NUMBER: "$BATCH_NUMBER"
                            ATLAS_MODE: "integration-gate"
                            ATLAS_POLL_INTERVAL: "30"
                            ATLAS_MAX_CYCLES: "240"
                            TRIGGER_COMMENT: "$COMMENT_BODY"
                        EOF_INTEGRATION

                        if grep -qi "created" /tmp/atlas-integration.log; then
                          echo "‚úÖ Atlas integration CodeRun created for PR #$PR_NUMBER (batch: $BATCH_NUMBER)"
                          cat /tmp/atlas-integration.log
                        else
                          echo "‚ö†Ô∏è Unable to confirm Atlas integration launch"
                          cat /tmp/atlas-integration.log
                          exit 1
                        fi
      retryStrategy:
        steps: 3
        duration: "10s"
        factor: 2

