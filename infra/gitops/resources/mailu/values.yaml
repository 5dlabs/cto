---
# Mailu Configuration for 5dlabs.ai
# Basic configuration to get email server running

# Domain configuration
domain: mail.5dlabs.ai
hostnames:
  - mail.5dlabs.ai
  - smtp.5dlabs.ai
  - imap.5dlabs.ai

# Initial admin configuration
initialAccount:
  enabled: true
  domain: 5dlabs.ai
  username: admin
  password: "ChangeMe123!"  # TODO: Move to sealed secret

# Database configuration (using our PostgreSQL cluster)
database:
  type: postgresql
  host: mailu-postgres.mailu.svc.cluster.local
  port: 5432
  name: mailu
  user: mailu
  # Password will be retrieved from the postgres secret
  existingSecret: mailu.mailu-postgres.credentials.postgresql.acid.zalan.do
  existingSecretPasswordKey: password

# Subnet configuration for Kubernetes
subnet: 10.42.0.0/16  # Adjust to your cluster CIDR

# Mail settings
messageSizeLimitMb: 50
authRatelimit:
  ip: "60/hour"
  user: "100/hour"

# TLS configuration
tls:
  enabled: true
  certmanager:
    enabled: true
    issuerName: letsencrypt-prod
    issuerKind: ClusterIssuer

# Component configuration
front:
  enabled: true
  replicaCount: 1  # Start with 1, scale later
  resources:
    requests:
      memory: "100Mi"
      cpu: "100m"
    limits:
      memory: "200Mi"
      cpu: "200m"
  service:
    type: LoadBalancer
    annotations:
      external-dns.alpha.kubernetes.io/hostname: "mail.5dlabs.ai"
      # Disable Cloudflare proxy for mail services
      external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"

admin:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

postfix:
  enabled: true
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

dovecot:
  enabled: true
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

rspamd:
  enabled: true
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# Disable ClamAV initially to save resources
clamav:
  enabled: false

roundcube:
  enabled: true
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"

redis:
  enabled: true
  persistence:
    enabled: true
    size: 1Gi
    storageClass: local-path

# Storage configuration
persistence:
  enabled: true
  storageClass: local-path
  size:
    data: 10Gi
    mail: 20Gi

# Ingress for webmail
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    external-dns.alpha.kubernetes.io/hostname: "webmail.5dlabs.ai"
    external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
  hosts:
    - host: webmail.5dlabs.ai
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: webmail-tls
      hosts:
        - webmail.5dlabs.ai

# Security settings
securityContext:
  runAsNonRoot: false  # Mailu requires root for some components
  fsGroup: 1000

# Network policies
networkPolicy:
  enabled: true
