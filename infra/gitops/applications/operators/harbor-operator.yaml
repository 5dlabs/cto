---
# Harbor Operator - Cloud-native container registry for Kubernetes
# Provides container registry with vulnerability scanning and content trust
# License: Apache 2.0 (safe for proprietary distribution)
# Source: https://github.com/goharbor/harbor-helm (for direct Harbor deployment)
# Note: The official goharbor/harbor-operator is deprecated, using direct Helm chart
# Docs: https://goharbor.io/docs/

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: harbor
  namespace: argocd
  labels:
    app.kubernetes.io/name: harbor
    app.kubernetes.io/part-of: platform
    app.kubernetes.io/component: registry
  annotations:
    # Deploy after storage and cert-manager are ready
    argocd.argoproj.io/sync-wave: "2"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  source:
    repoURL: https://helm.goharbor.io
    chart: harbor
    targetRevision: 1.16.0
    helm:
      values: |
        # Expose settings
        expose:
          type: clusterIP
          tls:
            # Use auto-generated self-signed certificates
            enabled: true
            certSource: auto
            auto:
              # Duration for the auto-generated cert
              commonName: "harbor.local"
          clusterIP:
            name: harbor
            annotations: {}
            ports:
              httpPort: 80
              httpsPort: 443

        # External URL for Harbor (internal ClusterIP access)
        externalURL: https://harbor.harbor.svc.cluster.local

        # Persistence settings
        persistence:
          enabled: true
          resourcePolicy: "keep"
          persistentVolumeClaim:
            registry:
              storageClass: "mayastor-single-replica"
              accessMode: ReadWriteOnce
              size: 50Gi
            jobservice:
              jobLog:
                storageClass: "mayastor-single-replica"
                accessMode: ReadWriteOnce
                size: 1Gi
            database:
              storageClass: "mayastor-single-replica"
              accessMode: ReadWriteOnce
              size: 10Gi
            redis:
              storageClass: "mayastor-single-replica"
              accessMode: ReadWriteOnce
              size: 1Gi
            trivy:
              storageClass: "mayastor-single-replica"
              accessMode: ReadWriteOnce
              size: 5Gi

        # Use internal database (can be configured for external PostgreSQL)
        database:
          type: internal
          internal:
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 1Gi
            podLabels:
              platform.5dlabs.io/log-collection: enabled

        # Use internal Redis (can be configured for external Redis/Valkey)
        redis:
          type: internal
          internal:
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 256Mi
            podLabels:
              platform.5dlabs.io/log-collection: enabled

        # Core component
        core:
          replicas: 1
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          podLabels:
            platform.5dlabs.io/log-collection: enabled
          podAnnotations:
            logs.platform.5dlabs.io/collect: "true"
            logs.platform.5dlabs.io/service: harbor-core

        # Job service
        jobservice:
          replicas: 1
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          podLabels:
            platform.5dlabs.io/log-collection: enabled

        # Registry
        registry:
          replicas: 1
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 1Gi
          podLabels:
            platform.5dlabs.io/log-collection: enabled

        # Portal (web UI)
        portal:
          replicas: 1
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 256Mi
          podLabels:
            platform.5dlabs.io/log-collection: enabled

        # Trivy vulnerability scanner
        trivy:
          enabled: true
          replicas: 1
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi
          podLabels:
            platform.5dlabs.io/log-collection: enabled

        # Notary (content trust) - disabled by default
        notary:
          enabled: false

        # Metrics
        metrics:
          enabled: true
          core:
            path: /metrics
            port: 8001
          registry:
            path: /metrics
            port: 8001

        # Update strategy
        updateStrategy:
          type: RollingUpdate

  destination:
    server: https://kubernetes.default.svc
    namespace: harbor

  ignoreDifferences:
    # Secrets are managed externally or auto-generated
    - group: ""
      kind: Secret
      jsonPointers:
        - /data

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false

    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground
      - RespectIgnoreDifferences=true

    retry:
      limit: 5
      backoff:
        duration: 30s
        factor: 2
        maxDuration: 5m

  revisionHistoryLimit: 5
