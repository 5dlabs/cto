---
# Mayastor - OpenEBS NVMe-optimized distributed storage for bare metal
# Provides high-performance persistent storage using NVMe drives
# License: Apache 2.0
# Source: https://github.com/openebs/mayastor
# Docs: https://mayastor.gitbook.io/

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mayastor
  namespace: argocd
  labels:
    app.kubernetes.io/name: mayastor
    app.kubernetes.io/part-of: platform
    app.kubernetes.io/component: storage
  annotations:
    # Deploy very early - storage is required by many workloads
    argocd.argoproj.io/sync-wave: "-10"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  source:
    repoURL: https://openebs.github.io/mayastor-extensions
    chart: mayastor
    targetRevision: 2.10.0
    helm:
      values: |
        # Mayastor configuration for Talos bare metal clusters

        # etcd for Mayastor control plane
        etcd:
          persistence:
            # Use local-path for etcd (bootstrap storage)
            storageClass: local-path
            size: 2Gi
          replicaCount: 1
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          # Fix deprecated bitnami-shell image (moved to bitnami/os-shell)
          volumePermissions:
            enabled: true
            image:
              registry: docker.io
              repository: bitnami/os-shell
              tag: latest

        # Disable bundled monitoring (we use our own observability stack)
        loki-stack:
          enabled: false

        # Disable bundled Loki entirely (we have our own observability)
        loki:
          enabled: false

        # HOME LAB ONLY: Reduce NATS replicas for 2-worker setup
        # For provider environments with 3+ workers, set cluster.replicas: 3
        nats:
          cluster:
            replicas: 2

        # HOME LAB ONLY: Reduce MinIO replicas for 2-worker setup
        # For provider environments with 3+ workers, set replicas: 3
        minio:
          replicas: 2

        obs:
          callhome:
            enabled: false

        # Disable built-in StorageClass (we define our own 'mayastor' class)
        storageClass:
          enabled: false

        # Disable localpv-provisioner (we use rancher local-path for etcd)
        localpv-provisioner:
          enabled: false

        # Mayastor CSI driver
        csi:
          node:
            # Tolerations for running on all nodes
            tolerations:
              - operator: Exists
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi
          controller:
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi

        # Mayastor data plane (io-engine)
        io_engine:
          # Resource limits for NVMe operations
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
              hugepages-2Mi: 2Gi
            limits:
              cpu: 2000m
              memory: 2Gi
              hugepages-2Mi: 2Gi
          # DPDK environment - use PA mode to avoid IOVA allocation issues on certain hardware
          envcontext: iova-mode=pa
          # Tolerations
          tolerations:
            - operator: Exists

        # Mayastor control plane
        agents:
          core:
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi

        # REST API
        apis:
          rest:
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 256Mi

        # Operator
        operator:
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 256Mi

  destination:
    server: https://kubernetes.default.svc
    namespace: mayastor

  ignoreDifferences:
    # CRD annotations are managed by the operator
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /metadata/annotations
    # StatefulSet volumeClaimTemplates get apiVersion/kind added by K8s
    - group: apps
      kind: StatefulSet
      name: mayastor-etcd
      jqPathExpressions:
        - .spec.volumeClaimTemplates[].apiVersion
        - .spec.volumeClaimTemplates[].kind
    # etcd JWT token is generated and changes between syncs
    - kind: Secret
      name: mayastor-etcd-jwt-token
      jsonPointers:
        - /data

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false

    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground
      - RespectIgnoreDifferences=true

    retry:
      limit: 5
      backoff:
        duration: 30s
        factor: 2
        maxDuration: 5m

  revisionHistoryLimit: 5
