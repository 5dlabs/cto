---
# Argo CD Application for Alertmanager
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: alertmanager
  namespace: argocd
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/part-of: platform
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 1.29.0
    chart: alertmanager
    helm:
      values: |
        # Alertmanager configuration
        replicaCount: 1

        # Persistence
        # NOTE: Use empty string to rely on default storage class (mayastor).
        # Explicit storageClass causes StatefulSet immutable field errors since
        # the existing StatefulSet was created with an empty storageClass.
        persistence:
          enabled: true
          storageClass: ""  # Uses default storage class (mayastor)
          size: 2Gi

        # Resource allocation
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi

        # Pod labels/annotations for log collection
        podLabels:
          platform.5dlabs.io/log-collection: enabled
        podAnnotations:
          logs.platform.5dlabs.io/collect: "true"
          logs.platform.5dlabs.io/service: alertmanager

        # Pod security context (pod-level, not container-level)
        podSecurityContext:
          fsGroup: 65534

        # Container security context
        securityContext:
          runAsUser: 65534
          runAsGroup: 65534
          runAsNonRoot: true

        # Inject Discord webhook URL as environment variable
        extraEnvFrom:
          - secretRef:
              name: alertmanager-discord-secret

        # Extra secret mounts for Discord webhook URL
        # Mount at /secrets/discord to avoid conflict with ConfigMap at /etc/alertmanager
        extraSecretMounts:
          - name: discord-webhook
            secretName: alertmanager-discord-secret
            mountPath: /secrets/discord
            readOnly: true

        # Alertmanager configuration
        # Uses native Discord integration (no sidecar needed)
        # Note: webhook_url_file reads the URL from a file at runtime
        config:
          global:
            resolve_timeout: 5m
          route:
            group_by: ['alertname', 'severity', 'service']
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 4h
            receiver: 'discord-default'
            routes:
              # Critical alerts - immediate notification
              - matchers:
                  - severity="critical"
                receiver: 'discord-critical'
                group_wait: 10s
                continue: true
              # Warning alerts
              - matchers:
                  - severity="warning"
                receiver: 'discord-warning'
                continue: true
              # Webhook/external monitoring alerts
              - matchers:
                  - job=~"blackbox-.*"
                receiver: 'discord-webhooks'
                group_by: ['alertname', 'instance']
          receivers:
            # Default receiver - all alerts go to Discord
            - name: 'discord-default'
              discord_configs:
                - webhook_url_file: /secrets/discord/DISCORD_WEBHOOK_URL
                  send_resolved: true
                  title: '{{ template "discord.default.title" . }}'
                  message: '{{ template "discord.default.message" . }}'
            # Critical alerts - same Discord channel but could be different
            - name: 'discord-critical'
              discord_configs:
                - webhook_url_file: /secrets/discord/DISCORD_WEBHOOK_URL
                  send_resolved: true
                  title: 'üö® CRITICAL: {{ template "discord.default.title" . }}'
                  message: '{{ template "discord.default.message" . }}'
            # Warning alerts
            - name: 'discord-warning'
              discord_configs:
                - webhook_url_file: /secrets/discord/DISCORD_WEBHOOK_URL
                  send_resolved: true
                  title: '‚ö†Ô∏è Warning: {{ template "discord.default.title" . }}'
                  message: '{{ template "discord.default.message" . }}'
            # Webhook monitoring alerts
            - name: 'discord-webhooks'
              discord_configs:
                - webhook_url_file: /secrets/discord/DISCORD_WEBHOOK_URL
                  send_resolved: true
                  title: 'üîó Webhook Alert: {{ template "discord.default.title" . }}'
                  message: |
                    {{ template "discord.default.message" . }}
                    **Endpoint:** {{ .CommonLabels.instance }}
                    **Service:** {{ .CommonLabels.service }}
          inhibit_rules:
            # Inhibit warning alerts when critical alerts are firing
            - source_matchers:
                - severity="critical"
              target_matchers:
                - severity="warning"
              equal: ['alertname', 'namespace']

  destination:
    server: https://kubernetes.default.svc
    namespace: observability
  # Ignore differences for fields defaulted by Kubernetes API server
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/persistentVolumeClaimRetentionPolicy
      jqPathExpressions:
        - .spec.volumeClaimTemplates[]?
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
