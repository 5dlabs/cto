---
# Argo CD Application for Grafana
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana
  namespace: argocd
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: platform
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  source:
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 9.2.9
    chart: grafana
    helm:
      values: |
        # Admin credentials
        adminUser: admin
        adminPassword: admin

        # Pod labels/annotations for log collection
        # Note: Don't override app.kubernetes.io/component - it's part of the
        # selector and can't be changed on existing Deployments
        podLabels:
          platform.5dlabs.io/log-collection: enabled
        podAnnotations:
          logs.platform.5dlabs.io/collect: "true"
          logs.platform.5dlabs.io/service: grafana

        # Resource allocation
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 500m
            memory: 512Mi

        # Persistence for dashboards and settings
        persistence:
          enabled: true
          size: 10Gi
          storageClassName: "local-path"  # Use local-path until Mayastor is configured with hugepages

        # Service configuration
        service:
          type: ClusterIP
          port: 80

        # Data sources - Prometheus, Loki, Alertmanager
        # Note: deleteDatasources removes old Victoria* datasources on provision
        datasources:
          datasources.yaml:
            apiVersion: 1
            deleteDatasources:
              - name: VictoriaMetrics
                orgId: 1
              - name: VictoriaLogs
                orgId: 1
            datasources:
              # Prometheus datasource
              - name: Prometheus
                type: prometheus
                access: proxy
                url: http://prometheus-server.observability.svc.cluster.local:80
                isDefault: true
                editable: false
                jsonData:
                  timeInterval: "15s"
                  queryTimeout: "60s"
                  httpMethod: POST

              # Loki datasource
              - name: Loki
                type: loki
                access: proxy
                url: http://loki-gateway.observability.svc.cluster.local:80
                editable: false
                jsonData:
                  maxLines: 1000

              # Alertmanager datasource
              - name: Alertmanager
                type: alertmanager
                access: proxy
                url: http://alertmanager.observability.svc.cluster.local:9093
                editable: false
                jsonData:
                  implementation: prometheus

        # Plugins to install (Loki is built-in, no special plugin needed)
        plugins:
          - grafana-piechart-panel
          - grafana-worldmap-panel

        # RBAC configuration
        rbac:
          create: true
          pspEnabled: false

        # Service account
        serviceAccount:
          create: true
          name: grafana

        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 472
          fsGroup: 472

        # Disable init container that tries to chown - PVC already has correct ownership
        # The init-chown-data container fails on Talos due to security restrictions
        initChownData:
          enabled: false

        # Environment variables
        env:
          GF_EXPLORE_ENABLED: "true"
          GF_ALERTING_ENABLED: "true"
          GF_UNIFIED_ALERTING_ENABLED: "true"

        # Grafana.ini configuration
        grafana.ini:
          server:
            domain: grafana.local
            root_url: "%(protocol)s://%(domain)s/"

          analytics:
            reporting_enabled: false
            check_for_updates: false

          log:
            mode: console
            level: info

          unified_alerting:
            enabled: true

          feature_toggles:
            enable: ngalert

        # Sidecar for dynamic dashboard/datasource provisioning
        sidecar:
          dashboards:
            enabled: true
            label: grafana_dashboard
            folder: /tmp/dashboards
            provider:
              name: sidecarProvider
              orgId: 1
              folder: 'Claude Code'
              type: file
              disableDeletion: false
              allowUiUpdates: true

          datasources:
            enabled: true
            label: grafana_datasource

        # Readiness and liveness probes
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000

        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 60
          timeoutSeconds: 30
          failureThreshold: 10
  destination:
    server: https://kubernetes.default.svc
    namespace: observability
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - SkipDryRunOnMissingResource=true
      - RespectIgnoreDifferences=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  revisionHistoryLimit: 5
