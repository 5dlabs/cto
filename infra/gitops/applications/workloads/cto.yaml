---
# CTO Platform - Single Application Deployment (Develop Branch)
# =============================================================================
# Deploys all CTO platform components from a single Helm chart.
# This application tracks the 'develop' branch and uses 'develop' tagged images.
#
# Branch-based image tagging:
#   - develop branch → images tagged 'develop'
#   - main branch → images tagged 'latest' (for production app)
#
# Components:
# - Controller: Agent orchestration and CodeRun management
# - PM Server: Project management integrations (Linear)
# - Tools Server: MCP server proxy
# - Healer: Self-healing platform monitor
# - OpenMemory: Long-term AI agent memory
# - Sensors: Argo Event automation
# - Webhooks: GitHub event handling

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cto
  namespace: argocd
  labels:
    app.kubernetes.io/name: cto
    app.kubernetes.io/part-of: cto-platform
    app.kubernetes.io/branch: develop
  annotations:
    # Image Updater for all CTO images
    # Uses 'name:develop' strategy to track the develop tag specifically
    argocd-image-updater.argoproj.io/image-list: |
      controller=ghcr.io/5dlabs/controller,
      pm=ghcr.io/5dlabs/pm-server,
      tools=ghcr.io/5dlabs/tools,
      openmemory=ghcr.io/5dlabs/openmemory,
      healer=ghcr.io/5dlabs/healer,
      tweakcn=ghcr.io/5dlabs/tweakcn,
      research=ghcr.io/5dlabs/research
    # Use 'name' strategy with 'develop' tag constraint for develop branch deployments
    argocd-image-updater.argoproj.io/controller.update-strategy: "name"
    argocd-image-updater.argoproj.io/controller.allow-tags: "regexp:^(develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
    argocd-image-updater.argoproj.io/pm.update-strategy: "name"
    argocd-image-updater.argoproj.io/pm.allow-tags: "regexp:^(develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
    argocd-image-updater.argoproj.io/tools.update-strategy: "name"
    argocd-image-updater.argoproj.io/tools.allow-tags: "regexp:^(develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
    argocd-image-updater.argoproj.io/openmemory.update-strategy: "name"
    argocd-image-updater.argoproj.io/openmemory.allow-tags: "regexp:^(develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
    argocd-image-updater.argoproj.io/healer.update-strategy: "name"
    argocd-image-updater.argoproj.io/healer.allow-tags: "regexp:^(develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
    argocd-image-updater.argoproj.io/tweakcn.update-strategy: "name"
    argocd-image-updater.argoproj.io/tweakcn.allow-tags: "regexp:^(develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
    argocd-image-updater.argoproj.io/research.update-strategy: "name"
    argocd-image-updater.argoproj.io/research.allow-tags: "regexp:^(develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
    argocd-image-updater.argoproj.io/write-back-method: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  source:
    repoURL: https://github.com/5dlabs/cto
    targetRevision: develop
    path: infra/charts/cto
    helm:
      valueFiles:
        - values.yaml
      # Develop branch overrides - uses 'develop' tagged images
      # =======================================================================
      # CLUSTER: Latitude.sh (cto-dal)
      # Worker: hardware-219s058355, Control: hardware-21bs002557
      # Registry: 10.8.0.2:30500 (internal VPN IP)
      # Storage: local-path (no mayastor on Latitude)
      # =======================================================================
      values: |
        global:
          namespace: cto
          imagePullSecrets:
            - name: ghcr-secret
          storageClass: "local-path"  # Latitude uses local-path (no mayastor)
          # Dev registry for local development builds
          devRegistry:
            enabled: true
            url: "10.8.0.2:30500"
            tag: "tilt-dev"
            pullPolicy: Always

        controller:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/controller
            tag: develop

        pm:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/pm-server
            tag: develop
          github:
            defaultOrg: "5dlabs"
            webhookCallbackUrl: "https://pm.5dlabs.ai/webhooks/github"

        tools:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/tools
            tag: develop

        healer:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/healer
            tag: develop

        openmemory:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/openmemory
            tag: develop

        sensors:
          enabled: true

        webhooks:
          enabled: true

        tweakcn:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/tweakcn
            tag: develop

        # Research - Twitter/X bookmark research pipeline
        research:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/research
            tag: develop
          # CronJob schedule (every 5 minutes)
          schedule: "*/5 * * * *"
          # Research configuration
          minRelevance: "0.4"  # Lower threshold to capture more bookmarks
          batchSize: "50"      # Process more per run
          model: "claude-sonnet-4-20250514"
          # PR creation disabled - research is local
          createPR: false
          # Email digest (daily at 9am UTC / 4am EST)
          digest:
            enabled: true
            schedule: "0 9 * * *"
            hoursBetween: "24"
            skipAnalysis: false

        cloudflare:
          enabled: true

        # BuildKit - Remote build infrastructure for Latitude cluster
        buildkit:
          enabled: true
          # Schedule on Latitude worker node
          nodeSelector:
            kubernetes.io/hostname: hardware-219s058355
          # Allow pushing to local in-cluster registry (HTTP)
          config:
            insecureRegistries:
              - "10.8.0.2:30500"
              - "10.8.0.1:30500"

  destination:
    server: https://kubernetes.default.svc
    namespace: cto

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false

    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground
      - RespectIgnoreDifferences=true

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  ignoreDifferences:
    - group: ""
      kind: Secret
      jsonPointers:
        - /data
    # Cloudflare operator adds default values
    - group: networking.cfargotunnel.com
      kind: ClusterTunnel
      jsonPointers:
        - /status
    - group: networking.cfargotunnel.com
      kind: TunnelBinding
      jqPathExpressions:
        - .subjects
        - .tunnelRef
    # StatefulSet field defaulting by API server (buildkit has 2 PVCs)
    - group: apps
      kind: StatefulSet
      name: buildkit
      jsonPointers:
        - /spec/persistentVolumeClaimRetentionPolicy
        - /spec/volumeClaimTemplates/0/status
        - /spec/volumeClaimTemplates/0/apiVersion
        - /spec/volumeClaimTemplates/0/kind
        - /spec/volumeClaimTemplates/1/status
        - /spec/volumeClaimTemplates/1/apiVersion
        - /spec/volumeClaimTemplates/1/kind

  revisionHistoryLimit: 5
