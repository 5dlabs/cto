---
# CTO Platform - Single Application Deployment
# Deploys all CTO platform components from a single Helm chart:
# - Controller: Agent orchestration and CodeRun management
# - PM Server: Project management integrations (Linear)
# - Tools Server: MCP server proxy
# - Healer: Self-healing platform monitor
# - OpenMemory: Long-term AI agent memory
# - Sensors: Argo Event automation
# - Webhooks: GitHub event handling

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cto
  namespace: argocd
  labels:
    app.kubernetes.io/name: cto
    app.kubernetes.io/part-of: cto-platform
  annotations:
    # Image Updater for all CTO images
    argocd-image-updater.argoproj.io/image-list: |
      controller=ghcr.io/5dlabs/controller,
      pm=ghcr.io/5dlabs/pm-server,
      tools=ghcr.io/5dlabs/tools,
      openmemory=ghcr.io/5dlabs/openmemory,
      healer=ghcr.io/5dlabs/healer,
      tweakcn=ghcr.io/5dlabs/tweakcn
    argocd-image-updater.argoproj.io/controller.update-strategy: latest
    argocd-image-updater.argoproj.io/pm.update-strategy: latest
    argocd-image-updater.argoproj.io/tools.update-strategy: latest
    argocd-image-updater.argoproj.io/openmemory.update-strategy: latest
    argocd-image-updater.argoproj.io/healer.update-strategy: latest
    argocd-image-updater.argoproj.io/tweakcn.update-strategy: latest
    argocd-image-updater.argoproj.io/write-back-method: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  source:
    repoURL: https://github.com/5dlabs/cto
    targetRevision: main
    path: infra/charts/cto
    helm:
      valueFiles:
        - values.yaml
      # Production overrides
      values: |
        global:
          namespace: cto
          imagePullSecrets:
            - name: ghcr-secret
          storageClass: local-path

        controller:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/controller
            tag: latest

        pm:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/pm-server
            tag: latest
          github:
            defaultOrg: "5dlabs"
            webhookCallbackUrl: "https://pm.5dlabs.ai/webhooks/github"

        tools:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/tools
            tag: latest

        healer:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/healer
            tag: latest

        openmemory:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/openmemory
            tag: latest

        sensors:
          enabled: true

        webhooks:
          enabled: true

        tweakcn:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/tweakcn
            tag: latest

        cloudflare:
          enabled: true

  destination:
    server: https://kubernetes.default.svc
    namespace: cto

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false

    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  ignoreDifferences:
    - group: ""
      kind: Secret
      jsonPointers:
        - /data
    # Cloudflare operator adds default values
    - group: networking.cfargotunnel.com
      kind: ClusterTunnel
      jsonPointers:
        - /status
    - group: networking.cfargotunnel.com
      kind: TunnelBinding
      jsonPointers:
        - /status
        - /tunnelRef/disableDNSUpdates
        - /subjects

  revisionHistoryLimit: 5
