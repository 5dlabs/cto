---
# CTO Platform - Umbrella Application
# Deploys all CTO platform components as a single release:
# - Controller: Agent orchestration and CodeRun management
# - PM Server: Project management integrations (Linear, etc.)
# - Tools Server: MCP server proxy and tools management
# - OpenMemory: Long-term memory for AI agents
# - Healer: Self-healing platform monitor
#
# Each component can be enabled/disabled via values

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cto
  namespace: argocd
  labels:
    app.kubernetes.io/name: cto
    app.kubernetes.io/part-of: cto-platform
  annotations:
    # Image Updater for all CTO images
    argocd-image-updater.argoproj.io/image-list: |
      controller=ghcr.io/5dlabs/cto-controller,
      pm=ghcr.io/5dlabs/pm-server,
      tools=ghcr.io/5dlabs/tools,
      openmemory=ghcr.io/5dlabs/openmemory,
      healer=ghcr.io/5dlabs/healer
    argocd-image-updater.argoproj.io/write-back-method: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  source:
    repoURL: https://github.com/5dlabs/cto
    targetRevision: main
    path: infra/charts/cto
    helm:
      valueFiles:
        - values.yaml
      # Production overrides
      values: |
        # Controller configuration
        controller:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/cto-controller
            tag: latest
          imagePullSecrets:
            - name: ghcr-secret

        # PM Server configuration
        pm:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/pm-server
            tag: latest
          imagePullSecrets:
            - name: ghcr-secret
          pm:
            provider: linear
            namespace: cto
          secrets:
            secretName: linear-secrets
          github:
            defaultOrg: "5dlabs"
            webhookCallbackUrl: "https://pm.5dlabs.ai/webhooks/github"

        # Tools Server configuration
        tools:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/tools
            tag: latest
          imagePullSecrets:
            - name: ghcr-secret

        # OpenMemory configuration
        openmemory:
          enabled: true
          image:
            repository: ghcr.io/5dlabs/openmemory
            tag: latest

        # Healer configuration (uses universal-app)
        healer:
          enabled: true
          fullnameOverride: healer
          image:
            repository: ghcr.io/5dlabs/healer
            tag: latest
          imagePullSecrets:
            - name: ghcr-secret
          serviceAccount:
            create: false
            name: healer

  destination:
    server: https://kubernetes.default.svc
    namespace: cto

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false

    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  ignoreDifferences:
    - group: ""
      kind: Secret
      jsonPointers:
        - /data

  revisionHistoryLimit: 5

