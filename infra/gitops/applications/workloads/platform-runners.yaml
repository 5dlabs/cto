---
# GitHub Actions Runner Scale Set for 5D Labs Platform
# Uses the new official ARC runner scale sets

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-runner
  namespace: argocd
  labels:
    app.kubernetes.io/name: k8s-runner
    app.kubernetes.io/part-of: platform
  annotations:
    # Deploy after arc-controller which installs required CRDs
    argocd.argoproj.io/sync-wave: "0"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  # Ignore differences in CRD fields that cause sync issues
  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/preserveUnknownFields
        - /metadata/annotations

  source:
    repoURL: https://github.com/actions/actions-runner-controller
    targetRevision: gha-runner-scale-set-0.12.1
    path: charts/gha-runner-scale-set

    helm:
      values: |
        githubConfigUrl: "https://github.com/5dlabs"
        githubConfigSecret: github-pat
        runnerScaleSetName: "k8s-runner"
        minRunners: 2
        maxRunners: 6  # Increased for faster CI throughput
        runnerGroup: "Default"

        # Docker-in-Docker configuration for container builds
        # KNOWN ISSUE: Docker bridge network inside DinD may have intermittent
        # connectivity to GHCR/GitHub due to MTU mismatch with Cilium WireGuard (1420)
        # and Flannel VXLAN (1450). The Docker bridge defaults to MTU 1500.
        #
        # WORKAROUND: Use --network=host in buildx build commands, or configure
        # the buildx builder with --driver-opt network=host
        #
        # PERMANENT FIX: Clean up the network stack - remove Kilo (deprecated)
        # and Flannel remnants, ensure consistent MTU throughout.
        containerMode:
          type: "dind"

        # Listener configuration for stable runner management
        listenerTemplate:
          spec:
            # Allow listener to run on control plane if needed (critical for runners)
            tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
            containers:
            - name: listener
              env:
              - name: ACTIONS_RUNNER_CONTROLLER_IDLE_TIMEOUT
                value: "3600"
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "150m"

        controllerServiceAccount:
          name: "arc-gha-rs-controller"
          namespace: "arc-systems"

        # Force persistent runner behavior with explicit configuration
        # Note: Don't override app.kubernetes.io/component - it's part of the
        # selector and can't be changed on existing resources
        template:
          metadata:
            labels:
              platform.5dlabs.io/log-collection: enabled
            annotations:
              logs.platform.5dlabs.io/collect: "true"
              logs.platform.5dlabs.io/service: github-runner
          spec:
            restartPolicy: OnFailure
            activeDeadlineSeconds: 3600
            containers:
            - name: runner
              image: ghcr.io/actions/actions-runner:latest
              imagePullPolicy: Always
              command: ["/home/runner/run.sh"]
              # Resource limits to prevent OOM on the node
              resources:
                requests:
                  cpu: "500m"
                  memory: "2Gi"
                limits:
                  cpu: "4"
                  memory: "12Gi"
              env:
              - name: ACTIONS_RUNNER_PRINT_LOG_TO_STDOUT
                value: "true"
              volumeMounts:
              - name: work
                mountPath: /home/runner/_work
            volumes:
            # Use emptyDir for runner workspace - each runner gets isolated storage
            # Build caching should use GitHub Actions' actions/cache instead of shared PVCs
            # This avoids Multi-Attach errors when multiple runners scale up simultaneously
            - name: work
              emptyDir:
                sizeLimit: 20Gi

  destination:
    server: https://kubernetes.default.svc
    namespace: arc-runners  # Namespace for runner scale set

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false

    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - SkipDryRunOnMissingResource=true

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  revisionHistoryLimit: 10
