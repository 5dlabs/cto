---
# GitHub Actions Runner Scale Set for 5D Labs Platform
# Uses the new official ARC runner scale sets

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-runner
  namespace: argocd
  labels:
    app.kubernetes.io/name: k8s-runner
    app.kubernetes.io/part-of: platform
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  
  # Ignore differences in CRD fields that cause sync issues
  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/preserveUnknownFields
        - /metadata/annotations
  
  source:
    repoURL: https://github.com/actions/actions-runner-controller
    targetRevision: gha-runner-scale-set-0.12.1
    path: charts/gha-runner-scale-set
    
    helm:
      values: |
        githubConfigUrl: "https://github.com/5dlabs"
        githubConfigSecret: "github-pat"
        runnerScaleSetName: "k8s-runner"
        minRunners: 2
        maxRunners: 10
        runnerGroup: "Default"
        
        # Explicit runner labels for workflow targeting
        listenerTemplate:
          metadata:
            labels:
              runner-label: "k8s-runner"
        
        controllerServiceAccount:
          name: "arc-gha-rs-controller"
          namespace: "arc-systems"
        
        # Proper configuration with rust-builder image and Docker support
        template:
          spec:
            imagePullSecrets:
            - name: ghcr-secret
            containers:
            - name: runner
              image: ghcr.io/5dlabs/platform/rust-builder:latest
              imagePullPolicy: Always
              volumeMounts:
              - name: work
                mountPath: /home/runner/_work
              - name: docker-sock
                mountPath: /var/run/docker.sock
            volumes:
            - name: work
              emptyDir:
                sizeLimit: 10Gi
            - name: docker-sock
              hostPath:
                path: /var/run/docker.sock
  
  destination:
    server: https://kubernetes.default.svc
    namespace: arc-runners  # Namespace for runner scale set
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - SkipDryRunOnMissingResource=true
    
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  revisionHistoryLimit: 10