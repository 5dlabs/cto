#!/bin/bash
set -euo pipefail

# =========================================================================
# E2E Watch Monitor - Lightweight Container Script
# =========================================================================
# This script runs the monitor loop directly without the full factory setup.
# The monitor's job is to submit Play workflows, watch them, and evaluate results.

echo "ğŸ” Morgan E2E Watch Monitor starting"
echo ""

# -------------------------------------------------------------------------
# Environment Setup
# -------------------------------------------------------------------------
if [ -f "$HOME/.cargo/env" ]; then
  . "$HOME/.cargo/env"
fi

if [ -f "/root/.cargo/env" ]; then
  . "/root/.cargo/env"
fi

echo "PATH: $PATH"

# -------------------------------------------------------------------------
# Configuration
# -------------------------------------------------------------------------
ITERATION=${ITERATION:-1}
MAX_ITERATIONS=${MAX_ITERATIONS:-5}
CONFIG_PATH=${CONFIG_PATH:-"/workspace/config/cto-config.json"}
NAMESPACE=${NAMESPACE:-"cto"}

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘              E2E WATCH MONITOR CONFIGURATION                  â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“ Iteration: $ITERATION / $MAX_ITERATIONS"
echo "ğŸ”§ Config: $CONFIG_PATH"
echo "ğŸ“‚ Namespace: $NAMESPACE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# -------------------------------------------------------------------------
# GitHub Authentication (same pattern as factory/container-base.sh.hbs)
# -------------------------------------------------------------------------
echo "ğŸ” Authenticating with GitHub..."

REPO_URL="{{repository_url}}"

if [ -z "${GITHUB_APP_PRIVATE_KEY:-}" ] || [ -z "${GITHUB_APP_ID:-}" ]; then
  echo "âš ï¸ Missing GitHub App credentials (GITHUB_APP_PRIVATE_KEY or GITHUB_APP_ID)"
  echo "   Continuing without GitHub auth - some operations may fail"
else
  TEMP_KEY_FILE="/tmp/github-app-key.pem"
  printf '%b' "$GITHUB_APP_PRIVATE_KEY" >"$TEMP_KEY_FILE"
  chmod 600 "$TEMP_KEY_FILE"

  # Generate JWT
  JWT_HEADER=$(printf '{"alg":"RS256","typ":"JWT"}' | base64 -w 0 | tr '+/' '-_' | tr -d '=')
  NOW=$(date +%s)
  EXP=$((NOW + 600))
  JWT_PAYLOAD=$(printf '{"iat":%d,"exp":%d,"iss":"%s"}' "$NOW" "$EXP" "$GITHUB_APP_ID" | base64 -w 0 | tr '+/' '-_' | tr -d '=')
  JWT_SIGNATURE=$(printf '%s.%s' "$JWT_HEADER" "$JWT_PAYLOAD" | openssl dgst -sha256 -sign "$TEMP_KEY_FILE" -binary | base64 -w 0 | tr '+/' '-_' | tr -d '=')
  JWT_TOKEN="$JWT_HEADER.$JWT_PAYLOAD.$JWT_SIGNATURE"
  rm -f "$TEMP_KEY_FILE"

  # Parse repo URL to get owner/name
  parse_repo() {
    local input="$1"
    if echo "$input" | grep -qE '^https://github.com/'; then
      echo "$input" | sed -E 's|https://github.com/([^/]+)/([^/]+?)(\.git)?$|\1 \2|'
    elif echo "$input" | grep -qE '^git@github.com:'; then
      echo "$input" | sed -E 's|git@github.com:([^/]+)/([^/]+?)(\.git)?$|\1 \2|'
    else
      echo "$input" | sed -E 's|\.git$||' | sed -E 's|([^/]+)/([^/]+)|\1 \2|'
    fi
  }

  read REPO_OWNER REPO_NAME <<<"$(parse_repo "$REPO_URL")"

  # Get installation ID for this repo
  INSTALLATION_ID=$(curl -s -L \
    -H "Authorization: Bearer $JWT_TOKEN" \
    -H "Accept: application/vnd.github+json" \
    "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/installation" | jq -r '.id')

  if [ "$INSTALLATION_ID" = "null" ] || [ -z "$INSTALLATION_ID" ]; then
    # Try org-level installation
    INSTALLATION_ID=$(curl -s -L \
      -H "Authorization: Bearer $JWT_TOKEN" \
      -H "Accept: application/vnd.github+json" \
      "https://api.github.com/orgs/$REPO_OWNER/installation" | jq -r '.id')
  fi

  if [ "$INSTALLATION_ID" = "null" ] || [ -z "$INSTALLATION_ID" ]; then
    echo "âš ï¸ Could not find GitHub App installation for $REPO_OWNER/$REPO_NAME"
  else
    # Get installation access token
    GITHUB_TOKEN=$(curl -s -X POST \
      -H "Authorization: Bearer $JWT_TOKEN" \
      -H "Accept: application/vnd.github+json" \
      "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens" | jq -r '.token')

    if [ "$GITHUB_TOKEN" != "null" ] && [ -n "$GITHUB_TOKEN" ]; then
      export GITHUB_TOKEN
      export GH_TOKEN="$GITHUB_TOKEN"
      export GH_HOST="github.com"

      # Authenticate gh CLI
      printf '%s\n' "$GITHUB_TOKEN" | gh auth login --with-token --hostname github.com >/dev/null 2>&1 || true
      gh auth setup-git >/dev/null 2>&1 || true

      echo "âœ… Authenticated with GitHub App (installation: $INSTALLATION_ID)"
    else
      echo "âš ï¸ Failed to get GitHub installation token"
    fi
  fi
fi

# -------------------------------------------------------------------------
# Verify Tools
# -------------------------------------------------------------------------
echo ""
echo "ğŸ” Verifying required tools..."

if ! command -v play-monitor &> /dev/null; then
  echo "âŒ play-monitor CLI not found in PATH"
  echo "   Available in PATH: $(echo $PATH | tr ':' '\n' | head -5)"
  exit 1
fi
echo "âœ… play-monitor: $(play-monitor --version 2>/dev/null || echo 'available')"

if ! command -v kubectl &> /dev/null; then
  echo "âš ï¸ kubectl not found - some operations may fail"
else
  echo "âœ… kubectl: $(kubectl version --client -o json 2>/dev/null | jq -r '.clientVersion.gitVersion' || echo 'available')"
fi

if ! command -v gh &> /dev/null; then
  echo "âš ï¸ gh CLI not found - GitHub operations may fail"
else
  echo "âœ… gh: $(gh --version | head -1)"
fi

# -------------------------------------------------------------------------
# Setup Watch Directory
# -------------------------------------------------------------------------
WATCH_DIR="/workspace/watch"
mkdir -p "$WATCH_DIR/logs"

echo ""
echo "ğŸ“‚ Watch directory: $WATCH_DIR"

# Initialize status file
cat > "$WATCH_DIR/status.md" << EOF
# E2E Watch Status

## Current State
- Iteration: $ITERATION
- Phase: Starting
- Started: $(date -Iseconds)

## Progress
- [ ] Environment setup
- [ ] Play workflow submitted
- [ ] Monitoring stages
- [ ] Evaluation complete
EOF

echo "âœ… Status file initialized"

# -------------------------------------------------------------------------
# Run Monitor Loop
# -------------------------------------------------------------------------
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘              STARTING MONITOR LOOP                            â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# The play-monitor CLI handles:
# 1. Reset (if iteration > 1)
# 2. Submit Play workflow
# 3. Watch for completion
# 4. Download and analyze logs
# 5. Evaluate against acceptance criteria
# 6. Write issue report or exit success

# Extract org/repo from URL (e.g., "https://github.com/5dlabs/cto" -> "5dlabs/cto")
REPO_URL="{{repository_url}}"
REPO_ORG_NAME=$(echo "$REPO_URL" | sed -E 's|https?://github\.com/||' | sed 's|\.git$||')

DOCS_REPO_URL="{{docs_repository_url}}"
DOCS_REPO_ORG_NAME=$(echo "$DOCS_REPO_URL" | sed -E 's|https?://github\.com/||' | sed 's|\.git$||')

# Pass all values as CLI args (values come from Handlebars context)
play-monitor monitor \
  --iteration "$ITERATION" \
  --max-iterations "$MAX_ITERATIONS" \
  --namespace "$NAMESPACE" \
  --repository "$REPO_ORG_NAME" \
  --service "{{service}}" \
  --task-id "{{task_id}}" \
  --docs-repository "$DOCS_REPO_ORG_NAME" \
  --docs-project-directory "{{docs_project_directory}}"

EXIT_CODE=$?

# -------------------------------------------------------------------------
# Completion
# -------------------------------------------------------------------------
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
if [ $EXIT_CODE -eq 0 ]; then
  echo "â•‘    âœ… MONITOR COMPLETE - ALL CRITERIA PASSED                  â•‘"
else
  echo "â•‘    âŒ MONITOR COMPLETE - ISSUES FOUND (triggering remediation)â•‘"
fi
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "âœ… Morgan E2E Watch Monitor complete"
exit $EXIT_CODE
