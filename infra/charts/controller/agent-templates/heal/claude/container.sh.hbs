#!/bin/sh
# Claude Heal Remediation - Rex
# Executes remediation tasks identified by the heal monitoring system
# Spawned via CodeRun CRD when heal detects issues requiring intervention
#
# IMPORTANT: This template does NOT use the docs workflow.
# Issue context comes from heal-generated files on the shared PVC.

set -e

echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
echo '‚ïë             REX HEAL REMEDIATION (CLAUDE) STARTING           ‚ïë'
echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
echo "üéØ Agent: {{github_app}}"
echo "üìã Task ID: {{task_id}}"
echo "üîß Alert Type: ${ALERT_TYPE:-unknown}"
echo "üìÇ Repository: {{repository_url}}"
echo "üå≥ CodeRun: ${CODERUN_NAME:-unknown}"

# Export worktree path for agent instructions
export WORKTREE_PATH="/workspace/worktrees/${CODERUN_NAME}"
echo "üìÅ Worktree: ${WORKTREE_PATH}"

# Create worktrees directory if needed
mkdir -p /workspace/worktrees

# Verify heal-generated files exist
PROMPT_FILE="${HEAL_PROMPT_FILE:-/workspace/watch/alerts/${ALERT_TYPE:-unknown}.md}"
LOG_FILE="${HEAL_LOG_FILE:-/workspace/watch/logs/${ALERT_TYPE:-A7}-*.log}"

echo ""
echo "‚ïê‚ïê‚ïê HEAL CONTEXT FILES ‚ïê‚ïê‚ïê"
echo "üìÑ Prompt file: ${PROMPT_FILE}"
echo "üìã Log pattern: ${LOG_FILE}"

if [ -f "${PROMPT_FILE}" ]; then
    echo "   ‚úì Prompt file exists"
else
    echo "   ‚ö†Ô∏è  Prompt file not found at ${PROMPT_FILE}"
    echo "   Checking /workspace/watch/alerts/..."
    ls -la /workspace/watch/alerts/ 2>/dev/null || echo "   No alerts directory"
LATEST_LOG=$(ls -t ${LOG_FILE} 2>/dev/null | head -1 || true)

# Find latest matching log file
LATEST_LOG=$(ls -t ${LOG_FILE} 2>/dev/null | head -1)
if [ -n "${LATEST_LOG}" ]; then
    echo "   ‚úì Log file: ${LATEST_LOG}"
    export HEAL_LOG_FILE="${LATEST_LOG}"
else
    echo "   ‚ö†Ô∏è  No log files matching ${LOG_FILE}"
fi

# Source common utilities if available
if [ -f /workspace/scripts/lib/common.sh ]; then
    . /workspace/scripts/lib/common.sh
fi

echo ""
echo "‚ïê‚ïê‚ïê STARTING CLAUDE ‚ïê‚ïê‚ïê"

# Run Claude with the heal remediation agent prompt
exec claude \
    --dangerously-skip-permissions \
    --model "{{model}}" \
    --allowedTools "Bash(git:*),Bash(gh:*),Bash(cargo:*),Bash(kubectl:*),Bash(cat:*),Bash(ls:*),Read,Write,Edit" \
    -p "$(cat /task-files/agents.md)"
