#!/bin/sh
# Factory Heal Remediation - Rex
# Executes remediation tasks identified by the heal monitoring system
# Spawned via CodeRun CRD when heal detects issues requiring intervention
#
# IMPORTANT: This template does NOT use the docs workflow.
# Issue context comes from heal-generated files on the shared PVC.
# Completion is verified against acceptance criteria with retry loop.

set -e

echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
echo '‚ïë            REX HEAL REMEDIATION (FACTORY) STARTING           ‚ïë'
echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
echo "üéØ Agent: {{github_app}}"
echo "üìã Task ID: {{task_id}}"
echo "üîß Alert Type: ${ALERT_TYPE:-unknown}"
echo "üìÇ Repository: {{repository_url}}"
echo "üå≥ CodeRun: ${CODERUN_NAME:-unknown}"
if [ -n "${HEAL_ISSUE_NUMBER}" ]; then
    echo "üîó GitHub Issue: #${HEAL_ISSUE_NUMBER}"
fi

# ============================================================================
# CONFIGURATION
# ============================================================================
MAX_RETRIES=${HEAL_MAX_RETRIES:-3}
COMPLETION_TIMEOUT=${HEAL_COMPLETION_TIMEOUT:-60}

# Export worktree path for agent instructions
export WORKTREE_PATH="/workspace/worktrees/${CODERUN_NAME}"
echo "üìÅ Worktree: ${WORKTREE_PATH}"

# Create worktrees directory if needed
mkdir -p /workspace/worktrees

# ============================================================================
# VERIFY HEAL CONTEXT FILES
# ============================================================================
PROMPT_FILE="${HEAL_PROMPT_FILE:-/workspace/watch/alerts/${ALERT_TYPE:-unknown}.md}"
LOG_FILE="${HEAL_LOG_FILE:-/workspace/watch/logs/${ALERT_TYPE:-A7}-*.log}"
ACCEPTANCE_FILE="${HEAL_ACCEPTANCE_FILE:-${HEAL_ISSUE_DIR:-/workspace/watch/issues/unknown}/acceptance-criteria.md}"

echo ""
echo "‚ïê‚ïê‚ïê HEAL CONTEXT FILES ‚ïê‚ïê‚ïê"
echo "üìÑ Prompt file: ${PROMPT_FILE}"
echo "üìã Log pattern: ${LOG_FILE}"
echo "‚úÖ Acceptance: ${ACCEPTANCE_FILE}"

if [ -f "${PROMPT_FILE}" ]; then
    echo "   ‚úì Prompt file exists"
else
    echo "   ‚ö†Ô∏è  Prompt file not found at ${PROMPT_FILE}"
    echo "   Checking /workspace/watch/alerts/..."
    ls -la /workspace/watch/alerts/ 2>/dev/null || echo "   No alerts directory"
fi

# Find latest matching log file (|| true prevents glob expansion errors)
LATEST_LOG=$(ls -t ${LOG_FILE} 2>/dev/null | head -1 || true)
if [ -n "${LATEST_LOG}" ]; then
    echo "   ‚úì Log file: ${LATEST_LOG}"
    export HEAL_LOG_FILE="${LATEST_LOG}"
else
    echo "   ‚ö†Ô∏è  No log files matching ${LOG_FILE}"
fi

if [ -f "${ACCEPTANCE_FILE}" ]; then
    echo "   ‚úì Acceptance criteria exists"
else
    echo "   ‚ö†Ô∏è  No acceptance criteria at ${ACCEPTANCE_FILE}"
fi

# Source common utilities if available
if [ -f /workspace/scripts/lib/common.sh ]; then
    . /workspace/scripts/lib/common.sh
fi

# Load agent prompt
AGENT_PROMPT="/task-files/agents.md"
if [ ! -f "${AGENT_PROMPT}" ]; then
    echo "‚ùå Agent prompt not found at ${AGENT_PROMPT}"
    exit 1
fi

# ============================================================================
# COMPLETION PROBE LOOP
# ============================================================================
ATTEMPT=1
SUCCESS=0
COMPLETION_LAST_MESSAGE="/tmp/heal-completion-last.txt"
COMPLETION_LOG="/tmp/heal-completion.log"

echo ""
echo "‚ïê‚ïê‚ïê STARTING REMEDIATION (max ${MAX_RETRIES} attempts) ‚ïê‚ïê‚ïê"

while [ $ATTEMPT -le $MAX_RETRIES ] && [ $SUCCESS -eq 0 ]; do
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "‚ïë ATTEMPT ${ATTEMPT} of ${MAX_RETRIES}                                         ‚ïë"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

    # Build the prompt content for this iteration
    PROMPT_CONTENT=$(cat "${AGENT_PROMPT}")

    # Add iteration context if not first attempt
    if [ $ATTEMPT -gt 1 ] && [ -f "${COMPLETION_LAST_MESSAGE}" ]; then
        LAST_REASON=$(cat "${COMPLETION_LAST_MESSAGE}" 2>/dev/null || echo "")
        if [ -n "${LAST_REASON}" ]; then
            PROMPT_CONTENT="${PROMPT_CONTENT}

üîÅ **ITERATION ${ATTEMPT} - Previous attempt incomplete**

The previous completion probe indicated these items remain:
${LAST_REASON}

Focus on addressing the above items before re-checking acceptance criteria."
        fi
    fi

    # Run Factory with the remediation prompt
    echo "üöÄ Running Factory remediation agent..."
    set +e
    droid exec \
        --auto high \
        --model "{{model}}" \
        --output-format stream-json \
        "${PROMPT_CONTENT}"
    AGENT_EXIT=$?
    set -e

    echo ""
    echo "üß≠ Agent exited with code: ${AGENT_EXIT}"

    # ========================================================================
    # COMPLETION PROBE - Check acceptance criteria
    # ========================================================================
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "‚ïë COMPLETION PROBE - Checking Acceptance Criteria              ‚ïë"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

    # Build completion probe prompt
    if [ -f "${ACCEPTANCE_FILE}" ]; then
        ACCEPTANCE_CONTENT=$(cat "${ACCEPTANCE_FILE}")
    else
        ACCEPTANCE_CONTENT="No acceptance criteria file found. Check if:
- Fix has been deployed
- Pod is running without errors
- No new alerts for this issue"
    fi

    COMPLETION_PROMPT="You are a completion probe for a heal remediation task.

## Acceptance Criteria
${ACCEPTANCE_CONTENT}

## Instructions
Review the current state and determine if ALL acceptance criteria are met.

Check:
1. Was a PR created and merged? (use: gh pr list --state merged --search 'fix heal')
2. Did ArgoCD sync successfully? (use: kubectl get application -n argocd)
3. Is the target pod running without errors? (use: kubectl get pods -n cto)
4. Are there any new errors in the logs?

Respond with ONLY:
- **yes** - if ALL criteria are satisfied
- **no** - if ANY criteria are NOT satisfied

If no, add:
REASON: [list the specific criteria that are not met]

Your response:"

    echo "üìã Running completion probe..."
    set +e
    COMPLETION_OUTPUT=$(droid exec --auto high --model "{{model}}" --output-format text "${COMPLETION_PROMPT}" 2>&1 | tee "${COMPLETION_LOG}")
    COMPLETION_EXIT=$?
    set -e

    echo "üß≠ Completion probe response:"
    printf '%s\n' "${COMPLETION_OUTPUT}"

    # Extract yes/no from response
    COMPLETION_RESPONSE=$(printf '%s\n' "${COMPLETION_OUTPUT}" | tr -d '\r' | grep -Eio '^\*\*(yes|no)\*\*|^(yes|no)$' | sed 's/\*//g' | head -n1 | tr '[:upper:]' '[:lower:]')

    if [ "${COMPLETION_RESPONSE}" = "yes" ]; then
        echo ""
        echo "‚úÖ Completion probe confirmed: ALL acceptance criteria met!"
        SUCCESS=1
        break
    elif [ "${COMPLETION_RESPONSE}" = "no" ]; then
        # Extract reason for next iteration
        CURRENT_REASON=$(printf '%s\n' "${COMPLETION_OUTPUT}" | awk 'BEGIN{IGNORECASE=1}/^reason:/{sub(/^reason:[[:space:]]*/,"");flag=1} flag{print}')
        if [ -n "${CURRENT_REASON}" ]; then
            echo ""
            echo "‚ö†Ô∏è Completion probe found incomplete criteria:"
            echo "${CURRENT_REASON}"
            printf '%s\n' "${CURRENT_REASON}" > "${COMPLETION_LAST_MESSAGE}"
        else
            echo "‚ö†Ô∏è Completion probe reported 'no' without specific reason"
            echo "Task incomplete - review acceptance criteria" > "${COMPLETION_LAST_MESSAGE}"
        fi
    else
        echo "‚ö†Ô∏è Could not parse completion probe response: ${COMPLETION_RESPONSE:-<empty>}"
        echo "Treating as incomplete..."
        echo "Unable to verify completion" > "${COMPLETION_LAST_MESSAGE}"
    fi

    ATTEMPT=$((ATTEMPT + 1))
done

# ============================================================================
# FINAL STATUS
# ============================================================================
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
if [ $SUCCESS -eq 1 ]; then
    echo "‚ïë ‚úÖ REMEDIATION COMPLETE                                       ‚ïë"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "Completed in ${ATTEMPT} attempt(s)"

    # Update GitHub issue if we have an issue number
    if [ -n "${HEAL_ISSUE_NUMBER}" ]; then
        echo "üìù Adding completion comment to issue #${HEAL_ISSUE_NUMBER}..."
        gh issue comment "${HEAL_ISSUE_NUMBER}" --repo 5dlabs/cto --body "‚úÖ **Remediation Complete**

All acceptance criteria have been verified:
- PR merged to main
- ArgoCD sync successful
- Target system healthy

Completed by: ${CODERUN_NAME}
Attempts: ${ATTEMPT}" 2>/dev/null || echo "   (could not comment on issue)"
    fi

    exit 0
else
    echo "‚ïë ‚ùå REMEDIATION INCOMPLETE                                      ‚ïë"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "Failed after ${MAX_RETRIES} attempts"

    # Update GitHub issue if we have an issue number
    if [ -n "${HEAL_ISSUE_NUMBER}" ]; then
        echo "üìù Adding failure comment to issue #${HEAL_ISSUE_NUMBER}..."
        LAST_REASON=$(cat "${COMPLETION_LAST_MESSAGE}" 2>/dev/null || echo "Unknown")
        gh issue comment "${HEAL_ISSUE_NUMBER}" --repo 5dlabs/cto --body "‚ö†Ô∏è **Remediation Incomplete**

Unable to satisfy all acceptance criteria after ${MAX_RETRIES} attempts.

**Remaining issues:**
${LAST_REASON}

**Next steps:** Manual intervention may be required.

Agent: ${CODERUN_NAME}" 2>/dev/null || echo "   (could not comment on issue)"
    fi

    exit 1
fi
