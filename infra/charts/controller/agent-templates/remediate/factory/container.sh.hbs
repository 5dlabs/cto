#!/bin/sh
# Factory PR Remediation - Rex
# Executes PR remediation tasks triggered by review findings
# Spawned via CodeRun CRD when users click "remediate" or when Rex is triggered to fix issues

set -e

echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
echo 'â•‘           REX PR REMEDIATION (FACTORY) STARTING              â•‘'
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
echo "ğŸ¯ Agent: {{github_app}}"
echo "ğŸ”¢ PR Number: {{pr_number}}"
echo "ğŸ“‚ Repository: {{repository_url}}"
echo "ğŸ“ Head SHA: {{head_sha}}"
{{#if task_id}}
echo "ğŸ“‹ Task ID: {{task_id}}"
{{/if}}

# Source common utilities if available
if [ -f /workspace/scripts/lib/common.sh ]; then
    . /workspace/scripts/lib/common.sh
fi

# Set up environment
export REPOSITORY_URL="{{repository_url}}"
export PR_NUMBER="{{pr_number}}"
export HEAD_SHA="{{head_sha}}"
export REPO_SLUG="{{repo_slug}}"

echo "ğŸ“¦ Repository: $REPO_SLUG"

# Check for review findings to remediate
{{#if findings_path}}
echo ""
echo "ğŸ“‹ Remediating findings from: {{findings_path}}"
if [ -f "{{findings_path}}" ]; then
    export FINDINGS_FILE="{{findings_path}}"
    echo "âœ… Findings file found"
else
    echo "âš ï¸ Findings file not found at {{findings_path}}"
fi
{{/if}}

# Check for review comment context
{{#if review_comment_id}}
echo ""
echo "ğŸ’¬ Triggered by review comment: {{review_comment_id}}"
export REVIEW_COMMENT_ID="{{review_comment_id}}"
{{/if}}

# Load agent prompt
AGENT_PROMPT="/task-files/agents.md"
if [ ! -f "${AGENT_PROMPT}" ]; then
    echo "âŒ Agent prompt not found at ${AGENT_PROMPT}"
    exit 1
fi

echo ""
echo "ğŸš€ Starting Factory CLI (droid exec)..."
echo ""

# Run Factory with the remediation agent prompt
exec droid exec \
    --auto high \
    --model "{{model}}" \
    --output-format stream-json \
    "$(cat ${AGENT_PROMPT})"
