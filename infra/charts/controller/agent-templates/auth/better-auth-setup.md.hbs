# BetterAuth Configuration Guide

## Overview
BetterAuth is the standard authentication library for all applications built by the CTO platform. This guide provides agent-specific instructions for implementing authentication.

## Agent Responsibilities

### Rex (Implementation Agent)
- Initialize BetterAuth backend configuration
- Set up database adapters (Prisma, Drizzle, etc.)
- Configure authentication methods based on requirements
- Implement API routes and middleware
- Set up OAuth providers if needed
- Configure MCP plugin for agent authentication

### Blaze (Frontend Agent)
- Implement authentication UI using shadcn/ui components
- Create login, signup, and profile pages
- Handle authentication flows (OAuth, magic links, etc.)
- Implement session management in the frontend
- Create responsive, accessible auth forms
- Integrate BetterAuth React hooks

### Cleo (Code Quality Agent)
- Verify no hardcoded secrets
- Check environment variable usage
- Validate TypeScript types
- Ensure proper error handling
- Review security configurations
- Check CORS settings

### Tess (QA Agent)
- Test complete authentication flows
- Verify email sending functionality
- Test OAuth provider integrations
- Validate session management
- Test password reset flows
- Verify 2FA functionality if enabled
- Test role-based access control

### Cipher (Security Agent)
- Audit authentication configuration
- Review token storage methods
- Validate session security
- Check for security vulnerabilities
- Review RBAC implementation
- Ensure secure communication (HTTPS)

## Standard Authentication Features

### Core Features (Always Implemented)
```typescript
export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql" // or mysql, sqlite
  }),
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true
  },
  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7 days
    updateAgeOnGet: true
  }
})
```

### Optional Features (Based on Requirements)

#### Social Authentication
```typescript
socialProviders: {
  github: {
    clientId: process.env.GITHUB_CLIENT_ID!,
    clientSecret: process.env.GITHUB_CLIENT_SECRET!
  },
  google: {
    clientId: process.env.GOOGLE_CLIENT_ID!,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET!
  }
}
```

#### Two-Factor Authentication
```typescript
plugins: [
  twoFactor({
    issuer: "{{project_name}}"
  })
]
```

#### Magic Links
```typescript
plugins: [
  magicLink({
    sendMagicLink: async ({ email, url }) => {
      // Email sending implementation
      await resend.emails.send({
        from: process.env.EMAIL_FROM!,
        to: email,
        subject: "Sign in to {{project_name}}",
        html: `Click <a href="${url}">here</a> to sign in.`
      })
    }
  })
]
```

#### Organizations (Multi-Tenancy)
```typescript
plugins: [
  organization({
    allowUserToCreateOrganization: true,
    organizationLimit: 5
  })
]
```

#### MCP Server (For Agent Authentication)
```typescript
plugins: [
  mcp({
    loginPage: "/sign-in",
    resource: "{{project_name}}-api"
  })
]
```

## Environment Variables Template

```bash
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/dbname"

# BetterAuth Configuration
BETTER_AUTH_SECRET="{{generate_secret}}" # 32+ char random string
BETTER_AUTH_URL="http://localhost:3000"

# Email Provider (if email auth is used)
EMAIL_FROM="noreply@{{domain}}"
RESEND_API_KEY="{{resend_api_key}}"

# OAuth Providers (optional)
GITHUB_CLIENT_ID="{{github_client_id}}"
GITHUB_CLIENT_SECRET="{{github_client_secret}}"
GOOGLE_CLIENT_ID="{{google_client_id}}"
GOOGLE_CLIENT_SECRET="{{google_client_secret}}"

# MCP Configuration (for agent auth)
MCP_RESOURCE_NAME="{{project_name}}-mcp"
```

## Frontend Implementation Pattern

### Authentication Provider Setup
```typescript
// app/providers.tsx
import { BetterAuthProvider } from "@better-auth/react"
import { authClient } from "@/lib/auth-client"

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <BetterAuthProvider client={authClient}>
      {children}
    </BetterAuthProvider>
  )
}
```

### Protected Routes
```typescript
// app/dashboard/layout.tsx
import { useAuth } from "@better-auth/react"
import { redirect } from "next/navigation"

export default function DashboardLayout({ children }) {
  const { user, isLoading } = useAuth()
  
  if (isLoading) return <LoadingSpinner />
  if (!user) redirect("/sign-in")
  
  return <>{children}</>
}
```

### Login Form with shadcn/ui
```typescript
import { useAuth } from "@better-auth/react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Form } from "@/components/ui/form"

export function LoginForm() {
  const { signIn } = useAuth()
  
  const onSubmit = async (data) => {
    const { error } = await signIn.email({
      email: data.email,
      password: data.password
    })
    
    if (!error) {
      // Redirect to dashboard
    }
  }
  
  return (
    <Form onSubmit={onSubmit}>
      {/* Form fields with shadcn/ui components */}
    </Form>
  )
}
```

## Security Checklist

- [ ] BETTER_AUTH_SECRET is at least 32 characters
- [ ] All API keys stored in environment variables
- [ ] HTTPS configured in production
- [ ] Session cookies configured as secure
- [ ] CORS properly configured
- [ ] Rate limiting implemented
- [ ] Email verification enabled
- [ ] Password requirements enforced
- [ ] SQL injection prevention (via ORM)
- [ ] XSS prevention (React default)

## Testing Requirements

### Unit Tests (Rex)
- Authentication configuration
- Database adapter setup
- Plugin initialization

### Integration Tests (Cleo)
- API endpoint functionality
- Middleware behavior
- Session management

### E2E Tests (Tess)
- Complete signup flow
- Login with credentials
- OAuth provider flows
- Password reset process
- Session expiration
- Logout functionality

## Migration from Other Auth Solutions

### From NextAuth.js
```typescript
// Replace NextAuth with BetterAuth
// Before: import NextAuth from "next-auth"
// After: import { betterAuth } from "better-auth"
```

### From Supabase Auth
```typescript
// Replace Supabase Auth client
// Before: const { data } = await supabase.auth.signUp()
// After: const { data } = await authClient.signUp.email()
```

### From Clerk
```typescript
// Replace Clerk components
// Before: <SignIn />
// After: Custom form with BetterAuth hooks
```

## Performance Optimization

- Use trusted clients for internal services
- Enable session caching with Redis
- Implement proper database indexes
- Use connection pooling
- Optimize email sending with queues

## Monitoring & Analytics

- Track authentication events
- Monitor failed login attempts
- Log security incidents
- Track OAuth provider usage
- Monitor session durations

## Support Resources

- BetterAuth Documentation: https://better-auth.com
- GitHub Issues: https://github.com/better-auth/better-auth/issues
- Community Discord: https://discord.gg/better-auth
- MCP Integration Guide: https://better-auth.com/docs/plugins/mcp

