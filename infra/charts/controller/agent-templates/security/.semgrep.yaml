---
# Semgrep configuration for Cipher security scanning
# Focuses on Rust and TypeScript/JavaScript security patterns

rules:
  # Rust Security Rules
  - id: rust-unsafe-block
    pattern: unsafe { ... }
    message: |
      Avoid unsafe blocks in Rust code. Unsafe code bypasses Rust's safety guarantees.
      Consider refactoring to use safe abstractions or thoroughly document why unsafe is necessary.
    languages: [rust]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
      owasp: "A01:2021 - Broken Access Control"

  - id: rust-unwrap-panic
    patterns:
      - pattern-either:
          - pattern: $X.unwrap()
          - pattern: $X.expect(...)
    message: |
      Avoid using unwrap() or expect() in production code as they can cause panics.
      Use proper error handling with Result and ? operator instead.
    languages: [rust]
    severity: WARNING
    metadata:
      category: security
      subcategory: error-handling

  - id: rust-hardcoded-secret
    patterns:
      - pattern-either:
          - pattern: |
              let $VAR = "$SECRET";
          - pattern: |
              const $VAR: &str = "$SECRET";
      - metavariable-regex:
          metavariable: $VAR
          regex: .*(password|secret|token|key|api_key|auth).*
      - metavariable-regex:
          metavariable: $SECRET
          regex: ^[A-Za-z0-9+/=]{20,}$
    message: |
      Potential hardcoded secret detected. Use environment variables or secure secret management.
      Example: std::env::var("API_KEY").expect("API_KEY not set")
    languages: [rust]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
      owasp: "A07:2021 - Identification and Authentication Failures"

  - id: rust-sql-injection
    patterns:
      - pattern-either:
          - pattern: |
              format!("... {$VAR} ...")
          - pattern: |
              format!("SELECT ... WHERE ... = {$VAR}")
    message: |
      Potential SQL injection vulnerability. Use parameterized queries instead.
      For sqlx: query!("SELECT * FROM users WHERE id = ?", user_id)
    languages: [rust]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-89: SQL Injection"
      owasp: "A03:2021 - Injection"

  # TypeScript/JavaScript Security Rules
  - id: ts-eval-usage
    pattern: eval(...)
    message: |
      Avoid using eval() as it can execute arbitrary code and is a major security risk.
      Consider using safer alternatives like JSON.parse() for data or Function constructor for limited cases.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code"
      owasp: "A03:2021 - Injection"

  - id: ts-dangerous-innerhtml
    patterns:
      - pattern-either:
          - pattern: $X.innerHTML = $VAR
          - pattern: $X.outerHTML = $VAR
    message: |
      Direct assignment to innerHTML/outerHTML can lead to XSS vulnerabilities.
      Use textContent for plain text or sanitize HTML with DOMPurify before insertion.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-79: Cross-site Scripting (XSS)"
      owasp: "A03:2021 - Injection"

  - id: ts-hardcoded-secret
    patterns:
      - pattern-either:
          - pattern: |
              const $VAR = "$SECRET"
          - pattern: |
              let $VAR = "$SECRET"
      - metavariable-regex:
          metavariable: $VAR
          regex: .*(password|secret|token|key|apiKey|authToken).*
      - metavariable-regex:
          metavariable: $SECRET
          regex: ^[A-Za-z0-9+/=]{20,}$
    message: |
      Potential hardcoded secret detected. Use environment variables instead.
      Example: process.env.API_KEY || throw new Error('API_KEY not set')
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
      owasp: "A07:2021 - Identification and Authentication Failures"

  - id: ts-sql-injection
    patterns:
      - pattern-either:
          - pattern: |
              `SELECT ... WHERE ... = ${$VAR}`
          - pattern: |
              "SELECT ... WHERE ... = " + $VAR
    message: |
      Potential SQL injection vulnerability. Use parameterized queries or an ORM.
      For PostgreSQL: client.query('SELECT * FROM users WHERE id = $1', [userId])
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-89: SQL Injection"
      owasp: "A03:2021 - Injection"

  - id: ts-insecure-random
    patterns:
      - pattern: Math.random()
    message: |
      Math.random() is not cryptographically secure. Use crypto.randomBytes() for security-sensitive operations.
      Example: crypto.randomBytes(32).toString('hex')
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330: Use of Insufficiently Random Values"

  - id: ts-command-injection
    patterns:
      - pattern-either:
          - pattern: |
              exec($CMD)
          - pattern: |
              execSync($CMD)
      - pattern-not: |
          exec("...")
      - pattern-not: |
          execSync("...")
    message: |
      Potential command injection vulnerability. Avoid using user input in shell commands.
      Use execFile() with array arguments or validate/sanitize input thoroughly.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-78: OS Command Injection"
      owasp: "A03:2021 - Injection"

  # General Rules (both languages)
  - id: weak-crypto-algorithm
    patterns:
      - pattern-either:
          - pattern: |
              md5(...)
          - pattern: |
              sha1(...)
          - pattern: |
              des(...)
    message: |
      Weak cryptographic algorithm detected (MD5, SHA1, or DES).
      Use stronger alternatives like SHA-256, SHA-3, or AES-256.
    languages: [rust, typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
      owasp: "A02:2021 - Cryptographic Failures"

# Paths to exclude from scanning
paths:
  exclude:
    - "*/test/*"
    - "*/tests/*"
    - "*_test.rs"
    - "*.test.ts"
    - "*.test.js"
    - "*/node_modules/*"
    - "*/target/*"
    - "*/dist/*"
    - "*/build/*"
    - "*/.git/*"
    - "*/vendor/*"

