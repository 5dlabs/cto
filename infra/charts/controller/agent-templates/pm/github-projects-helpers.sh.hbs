#!/bin/bash
# GitHub Projects V2 API Helper Functions
# GraphQL-based operations for managing GitHub Projects
# These functions are sourced by Morgan PM scripts
# Patterns adapted from 5dlabs/tasks reference implementation

# ============================================================================
# GraphQL QUERY HELPERS WITH RETRY LOGIC
# ============================================================================

graphql_query() {
  local query="$1"
  local variables="${2:-{}}"
  local max_retries=3
  local retry_count=0
  
  while [ $retry_count -lt $max_retries ]; do
    local result=$(gh api graphql -f query="$query" -F variables="$variables" 2>&1)
    local exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
      echo "$result"
      return 0
    fi
    
    # Check if rate limited
    if echo "$result" | grep -q "rate limit"; then
      retry_count=$((retry_count + 1))
      local backoff=$((2 ** retry_count))
      echo "⚠️  Rate limited, retrying in ${backoff}s..." >&2
      sleep "$backoff"
    else
      echo "{}" 
      return 1
    fi
  done
  
  echo "{}"
  return 1
}

# ============================================================================
# PROJECT MANAGEMENT
# ============================================================================

get_or_create_project() {
  local owner="$1"
  local repo_name="$2"
  local title="$3"
  
  # Get repository node ID - needed for linking project to repo
  local repo_result=$(gh api graphql -f query='
    query($owner: String!, $repo: String!) {
      repository(owner: $owner, name: $repo) {
        id
      }
    }
  ' -f owner="$owner" -f repo="$repo_name" 2>&1)
  
  local repo_id=$(echo "$repo_result" | jq -r '.data.repository.id // ""')
  
  if [[ -z "$repo_id" ]] || [[ "$repo_id" == "null" ]]; then
    echo "ERROR: Could not get repository ID for $owner/$repo_name" >&2
    echo "$repo_result" >&2
    echo ""
    return 1
  fi
  
  # Try to find existing project (check both org and linked projects)
  local query='
    query($owner: String!, $repo: String!) {
      repository(owner: $owner, name: $repo) {
        projectsV2(first: 20) {
          nodes {
            id
            title
          }
        }
      }
    }
  '
  
  local result=$(gh api graphql -f query="$query" -f owner="$owner" -f repo="$repo_name")
  
  # Check if project exists
  local project_id=$(echo "$result" | jq -r \
    --arg title "$title" \
    '.data.repository.projectsV2.nodes[] | select(.title == $title) | .id')
  
  if [[ -n "$project_id" ]] && [[ "$project_id" != "null" ]]; then
    echo "$project_id"
    return 0
  fi
  
  # GitHub Projects V2 are created at org/user level, then linked to repos
  # Get owner ID for project creation
  echo "Creating org-level project and linking to repository $owner/$repo_name" >&2
  
  local owner_result=$(gh api graphql -f query='
    query($owner: String!) {
      repositoryOwner(login: $owner) {
        id
      }
    }
  ' -f owner="$owner" 2>&1)
  
  local owner_id=$(echo "$owner_result" | jq -r '.data.repositoryOwner.id // ""')
  
  if [[ -z "$owner_id" ]] || [[ "$owner_id" == "null" ]]; then
    echo "ERROR: Could not get owner ID for $owner" >&2
    echo "$owner_result" >&2
    echo ""
    return 1
  fi
  
  echo "Owner ID: $owner_id" >&2
  
  local create_mutation='
    mutation($ownerId: ID!, $title: String!) {
      createProjectV2(input: {
        ownerId: $ownerId
        title: $title
      }) {
        projectV2 {
          id
        }
      }
    }
  '
  
  local create_result=$(gh api graphql \
    -f query="$create_mutation" \
    -f ownerId="$owner_id" \
    -f title="$title" 2>&1)
  
  # Check for errors in response
  if echo "$create_result" | jq -e '.errors' >/dev/null 2>&1; then
    echo "ERROR: Failed to create project" >&2
    echo "$create_result" | jq -r '.errors[0].message' >&2
    echo ""
    return 1
  fi
  
  local project_id=$(echo "$create_result" | jq -r '.data.createProjectV2.projectV2.id // ""')
  
  if [[ -z "$project_id" ]] || [[ "$project_id" == "null" ]]; then
    echo "ERROR: No project ID returned" >&2
    echo "$create_result" >&2
    echo ""
    return 1
  fi
  
  # Link the project to the repository so it appears on repo page
  echo "Linking project $project_id to repository $repo_id" >&2
  
  local link_mutation='
    mutation($projectId: ID!, $repositoryId: ID!) {
      linkProjectV2ToRepository(input: {
        projectId: $projectId
        repositoryId: $repositoryId
      }) {
        repository {
          id
        }
      }
    }
  '
  
  # Redirect both stdout and stderr to avoid contaminating the return value
  gh api graphql \
    -f query="$link_mutation" \
    -f projectId="$project_id" \
    -f repositoryId="$repo_id" >/dev/null 2>&1 || {
      echo "WARNING: Could not link project to repository (project still works)" >&2
    }
  
  # Create board view and set as default
  create_default_board_view "$project_id"
  
  # Return only the project ID (not mutation output)
  echo "$project_id"
}

create_default_board_view() {
  local project_id="$1"
  
  echo "Setting up board view as default..." >&2
  
  # First, get existing views (GitHub auto-creates a default table view)
  local views_query='
    query($projectId: ID!) {
      node(id: $projectId) {
        ... on ProjectV2 {
          views(first: 10) {
            nodes {
              id
              name
              layout
            }
          }
        }
      }
    }
  '
  
  local views_result=$(gh api graphql \
    -f query="$views_query" \
    -f projectId="$project_id" 2>&1)
  
  # Find the default table view to delete
  local default_view_id=$(echo "$views_result" | jq -r '.data.node.views.nodes[] | select(.layout == "TABLE_LAYOUT") | .id' | head -1)
  
  # Create our board view
  local view_mutation='
    mutation($projectId: ID!) {
      createProjectV2View(input: {
        projectId: $projectId
        name: "Task Board"
        layout: BOARD_LAYOUT
      }) {
        projectV2View {
          id
          number
        }
      }
    }
  '
  
  local view_result=$(gh api graphql \
    -f query="$view_mutation" \
    -f projectId="$project_id" 2>&1)
  
  local view_id=$(echo "$view_result" | jq -r '.data.createProjectV2View.projectV2View.id // ""')
  local view_number=$(echo "$view_result" | jq -r '.data.createProjectV2View.projectV2View.number // ""')
  
  if [[ -n "$view_id" ]] && [[ "$view_id" != "null" ]]; then
    echo "✅ Created board view (ID: $view_id, Number: $view_number)" >&2
    
    # Delete the default table view if it exists (makes board the default)
    if [[ -n "$default_view_id" ]] && [[ "$default_view_id" != "null" ]]; then
      echo "Removing default table view to make board the default..." >&2
      
      local delete_mutation='
        mutation($viewId: ID!) {
          deleteProjectV2View(input: {
            viewId: $viewId
          }) {
            projectV2View {
              id
            }
          }
        }
      '
      
      if gh api graphql \
        -f query="$delete_mutation" \
        -f viewId="$default_view_id" >/dev/null 2>&1; then
        echo "✅ Deleted default table view - board is now the default!" >&2
      else
        echo "⚠️  Could not delete table view (board view still available)" >&2
      fi
    fi
  else
    echo "⚠️  Could not create board view (project still works)" >&2
  fi
}

# ============================================================================
# CUSTOM FIELDS SETUP
# ============================================================================

setup_custom_fields() {
  local project_id="$1"
  
  # Create "Current Agent" field
  create_single_select_field "$project_id" "Current Agent" \
    "Pending" "Rex (Implementation)" "Cleo (Quality)" "Cipher (Security)" "Tess (QA)" "Atlas (Integration)" "Bolt (Deployment)" "Complete ✅"
  
  # Create "Stage" field
  create_single_select_field "$project_id" "Stage" \
    "Pending" "Implementation" "Code Review" "Security Check" "QA Testing" "Done"
  
  # Create "Task ID" field (text)
  create_text_field "$project_id" "Task ID"
}

create_single_select_field() {
  local project_id="$1"
  local field_name="$2"
  shift 2
  local options=("$@")
  
  # Check if field already exists
  local existing_field=$(get_project_field "$project_id" "$field_name")
  if [[ -n "$existing_field" ]] && [[ "$existing_field" != "null" ]]; then
    return 0
  fi
  
  # Build options JSON
  local options_json="["
  local colors=("RED" "BLUE" "GREEN" "YELLOW" "ORANGE" "PURPLE" "PINK" "GRAY")
  for i in "${!options[@]}"; do
    local color="${colors[$((i % ${#colors[@]}))]}"
    options_json+="{\"name\": \"${options[$i]}\", \"color\": \"$color\"}"
    if [[ $i -lt $((${#options[@]} - 1)) ]]; then
      options_json+=","
    fi
  done
  options_json+="]"
  
  local mutation='
    mutation($projectId: ID!, $name: String!, $options: [ProjectV2SingleSelectFieldOptionInput!]!) {
      createProjectV2Field(input: {
        projectId: $projectId
        dataType: SINGLE_SELECT
        name: $name
        singleSelectOptions: $options
      }) {
        projectV2Field {
          ... on ProjectV2SingleSelectField {
            id
          }
        }
      }
    }
  '
  
  gh api graphql \
    -f query="$mutation" \
    -f projectId="$project_id" \
    -f name="$field_name" \
    -f options="$options_json" >/dev/null 2>&1 || true
}

create_text_field() {
  local project_id="$1"
  local field_name="$2"
  
  # Check if field already exists
  local existing_field=$(get_project_field "$project_id" "$field_name")
  if [[ -n "$existing_field" ]] && [[ "$existing_field" != "null" ]]; then
    return 0
  fi
  
  local mutation='
    mutation($projectId: ID!, $name: String!) {
      createProjectV2Field(input: {
        projectId: $projectId
        dataType: TEXT
        name: $name
      }) {
        projectV2Field {
          ... on ProjectV2Field {
            id
          }
        }
      }
    }
  '
  
  gh api graphql \
    -f query="$mutation" \
    -f projectId="$project_id" \
    -f name="$field_name" >/dev/null 2>&1 || true
}

get_project_field() {
  local project_id="$1"
  local field_name="$2"
  
  local query='
    query($projectId: ID!) {
      node(id: $projectId) {
        ... on ProjectV2 {
          fields(first: 20) {
            nodes {
              ... on ProjectV2Field {
                id
                name
              }
              ... on ProjectV2SingleSelectField {
                id
                name
              }
            }
          }
        }
      }
    }
  '
  
  gh api graphql \
    -f query="$query" \
    -f projectId="$project_id" \
    | jq -r --arg name "$field_name" \
      '.data.node.fields.nodes[] | select(.name == $name) | .id'
}

# ============================================================================
# ISSUE MANAGEMENT
# ============================================================================

add_issue_to_project() {
  local project_id="$1"
  local issue_node_id="$2"
  
  local mutation='
    mutation($projectId: ID!, $contentId: ID!) {
      addProjectV2ItemById(input: {
        projectId: $projectId
        contentId: $contentId
      }) {
        item {
          id
        }
      }
    }
  '
  
  local result=$(gh api graphql \
    -f query="$mutation" \
    -f projectId="$project_id" \
    -f contentId="$issue_node_id")
  
  # Check for errors in the response
  if echo "$result" | jq -e '.errors' >/dev/null 2>&1; then
    log "⚠️  GraphQL error adding issue to project:"
    echo "$result" | jq '.errors' >&2
    echo "null"
    return 1
  fi
  
  echo "$result" | jq -r '.data.addProjectV2ItemById.item.id'
}

# ============================================================================
# FIELD VALUE UPDATES
# ============================================================================

set_project_item_status() {
  local project_id="$1"
  local item_id="$2"
  local status="$3"
  
  local field_id=$(get_project_field "$project_id" "Stage")
  
  if [[ -z "$field_id" ]] || [[ "$field_id" == "null" ]]; then
    return 0
  fi
  
  local option_id=$(get_field_option_id "$project_id" "$field_id" "$status")
  
  if [[ -z "$option_id" ]] || [[ "$option_id" == "null" ]]; then
    return 0
  fi
  
  update_project_item_field "$project_id" "$item_id" "$field_id" "$option_id"
}

set_project_item_agent() {
  local project_id="$1"
  local item_id="$2"
  local agent="$3"
  
  local field_id=$(get_project_field "$project_id" "Current Agent")
  
  if [[ -z "$field_id" ]] || [[ "$field_id" == "null" ]]; then
    return 0
  fi
  
  local option_id=$(get_field_option_id "$project_id" "$field_id" "$agent")
  
  if [[ -z "$option_id" ]] || [[ "$option_id" == "null" ]]; then
    return 0
  fi
  
  update_project_item_field "$project_id" "$item_id" "$field_id" "$option_id"
}

set_project_item_priority() {
  local project_id="$1"
  local item_id="$2"
  local priority="$3"
  
  local field_id=$(get_project_field "$project_id" "Priority")
  
  if [[ -z "$field_id" ]] || [[ "$field_id" == "null" ]]; then
    return 0
  fi
  
  local priority_value="$priority"
  case "$priority" in
    "high") priority_value="High" ;;
    "medium") priority_value="Medium" ;;
    "low") priority_value="Low" ;;
  esac
  
  local option_id=$(get_field_option_id "$project_id" "$field_id" "$priority_value")
  
  if [[ -z "$option_id" ]] || [[ "$option_id" == "null" ]]; then
    return 0
  fi
  
  update_project_item_field "$project_id" "$item_id" "$field_id" "$option_id"
}

get_field_option_id() {
  local project_id="$1"
  local field_id="$2"
  local option_name="$3"
  
  local query='
    query($projectId: ID!) {
      node(id: $projectId) {
        ... on ProjectV2 {
          fields(first: 20) {
            nodes {
              ... on ProjectV2SingleSelectField {
                id
                options {
                  id
                  name
                }
              }
            }
          }
        }
      }
    }
  '
  
  local result=$(gh api graphql \
    -f query="$query" \
    -f projectId="$project_id")
  
  echo "$result" | jq -r \
    --arg field_id "$field_id" \
    --arg option_name "$option_name" \
    '.data.node.fields.nodes[] | select(.id == $field_id) | .options[] | select(.name == $option_name) | .id'
}

update_project_item_field() {
  local project_id="$1"
  local item_id="$2"
  local field_id="$3"
  local value="$4"
  
  local mutation='
    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
      updateProjectV2ItemFieldValue(input: {
        projectId: $projectId
        itemId: $itemId
        fieldId: $fieldId
        value: {
          singleSelectOptionId: $value
        }
      }) {
        projectV2Item {
          id
        }
      }
    }
  '
  
  gh api graphql \
    -f query="$mutation" \
    -f projectId="$project_id" \
    -f itemId="$item_id" \
    -f fieldId="$field_id" \
    -f value="$value" >/dev/null 2>&1 || true
}

# Export functions for use in other scripts
export -f graphql_query
export -f get_or_create_project
export -f setup_custom_fields
export -f create_single_select_field
export -f create_text_field
export -f get_project_field
export -f add_issue_to_project
export -f set_project_item_status
export -f set_project_item_agent
export -f set_project_item_priority
export -f get_field_option_id
export -f update_project_item_field

