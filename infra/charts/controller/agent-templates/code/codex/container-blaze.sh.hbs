#!/bin/bash
set -euo pipefail

# =========================================================================
# Blaze Frontend Agent - Codex CLI
# =========================================================================
# Automated React/Next.js/TypeScript frontend development with:
# - Next.js 15 + React 19 + TypeScript 5
# - shadcn/ui component library
# - Live Kubernetes deployment + Ngrok preview
# - Playwright E2E tests + screenshots
# - Automated PR creation with visual documentation
# =========================================================================

echo "ðŸŽ¨ Blaze Codex frontend workflow starting"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Task ID: {{task_id}}"
echo "Repository: {{repository_url}}"
echo "Service: {{service}}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Source the base container setup
{{> codex_container_base
    agent_banner=""
    agent_completion_message=""}}

# =========================================================================
# BLAZE-SPECIFIC FRONTEND WORKFLOW
# =========================================================================

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘           BLAZE FRONTEND WORKFLOW STARTING                  â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Ensure we're in the task workspace
cd "$TASK_WORKSPACE"

# Check if frontend scripts are available
SCRIPTS_DIR="/workspace/scripts/blaze"
if [ ! -d "$SCRIPTS_DIR" ]; then
    echo "âš ï¸  Blaze scripts not found at $SCRIPTS_DIR"
    echo "   Falling back to standard Codex workflow..."
    echo "âœ… Blaze Codex frontend implementation complete"
    exit 0
fi

echo "âœ… Blaze frontend scripts found"

# Step 1: Initialize Next.js project
echo ""
echo "ðŸ“¦ Step 1/5: Initializing Next.js + shadcn/ui project..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if bash "$SCRIPTS_DIR/init-nextjs-project.sh" "$CLAUDE_WORK_DIR"; then
    echo "âœ… Next.js project initialized successfully"
else
    echo "âŒ Next.js initialization failed"
    exit 1
fi

# Step 2: Let Codex implement the frontend
echo ""
echo "ðŸ’» Step 2/5: Running Codex for frontend implementation..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# The base template already runs Codex, so this step is already done
# Codex will generate React components based on the task requirements
echo "âœ… Codex frontend implementation complete"

# Step 3: Deploy to Kubernetes
echo ""
echo "ðŸš€ Step 3/5: Deploying to Kubernetes staging..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
export NAMESPACE="agent-platform"
export TASK_ID="{{task_id}}"
export SERVICE_NAME="{{service}}"
if bash "$SCRIPTS_DIR/deploy-to-k8s.sh" "{{task_id}}" "{{service}}" 1; then
    echo "âœ… Kubernetes deployment successful"
else
    echo "âš ï¸  Kubernetes deployment failed, continuing without live preview"
fi

# Step 4: Setup Ngrok live preview
echo ""
echo "ðŸŒ Step 4/5: Setting up Ngrok live preview URL..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
APP_NAME="task-{{task_id}}-{{service}}"
SERVICE_NAME="${APP_NAME}"
if bash "$SCRIPTS_DIR/setup-ngrok-ingress.sh" "$APP_NAME" "$SERVICE_NAME" 3000; then
    PREVIEW_URL=$(cat /workspace/preview_url.txt 2>/dev/null || echo "")
    if [ -n "$PREVIEW_URL" ]; then
        echo "âœ… Live preview available at: $PREVIEW_URL"
        export PREVIEW_URL
    else
        echo "âš ï¸  Preview URL not generated"
    fi
else
    echo "âš ï¸  Ngrok setup failed, continuing without live preview"
fi

# Step 5: Run Playwright tests and capture screenshots
echo ""
echo "ðŸŽ­ Step 5/5: Running Playwright E2E tests..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -n "${PREVIEW_URL:-}" ]; then
    export PREVIEW_URL
    if bash "$SCRIPTS_DIR/run-playwright-tests.sh" "$PREVIEW_URL" "{{task_id}}"; then
        echo "âœ… Playwright tests and screenshots complete"
        SCREENSHOTS_DIR="$CLAUDE_WORK_DIR/screenshots"
        if [ -d "$SCREENSHOTS_DIR" ]; then
            echo "ðŸ“¸ Screenshots saved to: $SCREENSHOTS_DIR"
            ls -lh "$SCREENSHOTS_DIR"/*.png 2>/dev/null || echo "   (no PNG files found)"
        fi
    else
        echo "âš ï¸  Playwright tests failed, continuing..."
    fi
else
    echo "âš ï¸  No preview URL available, skipping Playwright tests"
fi

# Step 6: Create PR with preview URL and screenshots
echo ""
echo "ðŸ“ Creating GitHub PR with live preview and screenshots..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# The base template handles PR creation, but we'll enhance it with frontend-specific info
# Save preview URL and screenshot info for the PR description
if [ -n "${PREVIEW_URL:-}" ]; then
    echo "" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "## ðŸŒ Live Preview" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "**[ðŸ‘‰ View Live Demo]($PREVIEW_URL)** â† Click to see the implementation" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "> ðŸ”— **Preview URL**: \`$PREVIEW_URL\`" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "> â° **Available until**: PR is merged (auto-cleanup after merge)" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "> ðŸ”„ **Updates live**: Every push to this branch updates the preview" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "" >> "$TASK_WORKSPACE/.blaze-preview-info"
fi

# Add screenshot section if screenshots exist
if [ -d "$CLAUDE_WORK_DIR/screenshots" ] && [ -n "$(ls -A "$CLAUDE_WORK_DIR/screenshots"/*.png 2>/dev/null)" ]; then
    echo "---" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "## ðŸ“¸ UI Screenshots" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "" >> "$TASK_WORKSPACE/.blaze-preview-info"
    
    # List available screenshots
    for screenshot in "$CLAUDE_WORK_DIR/screenshots"/*.png; do
        if [ -f "$screenshot" ]; then
            filename=$(basename "$screenshot")
            echo "- ðŸ“Ž $filename" >> "$TASK_WORKSPACE/.blaze-preview-info"
        fi
    done
    echo "" >> "$TASK_WORKSPACE/.blaze-preview-info"
    echo "_Screenshots will be attached to this PR_" >> "$TASK_WORKSPACE/.blaze-preview-info"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘         BLAZE FRONTEND WORKFLOW COMPLETE                    â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ… Next.js project initialized"
echo "âœ… React components implemented"
echo "âœ… Kubernetes deployment: ${PREVIEW_URL:+SUCCESS}"
echo "âœ… Live preview URL: ${PREVIEW_URL:-Not available}"
echo "âœ… Screenshots captured: $(ls "$CLAUDE_WORK_DIR/screenshots"/*.png 2>/dev/null | wc -l)"
echo ""
echo "ðŸŽ¨ Blaze Codex frontend implementation complete"
