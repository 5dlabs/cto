#!/bin/sh
# Atlas - Batch/End-of-Play Integration Check
# Ensures all PRs from a batch or entire Play workflow are cleanly integrated

INTEGRATION_TYPE="${INTEGRATION_TYPE:-end-of-play}"
BATCH_NUMBER="${BATCH_NUMBER:-}"

if [ "$INTEGRATION_TYPE" = "batch" ]; then
    echo "Atlas: Batch $BATCH_NUMBER integration check for Play workflow {{workflow_name}}"
else
    echo "Atlas: Final integration check for Play workflow {{workflow_name}}"
fi

# Source common setup
source /agent-templates/shared_task-setup-functions.sh 2>/dev/null || true

# Setup authentication
setup_github_auth

# Determine which PRs to check
if [ "$INTEGRATION_TYPE" = "batch" ] && [ -n "$BATCH_NUMBER" ]; then
    # Batch integration: Check PRs from specific batch
    BATCH_LABEL="batch-$BATCH_NUMBER"
    echo "Checking PRs with label: $BATCH_LABEL"
    PR_FILTER="--label $BATCH_LABEL"
else
    # End-of-play: Check all PRs from this workflow
    RUN_LABEL="run-{{workflow_name}}"
    SERVICE_LABEL="service-{{service}}"
    echo "Checking PRs with labels: $RUN_LABEL, $SERVICE_LABEL"
    PR_FILTER="--label $RUN_LABEL --label $SERVICE_LABEL"
fi

# Find all relevant PRs
eval "PRS=\$(gh pr list -R \"{{repository_url}}\" $PR_FILTER --json number,headRefName,mergeable,mergeStateStatus,state --jq '.[]')"

if [ -z "$PRS" ]; then
    if [ "$INTEGRATION_TYPE" = "batch" ]; then
        echo "No PRs found for batch $BATCH_NUMBER"
    else
        echo "No PRs found for this workflow run"
    fi
    exit 0
fi

TOTAL_PRS=$(echo "$PRS" | jq -s 'length')
if [ "$INTEGRATION_TYPE" = "batch" ]; then
    echo "Found $TOTAL_PRS PRs from batch $BATCH_NUMBER"
else
    echo "Found $TOTAL_PRS PRs from this Play workflow"
fi

# Check each PR status
OPEN_PRS=0
MERGED_PRS=0
CONFLICTED_PRS=0
CLEAN_PRS=0

echo "$PRS" | jq -c '.' | while read -r pr; do
    PR_NUM=$(echo "$pr" | jq -r '.number')
    PR_STATE=$(echo "$pr" | jq -r '.state')
    MERGEABLE=$(echo "$pr" | jq -r '.mergeable')
    
    echo "PR #$PR_NUM: state=$PR_STATE, mergeable=$MERGEABLE"
    
    if [ "$PR_STATE" = "MERGED" ]; then
        MERGED_PRS=$((MERGED_PRS + 1))
    elif [ "$PR_STATE" = "OPEN" ]; then
        OPEN_PRS=$((OPEN_PRS + 1))
        
        if [ "$MERGEABLE" = "CONFLICTING" ]; then
            CONFLICTED_PRS=$((CONFLICTED_PRS + 1))
            echo "  ‚ö†Ô∏è PR #$PR_NUM has conflicts - triggering Atlas conflict resolution"
            # TODO: Trigger individual Atlas CodeRun for this PR
        elif [ "$MERGEABLE" = "MERGEABLE" ]; then
            CLEAN_PRS=$((CLEAN_PRS + 1))
        fi
    fi
done

# Post summary comment to main PR or workflow tracking issue
if [ "$INTEGRATION_TYPE" = "batch" ]; then
    SUMMARY="## üîó Atlas Batch $BATCH_NUMBER Integration Report

**Play Workflow:** {{workflow_name}}
**Batch:** $BATCH_NUMBER
**Service:** {{service}}

### PR Status Summary
- **Total PRs in Batch:** $TOTAL_PRS
- **Merged:** $MERGED_PRS ‚úÖ
- **Open & Clean:** $CLEAN_PRS ‚úÖ
- **Open & Conflicted:** $CONFLICTED_PRS ‚ö†Ô∏è

### Batch Integration Status
"
else
    SUMMARY="## üîó Atlas Final Integration Report

**Play Workflow:** {{workflow_name}}
**Service:** {{service}}

### PR Status Summary
- **Total PRs:** $TOTAL_PRS
- **Merged:** $MERGED_PRS ‚úÖ
- **Open & Clean:** $CLEAN_PRS ‚úÖ
- **Open & Conflicted:** $CONFLICTED_PRS ‚ö†Ô∏è

### Final Integration Status
"
fi

if [ $CONFLICTED_PRS -eq 0 ] && [ $OPEN_PRS -eq 0 ]; then
    if [ "$INTEGRATION_TYPE" = "batch" ]; then
        SUMMARY="$SUMMARY
‚úÖ **Batch $BATCH_NUMBER complete - All PRs merged**

All tasks from batch $BATCH_NUMBER have been successfully integrated. Ready for next batch."
    else
        SUMMARY="$SUMMARY
‚úÖ **All PRs merged - Integration complete**

All tasks from this Play workflow have been successfully integrated into main."
    fi
elif [ $CONFLICTED_PRS -eq 0 ]; then
    SUMMARY="$SUMMARY
‚úÖ **No conflicts detected**

All open PRs are cleanly mergeable. Ready for review and merge."
else
    SUMMARY="$SUMMARY
‚ö†Ô∏è **Conflicts detected in $CONFLICTED_PRS PR(s)**

Atlas will attempt to resolve conflicts automatically."
fi

SUMMARY="$SUMMARY

---
*Batch integration check by Atlas*"

echo "$SUMMARY"

# Exit successfully - Atlas ran the integration check
exit 0

