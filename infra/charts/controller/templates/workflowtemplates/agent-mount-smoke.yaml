---
{{- if .Values.argo.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ include "controller.fullname" . }}-agent-mount-smoke
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: smoke-test
spec:
  entrypoint: smoke-test
  templates:
    - name: smoke-test
      container:
        image: alpine:3.20
        command: [sh, -c]
        args:
          - |
            echo "=== Agent Mount Smoke Test ==="
            echo "Checking /etc/agents directory..."
            ls -la /etc/agents/
            echo
            echo "Verifying agent prompt files exist..."
            {{- range $key, $agent := .Values.agents }}
            if [ -f "/etc/agents/{{ $agent.githubApp }}_system-prompt.md" ]; then
              echo "✓ {{ $agent.githubApp }}_system-prompt.md exists ({{ $agent.name }})"
            else
              echo "✗ {{ $agent.githubApp }}_system-prompt.md missing ({{ $agent.name }})"
              exit 1
            fi
            {{- end }}
            echo
            echo "Checking agents.yaml metadata..."
            if [ -f "/etc/agents/agents.yaml" ]; then
              echo "✓ agents.yaml exists"
              grep -c "name:" /etc/agents/agents.yaml
            else
              echo "✗ agents.yaml missing"
              exit 1
            fi
            echo
            echo "=== All checks passed! ==="
            echo "OK"
        volumeMounts:
{{ include "platform.agentVolumeMounts" . | nindent 10 }}
{{ include "platform.agentTemplateVolumeMounts" . | nindent 10 }}
  volumes:
{{ include "platform.agentVolumes" . | nindent 4 }}
{{ include "platform.agentTemplateProjectedVolume" . | nindent 4 }}
{{- end }}
