{{- if .Values.argo.enabled }}
---
# Stage Transitions Sensor for Multi-Agent Workflow Orchestration
# This sensor handles GitHub webhook events and manages workflow stage transitions

apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: stage-transitions-sensor
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: stage-transitions-sensor
    app.kubernetes.io/part-of: platform
spec:
  template:
    serviceAccountName: operate-workflow-sa

  # GitHub webhook event dependencies
  dependencies:
    # PR Creation Event
    - name: github-pr-created
      eventSourceName: github
      eventName: pull_request
      filters:
        data:
          - path: headers.X-Github-Event
            type: string
            value:
              - pull_request
          - path: body.action
            type: string
            value:
              - opened
          - path: body.pull_request.state
            type: string
            value:
              - open

    # Ready for QA Label Event
    - name: github-ready-for-qa
      eventSourceName: github
      eventName: pull_request
      filters:
        data:
          - path: headers.X-Github-Event
            type: string
            value:
              - pull_request
          - path: body.action
            type: string
            value:
              - labeled
          - path: body.label.name
            type: string
            value:
              - ready-for-qa

    # PR Approval Event
    - name: github-pr-approved
      eventSourceName: github
      eventName: pull_request_review
      filters:
        data:
          - path: headers.X-Github-Event
            type: string
            value:
              - pull_request_review
          - path: body.review.state
            type: string
            value:
              - approved
          - path: body.sender.login
            type: string
            value:
              - 5DLabs-Tess[bot]

  # Stage-specific workflow resumption triggers
  triggers:
    # Resume workflows waiting for PR creation
    - template:
        name: resume-pr-created
        argoWorkflow:
          operation: resume
          parameters:
            - src:
                dependencyName: github-pr-created
                dataTemplate: |
                  {{`{{- range .Input.body.pull_request.labels -}}`}}
                  {{`{{- if hasPrefix "task-" .name -}}`}}
                  {{`{{- $parts := splitList "-" .name -}}`}}
                  {{`{{- if gt (len $parts) 1 -}}`}}
                  play-task-{{`{{- index $parts 1 -}}`}}-workflow
                  {{`{{- end -}}`}}
                  {{`{{- end -}}`}}
                  {{`{{- end -}}`}}
              dest: args.0
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                labels:
                  current-stage: waiting-pr-created

    # Resume workflows waiting for ready-for-qa
    - template:
        name: resume-ready-for-qa
        argoWorkflow:
          operation: resume
          parameters:
            - src:
                dependencyName: github-ready-for-qa
                dataTemplate: |
                  {{`{{- range .Input.body.pull_request.labels -}}`}}
                  {{`{{- if hasPrefix "task-" .name -}}`}}
                  {{`{{- $parts := splitList "-" .name -}}`}}
                  {{`{{- if gt (len $parts) 1 -}}`}}
                  play-task-{{`{{- index $parts 1 -}}`}}-workflow
                  {{`{{- end -}}`}}
                  {{`{{- end -}}`}}
                  {{`{{- end -}}`}}
              dest: args.0
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                labels:
                  current-stage: waiting-ready-for-qa

    # Resume workflows waiting for PR approval
    - template:
        name: resume-pr-approved
        argoWorkflow:
          operation: resume
          parameters:
            - src:
                dependencyName: github-pr-approved
                dataTemplate: |
                  {{`{{- range .Input.body.pull_request.labels -}}`}}
                  {{`{{- if hasPrefix "task-" .name -}}`}}
                  {{`{{- $parts := splitList "-" .name -}}`}}
                  {{`{{- if gt (len $parts) 1 -}}`}}
                  play-task-{{`{{- index $parts 1 -}}`}}-workflow
                  {{`{{- end -}}`}}
                  {{`{{- end -}}`}}
                  {{`{{- end -}}`}}
              dest: args.0
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                labels:
                  current-stage: waiting-pr-approved
{{- end }}
