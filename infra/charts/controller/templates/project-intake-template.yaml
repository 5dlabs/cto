{{- if .Values.argo.enabled }}
---
# Argo Workflow Template for Unified Project Intake
# This template processes new project PRDs, generates tasks,
# enriches context via Firecrawl, and creates comprehensive documentation
# in a single operation.

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: project-intake
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: project-intake
spec:
  arguments:
    parameters:
      - name: configmap-name
        description: "Name of the ConfigMap containing intake files"
      - name: project-name
        description: "Project name (auto-detected if not provided)"
        value: ""
      - name: repository-url
        description: "Target repository for the generated project - auto-detected from git"
        # NO DEFAULT - auto-detected by MCP/script
      - name: source-branch
        description: "Source branch to work from - auto-detected from git"
        # NO DEFAULT - auto-detected by MCP/script
      - name: github-app
        description: "GitHub App to use for authentication - REQUIRED from client config"
        # NO DEFAULT - must be provided by MCP client from config
      - name: primary-model
        description: "Primary AI model for main operations (task expansion) - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: research-model
        description: "Research AI model for PRD analysis and codebase understanding - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: fallback-model
        description: "Fallback AI model when primary fails - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: primary-provider
        description: "Primary AI provider (anthropic, openai, claude-code, etc.) - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: research-provider
        description: "Research AI provider (claude-code, anthropic, etc.) - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: fallback-provider
        description: "Fallback AI provider - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: num-tasks
        description: "Target number of tasks to generate - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: expand-tasks
        description: "Whether to expand tasks with subtasks - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      - name: analyze-complexity
        description: "Whether to analyze task complexity - REQUIRED from client"
        # NO DEFAULT - must be provided by MCP client
      # Unified intake parameters (docs generation)
      - name: docs-model
        description: "Model for documentation generation - defaults to primary model"
        value: ""
      - name: enrich-context
        description: "Whether to enrich context via Firecrawl - defaults to true"
        value: "true"
      - name: include-codebase
        description: "Whether to include existing codebase context - defaults to false"
        value: "false"
      - name: cli
        description: "CLI to use for documentation generation (claude, cursor, codex)"
        value: "claude"
      # Linear integration parameters (optional)
      - name: linear-session-id
        description: "Linear agent session ID for callbacks"
        value: ""
      - name: linear-issue-id
        description: "Linear issue ID for callbacks"
        value: ""
      - name: linear-team-id
        description: "Linear team ID for callbacks"
        value: ""
      - name: linear-callback-url
        description: "Linear service callback URL"
        value: "http://linear-svc.cto.svc.cluster.local:8081"

  # Service account for workflow execution
  serviceAccountName: argo-workflow
  
  # Exit handler for callbacks (including Linear)
  onExit: exit-handler

  # Workflow timeout (2 hours for intake processing)
  activeDeadlineSeconds: 7200

  # Main workflow entrypoint
  entrypoint: intake-main

  templates:
    # Main intake execution flow
    - name: intake-main
      steps:
      - - name: generate-intake-config
          template: generate-intake-config
          arguments:
            parameters:
            - name: configmap-name
              value: "{{`{{workflow.parameters.configmap-name}}`}}"
            - name: project-name
              value: "{{`{{workflow.parameters.project-name}}`}}"
            - name: repository-url
              value: "{{`{{workflow.parameters.repository-url}}`}}"
            - name: github-app
              value: "{{`{{workflow.parameters.github-app}}`}}"
            - name: primary-model
              value: "{{`{{workflow.parameters.primary-model}}`}}"
            - name: research-model
              value: "{{`{{workflow.parameters.research-model}}`}}"
            - name: fallback-model
              value: "{{`{{workflow.parameters.fallback-model}}`}}"
            - name: primary-provider
              value: "{{`{{workflow.parameters.primary-provider}}`}}"
            - name: research-provider
              value: "{{`{{workflow.parameters.research-provider}}`}}"
            - name: fallback-provider
              value: "{{`{{workflow.parameters.fallback-provider}}`}}"
            - name: num-tasks
              value: "{{`{{workflow.parameters.num-tasks}}`}}"
            - name: expand-tasks
              value: "{{`{{workflow.parameters.expand-tasks}}`}}"
            - name: analyze-complexity
              value: "{{`{{workflow.parameters.analyze-complexity}}`}}"

      - - name: run-intake
          template: intake-container
          arguments:
            parameters:
            - name: configmap-name
              value: "{{`{{steps.generate-intake-config.outputs.parameters.configmap-name}}`}}"

      - - name: cleanup-config
          template: cleanup-intake-config
          arguments:
            parameters:
            - name: configmap-name
              value: "{{`{{steps.generate-intake-config.outputs.parameters.configmap-name}}`}}"

    # Generate intake configuration
    - name: generate-intake-config
      inputs:
        parameters:
        - name: configmap-name
        - name: project-name
        - name: repository-url
        - name: github-app
        - name: primary-model
        - name: research-model
        - name: fallback-model
        - name: primary-provider
        - name: research-provider
        - name: fallback-provider
        - name: num-tasks
        - name: expand-tasks
        - name: analyze-complexity
      outputs:
        parameters:
        - name: configmap-name
          valueFrom:
            path: /tmp/configmap-name
      script:
        image: {{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}
        command: ["/bin/sh"]
        source: |
          #!/bin/sh
          set -e

          # ConfigMap already created by MCP server, just pass it through
          echo "Using ConfigMap: {{`{{inputs.parameters.configmap-name}}`}}"

          # Output the ConfigMap name for the next step
          echo "{{`{{inputs.parameters.configmap-name}}`}}" > /tmp/configmap-name
          echo "ConfigMap created successfully"

    # Run the intake container
    - name: intake-container
      inputs:
        parameters:
        - name: configmap-name
      container:
        image: {{ .Values.agent.image.repository }}:{{ .Values.agent.image.tag | default "latest" }}
        imagePullPolicy: {{ .Values.agent.image.pullPolicy | default "IfNotPresent" }}
        command: ["/bin/bash"]
        args: ["/templates/intake_unified-intake.sh"]
        workingDir: /workspace
        volumeMounts:
          - name: intake-files
            mountPath: /intake-files
            readOnly: true
          - name: templates
            mountPath: /templates
            readOnly: true
          - name: agents-config
            mountPath: /config/agents
            readOnly: true
        env:
          - name: ANTHROPIC_API_KEY
            valueFrom:
              secretKeyRef:
                name: cto-secrets
                key: ANTHROPIC_API_KEY
          - name: OPENAI_API_KEY
            valueFrom:
              secretKeyRef:
                name: cto-secrets
                key: OPENAI_API_KEY
          # GitHub App credentials - use the standardized secret name
          # All GitHub App secrets follow the pattern: github-app-{normalized-name}
          - name: GITHUB_APP_ID
            valueFrom:
              secretKeyRef:
                name: github-app-5dlabs-morgan
                key: app-id
                optional: true
          - name: GITHUB_APP_PRIVATE_KEY
            valueFrom:
              secretKeyRef:
                name: github-app-5dlabs-morgan
                key: private-key
                optional: true
          - name: GITHUB_APP_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: github-app-5dlabs-morgan
                key: client-id
                optional: true
          - name: GITHUB_APP_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: github-app-5dlabs-morgan
                key: client-secret
                optional: true
          # Intake model and provider configuration
          - name: GITHUB_APP
            value: "{{`{{workflow.parameters.github-app}}`}}"
          - name: PRIMARY_MODEL
            value: "{{`{{workflow.parameters.primary-model}}`}}"
          - name: RESEARCH_MODEL
            value: "{{`{{workflow.parameters.research-model}}`}}"
          - name: FALLBACK_MODEL
            value: "{{`{{workflow.parameters.fallback-model}}`}}"
          - name: PRIMARY_PROVIDER
            value: "{{`{{workflow.parameters.primary-provider}}`}}"
          - name: RESEARCH_PROVIDER
            value: "{{`{{workflow.parameters.research-provider}}`}}"
          - name: FALLBACK_PROVIDER
            value: "{{`{{workflow.parameters.fallback-provider}}`}}"
          - name: NUM_TASKS
            value: "{{`{{workflow.parameters.num-tasks}}`}}"
          - name: EXPAND_TASKS
            value: "{{`{{workflow.parameters.expand-tasks}}`}}"
          - name: ANALYZE_COMPLEXITY
            value: "{{`{{workflow.parameters.analyze-complexity}}`}}"
          # Unified intake: docs generation parameters
          - name: DOCS_MODEL
            value: "{{`{{workflow.parameters.docs-model}}`}}"
          - name: ENRICH_CONTEXT
            value: "{{`{{workflow.parameters.enrich-context}}`}}"
          - name: INCLUDE_CODEBASE
            value: "{{`{{workflow.parameters.include-codebase}}`}}"
          # CLI for documentation generation phase
          - name: CLI
            value: "{{`{{workflow.parameters.cli}}`}}"
          # Linear OAuth token for streaming status updates
          - name: LINEAR_OAUTH_TOKEN
            valueFrom:
              secretKeyRef:
                name: linear-secrets
                key: LINEAR_OAUTH_TOKEN
                optional: true
      volumes:
        - name: intake-files
          configMap:
            name: "{{`{{inputs.parameters.configmap-name}}`}}"
{{ include "platform.agentTemplateProjectedVolume" . | nindent 8 }}
        - name: agents-config
          configMap:
            name: {{ include "controller.fullname" . }}-agents

    # Cleanup the temporary ConfigMap
    - name: cleanup-intake-config
      inputs:
        parameters:
        - name: configmap-name
      script:
        image: bitnami/kubectl:latest
        command: ["/bin/sh"]
        source: |
          #!/bin/sh
          echo "Cleaning up ConfigMap: {{`{{inputs.parameters.configmap-name}}`}}"
          # Delete from the same namespace where the workflow runs (cto)
          kubectl delete configmap "{{`{{inputs.parameters.configmap-name}}`}}" \
            -n {{ .Release.Namespace }} \
            --ignore-not-found=true
          echo "Cleanup complete"

    # Exit handler for Linear callbacks
    # Note: The main task callback is now sent directly from the intake script.
    # This exit handler only sends a status update for failed workflows.
    - name: exit-handler
      script:
        image: curlimages/curl:8.5.0
        command: ["/bin/sh"]
        source: |
          #!/bin/sh
          set -e
          
          SESSION_ID="{{`{{workflow.parameters.linear-session-id}}`}}"
          ISSUE_ID="{{`{{workflow.parameters.linear-issue-id}}`}}"
          ISSUE_IDENTIFIER="{{`{{workflow.parameters.linear-issue-identifier}}`}}"
          TEAM_ID="{{`{{workflow.parameters.linear-team-id}}`}}"
          CALLBACK_URL="{{`{{workflow.parameters.linear-callback-url}}`}}"
          WORKFLOW_STATUS="{{`{{workflow.status}}`}}"
          
          # Skip if no Linear session configured
          if [ -z "$SESSION_ID" ] || [ "$SESSION_ID" = "" ]; then
            echo "No Linear session configured, skipping callback"
            exit 0
          fi
          
          echo "Exit handler running..."
          echo "  Session ID: $SESSION_ID"
          echo "  Issue Identifier: $ISSUE_IDENTIFIER"
          echo "  Workflow Status: $WORKFLOW_STATUS"
          
          # Only send callback if workflow failed
          # Success callbacks are sent directly from the intake script
          if [ "$WORKFLOW_STATUS" != "Succeeded" ]; then
            echo "Workflow failed - sending error callback to Linear"
            
            PAYLOAD=$(cat <<EOF
          {
            "sessionId": "$SESSION_ID",
            "issueId": "$ISSUE_ID",
            "issueIdentifier": "$ISSUE_IDENTIFIER",
            "teamId": "$TEAM_ID",
            "workflowName": "{{`{{workflow.name}}`}}",
            "tasks": [],
            "success": false,
            "error": "Intake workflow failed with status: $WORKFLOW_STATUS"
          }
          EOF
          )
            
            curl -s -X POST "$CALLBACK_URL/callbacks/intake-complete" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" || echo "Warning: Callback failed"
          else
            echo "Workflow succeeded - tasks callback already sent from intake script"
          fi
          
          echo "Exit handler complete"

  # TTL strategy for workflow cleanup
  ttlStrategy:
    secondsAfterCompletion: 86400    # Keep completed workflows for 24 hours
    secondsAfterFailure: 259200      # Keep failed workflows for 3 days
    secondsAfterSuccess: 86400       # Keep successful workflows for 24 hours

  # Pod garbage collection
  # Delete delay increased from 60s to 300s to allow heal system to capture logs
  # before pods are cleaned up (fixes issue #2576 - A2 alerts with missing logs)
  podGC:
    strategy: OnPodCompletion
    deleteDelayDuration: 300s

{{- end }}
