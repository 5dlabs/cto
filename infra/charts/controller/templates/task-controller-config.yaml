---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "controller.fullname" . }}-task-controller-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "controller.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Task Controller Configuration
    # Simplified configuration for CodeRun and DocsRun controllers

    # Job configuration
    job:
      activeDeadlineSeconds: 3600  # 1 hour timeout

    # Claude agent configuration
    agent:
      image:
        repository: {{ .Values.agent.image.repository | quote }}
        tag: {{ .Values.agent.image.tag | quote }}
      {{- /* Compute effective ServiceAccount: prefer non-empty agent.serviceAccountName; else cluster-admin SA if created; else omit */ -}}
      {{- $explicitSA := "" -}}
      {{- if (hasKey .Values "agent") }}
      {{- if (hasKey .Values.agent "serviceAccountName") }}
      {{- $explicitSA = (trim .Values.agent.serviceAccountName) -}}
      {{- end }}
      {{- end }}
      {{- $fallbackSA := "" -}}
      {{- if .Values.rbac.submitter.clusterAdminServiceAccount.create -}}
      {{- $fallbackSA = .Values.rbac.submitter.clusterAdminServiceAccount.name -}}
      {{- end -}}
      {{- $effectiveSA := coalesce $explicitSA $fallbackSA -}}
      {{- if $effectiveSA }}
      serviceAccountName: {{ $effectiveSA | quote }}
      {{- end }}
      imagePullSecrets:
        {{- range .Values.imagePullSecrets }}
        - {{ .name | quote }}
        {{- end }}
      inputBridge:
        enabled: {{ .Values.agent.inputBridge.enabled | default false }}
        image:
          repository: {{ .Values.agent.inputBridge.image.repository | default "" | quote }}
          tag: {{ .Values.agent.inputBridge.image.tag | default "" | quote }}
        port: {{ .Values.agent.inputBridge.port | default 8080 }}

    # Secrets configuration (references Kubernetes secrets)
    secrets:
      apiKeySecretName: "agent-platform-secrets"
      apiKeySecretKey: "ANTHROPIC_API_KEY"

    # Tool permissions configuration (only used when agentToolsOverride=true)
    # When false: uses hardcoded list in settings.json.hbs template
    # When true: uses this configuration
    permissions:
      agentToolsOverride: false
      allow:
        - "Bash"
        - "Edit"
        - "Read"
        - "Write"
        - "MultiEdit"
        - "Glob"
        - "Grep"
        - "LS"
        - "Task"
        - "ExitPlanMode"
        - "NotebookRead"
        - "NotebookEdit"
        - "WebFetch"
        - "WebSearch"
        - "TodoRead"
        - "TodoWrite"
      deny: []

    # Telemetry configuration (used in templates)
    telemetry:
      enabled: true
      otlpEndpoint: "otel-collector-opentelemetry-collector.telemetry.svc.cluster.local:4317"
      otlpProtocol: "grpc"
      logsEndpoint: "otel-collector-opentelemetry-collector.telemetry.svc.cluster.local:4317"
      logsProtocol: "grpc"

    # Storage configuration
    storage:
      {{- if .Values.storage.storageClassName }}
      storageClassName: {{ .Values.storage.storageClassName | quote }}
      {{- end }}
      workspaceSize: {{ .Values.storage.workspaceSize | default "10Gi" | quote }}

    # Cleanup configuration (event-driven cleanup by controller)
    cleanup:
      enabled: {{ .Values.cleanup.enabled | default true }}
      completedJobDelayMinutes: {{ .Values.cleanup.completedJobDelayMinutes | default 5 }}
      failedJobDelayMinutes: {{ .Values.cleanup.failedJobDelayMinutes | default 60 }}
      deleteConfigMap: {{ .Values.cleanup.deleteConfigMap | default true }}
