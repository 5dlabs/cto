{{- if .Values.research.enabled }}
---
# PersistentVolumeClaim for research data storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: research-data
  namespace: {{ include "cto.namespace" . }}
  labels:
    app.kubernetes.io/name: research-data
    app.kubernetes.io/part-of: research
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.research.persistence.size | default "5Gi" }}
  storageClassName: {{ .Values.research.persistence.storageClass | default .Values.storageClass | default "local-path" }}

---
# ServiceAccount for research CronJob
apiVersion: v1
kind: ServiceAccount
metadata:
  name: research
  namespace: {{ include "cto.namespace" . }}
  labels:
    app.kubernetes.io/name: research
    app.kubernetes.io/part-of: research

---
# CronJob that polls Twitter bookmarks
apiVersion: batch/v1
kind: CronJob
metadata:
  name: research-poller
  namespace: {{ include "cto.namespace" . }}
  labels:
    app.kubernetes.io/name: research-poller
    app.kubernetes.io/part-of: research
spec:
  schedule: {{ .Values.research.schedule | default "*/5 * * * *" | quote }}
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 1
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: research-poller
        spec:
          serviceAccountName: research
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          restartPolicy: OnFailure
          {{- include "cto.imagePullSecrets" . | nindent 10 }}
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node-role.kubernetes.io/control-plane
                        operator: DoesNotExist
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: research-data
          containers:
            - name: research
              image: "{{ include "cto.imageRef" (dict "component" "research" "image" .Values.research.image "global" .Values.global) }}"
              imagePullPolicy: {{ include "cto.imagePullPolicy" (dict "image" .Values.research.image "global" .Values.global) }}
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: false
              args:
                - poll
                - --output=/data/research
                - --state=/data/state.json
                - --min-relevance={{ .Values.research.minRelevance | default "0.5" }}
                - --batch-size={{ .Values.research.batchSize | default "10" }}
                - --model={{ .Values.research.model | default "claude-sonnet-4-20250514" }}
                {{- if .Values.research.createPR }}
                - --create-pr
                - --repo={{ .Values.research.repo | default "5dlabs/cto" }}
                - --base-branch={{ .Values.research.baseBranch | default "develop" }}
                - --research-dir={{ .Values.research.researchDir | default "docs/research" }}
                {{- end }}
              volumeMounts:
                - name: data
                  mountPath: /data
              env:
                - name: GITHUB_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: tools-github-secrets
                      key: GITHUB_PERSONAL_ACCESS_TOKEN
              envFrom:
                - secretRef:
                    name: research-twitter-secrets
                - secretRef:
                    name: cto-secrets
                - secretRef:
                    name: tools-firecrawl-secrets
              resources:
                {{- toYaml .Values.research.resources | nindent 16 }}

---
# CronJob that sends email digests of new research entries
{{- if .Values.research.digest.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: research-digest
  namespace: {{ include "cto.namespace" . }}
  labels:
    app.kubernetes.io/name: research-digest
    app.kubernetes.io/part-of: research
spec:
  schedule: {{ .Values.research.digest.schedule | default "0 13 * * *" | quote }}
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 1
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: research-digest
        spec:
          serviceAccountName: research
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          restartPolicy: OnFailure
          {{- include "cto.imagePullSecrets" . | nindent 10 }}
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node-role.kubernetes.io/control-plane
                        operator: DoesNotExist
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: research-data
          containers:
            - name: research
              image: "{{ include "cto.imageRef" (dict "component" "research" "image" .Values.research.image "global" .Values.global) }}"
              imagePullPolicy: {{ include "cto.imagePullPolicy" (dict "image" .Values.research.image "global" .Values.global) }}
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: false
              args:
                - digest
                - --dir=/data/research
                - --state=/data/digest-state.json
                - --check-and-send
                - --hours-between={{ .Values.research.digest.hoursBetween | default "24" }}
                - --model={{ .Values.research.digest.model | default .Values.research.model | default "claude-sonnet-4-20250514" }}
                {{- if .Values.research.digest.skipAnalysis }}
                - --skip-analysis
                {{- end }}
              volumeMounts:
                - name: data
                  mountPath: /data
              envFrom:
                - secretRef:
                    name: research-twitter-secrets
                - secretRef:
                    name: cto-secrets
                - secretRef:
                    name: tools-firecrawl-secrets
                - secretRef:
                    name: {{ .Values.research.digest.secretName | default "research-digest-secrets" }}
              resources:
                {{- toYaml .Values.research.resources | nindent 16 }}
{{- end }}
{{- end }}

