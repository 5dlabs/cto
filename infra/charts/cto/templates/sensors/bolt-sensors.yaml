{{- if and .Values.sensors.enabled .Values.sensors.bolt.enabled }}
{{- $automationNs := include "cto.automationNamespace" . }}
{{- $ctoNs := include "cto.namespace" . }}

{{- if .Values.sensors.bolt.production.enabled }}
---
# Bolt Production Deployment Sensor
# Triggers on PR merged with ready-for-production label
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: bolt-production-deployment
  namespace: {{ $automationNs }}
  labels:
    {{- include "cto.sensor.labels" . | nindent 4 }}
    agent: bolt
    mode: production
spec:
  template:
    serviceAccountName: argo-events-sa

  dependencies:
    - name: pr-merged
      eventSourceName: github
      eventName: org
      filters:
        data:
          # Trigger on PR merged events
          - path: headers.X-GitHub-Event
            type: string
            value:
              - pull_request
          # Only when PR is closed via merge
          - path: body.action
            type: string
            value:
              - closed
          - path: body.pull_request.merged
            type: bool
            value:
              - "true"
          # Filter for ready-for-production label (set by Tess)
          - path: body.pull_request.labels.[?(@.name=="ready-for-production")].name
            type: string
            value:
              - ready-for-production

  triggers:
    - template:
        name: bolt-deployment-validation
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform.5dlabs.ai/v1alpha1
              kind: CodeRun
              metadata:
                generateName: coderun-bolt-deploy-
                namespace: {{ $ctoNs }}
                labels:
                  agent: bolt
                  trigger: deployment-status
              spec:
                githubApp: "5DLabs-Bolt"
                cli: "Claude"
                model: "claude-sonnet-4-5-20250929"
                maxTokens: 4096
                temperature: 0.3
                repositoryUrl: ""
                env:
                  - name: DEPLOYMENT_STATE
                    value: ""
                  - name: DEPLOYMENT_URL
                    value: ""
                  - name: PR_NUMBER
                    value: ""
                  - name: SERVICE
                    value: ""

        parameters:
          - src:
              dependencyName: pr-merged
              dataKey: body.pull_request.number
            dest: spec.env.0.value

          - src:
              dependencyName: pr-merged
              dataKey: body.pull_request.head.ref
            dest: spec.env.1.value

          - src:
              dependencyName: pr-merged
              dataKey: body.repository.clone_url
            dest: spec.repositoryUrl

          - src:
              dependencyName: pr-merged
              dataKey: body.pull_request.head.repo.name
            dest: spec.env.2.value
{{- end }}

{{- if .Values.sensors.bolt.preview.enabled }}
---
# Bolt Preview Deployment Sensor
# Triggers on PR opened/updated to create preview deployments
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: bolt-preview-deployment
  namespace: {{ $automationNs }}
  labels:
    {{- include "cto.sensor.labels" . | nindent 4 }}
    agent: bolt
    mode: preview
spec:
  template:
    serviceAccountName: argo-events-sa

  dependencies:
    - name: pr-opened
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: headers.X-GitHub-Event
            type: string
            value:
              - pull_request
          - path: body.action
            type: string
            value:
              - opened
              - synchronize
              - reopened

  triggers:
    - template:
        name: bolt-preview-deployment
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform.5dlabs.ai/v1alpha1
              kind: CodeRun
              metadata:
                generateName: coderun-bolt-preview-
                namespace: {{ $ctoNs }}
                labels:
                  agent: bolt
                  mode: preview
                  trigger: pr-event
              spec:
                githubApp: "5DLabs-Bolt"
                cli: "Claude"
                model: "claude-sonnet-4-5-20250929"
                maxTokens: 4096
                temperature: 0.3
                repositoryUrl: ""
                env:
                  - name: BOLT_MODE
                    value: "preview"
                  - name: PR_NUMBER
                    value: ""
                  - name: PR_BRANCH
                    value: ""
                  - name: PR_ACTION
                    value: ""
                  - name: TASK_ID
                    value: ""
                  - name: SERVICE_NAME
                    value: ""

        parameters:
          - src:
              dependencyName: pr-opened
              dataKey: body.pull_request.number
            dest: spec.env.1.value
          - src:
              dependencyName: pr-opened
              dataKey: body.pull_request.head.ref
            dest: spec.env.2.value
          - src:
              dependencyName: pr-opened
              dataKey: body.action
            dest: spec.env.3.value
          - src:
              dependencyName: pr-opened
              dataKey: body.repository.clone_url
            dest: spec.repositoryUrl
          - src:
              dependencyName: pr-opened
              dataKey: body.pull_request.head.repo.name
            dest: spec.env.5.value

---
# Bolt Preview Cleanup Sensor
# Triggers when PR is closed to clean up preview environments
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: bolt-preview-cleanup
  namespace: {{ $automationNs }}
  labels:
    {{- include "cto.sensor.labels" . | nindent 4 }}
    agent: bolt
    mode: cleanup
spec:
  template:
    serviceAccountName: argo-events-sa

  dependencies:
    - name: pr-closed
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: headers.X-GitHub-Event
            type: string
            value:
              - pull_request
          - path: body.action
            type: string
            value:
              - closed

  triggers:
    - template:
        name: bolt-preview-cleanup
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform.5dlabs.ai/v1alpha1
              kind: CodeRun
              metadata:
                generateName: coderun-bolt-cleanup-
                namespace: {{ $ctoNs }}
                labels:
                  agent: bolt
                  mode: cleanup
                  trigger: pr-closed
              spec:
                githubApp: "5DLabs-Bolt"
                cli: "Claude"
                model: "claude-sonnet-4-5-20250929"
                maxTokens: 2048
                temperature: 0.3
                repositoryUrl: ""
                env:
                  - name: BOLT_MODE
                    value: "cleanup"
                  - name: PR_NUMBER
                    value: ""
                  - name: PR_MERGED
                    value: ""
                  - name: TASK_ID
                    value: ""

        parameters:
          - src:
              dependencyName: pr-closed
              dataKey: body.pull_request.number
            dest: spec.env.1.value
          - src:
              dependencyName: pr-closed
              dataKey: body.pull_request.merged
            dest: spec.env.2.value
          - src:
              dependencyName: pr-closed
              dataKey: body.repository.clone_url
            dest: spec.repositoryUrl
{{- end }}

{{- if .Values.sensors.bolt.monitor.enabled }}
---
# Bolt Monitor Daemon Sensor
# Runs on schedule to check ALL ArgoCD applications
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: bolt-monitor-daemon
  namespace: {{ $automationNs }}
  labels:
    {{- include "cto.sensor.labels" . | nindent 4 }}
    agent: bolt
    mode: monitor
spec:
  template:
    serviceAccountName: argo-events-sa

  dependencies:
    - name: monitor-trigger
      eventSourceName: calendar
      eventName: monitor-interval
      filters:
        time:
          start: "0 * * * * *"
          stop: "30 * * * * *"

  triggers:
    - template:
        name: bolt-monitor-check
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform.5dlabs.ai/v1alpha1
              kind: CodeRun
              metadata:
                generateName: coderun-bolt-monitor-
                namespace: {{ $ctoNs }}
                labels:
                  agent: bolt
                  mode: monitor
                  trigger: scheduled
              spec:
                githubApp: "5DLabs-Bolt"
                cli: "Claude"
                model: "claude-sonnet-4-5-20250929"
                maxTokens: 4096
                temperature: 0.3
                repositoryUrl: "https://github.com/5dlabs/cto.git"
                env:
                  - name: BOLT_MODE
                    value: "monitor"
                  - name: CHECK_INTERVAL
                    value: "30"
                  - name: UPDATE_ON_CHANGE_ONLY
                    value: "true"

---
# Calendar EventSource for scheduled monitoring
apiVersion: argoproj.io/v1alpha1
kind: EventSource
metadata:
  name: calendar
  namespace: {{ $automationNs }}
  labels:
    {{- include "cto.sensor.labels" . | nindent 4 }}
spec:
  calendar:
    monitor-interval:
      interval: 30s
      exclusionDates: []
      timezone: UTC
{{- end }}

{{- end }}


