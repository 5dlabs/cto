{{- if and .Values.sensors.enabled .Values.sensors.ciRemediation.enabled }}
{{- $automationNs := include "cto.automationNamespace" . }}
{{- $ctoNs := include "cto.namespace" . }}
---
# CI Failure Remediation Sensor
# Triggers Atlas to fix CI failures automatically
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: ci-failure-remediation
  namespace: {{ $automationNs }}
  labels:
    {{- include "cto.sensor.labels" . | nindent 4 }}
    app: ci-remediation
    component: failure-sensor
spec:
  replicas: 1
  deploymentStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    serviceAccountName: argo-events-sa
    container:
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "256Mi"
          cpu: "300m"
  dependencies:
    - name: workflow-failure
      eventSourceName: github
      eventName: org
      filters:
        data:
          # Only workflow_run events
          - path: body.X-GitHub-Event
            type: string
            value: ["workflow_run"]
          # Only completed workflows
          - path: body.action
            type: string
            value: ["completed"]
          # Only failures
          - path: body.workflow_run.conclusion
            type: string
            value: ["failure"]
          # Only 5dlabs/cto repository
          - path: body.repository.full_name
            type: string
            value: ["5dlabs/cto"]
        exprs:
          # Exclude workflows with skip-ci-remediation in commit message
          - expr: '!(body.workflow_run.head_commit.message contains "[skip-ci-remediation]")'
            fields:
              - name: skip_check
                path: body.workflow_run.head_commit.message
          # Additional validation
          - expr: 'body.workflow_run.id != ""'
            fields:
              - name: workflow_run_id
                path: body.workflow_run.id
          - expr: 'body.workflow_run.head_branch != ""'
            fields:
              - name: head_branch
                path: body.workflow_run.head_branch
  triggers:
    - template:
        name: trigger-ci-remediation
        conditions: "workflow-failure"
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform.5dlabs.ai/v1alpha1
              kind: CodeRun
              metadata:
                generateName: coderun-ci-fix-
                namespace: {{ $ctoNs }}
                labels:
                  agent: atlas
                  role: ci-remediation
                  workflow-run-id: ""
                  workflow-name: ""
                  repository: "cto"
              spec:
                githubApp: "5DLabs-Atlas"
                cli: "Claude"
                model: "claude-sonnet-4-5-20250929"
                maxTokens: 16384
                temperature: 0.2
                repositoryUrl: "https://github.com/5dlabs/cto"
                workingDirectory: "."
                continueSession: false
                overwriteMemory: false
                env:
                  - name: ATLAS_MODE
                    value: "ci-remediation"
                  - name: WORKFLOW_NAME
                    value: ""
                  - name: WORKFLOW_RUN_ID
                    value: ""
                  - name: WORKFLOW_RUN_URL
                    value: ""
                  - name: FAILURE_BRANCH
                    value: ""
                  - name: FAILURE_COMMIT_SHA
                    value: ""
                  - name: FAILURE_COMMIT_MESSAGE
                    value: ""
                  - name: WORKFLOW_CONCLUSION
                    value: "failure"
          parameters:
            - src:
                dependencyName: workflow-failure
                dataKey: body.workflow_run.name
              dest: spec.env.1.value
            - src:
                dependencyName: workflow-failure
                dataTemplate: "{{ `{{ .Input.body.workflow_run.id }}` }}"
              dest: spec.env.2.value
            - src:
                dependencyName: workflow-failure
                dataKey: body.workflow_run.html_url
              dest: spec.env.3.value
            - src:
                dependencyName: workflow-failure
                dataKey: body.workflow_run.head_branch
              dest: spec.env.4.value
            - src:
                dependencyName: workflow-failure
                dataKey: body.workflow_run.head_sha
              dest: spec.env.5.value
            - src:
                dependencyName: workflow-failure
                dataKey: body.workflow_run.head_commit.message
              dest: spec.env.6.value
            - src:
                dependencyName: workflow-failure
                dataTemplate: "{{ `{{ .Input.body.workflow_run.id }}` }}"
              dest: metadata.labels.workflow-run-id
            - src:
                dependencyName: workflow-failure
                dataTemplate: "{{ `{{ .Input.body.workflow_run.name | lower | replace \" \" \"-\" }}` }}"
              dest: metadata.labels.workflow-name
        retryStrategy:
          steps: 2
          duration: "10s"
          factor: 2
          jitter: 0.1
{{- end }}


