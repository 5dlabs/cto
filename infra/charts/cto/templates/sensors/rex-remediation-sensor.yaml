{{- if and .Values.sensors.enabled .Values.sensors.rexRemediation.enabled }}
{{- $automationNs := include "cto.automationNamespace" . }}
{{- $ctoNs := include "cto.namespace" . }}
---
# Rex PR Remediation Sensor
# Triggers Rex to remediate issues in a PR when:
# 1. User clicks "Remediate" button on Stitch's check run
# 2. User comments /remediate or @rex fix on the PR
# 3. User manually triggers via issue comment
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: rex-remediation
  namespace: {{ $automationNs }}
  labels:
    {{- include "cto.sensor.labels" . | nindent 4 }}
    agent: rex
    event-type: pr-remediation
spec:
  replicas: 1
  template:
    serviceAccountName: argo-events-sa
    container:
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi
  dependencies:
    # Trigger 1: Check run "Remediate" button click
    - name: check-run-action
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value:
              - check_run
          - path: body.action
            type: string
            value:
              - requested_action
          - path: body.requested_action.identifier
            type: string
            value:
              - remediate
              - rex_remediate
              - fix_issues

    # Trigger 2: PR comment with remediate command
    - name: comment-remediate
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value:
              - issue_comment
          - path: body.action
            type: string
            value:
              - created
          - path: body.issue.pull_request.url
            type: string
            comparator: "!="
            value:
              - ""
        exprs:
          - expr: >-
              body.comment.body contains "/remediate" ||
              body.comment.body contains "@rex" ||
              body.comment.body contains "rex fix" ||
              body.comment.body contains "Rex fix"
            fields:
              - name: body.comment.body
                path: body.comment.body
          - expr: >-
              !(body.comment.user.login contains "[bot]")
            fields:
              - name: body.comment.user.login
                path: body.comment.user.login

    # Trigger 3: PR review comment requesting fix
    - name: review-comment-remediate
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value:
              - pull_request_review_comment
          - path: body.action
            type: string
            value:
              - created
        exprs:
          - expr: >-
              body.comment.body contains "/remediate" ||
              body.comment.body contains "@rex" ||
              body.comment.body contains "fix this"
            fields:
              - name: body.comment.body
                path: body.comment.body
          - expr: >-
              !(body.comment.user.login contains "[bot]")
            fields:
              - name: body.comment.user.login
                path: body.comment.user.login

  triggers:
    - template:
        name: rex-remediate-coderun
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform/v1
              kind: CodeRun
              metadata:
                generateName: rex-remediate-
                namespace: {{ $ctoNs }}
                labels:
                  agent: rex
                  run-type: remediate
                  pr-number: ""
              spec:
                runType: remediate
                service: rex-remediation
                repositoryUrl: ""
                docsRepositoryUrl: ""
                docsBranch: main
                model: claude-sonnet-4-5-20250929
                githubApp: 5DLabs-Rex
                contextVersion: 1
                continueSession: false
                overwriteMemory: false
                enableDocker: false
                env:
                  PR_NUMBER: ""
                  HEAD_SHA: ""
                  BASE_BRANCH: ""
                  HEAD_BRANCH: ""
                  REPO_SLUG: ""
                  TRIGGER_TYPE: ""
                  TRIGGER_USER: ""
                  CHECK_RUN_ID: ""
                  CHECK_RUN_NAME: ""
                  COMMENT_ID: ""
                  COMMENT_BODY: ""
                envFromSecrets:
                  - name: FACTORY_API_KEY
                    secretName: cto-secrets
                    secretKey: FACTORY_API_KEY
                  - name: ANTHROPIC_API_KEY
                    secretName: cto-secrets
                    secretKey: ANTHROPIC_API_KEY
                cliConfig:
                  cliType: factory
                  model: claude-sonnet-4-5-20250929
                  settings:
                    template: remediate/factory
                    autoLevel: high
          parameters:
            # Check Run Action Trigger Parameters
            - src:
                dependencyName: check-run-action
                dataKey: body.check_run.pull_requests[0].number
              dest: metadata.labels.pr-number
            - src:
                dependencyName: check-run-action
                dataKey: body.check_run.pull_requests[0].number
              dest: spec.env.PR_NUMBER
            - src:
                dependencyName: check-run-action
                dataKey: body.repository.html_url
              dest: spec.repositoryUrl
            - src:
                dependencyName: check-run-action
                dataKey: body.repository.html_url
              dest: spec.docsRepositoryUrl
            - src:
                dependencyName: check-run-action
                dataKey: body.check_run.head_sha
              dest: spec.env.HEAD_SHA
            - src:
                dependencyName: check-run-action
                dataKey: body.repository.full_name
              dest: spec.env.REPO_SLUG
            - src:
                dependencyName: check-run-action
                dataKey: body.check_run.check_suite.head_branch
              dest: spec.env.HEAD_BRANCH
            - src:
                dependencyName: check-run-action
                dataTemplate: "check_run_action"
              dest: spec.env.TRIGGER_TYPE
            - src:
                dependencyName: check-run-action
                dataKey: body.sender.login
              dest: spec.env.TRIGGER_USER
            - src:
                dependencyName: check-run-action
                dataKey: body.check_run.id
              dest: spec.env.CHECK_RUN_ID
            - src:
                dependencyName: check-run-action
                dataKey: body.check_run.name
              dest: spec.env.CHECK_RUN_NAME

            # Issue Comment Trigger Parameters
            - src:
                dependencyName: comment-remediate
                dataKey: body.issue.number
              dest: metadata.labels.pr-number
            - src:
                dependencyName: comment-remediate
                dataKey: body.issue.number
              dest: spec.env.PR_NUMBER
            - src:
                dependencyName: comment-remediate
                dataKey: body.repository.html_url
              dest: spec.repositoryUrl
            - src:
                dependencyName: comment-remediate
                dataKey: body.repository.html_url
              dest: spec.docsRepositoryUrl
            - src:
                dependencyName: comment-remediate
                dataKey: body.repository.full_name
              dest: spec.env.REPO_SLUG
            - src:
                dependencyName: comment-remediate
                dataTemplate: "issue_comment"
              dest: spec.env.TRIGGER_TYPE
            - src:
                dependencyName: comment-remediate
                dataKey: body.comment.user.login
              dest: spec.env.TRIGGER_USER
            - src:
                dependencyName: comment-remediate
                dataKey: body.comment.id
              dest: spec.env.COMMENT_ID
            - src:
                dependencyName: comment-remediate
                dataKey: body.comment.body
              dest: spec.env.COMMENT_BODY

            # Review Comment Trigger Parameters
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.pull_request.number
              dest: metadata.labels.pr-number
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.pull_request.number
              dest: spec.env.PR_NUMBER
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.repository.html_url
              dest: spec.repositoryUrl
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.repository.html_url
              dest: spec.docsRepositoryUrl
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.pull_request.head.sha
              dest: spec.env.HEAD_SHA
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.repository.full_name
              dest: spec.env.REPO_SLUG
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.pull_request.head.ref
              dest: spec.env.HEAD_BRANCH
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.pull_request.base.ref
              dest: spec.env.BASE_BRANCH
            - src:
                dependencyName: review-comment-remediate
                dataTemplate: "review_comment"
              dest: spec.env.TRIGGER_TYPE
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.comment.user.login
              dest: spec.env.TRIGGER_USER
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.comment.id
              dest: spec.env.COMMENT_ID
            - src:
                dependencyName: review-comment-remediate
                dataKey: body.comment.body
              dest: spec.env.COMMENT_BODY
{{- end }}

