{{- if .Values.webhooks.enabled }}
---
# MCP Server Verification Sensor
# Triggers verification CodeRun after MCP server PRs are merged
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: mcp-server-verification-sensor
  namespace: automation
  labels:
    app: mcp-server-management
    component: verification-sensor
spec:
  replicas: 1
  deploymentStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    serviceAccountName: argo-events-sa
    container:
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "128Mi"
          cpu: "200m"
  dependencies:
    # Trigger on merged PR with mcp-server-add label
    - name: mcp-server-add-merged
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value: ["pull_request"]
          - path: body.action
            type: string
            value: ["closed"]
          - path: body.pull_request.merged
            type: bool
            value: ["true"]
          - path: body.repository.full_name
            type: string
            value: ["5dlabs/cto"]
          # Match PRs with mcp-server-add label
          - path: "body.pull_request.labels.#(name==\"mcp-server-add\").name"
            type: string
            value: ["mcp-server-add"]

    # Trigger on merged PR with mcp-server-remove label
    - name: mcp-server-remove-merged
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value: ["pull_request"]
          - path: body.action
            type: string
            value: ["closed"]
          - path: body.pull_request.merged
            type: bool
            value: ["true"]
          - path: body.repository.full_name
            type: string
            value: ["5dlabs/cto"]
          # Match PRs with mcp-server-remove label
          - path: "body.pull_request.labels.#(name==\"mcp-server-remove\").name"
            type: string
            value: ["mcp-server-remove"]

    # Trigger on merged PR with mcp-server-update label
    - name: mcp-server-update-merged
      eventSourceName: github
      eventName: org
      filters:
        data:
          - path: body.X-GitHub-Event
            type: string
            value: ["pull_request"]
          - path: body.action
            type: string
            value: ["closed"]
          - path: body.pull_request.merged
            type: bool
            value: ["true"]
          - path: body.repository.full_name
            type: string
            value: ["5dlabs/cto"]
          # Match PRs with mcp-server-update label
          - path: "body.pull_request.labels.#(name==\"mcp-server-update\").name"
            type: string
            value: ["mcp-server-update"]

  triggers:
    # Verification trigger for mcp-server-add
    - template:
        name: mcp-server-add-verification
        conditions: "mcp-server-add-merged"
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform/v1
              kind: CodeRun
              metadata:
                generateName: coderun-mcp-verify-add-
                namespace: cto
                labels:
                  agent: rex
                  task-type: mcp-server-verify
                  mcp-server-action: add
              spec:
                taskId: 0
                service: "cto"
                repositoryUrl: "https://github.com/5dlabs/cto"
                docsRepositoryUrl: "https://github.com/5dlabs/cto"
                model: "claude-sonnet-4-5-20250929"
                githubApp: "5DLabs-Rex"
                continueSession: false
                overwriteMemory: true
                env:
                  MCP_SERVER_ACTION: "add"
          parameters:
            - src:
                dependencyName: mcp-server-add-merged
                dataTemplate: |
                  {{ range .Input.body.pull_request.labels }}{{ if hasPrefix "mcp-server-key-" .name }}{{ trimPrefix "mcp-server-key-" .name }}{{ end }}{{ end }}
              dest: spec.env.MCP_SERVER_KEY
            - src:
                dependencyName: mcp-server-add-merged
                dataKey: body.pull_request.number
              dest: spec.env.PR_NUMBER

    # Verification trigger for mcp-server-remove
    - template:
        name: mcp-server-remove-verification
        conditions: "mcp-server-remove-merged"
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform/v1
              kind: CodeRun
              metadata:
                generateName: coderun-mcp-verify-remove-
                namespace: cto
                labels:
                  agent: rex
                  task-type: mcp-server-verify
                  mcp-server-action: remove
              spec:
                taskId: 0
                service: "cto"
                repositoryUrl: "https://github.com/5dlabs/cto"
                docsRepositoryUrl: "https://github.com/5dlabs/cto"
                model: "claude-sonnet-4-5-20250929"
                githubApp: "5DLabs-Rex"
                continueSession: false
                overwriteMemory: true
                env:
                  MCP_SERVER_ACTION: "remove"
          parameters:
            - src:
                dependencyName: mcp-server-remove-merged
                dataTemplate: |
                  {{ range .Input.body.pull_request.labels }}{{ if hasPrefix "mcp-server-key-" .name }}{{ trimPrefix "mcp-server-key-" .name }}{{ end }}{{ end }}
              dest: spec.env.MCP_SERVER_KEY
            - src:
                dependencyName: mcp-server-remove-merged
                dataKey: body.pull_request.number
              dest: spec.env.PR_NUMBER

    # Verification trigger for mcp-server-update
    - template:
        name: mcp-server-update-verification
        conditions: "mcp-server-update-merged"
        k8s:
          operation: create
          source:
            resource:
              apiVersion: agents.platform/v1
              kind: CodeRun
              metadata:
                generateName: coderun-mcp-verify-update-
                namespace: cto
                labels:
                  agent: rex
                  task-type: mcp-server-verify
                  mcp-server-action: update
              spec:
                taskId: 0
                service: "cto"
                repositoryUrl: "https://github.com/5dlabs/cto"
                docsRepositoryUrl: "https://github.com/5dlabs/cto"
                model: "claude-sonnet-4-5-20250929"
                githubApp: "5DLabs-Rex"
                continueSession: false
                overwriteMemory: true
                env:
                  MCP_SERVER_ACTION: "update"
          parameters:
            - src:
                dependencyName: mcp-server-update-merged
                dataTemplate: |
                  {{ range .Input.body.pull_request.labels }}{{ if hasPrefix "mcp-server-key-" .name }}{{ trimPrefix "mcp-server-key-" .name }}{{ end }}{{ end }}
              dest: spec.env.MCP_SERVER_KEY
            - src:
                dependencyName: mcp-server-update-merged
                dataKey: body.pull_request.number
              dest: spec.env.PR_NUMBER
{{- end }}
