{{- /*
GitHub App External Secrets for Agent Authentication

This template generates ExternalSecret resources for each configured agent's
GitHub App credentials. Each agent has its own GitHub App for repository access.

The secrets are synced from OpenBao using the External Secrets Operator.
Each secret contains: app-id, client-id, private-key
*/ -}}

{{- if .Values.secrets.enabled }}
{{- $namespace := include "cto.namespace" . }}
{{- $secretStore := .Values.secrets.secretStore }}
{{- range .Values.secrets.githubApps }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: github-app-5dlabs-{{ .name }}
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: github-app
    app.kubernetes.io/part-of: cto-platform
    cto.5dlabs.io/agent: {{ .name }}
spec:
  refreshInterval: {{ $.Values.secrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: github-app-5dlabs-{{ .name }}
    creationPolicy: Owner
  data:
    - secretKey: app-id
      remoteRef:
        key: {{ .baoKey | default (printf "github-app-%s" .name) }}
        property: app-id
    - secretKey: client-id
      remoteRef:
        key: {{ .baoKey | default (printf "github-app-%s" .name) }}
        property: client-id
    {{- if .includeClientSecret }}
    - secretKey: client-secret
      remoteRef:
        key: {{ .baoKey | default (printf "github-app-%s" .name) }}
        property: client-secret
    {{- end }}
    - secretKey: private-key
      remoteRef:
        key: {{ .baoKey | default (printf "github-app-%s" .name) }}
        property: private-key
{{- end }}
{{- end }}

