{{- /*
Tools Server External Secrets

This template generates ExternalSecret resources for the MCP tools server,
including GitHub PAT, Firecrawl API key, and Kubernetes config.
*/ -}}

{{- if .Values.secrets.enabled }}
{{- $namespace := include "cto.namespace" . }}
{{- $secretStore := .Values.secrets.secretStore }}
{{- $refreshInterval := .Values.secrets.refreshInterval | default "1h" }}

{{- /* GHCR Docker Registry Secret */ -}}
{{- if .Values.secrets.ghcr.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ghcr-secret
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: registry
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: ghcr-secret
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: "{{ "{{ .dockerconfigjson }}" }}"
  data:
    - secretKey: dockerconfigjson
      remoteRef:
        key: {{ .Values.secrets.ghcr.baoKey | default "ghcr-secret" }}
        property: .dockerconfigjson
{{- end }}

{{- /* Tools GitHub Secrets */ -}}
{{- if .Values.secrets.tools.github.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tools-github-secrets
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: tools-mcp
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: tools-github-secrets
    creationPolicy: Owner
  data:
    - secretKey: GITHUB_PERSONAL_ACCESS_TOKEN
      remoteRef:
        key: {{ .Values.secrets.tools.github.baoKey | default "tools-github" }}
        property: GITHUB_PERSONAL_ACCESS_TOKEN
{{- end }}

{{- /* Tools Firecrawl Secrets */ -}}
{{- if .Values.secrets.tools.firecrawl.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tools-firecrawl-secrets
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: tools-mcp
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: tools-firecrawl-secrets
    creationPolicy: Owner
  data:
    - secretKey: FIRECRAWL_API_KEY
      remoteRef:
        key: {{ .Values.secrets.tools.firecrawl.baoKey | default "tools-firecrawl" }}
        property: FIRECRAWL_API_KEY
{{- end }}

{{- /* Tools Kubernetes Secrets */ -}}
{{- if .Values.secrets.tools.kubernetes.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tools-kubernetes-secrets
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: tools-mcp
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: tools-kubernetes-secrets
    creationPolicy: Owner
  data:
    - secretKey: KUBECONFIG
      remoteRef:
        key: {{ .Values.secrets.tools.kubernetes.baoKey | default "tools-kubernetes" }}
        property: KUBECONFIG
{{- end }}

{{- /* Tools App Store Connect Secrets */ -}}
{{- if .Values.secrets.tools.appstoreConnect.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tools-appstore-connect-secrets
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: tools-mcp
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: tools-appstore-connect-secrets
    creationPolicy: Owner
    template:
      data:
        APP_STORE_KEY_ID: "{{ "{{ .keyId }}" }}"
        APP_STORE_ISSUER_ID: "{{ "{{ .issuerId }}" }}"
        # The .p8 key is stored base64 encoded, decode it for the file
        AuthKey.p8: "{{ "{{ .p8Key | base64decode }}" }}"
  data:
    - secretKey: keyId
      remoteRef:
        key: {{ .Values.secrets.tools.appstoreConnect.baoKey | default "tools-appstore-connect" }}
        property: APP_STORE_KEY_ID
    - secretKey: issuerId
      remoteRef:
        key: {{ .Values.secrets.tools.appstoreConnect.baoKey | default "tools-appstore-connect" }}
        property: APP_STORE_ISSUER_ID
    - secretKey: p8Key
      remoteRef:
        key: {{ .Values.secrets.tools.appstoreConnect.baoKey | default "tools-appstore-connect" }}
        property: APP_STORE_P8_KEY
{{- end }}

{{- end }}

