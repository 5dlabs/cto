{{- /*
API Keys External Secrets for Agent CLI Access

This template generates ExternalSecret resources for API keys used by
agent CLIs (Claude, OpenAI, Gemini, etc.) and platform services.

Secrets generated:
- agent-platform-secrets: All CLI API keys for Argo Workflow pods
- cto-secrets: Core platform API keys
*/ -}}

{{- if .Values.secrets.enabled }}
{{- $namespace := include "cto.namespace" . }}
{{- $secretStore := .Values.secrets.secretStore }}
{{- $refreshInterval := .Values.secrets.refreshInterval | default "1h" }}

{{- /* Agent Platform Secrets - used by all CLI workflows */ -}}
{{- if .Values.secrets.agentPlatformKeys }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-platform-secrets
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: workflow-secrets
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: agent-platform-secrets
    creationPolicy: Owner
  data:
{{ range .Values.secrets.agentPlatformKeys }}
    - secretKey: {{ .key }}
      remoteRef:
        key: {{ .baoKey | default "api-keys" }}
        property: {{ .property | default .key }}
{{- end }}
{{- end }}

{{- /* CTO Secrets - core platform API keys */ -}}
{{- if .Values.secrets.ctoKeys }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cto-secrets
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: platform-secrets
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: cto-secrets
    creationPolicy: Owner
  data:
{{ range .Values.secrets.ctoKeys }}
    - secretKey: {{ .key }}
      remoteRef:
        key: {{ .baoKey | default "api-keys" }}
        property: {{ .property | default .key }}
{{- end }}
{{- end }}

{{- /* Linear Secrets - project management integration */ -}}
{{- if .Values.secrets.linear.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: linear-secrets
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/managed-by: external-secrets
    app.kubernetes.io/component: linear-integration
    app.kubernetes.io/part-of: cto-platform
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ $secretStore.name }}
    kind: {{ $secretStore.kind }}
  target:
    name: linear-secrets
    creationPolicy: Owner
  data:
{{ range .Values.secrets.linear.keys }}
    - secretKey: {{ .key }}
      remoteRef:
        key: {{ .baoKey | default "linear-sync" }}
        property: {{ .property | default .key }}
{{- end }}
    - secretKey: GITHUB_TOKEN  # pragma: allowlist secret
      remoteRef:
        key: tools-github
        property: GITHUB_PERSONAL_ACCESS_TOKEN
{{- end }}

{{- end }}
