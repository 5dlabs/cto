---
{{- if .Values.agents }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cto.controller.fullname" . }}-agents
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cto.controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: agents-config
data:
  agents.yaml: |
    agents:
      {{- range $key, $agent := .Values.agents }}
      {{ $key }}:
        name: {{ $agent.name | quote }}
        githubApp: {{ $agent.githubApp | quote }}
        appId: {{ $agent.appId | quote }}
        clientId: {{ $agent.clientId | quote }}
        role: {{ $agent.role | quote }}
        expertise:
          {{- range $expertise := $agent.expertise }}
          - {{ $expertise | quote }}
          {{- end }}
        description: {{ $agent.description | quote }}
        systemPrompt: {{ $agent.systemPrompt | quote }}
      {{- end }}
    # Agent defaults are now managed through cto-config.json in the MCP server
  {{- range $key, $agent := .Values.agents }}
  {{- if $agent.systemPrompt }}
  {{ $agent.githubApp }}_system-prompt.md: |
    ---
    name: {{ $agent.name }}
    description: {{ $agent.description }}
    # tools: omitted to inherit all available tools
    ---
{{- range $line := splitList "\n" $agent.systemPrompt }}
{{- if $line }}
    {{ $line }}
{{- else }}

{{- end }}
{{- end }}
  {{- end }}
  {{- end }}
{{- end }}
