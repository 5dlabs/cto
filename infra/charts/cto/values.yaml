---
# =============================================================================
# CTO Platform - Unified Configuration
# =============================================================================
# Single chart for all CTO platform components:
# - Controller: Agent orchestration and CodeRun management
# - PM: Project management integrations (Linear)
# - Tools: MCP server proxy
# - Healer: Self-healing platform monitor
# - OpenMemory: Long-term AI agent memory
# - Sensors: Argo Event sensors for automation
# - Webhooks: GitHub webhook event handling

# Global configuration shared across all components
global:
  namespace: cto
  imagePullSecrets:
    - name: ghcr-secret
  # Storage class for PVCs
  storageClass: local-path

  # ==========================================================================
  # Dev Registry - Toggle between GHCR and local in-cluster registry
  # ==========================================================================
  # Enable this to use images from a local registry instead of GHCR.
  # Useful for fast iteration during development without pushing to GHCR.
  #
  # Setup: ./scripts/dev-load.sh --setup
  # Build: ./scripts/dev-load.sh controller
  # Toggle: helm upgrade cto ./infra/charts/cto --set global.devRegistry.enabled=true
  #
  devRegistry:
    # Set to true to use local in-cluster registry images
    enabled: false
    # URL of the local registry (node-ip:nodeport)
    # Get this from: kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}'
    url: "192.168.1.77:30500"
    # Tag for dev images (default: dev-local)
    tag: "dev-local"
    # Pull policy for dev images (use Always to get latest pushes)
    pullPolicy: Always
    # Override specific components (leave empty to use defaults)
    # Example: { controller: "my-custom-tag", tools: "feature-branch" }
    componentTags: {}

# =============================================================================
# Controller - Agent Orchestration
# =============================================================================
controller:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/5dlabs/controller
    pullPolicy: Always
    tag: "latest"

  service:
    type: ClusterIP
    port: 80
    targetPort: 8080

  resources:
    limits:
      cpu: 1000m
      memory: 8Gi
    requests:
      cpu: 500m
      memory: 1Gi

  # Argo workflow templates
  argo:
    enabled: true

  # Template version - bump to force pod restart
  templatesVersion: "v1.1.0"

  config:
    kubernetesNamespace: "cto"
    serverHost: "0.0.0.0"
    serverPort: "8080"
    rustLog: "debug"

# =============================================================================
# Agent Configuration - CodeRun/Workflow Defaults
# =============================================================================
agent:
  image:
    repository: ghcr.io/5dlabs/agent
    tag: latest
  serviceAccountName: ""
  cliImages:
    claude:
      repository: ghcr.io/5dlabs/claude-code
      tag: latest
    cursor:
      repository: ghcr.io/5dlabs/cursor
      tag: latest
    codex:
      repository: ghcr.io/5dlabs/codex
      tag: latest
    gemini:
      repository: ghcr.io/5dlabs/gemini
      tag: latest
    factory:
      repository: ghcr.io/5dlabs/factory
      tag: latest
    opencode:
      repository: ghcr.io/5dlabs/opencode
      tag: latest
  cliProviders: {}
  agentCliConfigs: {}
  inputBridge:
    enabled: false
    image:
      repository: ""
      tag: ""
    port: 8080

# =============================================================================
# PM Server - Project Management
# =============================================================================
pm:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/5dlabs/pm-server
    pullPolicy: IfNotPresent
    tag: "latest"

  service:
    type: ClusterIP
    port: 8081

  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # PM provider configuration
  provider: linear
  maxTimestampAgeMs: 60000

  # Linear integration
  linear:
    enabled: true

  # GitHub configuration
  github:
    defaultOrg: "5dlabs"
    webhookCallbackUrl: "https://pm.5dlabs.ai/webhooks/github"

  # Secrets
  secrets:
    secretName: linear-secrets

# =============================================================================
# Tools Server - MCP Proxy
# =============================================================================
tools:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/5dlabs/tools
    pullPolicy: Always
    tag: "latest"

  service:
    type: ClusterIP
    port: 3000

  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 200m
      memory: 512Mi

  persistence:
    enabled: true
    size: 10Gi

  rbac:
    create: true
    clusterWide: true

# =============================================================================
# Healer - Self-Healing Monitor
# =============================================================================
healer:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/5dlabs/healer
    pullPolicy: Always
    tag: "latest"

  service:
    type: ClusterIP
    port: 80

  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 100m
      memory: 256Mi

  config:
    cli: "Factory"
    model: "claude-opus-4-5-20250929"
    maxAttempts: 3
    timeWindowMins: 10
    memoryUrl: "http://openmemory.cto.svc:3000"
    memoryEnabled: true

  persistence:
    enabled: true
    size: 10Gi

  filebrowser:
    enabled: true
    port: 8081

# =============================================================================
# OpenMemory - AI Agent Memory
# =============================================================================
openmemory:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/5dlabs/openmemory
    pullPolicy: Always
    tag: "latest"

  service:
    type: ClusterIP
    port: 3000

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  persistence:
    enabled: true
    size: 5Gi

# =============================================================================
# Sensors - Argo Event Automation
# =============================================================================
sensors:
  enabled: true
  # Sensors are deployed to the automation namespace
  namespace: automation

# =============================================================================
# Webhooks - GitHub Event Handling
# =============================================================================
webhooks:
  enabled: true
  # EventSource and sensors for GitHub events
  namespace: automation

# =============================================================================
# TweakCN - Theme Editor
# =============================================================================
tweakcn:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/5dlabs/tweakcn
    pullPolicy: Always
    tag: "latest"

  service:
    type: ClusterIP
    port: 3000

  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 256Mi

# =============================================================================
# Research - Twitter/X Research Pipeline
# =============================================================================
research:
  enabled: true

  image:
    repository: ghcr.io/5dlabs/research
    pullPolicy: Always
    tag: "latest"

  # CronJob schedule (every 5 minutes)
  schedule: "*/5 * * * *"

  # Research configuration
  minRelevance: "0.5"
  batchSize: "10"
  model: "claude-sonnet-4-20250514"

  # PR creation
  createPR: true
  repo: "5dlabs/cto"
  baseBranch: "develop"
  researchDir: "docs/research"

  persistence:
    size: 5Gi
    storageClass: ""  # Uses global.storageClass if empty

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

# =============================================================================
# Maintenance - Workspace and Event Cleanup
# =============================================================================
maintenance:
  enabled: true

  # Kubectl image for cleanup jobs
  image: bitnami/kubectl:latest

  # Workspace PVC cleaner
  pvcCleaner:
    schedule: "15 * * * *"  # Every hour at :15
    retentionHours: "12"
    maxDeletions: "15"

  # Event cleaner
  eventCleaner:
    schedule: "*/30 * * * *"  # Every 30 minutes
    retentionMinutes: "60"

# =============================================================================
# Cloudflare Tunnel - Ingress via Cloudflare
# =============================================================================
cloudflare:
  enabled: true
  # Cloudflare domain (must be a zone you own)
  domain: 5dlabs.ai
  # Cloudflare Account ID
  accountId: b73ec19faa187789b3f9d1deb0e0d95f
  # Secret name (in cloudflare-operator-system namespace)
  secretName: cloudflare-api-credentials

  # Tunnel configuration
  tunnel:
    name: cto-main

  # Service bindings
  bindings:
    pm:
      hostname: pm.5dlabs.ai
    webhooks:
      hostname: github-webhooks.5dlabs.ai
