#!/bin/sh

echo '════════════════════════════════════════════════════════════════'
echo '║                 IMPLEMENTATION TASK STARTING                 ║'
echo '════════════════════════════════════════════════════════════════'

# Disable interactive Git prompts globally
export GIT_TERMINAL_PROMPT=0
export GIT_ASKPASS=/bin/true
export SSH_ASKPASS=/bin/true

# Export GitHub environment for hooks (SSH-only system)
export GITHUB_USER="{{github_user}}"
# Note: No GITHUB_TOKEN - using SSH authentication only

# Install GitHub CLI if not present
if ! command -v gh >/dev/null 2>&1; then
    echo "=== Installing GitHub CLI ==="
    if command -v apt-get >/dev/null 2>&1; then
        apt-get update && apt-get install -y gh || echo "⚠️ Failed to install gh CLI"
    elif command -v apk >/dev/null 2>&1; then
        apk add --no-cache github-cli || echo "⚠️ Failed to install gh CLI"
    else
        echo "⚠️ Cannot install gh CLI - package manager not found"
    fi
fi

# Configure SSH authentication (SSH-only system)
echo "=== SSH AUTHENTICATION SETUP ==="

if [ -f "/workspace/.ssh/id_ed25519" ]; then
  echo "✓ SSH private key found at /workspace/.ssh/id_ed25519"

  # Create SSH directory in home
  mkdir -p ~/.ssh
  chmod 700 ~/.ssh

  # Configure SSH to use the mounted key directly (no copying needed)
  cat > ~/.ssh/config << EOF
Host github.com
    HostName github.com
    User git
    IdentityFile /workspace/.ssh/id_ed25519
    IdentitiesOnly yes
    StrictHostKeyChecking no
EOF

  chmod 600 ~/.ssh/config

  # Test SSH connection
  echo "Testing SSH connection to GitHub..."
  ssh -T git@github.com 2>&1 | head -3 || echo "SSH test completed (expected to fail with 'successfully authenticated')"

  echo "✓ SSH authentication configured successfully"
else
  echo "❌ SSH private key not found at /workspace/.ssh/id_ed25519"
  echo "   Expected SSH key secret to be mounted to /workspace/.ssh/"
  echo "   This system is SSH-only - no HTTPS authentication support"
  exit 1
fi

# Configure GitHub CLI for SSH operations
echo "=== GITHUB CLI CONFIGURATION ==="
if command -v gh >/dev/null 2>&1; then
  echo "Configuring GitHub CLI to use SSH for git operations..."
  gh config set git_protocol ssh --host github.com
  echo "✓ GitHub CLI configured to use SSH protocol for github.com"

  # Authenticate with GitHub using the provided PAT
  if [ -n "$GITHUB_TOKEN" ]; then
    echo "Authenticating GitHub CLI with provided token..."
    echo "$GITHUB_TOKEN" | gh auth login --with-token
    echo "✓ GitHub CLI authenticated successfully"
  else
    echo "⚠️ No GitHub token (GITHUB_TOKEN) provided - API operations may fail"
  fi
else
  echo "⚠️ GitHub CLI not available - will use pure git commands"
fi

# Configure git user after successful SSH setup
git config --global --add safe.directory /workspace
echo "✓ Added /workspace to safe directories"

# Note: Git user config will be set locally in repository after clone

# =============================================================================
# AUTHENTICATION VERIFICATION
# =============================================================================
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "🔐 AUTHENTICATION VERIFICATION"
echo "═══════════════════════════════════════════════════════════════"
echo ""

# Repository URLs - Convert org/repo format to full URLs
REPO_SSH_URL="git@github.com:{{repository_url}}.git"
REPO_HTTP_URL="https://github.com/{{repository_url}}.git"
DOCS_SSH_URL="git@github.com:{{docs_repository_url}}.git" 
DOCS_HTTP_URL="https://github.com/{{docs_repository_url}}.git"

# DEBUG: Show what URLs are being constructed
echo "🔍 DEBUG: URL Construction"
echo "  Input repository_url: '{{repository_url}}'"
echo "  Input docs_repository_url: '{{docs_repository_url}}'"
echo "  Constructed REPO_SSH_URL: '$REPO_SSH_URL'"
echo "  Constructed DOCS_SSH_URL: '$DOCS_SSH_URL'"
echo "  Constructed REPO_HTTP_URL: '$REPO_HTTP_URL'"
echo "  Constructed DOCS_HTTP_URL: '$DOCS_HTTP_URL'"

# Test SSH access to repository
echo "Testing SSH repository access..."
if git ls-remote "$REPO_SSH_URL" HEAD > /dev/null 2>&1; then
  echo "✓ SSH repository access successful"
  echo "  Repository: {{repository_url}} ($REPO_SSH_URL)"
else
  echo "❌ SSH repository access failed"
  echo "  Repository: {{repository_url}} ($REPO_SSH_URL)"
  echo ""
  echo "🚫 ABORTING: Cannot access repository via SSH"
  exit 1
fi

# Test docs repository access
echo "Testing docs repository access..."
if git ls-remote "$DOCS_SSH_URL" HEAD > /dev/null 2>&1; then
  echo "✓ Docs repository access successful"
  echo "  Repository: {{docs_repository_url}} ($DOCS_SSH_URL)"
else
  echo "❌ Docs repository access failed"
  echo "  Repository: {{docs_repository_url}} ($DOCS_SSH_URL)"
  echo ""
  echo "🚫 ABORTING: Cannot access docs repository via SSH"
  exit 1
fi

# Dual Repository Setup - Platform repo for docs, Target repo for implementation
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "║                 DUAL REPOSITORY SETUP                        ║"
echo "═══════════════════════════════════════════════════════════════"

# Repository Information
DOCS_BRANCH="{{docs_branch}}"
GITHUB_USER="{{github_user}}"

# Extract repository names from org/repo format
DOCS_REPO_NAME="{{docs_repository_url}}"
TARGET_REPO_NAME="{{repository_url}}"
# Convert to directory-safe names
DOCS_REPO_DIR=$(echo "$DOCS_REPO_NAME" | sed 's/\//-/g')
TARGET_REPO_DIR=$(echo "$TARGET_REPO_NAME" | sed 's/\//-/g')

echo "=== REPOSITORY SETUP ==="
echo "Docs repository: {{docs_repository_url}} ($DOCS_SSH_URL)"
echo "Target repository: {{repository_url}} ($REPO_SSH_URL)"
echo "Docs branch: $DOCS_BRANCH"
echo "GitHub user: $GITHUB_USER"

# Determine workflow type
if [ "{{docs_repository_url}}" = "{{repository_url}}" ]; then
    echo "✓ Single-repo workflow detected (same repository for docs and implementation)"
    WORKFLOW_TYPE="single-repo"
else
    echo "✓ Multi-repo workflow detected (separate docs and target repositories)"
    WORKFLOW_TYPE="multi-repo"
fi

# Repository Setup Based on Workflow Type
if [ "$WORKFLOW_TYPE" = "single-repo" ]; then
    echo "=== SINGLE-REPO WORKFLOW ==="
    # Check if repository already exists (retry scenario)
    if [ -d "$TARGET_REPO_DIR" ]; then
        echo "🔄 REPOSITORY: UPDATE - directory already exists"
        echo "📁 Found existing repository '$TARGET_REPO_DIR', updating..."
        cd "$TARGET_REPO_DIR"
        git fetch origin
        git checkout "$DOCS_BRANCH"
        git reset --hard "origin/$DOCS_BRANCH"
        cd /workspace
        echo "✓ Repository updated successfully"
    else
        echo "📥 REPOSITORY: CLONING - first time setup"
        if ! git clone "$REPO_SSH_URL" "$TARGET_REPO_DIR"; then
            echo "❌ Failed to clone repository: {{repository_url}} ($REPO_SSH_URL)"
            exit 1
        fi
        cd "$TARGET_REPO_DIR" && git checkout "$DOCS_BRANCH" && cd /workspace
        echo "✓ Repository cloned successfully"
    fi
    
    # Set working directory to the repository root
    REPO_NAME="$TARGET_REPO_DIR"
    echo "✓ Working directory: /workspace/$REPO_NAME"
    echo "✓ Task files already available in repository"

else
    echo "=== MULTI-REPO WORKFLOW ==="
    
    # Step 1: Clone or update docs repository temporarily
    if [ -d "/tmp/docs-repo" ]; then
        echo "🔄 DOCS REPOSITORY: UPDATE - temporary directory exists"
        cd /tmp/docs-repo
        git fetch origin
        git checkout "$DOCS_BRANCH" 
        git reset --hard "origin/$DOCS_BRANCH"
        cd /workspace
        echo "✓ Docs repository updated"
    else
        echo "📥 DOCS REPOSITORY: CLONING - extracting task files"
        if ! git clone "$DOCS_SSH_URL" /tmp/docs-repo; then
            echo "❌ Failed to clone docs repository: {{docs_repository_url}} ($DOCS_SSH_URL)"
            exit 1
        fi
        cd /tmp/docs-repo && git checkout "$DOCS_BRANCH" && cd /workspace
        echo "✓ Docs repository cloned to temporary location"
    fi
    
    # Step 2: Clone or update target repository  
    if [ -d "$TARGET_REPO_DIR" ]; then
        echo "🔄 TARGET REPOSITORY: UPDATE - directory already exists"
        echo "📁 Found existing target repository '$TARGET_REPO_DIR', updating..."
        cd "$TARGET_REPO_DIR"
        git fetch origin main
        git reset --hard origin/main
        cd /workspace
        echo "✓ Target repository updated successfully"
    else
        echo "📥 TARGET REPOSITORY: CLONING - first time setup"
        if ! git clone "$REPO_SSH_URL" "$TARGET_REPO_DIR"; then
            echo "❌ Failed to clone target repository: {{repository_url}} ($REPO_SSH_URL)"
            exit 1
        fi
        echo "✓ Target repository cloned successfully"
    fi
    
    # Step 3: Copy task files from docs repo to target repo
    echo "📋 TASK FILES: COPYING from docs to target repository"
    mkdir -p "/workspace/$TARGET_REPO_DIR/task"
    
    # Determine docs project directory path
    {{#if docs_project_directory}}
    if [ "{{docs_project_directory}}" = "." ]; then
        DOCS_PATH="/tmp/docs-repo/.taskmaster"
    else
        DOCS_PATH="/tmp/docs-repo/{{docs_project_directory}}/.taskmaster"
    fi
    {{else}}
    DOCS_PATH="/tmp/docs-repo/.taskmaster"
    {{/if}}
    
    # Copy specific task files
    TASK_DIR="$DOCS_PATH/docs/task-{{task_id}}"
    echo "🔍 DEBUG: Looking for task files at: $TASK_DIR"
    echo "🔍 DEBUG: Docs path is: $DOCS_PATH"
    echo "🔍 DEBUG: Contents of docs temp directory:"
    ls -la /tmp/docs-repo/.taskmaster/ || echo "No .taskmaster found"
    echo "🔍 DEBUG: Contents of docs directory:"
    ls -la /tmp/docs-repo/.taskmaster/docs/ || echo "No docs directory found"
    
    if [ -d "$TASK_DIR" ]; then
        echo "🔍 DEBUG: Task directory found, contents:"
        ls -la "$TASK_DIR"
        
        echo "✅ Copying task.md..."
        cp "$TASK_DIR/task.md" "/workspace/$TARGET_REPO_DIR/task/" && echo "✓ task.md copied" || echo "❌ task.md copy failed"
        
        echo "✅ Copying acceptance-criteria.md..."
        cp "$TASK_DIR/acceptance-criteria.md" "/workspace/$TARGET_REPO_DIR/task/" && echo "✓ acceptance-criteria.md copied" || echo "❌ acceptance-criteria.md copy failed"
        
        echo "✅ Copying prompt.md..."
        cp "$TASK_DIR/prompt.md" "/workspace/$TARGET_REPO_DIR/task/" && echo "✓ prompt.md copied" || echo "❌ prompt.md copy failed"
        
        echo "✅ Copying toolman-config.json..."
        if [ -f "$TASK_DIR/toolman-config.json" ]; then
            cp "$TASK_DIR/toolman-config.json" "/workspace/$TARGET_REPO_DIR/toolman-config.json" && echo "✓ toolman-config.json copied to workspace root" || echo "❌ toolman-config.json copy failed"
        else
            echo "⚠️ toolman-config.json not found - toolman may not work correctly"
        fi
        
        echo "✅ Copying toolman-guide.md..."
        if [ -f "$TASK_DIR/toolman-guide.md" ]; then
            cp "$TASK_DIR/toolman-guide.md" "/workspace/$TARGET_REPO_DIR/task/" && echo "✓ toolman-guide.md copied" || echo "❌ toolman-guide.md copy failed"
        else
            echo "⚠️ toolman-guide.md not found - code agent won't have tool usage guidance"
        fi
        
        echo "✓ Task {{task_id}} files copied from $TASK_DIR"
    else
        echo "❌ CRITICAL: Task {{task_id}} directory not found at: $TASK_DIR"
        echo "🔍 DEBUG: Available directories in docs:"
        find /tmp/docs-repo -name "task-*" -type d || echo "No task directories found"
    fi
    
    # Copy architecture.md from docs root
    ARCH_FILE="$DOCS_PATH/docs/architecture.md"
    if [ -f "$ARCH_FILE" ]; then
        cp "$ARCH_FILE" "/workspace/$TARGET_REPO_DIR/task/"
        echo "✓ Architecture documentation copied"
    else
        echo "⚠️ architecture.md not found at: $ARCH_FILE"
    fi
    
    # Copy tasks.json if it exists
    if [ -f "$DOCS_PATH/tasks.json" ]; then
        cp "$DOCS_PATH/tasks.json" "/workspace/$TARGET_REPO_DIR/task/"
        echo "✓ tasks.json copied"
    fi
    
    echo "✓ Task files copied to target repository"
    
    # DEBUG: Verify files were copied successfully
    echo "🔍 DEBUG: Contents of target task directory after copy:"
    ls -la "/workspace/$TARGET_REPO_DIR/task/" || echo "Task directory not found"
    echo "🔍 DEBUG: Checking if prompt.md exists:"
    [ -f "/workspace/$TARGET_REPO_DIR/task/prompt.md" ] && echo "✅ prompt.md exists" || echo "❌ prompt.md missing"
    
    # Step 4: Clean up docs repository
    echo "🧹 CLEANUP: Removing temporary docs repository"
    rm -rf /tmp/docs-repo
    echo "✓ Docs repository cleaned up"
    
    # Set working directory to the target repository root
    REPO_NAME="$TARGET_REPO_DIR"
    echo "✓ Working directory: /workspace/$REPO_NAME"
fi

# Setup feature branch for implementation
echo "=== BRANCH SETUP ==="
cd "/workspace/$REPO_NAME"

# Sync with latest main to prevent conflicts
echo "🔄 Syncing with latest main to prevent conflicts..."
git fetch origin main 2>/dev/null || git fetch origin master 2>/dev/null || echo "⚠️ Could not fetch main/master branch"

# Create or checkout feature branch
FEATURE_BRANCH="feature/task-{{task_id}}-implementation"
BRANCH_EXISTS="false"

    if git show-ref --verify --quiet refs/heads/$FEATURE_BRANCH; then
        BRANCH_EXISTS="true"
        echo "Feature branch '$FEATURE_BRANCH' exists, checking out..."
        git checkout $FEATURE_BRANCH

        echo "📥 Merging latest main into $FEATURE_BRANCH..."
        if git merge origin/main --no-edit; then
            echo "✓ Successfully merged latest main into feature branch"
        else
            echo "⚠️ MERGE CONFLICT: Cannot auto-merge main into $FEATURE_BRANCH"
            echo "❗ Manual conflict resolution required by Claude agent"
            echo ""
            echo "📋 Conflict files:"
            git status --porcelain | grep "^UU\|^AA\|^DD" || echo "   (Use 'git status' to see details)"
            echo ""
            echo "🔧 Claude will need to resolve conflicts manually before proceeding"
            # Don't exit - let Claude handle the conflicts
        fi
    else
        # Create new feature branch from latest main
        echo "Creating new feature branch '$FEATURE_BRANCH' from latest main..."
        git checkout -b $FEATURE_BRANCH origin/main
        echo "✓ Created feature branch: $FEATURE_BRANCH"
    fi

# 5. Set Working Directory (Critical for Claude Execution)
WORK_DIR="{{working_directory}}"
if [ "$WORK_DIR" = "." ] || [ -z "$WORK_DIR" ]; then
  CLAUDE_WORK_DIR="/workspace/$REPO_NAME"
else
  CLAUDE_WORK_DIR="/workspace/$REPO_NAME/$WORK_DIR"
fi
mkdir -p "$CLAUDE_WORK_DIR" && cd "$CLAUDE_WORK_DIR"
echo "✓ Set working directory: $CLAUDE_WORK_DIR"
echo "🔑 CRITICAL: Claude will be launched from this directory"

# Working directory setup completed above

# Configure git user after successful clone
echo "=== POST-CLONE GIT CONFIGURATION ==="
# Fix dubious ownership issues
git config --global --add safe.directory "/workspace/$REPO_NAME"
echo "✓ Added repository to safe directories"

# Set git config locally in the working repository (persistent on PVC)
if [ -d "/workspace/$REPO_NAME/.git" ]; then
    cd "/workspace/$REPO_NAME"
    git config --local user.name "$GITHUB_USER"
    git config --local user.email "${GITHUB_USER}@users.noreply.github.com"
    # Set up automatic upstream for new branches
    git config --local push.autoSetupRemote true
    echo "✓ Configured git user in target repository: $GITHUB_USER"
    echo "✓ Enabled automatic upstream setup for new branches"
fi

cd /workspace

# Copy ConfigMap files to working directory (AFTER repository clone)
echo "=== CONFIGMAP FILE SETUP ==="

# Claude working directory already set above during repository setup

echo "Setting up files in Claude working directory: $CLAUDE_WORK_DIR"
cd "$CLAUDE_WORK_DIR"

# Copy all files from ConfigMap to working directory
if [ -d "/task-files" ]; then
  echo "Copying ConfigMap files to working directory..."

  # CLAUDE.md Memory Persistence Logic (controlled by overwriteMemory CRD field)
        OVERWRITE_MEMORY="{{overwrite_memory}}"

  # Handle CLAUDE.md based on overwriteMemory setting
        if [ "$OVERWRITE_MEMORY" = "true" ]; then
          # Overwrite mode: Always replace CLAUDE.md with fresh template
    cp "/task-files/CLAUDE.md" "$CLAUDE_WORK_DIR/CLAUDE.md"
    cp "/task-files/CLAUDE.md" "/workspace/CLAUDE.md"
          echo "✓ Overwrote CLAUDE.md memory file (fresh start requested)"
          echo "✓ Copied CLAUDE.md to workspace root for easy access"
        else
          # Preserve mode (default): Only copy if doesn't exist
          if [ ! -f "$CLAUDE_WORK_DIR/CLAUDE.md" ]; then
      # Initial creation - copy from ConfigMap
      cp "/task-files/CLAUDE.md" "$CLAUDE_WORK_DIR/CLAUDE.md"
      cp "/task-files/CLAUDE.md" "/workspace/CLAUDE.md"
            echo "✓ Created initial CLAUDE.md memory file"
            echo "✓ Copied CLAUDE.md to workspace root for easy access"
          else
            echo "✓ Preserved existing CLAUDE.md memory file (maintaining accumulated context)"
            # Still copy to workspace root for consistency
            cp "$CLAUDE_WORK_DIR/CLAUDE.md" "/workspace/CLAUDE.md"
            echo "✓ Synced CLAUDE.md to workspace root"
          fi
        fi

  # Copy all other markdown files (excluding CLAUDE.md)
  for md_file in /task-files/*.md; do
    if [ -f "$md_file" ]; then
      basename_file=$(basename "$md_file")
      # Skip CLAUDE.md since we handled it above
      if [ "$basename_file" != "CLAUDE.md" ]; then
        cp "$md_file" "$CLAUDE_WORK_DIR/"
        echo "✓ Updated $basename_file"
      fi
    fi
  done

  # Verify enterprise settings (mounted directly from ConfigMap)
  if [ -f "/etc/claude-code/managed-settings.json" ]; then
    echo "✓ Enterprise settings verified"
    if ! jq empty /etc/claude-code/managed-settings.json 2>/dev/null; then
      echo "❌ Invalid enterprise settings JSON"
      exit 1
    fi
  else
    echo "❌ Enterprise settings not found"
    exit 1
  fi

  # Copy guidelines files to working directory
  if [ -f "/task-files/coding-guidelines.md" ]; then
    cp /task-files/coding-guidelines.md "$CLAUDE_WORK_DIR/"
    echo "✓ Copied coding-guidelines.md to working directory"
  fi

  if [ -f "/task-files/github-guidelines.md" ]; then
    cp /task-files/github-guidelines.md "$CLAUDE_WORK_DIR/"
    echo "✓ Copied github-guidelines.md to working directory"
  fi

  # System prompt will be rendered inline (no file copying needed)
  echo "✓ System prompt template will be rendered inline"

  # Hook copying disabled
  echo "! Hook scripts disabled - no hooks will be copied"

  # Set up MCP configuration
  echo "Setting up MCP configuration..."
  mkdir -p "$CLAUDE_WORK_DIR/.claude"
  chmod 755 "$CLAUDE_WORK_DIR/.claude"

  # Copy MCP configuration from ConfigMap
  if [ -f "/task-files/mcp.json" ]; then
    cp /task-files/mcp.json "$CLAUDE_WORK_DIR/.claude/mcp.json"
    echo "✓ Copied mcp.json to .claude/mcp.json"
  else
    echo "⚠️  mcp.json template not found"
  fi
  
  # Enterprise managed settings are mounted directly from ConfigMap  
  echo "=== ENTERPRISE MANAGED SETTINGS ==="
  echo "✓ Settings mounted directly from ConfigMap at: /etc/claude-code/managed-settings.json"
  echo "✓ No copying needed - mount automatically reflects latest ConfigMap changes"

  echo "✓ ConfigMap files copied to $CLAUDE_WORK_DIR"
else
  echo "⚠️  Warning: /task-files directory not found (ConfigMap not mounted?)"
fi

# Ensure toolman-config.json is available in Claude's working directory
echo "=== TOOLMAN CONFIG SETUP ==="
WORKSPACE_CONFIG="/workspace/$REPO_NAME/toolman-config.json"
CLAUDE_CONFIG="$CLAUDE_WORK_DIR/toolman-config.json"

if [ -f "$WORKSPACE_CONFIG" ]; then
  cp "$WORKSPACE_CONFIG" "$CLAUDE_CONFIG"
  echo "✓ toolman-config.json copied to Claude working directory"
else
  echo "⚠️ toolman-config.json not found at $WORKSPACE_CONFIG - toolman may not work correctly"
fi

# Copy Current Task Documentation to Working Directory
echo "=== TASK DOCUMENTATION SETUP ==="
echo "🔍 DEBUG: WORKFLOW_TYPE is: $WORKFLOW_TYPE"
echo "🔍 DEBUG: REPO_NAME is: $REPO_NAME" 
echo "🔍 DEBUG: CLAUDE_WORK_DIR is: $CLAUDE_WORK_DIR"
echo "🔍 DEBUG: Task ID is: {{task_id}}"

# Task directory should already exist from multi-repo workflow or be created as needed
mkdir -p "$CLAUDE_WORK_DIR/task"
echo "✓ Created task directory at: $CLAUDE_WORK_DIR/task"

# Task documentation should already be available in the task/ directory
if [ "$WORKFLOW_TYPE" = "single-repo" ]; then
    echo "✓ Copying task documentation from repository's .taskmaster directory"
    
    # Copy task files from .taskmaster/docs/task-{id} to task/ directory
    # Use docs_project_directory if specified
    {{#if docs_project_directory}}
    if [ "{{docs_project_directory}}" = "." ]; then
        SINGLE_TASK_DIR="/workspace/$REPO_NAME/.taskmaster/docs/task-{{task_id}}"
    else
        SINGLE_TASK_DIR="/workspace/$REPO_NAME/{{docs_project_directory}}/.taskmaster/docs/task-{{task_id}}"
    fi
    {{else}}
    SINGLE_TASK_DIR="/workspace/$REPO_NAME/.taskmaster/docs/task-{{task_id}}"
    {{/if}}
    echo "🔍 DEBUG: Looking for task files at: $SINGLE_TASK_DIR"
    
    # Debug: Check if .taskmaster directory exists (use correct path based on docs_project_directory)
    {{#if docs_project_directory}}
    if [ "{{docs_project_directory}}" = "." ]; then
        TASKMASTER_DIR="/workspace/$REPO_NAME/.taskmaster"
    else
        TASKMASTER_DIR="/workspace/$REPO_NAME/{{docs_project_directory}}/.taskmaster"
    fi
    {{else}}
    TASKMASTER_DIR="/workspace/$REPO_NAME/.taskmaster"
    {{/if}}
    
    echo "🔍 DEBUG: Checking if .taskmaster directory exists at: $TASKMASTER_DIR"
    if [ -d "$TASKMASTER_DIR" ]; then
        echo "✓ .taskmaster directory found"
        echo "🔍 DEBUG: Contents of .taskmaster directory:"
        ls -la "$TASKMASTER_DIR/" || echo "Could not list .taskmaster contents"
        
        echo "🔍 DEBUG: Contents of .taskmaster/docs directory:"
        ls -la "$TASKMASTER_DIR/docs/" || echo "Could not list docs contents"
    else
        echo "❌ .taskmaster directory NOT found at $TASKMASTER_DIR"
        echo "🔍 DEBUG: Contents of repository root:"
        ls -la "/workspace/$REPO_NAME/" || echo "Could not list repo contents"
        
        {{#if docs_project_directory}}
        echo "🔍 DEBUG: Contents of docs project directory:"
        ls -la "/workspace/$REPO_NAME/{{docs_project_directory}}/" || echo "Could not list docs project directory contents"
        {{/if}}
    fi
    
    if [ -d "$SINGLE_TASK_DIR" ]; then
        echo "🔍 DEBUG: Task directory found, contents:"
        ls -la "$SINGLE_TASK_DIR"
        
        echo "✅ Copying task.txt to task.md..."
        if [ -f "$SINGLE_TASK_DIR/task.txt" ]; then
            cp "$SINGLE_TASK_DIR/task.txt" "$CLAUDE_WORK_DIR/task/task.md" && echo "✓ task.txt copied as task.md" || echo "❌ task.txt copy failed"
        else
            echo "⚠️ task.txt not found"
        fi
        
        echo "✅ Copying acceptance-criteria.md..."
        if [ -f "$SINGLE_TASK_DIR/acceptance-criteria.md" ]; then
            cp "$SINGLE_TASK_DIR/acceptance-criteria.md" "$CLAUDE_WORK_DIR/task/" && echo "✓ acceptance-criteria.md copied" || echo "❌ acceptance-criteria.md copy failed"
        else
            echo "⚠️ acceptance-criteria.md not found"
        fi
        
        echo "✅ Copying prompt.md..."
        if [ -f "$SINGLE_TASK_DIR/prompt.md" ]; then
            cp "$SINGLE_TASK_DIR/prompt.md" "$CLAUDE_WORK_DIR/task/" && echo "✓ prompt.md copied" || echo "❌ prompt.md copy failed"
        else
            echo "⚠️ prompt.md not found"
        fi
        
        echo "✅ Copying toolman-config.json..."
        if [ -f "$SINGLE_TASK_DIR/toolman-config.json" ]; then
            cp "$SINGLE_TASK_DIR/toolman-config.json" "/workspace/$REPO_NAME/toolman-config.json" && echo "✓ toolman-config.json copied to workspace root" || echo "❌ toolman-config.json copy failed"
        else
            echo "⚠️ toolman-config.json not found - toolman may not work correctly"
        fi
        
        echo "✅ Copying toolman-guide.md..."
        if [ -f "$SINGLE_TASK_DIR/toolman-guide.md" ]; then
            cp "$SINGLE_TASK_DIR/toolman-guide.md" "$CLAUDE_WORK_DIR/task/" && echo "✓ toolman-guide.md copied" || echo "❌ toolman-guide.md copy failed"
        else
            echo "⚠️ toolman-guide.md not found - code agent won't have tool usage guidance"
        fi
        
        echo "✓ Task {{task_id}} files copied from $SINGLE_TASK_DIR"
    else
        echo "❌ CRITICAL: Task {{task_id}} directory not found at: $SINGLE_TASK_DIR"
        echo "🔍 DEBUG: Available directories in .taskmaster/docs:"
        find "$TASKMASTER_DIR" -name "task-*" -type d 2>/dev/null || echo "No task directories found"
        exit 1
    fi
    
    # Copy architecture.md from docs root
    ARCH_FILE="$TASKMASTER_DIR/docs/architecture.md"
    if [ -f "$ARCH_FILE" ]; then
        cp "$ARCH_FILE" "$CLAUDE_WORK_DIR/task/"
        echo "✓ Architecture documentation copied"
    else
        echo "⚠️ architecture.md not found at: $ARCH_FILE"
    fi
    
    # Copy tasks.json if it exists
    if [ -f "$TASKMASTER_DIR/tasks/tasks.json" ]; then
        cp "$TASKMASTER_DIR/tasks/tasks.json" "$CLAUDE_WORK_DIR/task/"
        echo "✓ tasks.json copied"
    fi
    
    # DEBUG: Verify files were copied successfully
    echo "🔍 DEBUG: Contents of target task directory after copy:"
    ls -la "$CLAUDE_WORK_DIR/task/" || echo "Task directory not found"
    echo "🔍 DEBUG: Checking if prompt.md exists:"
    [ -f "$CLAUDE_WORK_DIR/task/prompt.md" ] && echo "✅ prompt.md exists" || echo "❌ prompt.md missing"
    
else
    echo "✓ Task documentation copied from docs repository during multi-repo setup"
fi

echo '=== WORKSPACE VALIDATION ==='

# Check for required files in Claude's working directory
MISSING_FILES=""
REQUIRED_FILES="CLAUDE.md"

echo "Checking for required files..."
for file in $REQUIRED_FILES; do
  if [ ! -f "$CLAUDE_WORK_DIR/$file" ]; then
    echo "ERROR: Missing required file: $CLAUDE_WORK_DIR/$file"
    MISSING_FILES="$MISSING_FILES $file"
  else
    echo "✓ Found: $CLAUDE_WORK_DIR/$file"
    # Show file size for verification
    size=$(wc -c < "$CLAUDE_WORK_DIR/$file" 2>/dev/null || echo "0")
    echo "  File size: $size bytes"
  fi
done

# Check git repository (REQUIRED for implementation tasks)
if [ ! -d "/workspace/$REPO_NAME/.git" ]; then
  echo "✗ CRITICAL ERROR: No target git repository found!"
  MISSING_FILES="$MISSING_FILES git-repository"
else
  echo "✓ Found: target git repository"
fi

# If any files are missing, abort
if [ -n "$MISSING_FILES" ]; then
  echo ""
  echo "═══════════════════════════════════════════════════════════════"
  echo "║                 WORKSPACE VALIDATION FAILED                  ║"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  echo "The following required files are missing:"
  for missing in $MISSING_FILES; do
    case "$missing" in
      "CLAUDE.md")
        echo "  ❌ $missing - Main task instructions for Claude"
        ;;
      "git-repository")
        echo "  ❌ $missing - Required for committing implementation changes"
        ;;
      *)
        echo "  ❌ $missing"
        ;;
    esac
  done
  echo ""
  echo "These files should have been created by the ConfigMap setup process."
  echo "Claude will NOT be started to avoid wasting API credits."
  echo ""
  exit 1
fi

echo "✓ All required files present. Workspace is valid."

echo '=== IMPLEMENTATION TASK DIAGNOSTICS ==='
echo "Project directory: $CLAUDE_WORK_DIR"
echo "Project directory contents:"
ls -la "$CLAUDE_WORK_DIR"
echo ""

# Show git status
echo "Git status:"
git status 2>/dev/null || echo "Git status unavailable"
echo ""

echo '=== CLAUDE EXECUTION ==='

# Export necessary variables
export SERVICE_NAME="{{service}}"
export TASK_ID="{{task_id}}"

# Change to project directory before running Claude
cd "$CLAUDE_WORK_DIR"
echo "Changed to directory: $(pwd)"

# Verify we're in the correct directory and have required files
echo "=== WORKING DIRECTORY VERIFICATION ==="
echo "Current working directory: $(pwd)"
echo "Expected directory: $CLAUDE_WORK_DIR"
if [ "$(pwd)" != "$CLAUDE_WORK_DIR" ]; then
  echo "❌ ERROR: Failed to change to correct working directory!"
  echo "Attempting to change directory again..."
  cd "$CLAUDE_WORK_DIR" || exit 1
  echo "✓ Successfully changed to: $(pwd)"
fi

# Verify setup
echo "✓ Code implementation environment ready"

# Build Claude command
CLAUDE_CMD="claude -p --output-format stream-json --verbose"

# Add model flag if specified via environment variable
if [ -n "$MODEL" ]; then
    CLAUDE_CMD="$CLAUDE_CMD --model $MODEL"
    echo "Using specified model: $MODEL"
fi

# Add continue flag if this is a retry attempt or user requested continuation
{{#if continue_session}}
CLAUDE_CMD="$CLAUDE_CMD --continue"
echo 'Adding --continue flag (attempt {{attempts}}{{#if user_requested}} - user requested{{/if}})'
{{/if}}

echo "════════════════════════════════════════════════════════════════"
echo "║                    STARTING CLAUDE EXECUTION                  ║"
echo "════════════════════════════════════════════════════════════════"
echo "Command: $CLAUDE_CMD"
echo "Note: Claude will automatically read CLAUDE.md from the working directory"

# Inline system prompt (static content)
SYSTEM_PROMPT='## 🚨 CRITICAL SYSTEM REQUIREMENTS 🚨

**⛔ OVERCONFIDENCE MITIGATION - MANDATORY VERIFICATION ⛔**

You have a DANGEROUS tendency to declare task completion before actually verifying everything works. This is ABSOLUTELY UNACCEPTABLE.

**MANDATORY VERIFICATION REQUIREMENTS:**
- ✅ **MUST** actually run and test your code - never assume it works
- ✅ **MUST** verify ALL acceptance criteria through actual testing
- ✅ **MUST** confirm your changes don'\''t break existing functionality
- ✅ **MUST** test end-to-end workflows and edge cases
- ✅ **MUST** run all linters and build checks successfully
- ✅ **CANNOT** claim completion based on code appearance alone

**YOU ARE PROHIBITED FROM CLAIMING SUCCESS UNTIL:**
1. You have executed and verified every piece of functionality
2. You have tested integration with existing systems
3. You have confirmed all acceptance criteria pass through testing
4. All automated tests pass (linting, builds, unit tests)
5. You have verified the solution works end-to-end in practice

**IF YOU DECLARE SUCCESS WITHOUT VERIFICATION, YOU HAVE FAILED.**

## 🔧 ORCHESTRATOR EXECUTION CONTEXT

- **Service**: {{service}}
- **Task ID**: {{task_id}}
- **Repository**: {{repository_url}}
- **Docs Repository**: {{docs_repository_url}}
- **Working Directory**: {{working_directory}}

{{#if continue_session}}
## 🔄 CONTINUE SESSION - PR COMMENT RESOLUTION PRIORITY

**⚠️ MANDATORY FIRST STEP: Before proceeding with any other work, you MUST:**

1. **Check for unresolved PR comments**: Use `gh pr view --json reviews` or check the PR directly
2. **Resolve ALL pending comments first**: Address reviewer feedback, fix issues, respond to questions
3. **Push comment resolutions**: Commit and push any fixes for reviewer concerns
4. **Only then proceed**: After ALL PR comments are resolved, continue with the main task

**This ensures reviewer feedback takes priority and maintains collaborative workflow quality.**

{{/if}}
## ⚠️ EXECUTION REQUIREMENTS

- **Follow patterns**: Use @coding-guidelines.md and @github-guidelines.md
- **GitHub workflow**: Read @github-guidelines.md for commit standards and **🚨 MANDATORY: CREATE A PULL REQUEST USING `gh pr create` - THE TASK IS NOT COMPLETE WITHOUT THIS STEP 🚨**
- **Verify continuously**: Run tests and checks after each significant change
- **Commit incrementally**: Don'\''t save all changes for the end
- **Test thoroughly**: Validate against acceptance criteria before completion

**Remember**: Focus on thorough implementation and verification.'

echo "Starting Claude execution..."
echo "=========================="

# Safe mode toggle for debugging (prevents token consumption)
SAFE_MODE="false"  # Set to "false" for full task execution

if [ "$SAFE_MODE" = "true" ]; then
    echo "🛡️ SAFE MODE ENABLED - Running simple test instead of full task"
    echo "What time is it? Please answer this simple question and exit immediately." | $CLAUDE_CMD
else
    # Debug: Show what's actually in the task directory before checking for prompt.md
    echo "🔍 DEBUG: About to check for prompt.md at: $CLAUDE_WORK_DIR/task/prompt.md"
    echo "🔍 DEBUG: Contents of task directory:"
    ls -la "$CLAUDE_WORK_DIR/task/" || echo "Task directory not found or empty"
    echo "🔍 DEBUG: Current working directory contents:"
    ls -la "$CLAUDE_WORK_DIR/" || echo "Working directory not accessible"
    
    # Check if prompt.md exists and use it as main prompt
    if [ -f "$CLAUDE_WORK_DIR/task/prompt.md" ]; then
        echo "✓ Using task-specific prompt from docs service: task/prompt.md"

        echo "startingTask:{{task_id}}"
        echo ""

        # Prepare prompt prefix for toolman guidance
        PROMPT_PREFIX=""
        if [ -f "$CLAUDE_WORK_DIR/task/toolman-guide.md" ]; then
            PROMPT_PREFIX="🔧 **CRITICAL: Tool Usage Reference**

Before starting implementation, you MUST read and follow the task-specific tool guidance in the file \`task/toolman-guide.md\`. This file contains:
- Selected tools for this specific task
- When and how to use each tool
- Tool arguments, parameters, and configuration options
- Implementation workflow and best practices
- Tool relationships and sequencing

**The toolman-guide.md is your authoritative reference for tool usage in this task.**

---

"
            echo "✓ Including toolman guidance prefix"
        else
            echo "⚠️ No toolman-guide.md found - proceeding without tool guidance"
        fi

        # Get main prompt content
        MAIN_PROMPT="$(cat $CLAUDE_WORK_DIR/task/prompt.md)"
        
        # Combine prefix with main prompt
        FULL_PROMPT="${PROMPT_PREFIX}${MAIN_PROMPT}"

        # Use combined prompt with system prompt (unchanged)
        $CLAUDE_CMD --append-system-prompt "$SYSTEM_PROMPT" "$FULL_PROMPT"
    else
        echo "❌ ERROR: No prompt.md found from docs service"
        echo "The docs service should always provide task/prompt.md"
        echo "Check docs repository and task configuration"
        exit 1
    fi
fi

echo '════════════════════════════════════════════════════════════════'
echo '║                 IMPLEMENTATION TASK COMPLETE                 ║'
echo '════════════════════════════════════════════════════════════════'

# Claude execution completed - no hooks configured
echo "Claude has completed successfully."