#!/bin/bash
# Post-completion hook for code implementation - PR creation

# IMMEDIATE DEBUG - Write to PVC to verify hook is called
echo "=== STOP HOOK DEBUG START ===" >> /workspace/hook-debug.log
echo "Hook called at: $(date)" >> /workspace/hook-debug.log
echo "PWD: $(pwd)" >> /workspace/hook-debug.log
echo "USER: $(whoami)" >> /workspace/hook-debug.log
echo "ENV PATH: $PATH" >> /workspace/hook-debug.log
echo "=== END DEBUG ===" >> /workspace/hook-debug.log

echo "üîó STOP HOOK - Starting code implementation PR creation..."
echo "Timestamp: $(date)"
echo "Working directory: $(pwd)"

# Create a test file to prove the stop hook ran
echo "Stop hook executed at $(date)" > .stop-hook-executed
echo "‚úÖ Created .stop-hook-executed file"

# Check if we have any changes (including untracked files)
if git diff --quiet HEAD 2>/dev/null && git diff --cached --quiet HEAD 2>/dev/null; then
    # Check for untracked files (excluding .stop-hook-executed and common temp files)
    UNTRACKED_FILES=$(git ls-files --others --exclude-standard | grep -v -E '(\.stop-hook-executed|node_modules|\.env)' | wc -l)
    if [ "$UNTRACKED_FILES" -eq 0 ]; then
        echo "‚ÑπÔ∏è  No code changes found - exiting"
        exit 0
    fi
fi

echo "üìù Code changes detected - proceeding with PR creation"

# Get the current branch (this should be our feature branch)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "üìç Current feature branch: $CURRENT_BRANCH"

# Stage all changes including untracked files
echo "üìù Staging all changes..."
git add .

# Check if there are staged changes
if git diff --cached --quiet; then
    echo "‚ÑπÔ∏è  No changes to commit after staging"
    exit 0
fi

# Commit changes
COMMIT_MSG="feat: implement {{service_name}} task {{task_id}}

- Implemented core functionality as specified
- Added necessary dependencies and configuration
- Created project structure and basic setup
- Branch: $CURRENT_BRANCH

ü§ñ Auto-generated by orchestrator code agent"

if git commit -m "$COMMIT_MSG"; then
    echo "‚úÖ Successfully committed implementation changes"
else
    echo "‚ùå Failed to commit changes"
    exit 1
fi

# Push the current feature branch
if git push -u origin "$CURRENT_BRANCH"; then
    echo "‚úÖ Successfully pushed feature branch: $CURRENT_BRANCH"
else
    echo "‚ùå Failed to push feature branch"
    exit 1
fi

# Create PR from feature branch to main
if command -v gh >/dev/null 2>&1; then
    PR_TITLE="feat: implement {{service_name}} task {{task_id}}"
    PR_BODY="## Implementation Complete

**Generated by:** Claude Code Agent
**PR Created by:** Orchestrator Hook (stop-code-pr-creation.sh)
**Working Directory:** {{working_directory}}
**Branch:** \`$CURRENT_BRANCH\` ‚Üí \`main\`
**Timestamp:** $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")
**Target Task:** {{task_id}}
**Service:** {{service_name}}

### Changes
- Implemented task {{task_id}} for {{service_name}}
- Added core functionality and dependencies
- Created proper project structure
- Configured environment and build setup

### Implementation Details
- Task specification followed from platform repository
- All acceptance criteria addressed
- Code follows project conventions
- Ready for review and testing

### Files Modified/Created
$(git diff --name-status HEAD~1 | sed 's/^/- /')

### Notes
This PR was automatically created by the **orchestrator post-completion hook**.
The Claude agent implemented the functionality, and the hook handled git workflow and PR creation.

ü§ñ **Auto-generated by Hook** - Review and merge when ready"

    if gh pr create \
        --title "$PR_TITLE" \
        --body "$PR_BODY" \
        --base "main" \
        --head "$CURRENT_BRANCH"; then
        echo "‚úÖ Pull request created successfully"
        echo "üìù PR: $PR_TITLE"
        echo "üîó From: $CURRENT_BRANCH ‚Üí main"
    else
        echo "‚ö†Ô∏è PR creation failed (may already exist or GitHub CLI authentication issue)"
    fi
else
    echo "‚ö†Ô∏è GitHub CLI not available - PR must be created manually"
    echo "üìù Manual PR details:"
    echo "   Title: feat: implement {{service_name}} task {{task_id}}"
    echo "   From: $CURRENT_BRANCH"
    echo "   To: main"
fi

echo "üéâ Code implementation stop hook completed successfully!"