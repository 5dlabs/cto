apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openmemory.fullname" . }}
  labels:
    {{- include "openmemory.labels" . | nindent 4 }}
data:
  config.json: |
    {
      "database": {
        "path": "{{ .Values.database.path }}",
        "backup": {
          "enabled": {{ .Values.database.backup.enabled }},
          "schedule": "{{ .Values.database.backup.schedule }}",
          "retention": {{ .Values.database.backup.retention }}
        }
      },
      "embeddings": {
        "provider": "{{ .Values.embeddings.provider }}",
        "model": "{{ .Values.embeddings.localModel }}",
        "dimensions": {{ .Values.embeddings.dimensions }},
        "cache": {
          "enabled": {{ .Values.embeddings.cacheEnabled }},
          "size": {{ .Values.embeddings.cacheSize }}
        }
      },
      "memory": {
        "decay": {
          "enabled": {{ .Values.memory.decay.enabled }},
          "lambda": {{ .Values.memory.decay.lambda }},
          "minSalience": {{ .Values.memory.decay.minSalience }}
        },
        "sectors": {{ .Values.memory.sectors | toJson }},
        "waypoints": {
          "enabled": {{ .Values.memory.waypoints.enabled }},
          "maxConnections": {{ .Values.memory.waypoints.maxConnections }},
          "similarityThreshold": {{ .Values.memory.waypoints.similarityThreshold }}
        }
      },
      "api": {
        "rateLimit": {
          "enabled": {{ .Values.api.rateLimit.enabled }},
          "windowMs": {{ .Values.api.rateLimit.windowMs }},
          "maxRequests": {{ .Values.api.rateLimit.maxRequests }}
        },
        "cors": {
          "enabled": {{ .Values.api.cors.enabled }},
          "origins": {{ .Values.api.cors.origins | toJson }}
        },
        "auth": {
          "enabled": {{ .Values.api.auth.enabled }},
          "type": "{{ .Values.api.auth.type }}"
        }
      },
      "performance": {
        "queryTimeout": {{ .Values.performance.queryTimeout }},
        "maxConcurrentQueries": {{ .Values.performance.maxConcurrentQueries }},
        "cache": {
          "resultCacheEnabled": {{ .Values.performance.resultCacheEnabled }},
          "resultCacheTTL": {{ .Values.performance.resultCacheTTL }}
        },
        "connection": {
          "maxConnections": {{ .Values.performance.maxConnections }},
          "connectionTimeout": {{ .Values.performance.connectionTimeout }}
        }
      },
      "monitoring": {
        "metrics": {
          "enabled": {{ .Values.monitoring.metrics.enabled }},
          "port": {{ .Values.monitoring.metrics.port }},
          "path": "{{ .Values.monitoring.metrics.path }}"
        },
        "healthCheck": {
          "enabled": {{ .Values.monitoring.healthCheck.enabled }},
          "path": "{{ .Values.monitoring.healthCheck.path }}"
        }
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openmemory.fullname" . }}-agents
  labels:
    {{- include "openmemory.labels" . | nindent 4 }}
data:
  agents.json: |
    {
      "agents": {
        {{- range $name, $config := .Values.agents }}
        {{- if $config.enabled }}
        "{{ $name }}": {
          "namespace": "{{ $config.namespace }}",
          "queryLimit": {{ $config.queryLimit }},
          "reinforcementMultiplier": {{ $config.reinforcementMultiplier }}
        }{{ if not (last (keys $.Values.agents) | eq $name) }},{{ end }}
        {{- end }}
        {{- end }}
      }
    }
