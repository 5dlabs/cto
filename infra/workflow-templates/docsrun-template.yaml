---
# Argo Workflow Template for DocsRun Tasks  
# This template creates DocsRun CRDs and lets the existing controller handle execution

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: docsrun-template
  namespace: agent-platform
  labels:
    app.kubernetes.io/name: docsrun-template
    app.kubernetes.io/part-of: platform
    agents.platform/template-type: docsrun
spec:
  # Define input parameters that match the MCP server interface
  arguments:
    parameters:
      # Required parameters from MCP server  
      - name: working-directory
        description: "Working directory within the repository (Task Master project path)"
      # Authentication (one required)
      - name: github-user
        description: "GitHub username for commits and authentication (deprecated - use github-app)"
        default: ""
      - name: github-app
        description: "GitHub App name for authentication (e.g., '5DLabs-Morgan')"
        default: "5DLabs-Morgan"
      
      # Optional parameters
      - name: source-branch
        description: "Source branch to work from"
        default: "main"
      - name: model
        description: "Claude model to use for documentation generation"
        default: "claude-opus-4-20250514"

  # Service account for workflow execution
  serviceAccountName: argo-workflow
  
  # Workflow timeout
  activeDeadlineSeconds: 1800  # 30 minutes default
  
  # Main workflow entry point
  entrypoint: docsrun-main
  
  templates:
    # Main DocsRun execution - create CRD and wait for completion
    - name: docsrun-main
      steps:
      - - name: create-docsrun-resource
          template: create-docsrun-resource
      - - name: wait-for-completion
          template: wait-docsrun-completion
          arguments:
            parameters:
            - name: docsrun-name
              value: "{{steps.create-docsrun-resource.outputs.parameters.name}}"
          
    - name: create-docsrun-resource
      outputs:
        parameters:
        - name: name
          valueFrom:
            jsonPath: '{.metadata.name}'
      resource:
        action: create
        setOwnerReference: true
        manifest: |
          apiVersion: agents.platform/v1
          kind: DocsRun
          metadata:
            generateName: "docsrun-morgan-"
            namespace: agent-platform
            labels:
              workflow-name: "{{workflow.name}}"
              github-app: "{{workflow.parameters.github-app}}"
          spec:
            workingDirectory: "{{workflow.parameters.working-directory}}"
            githubApp: "{{workflow.parameters.github-app}}"
            sourceBranch: "{{workflow.parameters.source-branch}}"
            repositoryUrl: "{{workflow.parameters.repository-url}}"
            model: "{{workflow.parameters.model}}"
            
    - name: wait-docsrun-completion
      inputs:
        parameters:
        - name: docsrun-name
      resource:
        action: get
        manifest: |
          apiVersion: agents.platform/v1
          kind: DocsRun
          metadata:
            name: "{{inputs.parameters.docsrun-name}}"
            namespace: agent-platform
        successCondition: status.phase == Succeeded
        failureCondition: status.phase == Failed
            
  # Cleanup policy - aggressive cleanup for development
  ttlStrategy:
    secondsAfterCompletion: 300    # Keep completed workflows for 5 minutes
    secondsAfterFailure: 3600      # Keep failed workflows for 1 hour
  
  # Pod garbage collection
  podGC:
    strategy: OnPodCompletion      # Delete pods immediately when they complete