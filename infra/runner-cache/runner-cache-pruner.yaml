---
# Periodic cleanup job for the shared ARC runner cache PVC
apiVersion: batch/v1
kind: CronJob
metadata:
  name: runner-cache-pruner
  namespace: arc-runners
  labels:
    app.kubernetes.io/name: runner-cache-pruner
    app.kubernetes.io/part-of: platform
spec:
  # Run every 6 hours to keep cache growth under control
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: runner-cache-pruner
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cleaner
              image: busybox:1.36
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  echo "[$(date -u '+%Y-%m-%dT%H:%M:%SZ')] Runner cache usage before cleanup:"
                  du -sh /cache || true
                  echo "[$(date -u '+%Y-%m-%dT%H:%M:%SZ')] Purging cache contents..."
                  find /cache -mindepth 1 -maxdepth 1 -exec rm -rf {} +
                  sync
                  echo "[$(date -u '+%Y-%m-%dT%H:%M:%SZ')] Runner cache usage after cleanup:"
                  du -sh /cache || true
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 200m
                  memory: 256Mi
              volumeMounts:
                - name: runner-cache
                  mountPath: /cache
          volumes:
            - name: runner-cache
              persistentVolumeClaim:
                claimName: runner-cache-pvc

