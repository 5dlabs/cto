---
# Mailu External Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mailu-database-secret
  namespace: mailu
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: secret-store
    kind: ClusterSecretStore
  target:
    name: mailu-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Keep the existing secret-key from Helm
        secret-key: "{{ .secretkey }}"
        # Add the database password from PostgreSQL secret
        DB_PW: "{{ .dbpassword }}"
        # SendGrid SMTP relay credentials
        RELAYHOST: "smtp.sendgrid.net"
        RELAYUSER: "apikey"
        RELAYPASSWORD: "{{ .sendgridapikey }}"
  data:
  - secretKey: secretkey
    remoteRef:
      key: mailu-config
      property: secret_key
  - secretKey: dbpassword
    remoteRef:
      key: mailu-config  
      property: db_password
  - secretKey: sendgridapikey
    remoteRef:
      key: mailu-config
      property: sendgrid_api_key
