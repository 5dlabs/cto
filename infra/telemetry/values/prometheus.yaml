---
# Prometheus Helm Values for Claude Code Telemetry

# Server configuration
server:
  # Enable server
  enabled: true

  # Image configuration
  image:
    repository: quay.io/prometheus/prometheus
    tag: v2.54.1
    pullPolicy: IfNotPresent

  # Resource allocation - adjusted for development environment
  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 1000m
      memory: 2Gi

  # Data retention period
  retention: 15d

  # Storage configuration
  persistentVolume:
    enabled: true
    size: 50Gi
    storageClass: local-path

  # Enable remote write receiver for OTel collector
  extraFlags:
    - web.enable-remote-write-receiver

  # Global scrape settings
  global:
    scrape_interval: 15s
    scrape_timeout: 10s
    evaluation_interval: 15s

  # Service configuration
  # Note: Using helm default port 80 (targets container 9090)
  service:
    type: ClusterIP
    servicePort: 80
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "80"
      prometheus.io/path: "/metrics"

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  # Liveness and readiness probes
  livenessProbe:
    httpGet:
      path: /-/healthy
      port: 9090
    initialDelaySeconds: 30
    periodSeconds: 15

  readinessProbe:
    httpGet:
      path: /-/ready
      port: 9090
    initialDelaySeconds: 5
    periodSeconds: 5

  # Pod annotations
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"

# Scrape configurations
serverFiles:
  prometheus.yml:
    scrape_configs:
      # Scrape Prometheus itself
      - job_name: prometheus
        static_configs:
          - targets:
              - localhost:9090

      # Scrape OpenTelemetry Collector's Prometheus exporter
      # Port 8889 = prometheus exporter (configured in otel-collector chart)
      # This includes both OTEL collector internal metrics and scraped application metrics
      - job_name: otel-collector
        static_configs:
          - targets:
              - otel-collector-opentelemetry-collector.observability.svc.cluster.local:8889
            labels:
              namespace: observability
              service: otel-collector

      # Scrape Claude Code metrics from OTLP collector's Prometheus endpoint
      - job_name: claude-code-metrics
        static_configs:
          - targets:
              - otel-collector-opentelemetry-collector.observability.svc.cluster.local:8889
        metric_relabel_configs:
          # Only keep claude_code metrics
          - source_labels: [__name__]
            regex: 'claude_code.*'
            action: keep

      # Scrape kube-state-metrics for pod/container status
      - job_name: kube-state-metrics
        static_configs:
          - targets:
              - kube-state-metrics.observability.svc.cluster.local:8080
        metric_relabel_configs:
          # Keep pod and container status metrics
          - source_labels: [__name__]
            regex: 'kube_pod_.*|kube_container_.*|kube_job_.*|kube_namespace_.*'
            action: keep

      # Scrape Loki metrics (for LokiDown alert)
      - job_name: loki
        static_configs:
          - targets:
              - loki-gateway.observability.svc.cluster.local:80
            labels:
              namespace: observability
              service: loki

      # Scrape Alertmanager metrics (for AlertmanagerDown alert)
      - job_name: alertmanager
        static_configs:
          - targets:
              - alertmanager.observability.svc.cluster.local:9093
            labels:
              namespace: observability
              service: alertmanager

      # Scrape Grafana metrics (for GrafanaDown alert)
      - job_name: grafana
        static_configs:
          - targets:
              - grafana.observability.svc.cluster.local:80
            labels:
              namespace: observability
              service: grafana

      # Scrape Kubernetes metrics-server
      - job_name: metrics-server
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - kube-system
        scheme: https
        tls_config:
          insecure_skip_verify: true  # metrics-server uses self-signed certs
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: metrics-server
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: https

# Disable components we deploy separately or don't need
alertmanager:
  enabled: false

kube-state-metrics:
  enabled: false

prometheus-node-exporter:
  enabled: false

prometheus-pushgateway:
  enabled: false

# Ingress configuration
ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  hosts:
    - host: prometheus.local
      paths:
        - path: /
          pathType: Prefix

# Service Monitor for Prometheus Operator (if available)
serviceMonitor:
  enabled: false

