#!/bin/sh

echo '════════════════════════════════════════════════════════════════'
echo '║                 IMPLEMENTATION TASK STARTING                 ║'
echo '════════════════════════════════════════════════════════════════'

# Disable interactive Git prompts globally
export GIT_TERMINAL_PROMPT=0
export GIT_ASKPASS=/bin/true
export SSH_ASKPASS=/bin/true

# Setup authentication based on repository URL type
{{#if repository}}
REPO_URL="{{repository.url}}"
if echo "$REPO_URL" | grep -q "^git@\|^ssh://"; then
  echo "SSH repository URL detected"
  USE_SSH=true
else
  echo "HTTPS repository URL detected"
  USE_SSH=false
fi

# SSH Authentication Setup
if [ "$USE_SSH" = "true" ]; then
  echo "=== SSH AUTHENTICATION SETUP ==="

  # Check if SSH key is mounted (mounted to /ssh-keys by orchestrator)
  if [ -f "/ssh-keys/ssh-privatekey" ]; then
    echo "✓ SSH private key found"

    # Create .ssh directory with proper permissions
    mkdir -p /root/.ssh
    chmod 700 /root/.ssh

    # Copy SSH keys to writable location with correct permissions
    cp /ssh-keys/ssh-privatekey /root/.ssh/id_rsa
    chmod 600 /root/.ssh/id_rsa

    # Copy public key if available
    if [ -f "/ssh-keys/ssh-publickey" ]; then
      cp /ssh-keys/ssh-publickey /root/.ssh/id_rsa.pub
      chmod 644 /root/.ssh/id_rsa.pub
    fi

    # Add GitHub to known hosts
    ssh-keyscan github.com >> /root/.ssh/known_hosts 2>/dev/null || echo "Warning: Failed to add GitHub to known hosts"

    # Test SSH connection
    echo "Testing SSH connection to GitHub..."
    ssh -T git@github.com 2>&1 | head -3 || echo "SSH test completed"

    echo "✓ SSH authentication configured successfully"
  else
    echo "❌ SSH private key not found at /ssh-keys/ssh-privatekey"
    echo "   Expected SSH key secret to be mounted at /ssh-keys"
    exit 1
  fi
else
  # HTTPS Authentication Setup
  echo "=== HTTPS AUTHENTICATION SETUP ==="

  # Use environment variables directly (they're mounted as secrets)
  if [ -n "$GITHUB_TOKEN" ] && [ -n "$GITHUB_USER" ]; then
    echo "✓ GitHub environment variables found"

    # Configure git user FIRST
    git config --global user.name "$GITHUB_USER"
    git config --global user.email "${GITHUB_USER}@users.noreply.github.com"

    # Disable interactive prompts for git operations
    git config --global credential.helper ""
    git config --global core.askPass ""

    # Create credentials file with proper format
    mkdir -p /root/.git-credentials-dir
    echo "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com" > /root/.git-credentials
    chmod 600 /root/.git-credentials

    # Configure git to use the credentials file
    git config --global credential.helper 'store --file=/root/.git-credentials'

    # Also set up workspace-specific credentials (for compatibility)
    echo "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com" > /workspace/.git-credentials
    chmod 600 /workspace/.git-credentials

    echo "✓ Git credentials configured for user: $GITHUB_USER"

  else
    echo "❌ Missing GITHUB_TOKEN or GITHUB_USER environment variables"
    echo "   GITHUB_TOKEN present: $([ -n "$GITHUB_TOKEN" ] && echo "yes" || echo "no")"
    echo "   GITHUB_USER present: $([ -n "$GITHUB_USER" ] && echo "yes" || echo "no")"
    exit 1
  fi
fi

# =============================================================================
# GITHUB AUTHENTICATION TESTING
# =============================================================================
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "║                 GITHUB AUTHENTICATION TESTING                ║"
echo "═══════════════════════════════════════════════════════════════"
echo ""

# Test 1: Basic GitHub API access
echo "=== TEST 1: GitHub API Authentication ==="
if [ -n "$GITHUB_TOKEN" ]; then
  echo "Testing GitHub API access..."
  API_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user)
  if echo "$API_RESPONSE" | grep -q '"login"'; then
    API_USER=$(echo "$API_RESPONSE" | grep '"login"' | sed 's/.*"login": *"\([^"]*\)".*/\1/')
    echo "✓ GitHub API authentication successful"
    echo "  Authenticated as: $API_USER"
  else
    echo "❌ GitHub API authentication failed"
    echo "   Response: $API_RESPONSE"
    echo ""
    echo "🚫 ABORTING: Cannot proceed without GitHub API access"
    exit 1
  fi
else
  echo "❌ No GITHUB_TOKEN available for API testing"
  exit 1
fi

# Test 2: Repository access permissions
echo ""
echo "=== TEST 2: Repository Access Verification ==="
REPO_URL="{{repository.url}}"
# Extract owner/repo from URL
if echo "$REPO_URL" | grep -q "github.com"; then
  REPO_PATH=$(echo "$REPO_URL" | sed 's|.*github.com[/:]||' | sed 's|\.git$||')
  echo "Testing repository access for: $REPO_PATH"

  REPO_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$REPO_PATH")
  if echo "$REPO_RESPONSE" | grep -q '"full_name"'; then
    echo "✓ Repository is accessible via API"

    # Check permissions
    PERMISSIONS=$(echo "$REPO_RESPONSE" | grep -o '"permissions":{[^}]*}' || echo "")
    if echo "$PERMISSIONS" | grep -q '"push":true'; then
      echo "✓ Push permissions confirmed"
    else
      echo "⚠️  WARNING: Push permissions may be limited"
      echo "   Permissions: $PERMISSIONS"
    fi
  else
    echo "❌ Repository not accessible via API"
    echo "   Response: $REPO_RESPONSE"
    echo ""
    echo "🚫 ABORTING: Cannot access target repository"
    exit 1
  fi
else
  echo "⚠️  Non-GitHub repository detected, skipping API permission check"
fi

{{else}}
echo "⚠️ No repository configured for authentication setup"
{{/if}}

# Clone repository to get project files
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "║                    REPOSITORY SETUP                          ║"
echo "═══════════════════════════════════════════════════════════════"

{{#if repository}}
# Repository information
REPO_URL="{{repository.url}}"
REPO_BRANCH="{{repository.branch}}"
GITHUB_USER="{{repository.githubUser}}"

echo "Cloning repository: $REPO_URL"
echo "Branch: $REPO_BRANCH"
echo "GitHub User: $GITHUB_USER"

# Clone the repository to /workspace
if [ -d "/workspace/.git" ]; then
  echo "Repository already exists, pulling latest changes..."
  cd /workspace

  # Ensure we have the right remote configuration
  git remote set-url origin "$REPO_URL"

  echo "Fetching from origin..."
  if ! git fetch origin; then
    echo "❌ Failed to fetch from origin"
    echo "🚫 ABORTING: Cannot fetch repository updates"
    exit 1
  fi

  echo "Checking out branch: $REPO_BRANCH"
  if ! git checkout "$REPO_BRANCH"; then
    echo "❌ Failed to checkout branch: $REPO_BRANCH"
    exit 1
  fi

  echo "Pulling latest changes..."
  if ! git pull origin "$REPO_BRANCH"; then
    echo "❌ Failed to pull latest changes"
    exit 1
  fi
else
  echo "Cloning repository..."
  echo "DEBUG: Contents of /workspace before clone:"
  ls -la /workspace

  # Handle non-empty workspace directory by temporarily backing up existing files
  if [ "$(ls -A /workspace 2>/dev/null)" ]; then
    echo "Workspace is not empty, backing up existing files..."
    BACKUP_DIR="/tmp/workspace-backup"
    rm -rf "$BACKUP_DIR"
    mkdir -p "$BACKUP_DIR"

    # Backup existing files (like .gitconfig)
    cp -r /workspace/. "$BACKUP_DIR/" 2>/dev/null || true

    # Clear workspace for clean clone
    rm -rf /workspace/*
    rm -rf /workspace/.[^.]*  # Remove hidden files but keep . and ..

    # Clone to temp directory first, then move contents
    TEMP_CLONE_DIR="/tmp/repo-clone"
    rm -rf "$TEMP_CLONE_DIR"

    if ! git clone --depth 1 --branch "$REPO_BRANCH" "$REPO_URL" "$TEMP_CLONE_DIR"; then
      echo ""
      echo "═══════════════════════════════════════════════════════════════"
      echo "║                   REPOSITORY CLONE FAILED                    ║"
      echo "═══════════════════════════════════════════════════════════════"
      echo ""
      echo "❌ Failed to clone repository: $REPO_URL"
      echo "   Branch: $REPO_BRANCH"
      echo ""
      echo "Debugging information:"
      echo "  • Git version: $(git --version)"
      echo "  • Git config (user): $(git config --global user.name) <$(git config --global user.email)>"
      echo "  • Git config (credential): $(git config --global credential.helper)"
      echo ""
      echo "🚫 IMPLEMENTATION TASK CANNOT PROCEED WITHOUT REPOSITORY"
      echo ""
      exit 1
    fi

    # Move cloned repository contents to workspace
    echo "Moving repository contents to workspace..."
    mv "$TEMP_CLONE_DIR"/* /workspace/ 2>/dev/null || true
    mv "$TEMP_CLONE_DIR"/.[^.]* /workspace/ 2>/dev/null || true
    rm -rf "$TEMP_CLONE_DIR"
    cd /workspace

    # Restore backed up files that don't conflict with repository
    echo "Restoring non-conflicting workspace files..."
    for file in "$BACKUP_DIR"/.gitconfig "$BACKUP_DIR"/.git-credentials; do
      if [ -f "$file" ]; then
        cp "$file" /workspace/ 2>/dev/null || true
        echo "✓ Restored: $(basename "$file")"
      fi
    done
    cd /workspace
  else
    # Workspace is empty, clone directly
    if ! git clone --depth 1 --branch "$REPO_BRANCH" "$REPO_URL" /workspace; then
      echo ""
      echo "═══════════════════════════════════════════════════════════════"
      echo "║                   REPOSITORY CLONE FAILED                    ║"
      echo "═══════════════════════════════════════════════════════════════"
      echo ""
      echo "❌ Failed to clone repository: $REPO_URL"
      echo "   Branch: $REPO_BRANCH"
      echo ""
      echo "🚫 IMPLEMENTATION TASK CANNOT PROCEED WITHOUT REPOSITORY"
      echo ""
      exit 1
    fi
    cd /workspace
  fi
fi

echo "✓ Repository cloned successfully"

# Configure git user after successful clone
echo "=== POST-CLONE GIT CONFIGURATION ==="
# Fix dubious ownership issue when repository is cloned as different user
git config --global --add safe.directory /workspace
echo "✓ Added /workspace to safe directories"

git config --global user.name "{{repository.githubUser}}"
git config --global user.email "{{repository.githubUser}}@users.noreply.github.com"
echo "✓ Configured git user: {{repository.githubUser}}"

{{else}}
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "║                NO REPOSITORY CONFIGURED                      ║"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "❌ CRITICAL ERROR: No repository configured for implementation task"
echo ""
echo "Implementation tasks require:"
echo "  • Repository URL to clone source code"
echo "  • Git repository for committing changes"
echo ""
echo "🚫 IMPLEMENTATION TASK CANNOT PROCEED WITHOUT REPOSITORY"
echo ""
exit 1
{{/if}}

# Copy ConfigMap files to working directory (AFTER repository clone)
echo "=== CONFIGMAP FILE SETUP ==="

# For implementation tasks, Claude works in the repository root
CLAUDE_WORK_DIR="/workspace"

echo "Setting up files in Claude working directory: $CLAUDE_WORK_DIR"
cd "$CLAUDE_WORK_DIR"

# Copy all files from ConfigMap to working directory
if [ -d "/config" ]; then
  echo "Copying ConfigMap files to working directory..."

  # Copy markdown files (force overwrite any existing files)
  cp -f /config/*.md "$CLAUDE_WORK_DIR/" 2>/dev/null && echo "✓ Copied markdown files" || echo "! No markdown files to copy"

  # Set up Claude Code local settings (user-level settings)
  echo "=== CLAUDE CODE LOCAL SETTINGS ==="
  mkdir -p "$CLAUDE_WORK_DIR/.claude"
  chmod 755 "$CLAUDE_WORK_DIR/.claude"

  # Copy Claude settings as local settings
  if [ -f "/config/settings-local.json" ]; then
    cp /config/settings-local.json "$CLAUDE_WORK_DIR/.claude/settings.local.json"
    chmod 644 "$CLAUDE_WORK_DIR/.claude/settings.local.json"
    echo "✓ Copied settings-local.json to .claude/settings.local.json"
  else
    echo "❌ ERROR: Claude settings template not found in ConfigMap!"
    echo "Expected: /config/settings-local.json"
    exit 1
  fi

  # Validate the settings JSON
  if jq empty "$CLAUDE_WORK_DIR/.claude/settings.local.json" 2>/dev/null; then
    echo "✓ Local settings JSON is valid"
    echo "✓ Model configuration, tools, and permissions are defined"

    echo ""
    echo "Local settings contents:"
    cat "$CLAUDE_WORK_DIR/.claude/settings.local.json" | jq . 2>/dev/null || cat "$CLAUDE_WORK_DIR/.claude/settings.local.json"
  else
    echo "❌ Local settings JSON is invalid"
    cat "$CLAUDE_WORK_DIR/.claude/settings.local.json"
    exit 1
  fi

  # Copy all hook scripts from hooks directory
  if [ -d "/config/hooks" ]; then
    echo "Copying hook scripts..."
    cp /config/hooks/*.sh "$CLAUDE_WORK_DIR/" 2>/dev/null && echo "✓ Copied hook scripts" || echo "! No hook scripts to copy"
    chmod +x "$CLAUDE_WORK_DIR"/*.sh 2>/dev/null
  else
    echo "! No hooks directory found in ConfigMap"
  fi

  echo "✓ ConfigMap files copied to $CLAUDE_WORK_DIR"
else
  echo "⚠️  Warning: /config directory not found (ConfigMap not mounted?)"
fi

echo '=== WORKSPACE VALIDATION ==='

# Check for required files in Claude's working directory
MISSING_FILES=""
REQUIRED_FILES="CLAUDE.md"

echo "Checking for required files..."
for file in $REQUIRED_FILES; do
  if [ ! -f "$CLAUDE_WORK_DIR/$file" ]; then
    echo "ERROR: Missing required file: $CLAUDE_WORK_DIR/$file"
    MISSING_FILES="$MISSING_FILES $file"
  else
    echo "✓ Found: $CLAUDE_WORK_DIR/$file"
    # Show file size for verification
    size=$(wc -c < "$CLAUDE_WORK_DIR/$file" 2>/dev/null || echo "0")
    echo "  File size: $size bytes"
  fi
done

# Check git repository (REQUIRED for implementation tasks)
if [ ! -d "/workspace/.git" ]; then
  echo "✗ CRITICAL ERROR: No git repository found!"
  MISSING_FILES="$MISSING_FILES git-repository"
else
  echo "✓ Found: git repository"
fi

# If any files are missing, abort
if [ -n "$MISSING_FILES" ]; then
  echo ""
  echo "═══════════════════════════════════════════════════════════════"
  echo "║                 WORKSPACE VALIDATION FAILED                  ║"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  echo "The following required files are missing:"
  for missing in $MISSING_FILES; do
    case "$missing" in
      "CLAUDE.md")
        echo "  ❌ $missing - Main task instructions for Claude"
        ;;
      "git-repository")
        echo "  ❌ $missing - Required for committing implementation changes"
        ;;
      *)
        echo "  ❌ $missing"
        ;;
    esac
  done
  echo ""
  echo "These files should have been created by the ConfigMap setup process."
  echo "Claude will NOT be started to avoid wasting API credits."
  echo ""
  exit 1
fi

echo "✓ All required files present. Workspace is valid."

echo '=== IMPLEMENTATION TASK DIAGNOSTICS ==='
echo "Project directory: $CLAUDE_WORK_DIR"
echo "Project directory contents:"
ls -la "$CLAUDE_WORK_DIR"
echo ""

# Show git status
echo "Git status:"
git status 2>/dev/null || echo "Git status unavailable"
echo ""

echo '=== CLAUDE EXECUTION ==='

# Export necessary variables
export SERVICE_NAME="{{service_name}}"
export TASK_ID="{{task_id}}"

# Change to project directory before running Claude
cd "$CLAUDE_WORK_DIR"
echo "Changed to directory: $(pwd)"

# Verify we're in the correct directory and have required files
echo "=== WORKING DIRECTORY VERIFICATION ==="
echo "Current working directory: $(pwd)"
echo "Expected directory: $CLAUDE_WORK_DIR"
if [ "$(pwd)" != "$CLAUDE_WORK_DIR" ]; then
  echo "❌ ERROR: Failed to change to correct working directory!"
  echo "Attempting to change directory again..."
  cd "$CLAUDE_WORK_DIR" || exit 1
  echo "✓ Successfully changed to: $(pwd)"
fi

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "║                    CLAUDE CONTENT PREVIEW                     ║"
echo "════════════════════════════════════════════════════════════════"
echo ""

echo "=== 1. LOCAL SETTINGS (.claude/settings.local.json) ==="
if [ -f ".claude/settings.local.json" ]; then
  echo "Local settings contents:"
  cat ".claude/settings.local.json" | jq . 2>/dev/null || cat ".claude/settings.local.json"
else
  echo "❌ Local settings file not found!"
fi
echo ""

echo "=== 2. CLAUDE TASK INSTRUCTIONS (CLAUDE.md) ==="
if [ -f "CLAUDE.md" ]; then
  echo "Full CLAUDE.md contents:"
  cat "CLAUDE.md"
else
  echo "❌ CLAUDE.md not found!"
fi
echo ""

echo "=== 3. ADDITIONAL MARKDOWN FILES ==="
echo "Other markdown files in working directory:"
for md_file in *.md; do
  if [ -f "$md_file" ] && [ "$md_file" != "CLAUDE.md" ]; then
    echo ""
    echo "--- FILE: $md_file ---"
    cat "$md_file"
    echo ""
  fi
done
echo ""

echo "════════════════════════════════════════════════════════════════"
echo "║                    END CONTENT PREVIEW                        ║"
echo "════════════════════════════════════════════════════════════════"
echo ""

# Build Claude command
CLAUDE_CMD="{{command}} -p --output-format stream-json --verbose"

# Add model flag if specified and different from default
{{#if model_override}}
CLAUDE_CMD="$CLAUDE_CMD --model {{model}}"
echo "Using specified model: {{model}}"
{{/if}}

# Add retry flag if this is a retry attempt
{{#if is_retry}}
CLAUDE_CMD="$CLAUDE_CMD --continue"
echo 'Adding --continue flag for attempt {{attempts}}'
{{/if}}

echo "=== 4. ENVIRONMENT VARIABLES ==="
echo "Environment variables Claude will see:"
env | grep -E '^(CLAUDE|ANTHROPIC|OTEL|SERVICE_NAME|TASK_ID|GITHUB|NODE_ENV|DISABLE)' | sort || echo "No relevant env vars found"
echo ""

echo "=== 5. WORKING DIRECTORY STATE ==="
echo "Current working directory: $(pwd)"
echo "Directory contents:"
ls -la
echo ""

echo "════════════════════════════════════════════════════════════════"
echo "║                    STARTING CLAUDE EXECUTION                  ║"
echo "════════════════════════════════════════════════════════════════"
echo "Command: $CLAUDE_CMD"
echo "Note: Claude will automatically read CLAUDE.md from the working directory"
echo "Starting Claude execution..."
echo "=========================="

# Load the prompt template content
PROMPT="{{prompt_content}}"

echo "=== 6. FINAL EXECUTION ==="
echo "CLAUDE.md (project memory): Will be automatically loaded by Claude"
echo "Prompt (task instruction): $PROMPT"
echo "=== END EXECUTION INFO ==="
echo ""

exec $CLAUDE_CMD "$PROMPT"

echo '════════════════════════════════════════════════════════════════'
echo '║                 IMPLEMENTATION TASK COMPLETE                 ║'
echo '════════════════════════════════════════════════════════════════'