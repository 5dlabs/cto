#!/bin/sh
# Factory PR Review - Stitch
# Executes PR review tasks triggered by GitHub events
# Spawned via CodeRun CRD (runType: review) when PRs are opened, CI fails, or review commands are issued

set -e

echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
echo 'â•‘           STITCH PR REVIEW (FACTORY) STARTING                â•‘'
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
echo "ğŸ¯ Agent: {{github_app}}"
echo "ğŸ”¢ PR Number: {{pr_number}}"
echo "ğŸ“‚ Repository: {{repository_url}}"
echo "ğŸ” Review Mode: {{review_mode}}"
echo "âš¡ Trigger: {{trigger}}"
echo "ğŸ“ Head SHA: {{head_sha}}"

# Source common utilities if available
if [ -f /workspace/scripts/lib/common.sh ]; then
    . /workspace/scripts/lib/common.sh
fi

# Set up environment (names match agents.md documentation)
export REPOSITORY_URL="{{repository_url}}"
export PR_NUMBER="{{pr_number}}"
export HEAD_SHA="{{head_sha}}"
export REVIEW_MODE="{{review_mode}}"
export TRIGGER="{{trigger}}"

# MCP Tools configuration
export TOOLS_URL="{{tools_url}}"

# Extract owner/repo from URL
REPO_SLUG=$(echo "$REPOSITORY_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
export REPO_SLUG

echo "ğŸ“¦ Repository: $REPO_SLUG"
echo "ğŸ”§ Tools URL: $TOOLS_URL"

# Always fetch CI alerts for proactive analysis (not just when triggered by check_run)
echo ""
echo "ğŸ“Š Pre-flight: Checking CI status..."
if command -v utils >/dev/null 2>&1; then
    utils alerts --repo "$REPO_SLUG" --pr "$PR_NUMBER" --format json > /tmp/ci-alerts.json 2>/dev/null || echo "[]" > /tmp/ci-alerts.json
    
    # Count alerts by severity
    if command -v jq >/dev/null 2>&1 && [ -s /tmp/ci-alerts.json ]; then
        FAILURE_COUNT=$(jq '[.[] | select(.annotation_level == "failure")] | length' /tmp/ci-alerts.json 2>/dev/null || echo "0")
        WARNING_COUNT=$(jq '[.[] | select(.annotation_level == "warning")] | length' /tmp/ci-alerts.json 2>/dev/null || echo "0")
        export CI_ALERTS_FILE="/tmp/ci-alerts.json"
        export CI_FAILURE_COUNT="$FAILURE_COUNT"
        export CI_WARNING_COUNT="$WARNING_COUNT"
        
        if [ "$FAILURE_COUNT" -gt 0 ]; then
            echo "ğŸ”´ Found $FAILURE_COUNT CI error(s), $WARNING_COUNT warning(s)"
            echo "   â†’ CI failures will be analyzed and posted as inline comments"
        elif [ "$WARNING_COUNT" -gt 0 ]; then
            echo "ğŸŸ¡ Found $WARNING_COUNT CI warning(s)"
        else
            echo "âœ… No CI failures detected"
        fi
    else
        echo "âš ï¸  Could not parse CI alerts (jq not available)"
    fi
else
    echo "âš ï¸  utils binary not available, skipping CI analysis"
fi

# Additional context if triggered by check_run
{{#if check_run_context}}
echo ""
echo "ğŸ”´ CI Failure Analysis Mode (triggered by check_run)"
echo "   Check Run: {{check_run_context.name}}"
echo "   Check Run ID: {{check_run_context.check_run_id}}"
echo "   Conclusion: {{check_run_context.conclusion}}"
export CHECK_RUN_ID="{{check_run_context.check_run_id}}"
export CHECK_RUN_NAME="{{check_run_context.name}}"
{{/if}}

# Fetch comment context if triggered by comment
{{#if comment_context}}
echo ""
echo "ğŸ’¬ Comment-Triggered Review"
echo "   Author: {{comment_context.author}}"
echo "   Command: {{comment_context.body}}"
{{#if comment_context.file_path}}
echo "   File: {{comment_context.file_path}}:{{comment_context.line_number}}"
{{/if}}
{{/if}}

# Fetch code scan context if triggered by security alert
{{#if code_scan_context}}
echo ""
echo "ğŸ”’ Security Alert Analysis Mode"
echo "   Alert: #{{code_scan_context.alert_number}}"
echo "   Rule: {{code_scan_context.rule_id}}"
echo "   Severity: {{code_scan_context.severity}}"
{{#if code_scan_context.file_path}}
echo "   File: {{code_scan_context.file_path}}"
{{/if}}
{{/if}}

# Load agent prompt
AGENT_PROMPT="/task-files/agents.md"
if [ ! -f "${AGENT_PROMPT}" ]; then
    echo "âŒ Agent prompt not found at ${AGENT_PROMPT}"
    exit 1
fi

# =========================================================================
# MCP TOOLS VALIDATION
# =========================================================================
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘                 VALIDATING MCP TOOLS ACCESS                   â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Display configured remote tools
echo ""
echo "ğŸ“‹ Configured Remote Tools:"
{{#if remote_tools}}
{{#each remote_tools}}
echo "  â€¢ {{this}}"
{{/each}}
{{else}}
echo "  (none configured)"
{{/if}}

# Verify Factory MCP tools are available using droid --list-tools
echo ""
echo "ğŸ” Verifying Factory MCP tools..."
if command -v droid >/dev/null 2>&1; then
    TOOL_LIST=$(droid exec --list-tools 2>&1 || echo "FAILED")
    
    if [ "$TOOL_LIST" != "FAILED" ]; then
        # Show tool count
        TOOL_COUNT=$(echo "$TOOL_LIST" | grep -c "status:" || echo "0")
        echo "  ğŸ“Š Total tools available: $TOOL_COUNT"
        
        # List available tools for verification
        echo ""
        echo "ğŸ“‹ Available Tools:"
        echo "$TOOL_LIST" | grep "status:" | sed 's/^/  /' | head -20
        
        if [ "$TOOL_COUNT" -gt 20 ]; then
            echo "  ... and $((TOOL_COUNT - 20)) more"
        fi
    else
        echo "  âš ï¸ Could not list Factory tools (droid exec --list-tools failed)"
    fi
else
    echo "  âš ï¸ droid CLI not available for tool verification"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

echo ""
echo "ğŸš€ Starting Factory CLI (droid exec)..."
echo ""

# Run Factory with the review agent prompt
exec droid exec \
    --auto high \
    --model "{{model}}" \
    --output-format stream-json \
    "$(cat ${AGENT_PROMPT})"

