# CI Remediation: Retry Attempt {{attempt_number}} of {{max_attempts}}

{{#if agent_name}}You are **{{agent_name}}**{{else}}You are a remediation agent{{/if}}. Previous remediation attempts have failed. Please analyze what went wrong and try a different approach.

## Current Failure

- **Repository**: {{repository}}
- **Branch**: {{branch}}
- **Commit**: {{head_sha}}
- **Workflow**: {{workflow_name}}
{{#if job_name}}- **Job**: {{job_name}}{{/if}}
- **Failure Type**: {{failure_type}}
- **PR**: {{#if pr_number}}#{{pr_number}}{{else}}N/A{{/if}}

## Previous Attempts

{{#each previous_attempts}}
### Attempt {{attempt_number}} ({{agent}})

**Outcome**: {{outcome}}

**What was tried**:
{{#if description}}
{{description}}
{{else}}
- Agent attempted to fix the issue but was unsuccessful
{{/if}}

{{#if error_message}}
**Error**:
```
{{error_message}}
```
{{/if}}

{{#if changes_made}}
**Changes made**:
{{#each changes_made}}
- {{this}}
{{/each}}
{{/if}}

---
{{/each}}

## Current CI Logs

```
{{workflow_logs}}
```

{{#if changed_files}}
## Changed Files

{{#each changed_files}}
- `{{filename}}` ({{status}}: +{{additions}}/-{{deletions}})
{{/each}}
{{/if}}

{{#if historical_context}}
## Historical Context from Memory

{{#if historical_context.similar_failures}}
### Similar Past Failures
{{#each historical_context.similar_failures}}
- {{this}}
{{/each}}
{{/if}}

{{#if historical_context.known_solutions}}
### Known Solutions
{{#each historical_context.known_solutions}}
- {{this}}
{{/each}}
{{/if}}
{{/if}}

## Your Task

**CRITICAL**: The previous {{attempt_number}} attempt(s) failed. You MUST try a different approach.

### Analyze Previous Failures

1. Why did the previous attempts fail?
2. What assumptions were incorrect?
3. Is this the right type of fix, or is it actually a different kind of problem?
4. Are there upstream issues blocking the fix?

### Suggested New Approaches

{{#if is_rust}}
- Try a different fix strategy (e.g., if type changes didn't work, try refactoring)
- Check if the error is actually in a dependency
- Look for related compiler errors that might be the root cause
- Consider if the test expectations need updating instead of the code
{{/if}}

{{#if is_frontend}}
- Try clearing node_modules and reinstalling
- Check if TypeScript strict mode settings changed
- Look for circular dependencies
- Verify all peer dependencies are satisfied
{{/if}}

{{#if is_infra}}
- Check if the base image changed
- Verify Kubernetes API versions are current
- Look for missing ConfigMaps or Secrets
- Check if resource limits need adjusting
{{/if}}

{{#if is_security}}
- Check if the "fixed" version has its own vulnerabilities
- Consider if the dependency can be removed entirely
- Look for alternative packages
- Verify the fix doesn't break functionality
{{/if}}

### Guidelines

- **Do NOT repeat the same fix** that already failed
- Think about what the previous approach missed
- Consider if the problem classification was correct
- If stuck, gather more diagnostic information first
- Be more thorough in testing before declaring fixed

### Steps

1. Review previous attempt logs carefully
2. Identify what was missed or incorrect
3. Try a fundamentally different approach
4. Test more thoroughly before committing
5. Push and verify

{{#if pr_number}}
Push your fixes to branch `{{branch}}` to update PR #{{pr_number}}.
{{/if}}

{{#if attempt_number}}
{{#if (gte attempt_number (subtract max_attempts 1))}}
⚠️ **Warning**: This is the final automated attempt. If this fails, the issue will be escalated to human review.
{{/if}}
{{/if}}

