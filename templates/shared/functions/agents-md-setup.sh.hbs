# =========================================================================
# AGENTS.md Setup - Universal Agent Identity Configuration
# 
# This partial sets up AGENTS.md as the single source of truth for agent
# identity across all supported CLIs.
#
# Supported CLIs:
#   - Claude Code: CLAUDE.md symlink
#   - OpenAI Codex: AGENTS.md native
#   - Cursor: .cursor/rules/ symlink
#   - Gemini CLI: GEMINI.md symlink + settings.json
#   - OpenCode: AGENTS.md native + config
#   - Aider: .aider.conf.yml config
# =========================================================================

setup_agents_md() {
    local workspace_dir="${1:-/workspace}"
    local agent_name="${2:-{{agent_name}}}"
    
    echo "═══════════════════════════════════════════════════════════════"
    echo "║               AGENTS.MD SETUP                               ║"
    echo "═══════════════════════════════════════════════════════════════"
    
    # Verify AGENTS.md exists (should be rendered by container setup)
    if [ ! -f "${workspace_dir}/AGENTS.md" ]; then
        echo "⚠️ AGENTS.md not found at ${workspace_dir}/AGENTS.md"
        echo "   This should have been generated by the container setup."
        return 1
    fi
    
    echo "✓ AGENTS.md found at ${workspace_dir}/AGENTS.md"
    
    # =========================================================================
    # Claude Code: Symlink CLAUDE.md -> AGENTS.md
    # Claude looks for CLAUDE.md in project root
    # =========================================================================
    if [ ! -f "${workspace_dir}/CLAUDE.md" ]; then
        ln -sf AGENTS.md "${workspace_dir}/CLAUDE.md"
        echo "✓ Created CLAUDE.md symlink"
    else
        echo "ℹ️ CLAUDE.md already exists, skipping symlink"
    fi
    
    # =========================================================================
    # Gemini CLI: Symlink GEMINI.md + settings.json
    # Gemini looks for GEMINI.md or configured context file
    # =========================================================================
    if [ ! -f "${workspace_dir}/GEMINI.md" ]; then
        ln -sf AGENTS.md "${workspace_dir}/GEMINI.md"
        echo "✓ Created GEMINI.md symlink"
    fi
    
    mkdir -p "${workspace_dir}/.gemini"
    cat > "${workspace_dir}/.gemini/settings.json" << 'EOF'
{
  "context": {
    "fileName": ["AGENTS.md", "GEMINI.md"]
  }
}
EOF
    echo "✓ Created .gemini/settings.json"
    
    # =========================================================================
    # Cursor: .cursor/rules/ directory
    # Cursor looks for rules in .cursor/rules/*.mdc
    # =========================================================================
    mkdir -p "${workspace_dir}/.cursor/rules"
    if [ ! -f "${workspace_dir}/.cursor/rules/agent.mdc" ]; then
        ln -sf ../../AGENTS.md "${workspace_dir}/.cursor/rules/agent.mdc"
        echo "✓ Created .cursor/rules/agent.mdc symlink"
    fi
    
    # =========================================================================
    # Aider: .aider.conf.yml
    # Aider reads files specified in config
    # =========================================================================
    if [ ! -f "${workspace_dir}/.aider.conf.yml" ]; then
        cat > "${workspace_dir}/.aider.conf.yml" << 'EOF'
# Aider configuration - read AGENTS.md for project context
read: AGENTS.md
EOF
        echo "✓ Created .aider.conf.yml"
    fi
    
    # =========================================================================
    # OpenCode: opencode.json
    # OpenCode reads instructions from config
    # =========================================================================
    if [ ! -f "${workspace_dir}/opencode.json" ]; then
        cat > "${workspace_dir}/opencode.json" << 'EOF'
{
  "instructions": ["AGENTS.md"]
}
EOF
        echo "✓ Created opencode.json"
    fi
    
    echo ""
    echo "✓ AGENTS.md setup complete for all CLIs"
    echo "  Agent: ${agent_name}"
    echo ""
}

# Export the function for use in container scripts
export -f setup_agents_md 2>/dev/null || true

