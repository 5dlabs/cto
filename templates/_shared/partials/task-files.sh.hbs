# =========================================================================
# Task Files
# =========================================================================

mkdir -p "$CLI_WORK_DIR/task"

# Copy task files from ConfigMap first (these are templates and agent files)
cp -R /task-files/* "$CLI_WORK_DIR/task/" 2>/dev/null || true

# Fetch task-specific files from the repository's .tasks directory
# The task files are located at .tasks/docs/task-{TASK_ID}/ in the repo
TASK_ID="${TASK_ID:-}"
if [ -n "$TASK_ID" ]; then
    echo "üì• Fetching task files for task $TASK_ID..."
    
    # Check both possible locations for task files
    TASK_DOCS_DIR="$REPO_ROOT/.tasks/docs/task-$TASK_ID"
    TASK_TASKS_DIR="$REPO_ROOT/.tasks/tasks/task-$TASK_ID"
    PROJECT_TASK_DOCS_DIR="$REPO_ROOT/$DOCS_PROJECT_DIR/.tasks/docs/task-$TASK_ID"
    PROJECT_TASK_TASKS_DIR="$REPO_ROOT/$DOCS_PROJECT_DIR/.tasks/tasks/task-$TASK_ID"
    
    TASK_SOURCE_DIR=""
    
    # Try each location in order of preference
    if [ -d "$TASK_DOCS_DIR" ]; then
        TASK_SOURCE_DIR="$TASK_DOCS_DIR"
    elif [ -d "$TASK_TASKS_DIR" ]; then
        TASK_SOURCE_DIR="$TASK_TASKS_DIR"
    elif [ -d "$PROJECT_TASK_DOCS_DIR" ]; then
        TASK_SOURCE_DIR="$PROJECT_TASK_DOCS_DIR"
    elif [ -d "$PROJECT_TASK_TASKS_DIR" ]; then
        TASK_SOURCE_DIR="$PROJECT_TASK_TASKS_DIR"
    fi
    
    if [ -n "$TASK_SOURCE_DIR" ]; then
        echo "  ‚úì Found task files at: $TASK_SOURCE_DIR"
        
        # Copy prompt.md if it exists
        if [ -f "$TASK_SOURCE_DIR/prompt.md" ]; then
            cp "$TASK_SOURCE_DIR/prompt.md" "$CLI_WORK_DIR/task/prompt.md"
            echo "  ‚úì Copied prompt.md"
        elif [ -f "$TASK_SOURCE_DIR/task.md" ]; then
            # Some task structures use task.md instead of prompt.md
            cp "$TASK_SOURCE_DIR/task.md" "$CLI_WORK_DIR/task/prompt.md"
            echo "  ‚úì Copied task.md as prompt.md"
        fi
        
        # Copy acceptance criteria (check both naming conventions)
        if [ -f "$TASK_SOURCE_DIR/acceptance-criteria.md" ]; then
            cp "$TASK_SOURCE_DIR/acceptance-criteria.md" "$CLI_WORK_DIR/task/acceptance-criteria.md"
            echo "  ‚úì Copied acceptance-criteria.md"
        elif [ -f "$TASK_SOURCE_DIR/acceptance.md" ]; then
            cp "$TASK_SOURCE_DIR/acceptance.md" "$CLI_WORK_DIR/task/acceptance-criteria.md"
            echo "  ‚úì Copied acceptance.md as acceptance-criteria.md"
        fi
        
        # Copy prompt.xml for Claude (XML format produces better results)
        if [ -f "$TASK_SOURCE_DIR/prompt.xml" ]; then
            cp "$TASK_SOURCE_DIR/prompt.xml" "$CLI_WORK_DIR/task/prompt.xml"
            echo "  ‚úì Copied prompt.xml"
        fi
        
        # Copy any other .md files that might be useful (exclude already-handled files)
        for md_file in "$TASK_SOURCE_DIR"/*.md; do
            if [ -f "$md_file" ]; then
                base=$(basename "$md_file")
                # Skip files we've already handled specially
                if [ "$base" != "prompt.md" ] && [ "$base" != "task.md" ] && \
                   [ "$base" != "acceptance-criteria.md" ] && [ "$base" != "acceptance.md" ]; then
                    cp "$md_file" "$CLI_WORK_DIR/task/$base" 2>/dev/null || true
                fi
            fi
        done
    else
        echo "  ‚ö†Ô∏è Task files not found for task $TASK_ID"
        echo "     Searched: $TASK_DOCS_DIR, $TASK_TASKS_DIR"
        if [ -n "$DOCS_PROJECT_DIR" ]; then
            echo "     Also: $PROJECT_TASK_DOCS_DIR, $PROJECT_TASK_TASKS_DIR"
        fi
    fi
fi

# Verify critical task files
echo ""
echo "üìÅ Task Files:"

# Prompt (required - prefer XML for Claude)
if [ -f "$CLI_WORK_DIR/task/prompt.xml" ]; then
    echo "  ‚úì prompt.xml (XML format)"
    export PROMPT_FORMAT="xml"
elif [ -f "$CLI_WORK_DIR/task/prompt.md" ]; then
    echo "  ‚úì prompt.md"
    export PROMPT_FORMAT="md"
else
    echo "  ‚ö†Ô∏è No prompt file found"
fi

# Acceptance Criteria (required for verification)
if [ -f "$CLI_WORK_DIR/task/acceptance-criteria.md" ]; then
    echo "  ‚úì acceptance-criteria.md"
    # Count criteria for summary
    CRITERIA_COUNT=$(grep -cE '^\s*-\s*\[([ x])\]' "$CLI_WORK_DIR/task/acceptance-criteria.md" 2>/dev/null || echo "0")
    echo "    ‚îî‚îÄ $CRITERIA_COUNT criteria items"
else
    echo "  ‚ö†Ô∏è acceptance-criteria.md not found (verification will be skipped)"
fi

# Task definition
if [ -f "$CLI_WORK_DIR/task/task.md" ]; then
    echo "  ‚úì task.md"
fi

# Tools guide (optional)
if [ -f "$CLI_WORK_DIR/task/tools-guide.md" ]; then
    echo "  ‚úì tools-guide.md"
fi

# Agent guidelines
if [ -f /task-files/AGENTS.md ]; then
    cp /task-files/AGENTS.md "$CLI_WORK_DIR/"
    echo "  ‚úì AGENTS.md"
fi

echo ""
