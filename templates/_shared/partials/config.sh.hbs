# =========================================================================
# Configuration
# =========================================================================

# Retry/iteration settings  
MAX_RETRIES="${EXECUTION_MAX_RETRIES:-{{default_retries}}}"
CURRENT_ATTEMPT="${CURRENT_ATTEMPT:-1}"
ACCEPTANCE_THRESHOLD="${ACCEPTANCE_THRESHOLD:-90}"

# Model rotation configuration
# Supports both direct model_rotation array and cli_config.modelRotation
{{#if cli_config.modelRotation}}
MODEL_ROTATION_MODELS='[{{#each cli_config.modelRotation}}"{{this}}"{{#unless @last}},{{/unless}}{{/each}}]'
{{else if model_rotation}}
MODEL_ROTATION_MODELS='[{{#each model_rotation}}"{{this}}"{{#unless @last}},{{/unless}}{{/each}}]'
{{else}}
MODEL_ROTATION_MODELS='[]'
{{/if}}
DEFAULT_MODEL="{{model}}"

# Determine if rotation is enabled based on whether models array is non-empty
MODEL_ROTATION_ENABLED="false"
if [ "$(echo "$MODEL_ROTATION_MODELS" | jq 'length' 2>/dev/null)" -gt 0 ]; then
    MODEL_ROTATION_ENABLED="true"
fi

# Function to get model for current attempt (with rotation support)
get_model_for_attempt() {
    local attempt="${1:-1}"
    
    if [ "$MODEL_ROTATION_ENABLED" != "true" ]; then
        echo "$DEFAULT_MODEL"
        return
    fi
    
    # Parse rotation models array
    local model_count
    model_count=$(echo "$MODEL_ROTATION_MODELS" | jq -r 'length' 2>/dev/null || echo "0")
    
    if [ "$model_count" -eq 0 ]; then
        echo "$DEFAULT_MODEL"
        return
    fi
    
    # Zero-indexed: attempt 1 uses model[0], attempt 2 uses model[1], etc.
    local index=$(( (attempt - 1) % model_count ))
    local selected_model
    selected_model=$(echo "$MODEL_ROTATION_MODELS" | jq -r ".[$index]" 2>/dev/null)
    
    if [ -z "$selected_model" ] || [ "$selected_model" = "null" ]; then
        echo "$DEFAULT_MODEL"
    else
        echo "$selected_model"
    fi
}

# Get current model based on attempt
CURRENT_MODEL=$(get_model_for_attempt "$CURRENT_ATTEMPT")

# Export for use in scripts
export MAX_RETRIES
export CURRENT_ATTEMPT
export ACCEPTANCE_THRESHOLD
export MODEL_ROTATION_ENABLED
export MODEL_ROTATION_MODELS
export DEFAULT_MODEL
export CURRENT_MODEL
export -f get_model_for_attempt 2>/dev/null || true

echo ""
echo "ğŸ“‹ Configuration:"
echo "  ğŸ¤– CLI: {{cli_type}}"
if [ "$MODEL_ROTATION_ENABLED" = "true" ]; then
    echo "  ğŸ¯ Model: $CURRENT_MODEL (rotation enabled)"
    echo "     Rotation pool: $(echo "$MODEL_ROTATION_MODELS" | jq -r 'join(", ")' 2>/dev/null || echo "$MODEL_ROTATION_MODELS")"
else
    echo "  ğŸ¯ Model: $DEFAULT_MODEL"
fi
echo "  ğŸ”„ Attempt: $CURRENT_ATTEMPT of $MAX_RETRIES"
echo "  âœ“ Acceptance threshold: ${ACCEPTANCE_THRESHOLD}%"
{{#if continue_session}}
echo "  ğŸ” Continue session: enabled (retry mode)"
{{/if}}
echo ""
