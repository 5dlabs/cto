{{> header }}

{{!-- Node.js environment for JavaScript/TypeScript agents (Blaze, Spark, Tap, Nova) --}}
{{!-- agent_name is the lowercase extracted name (e.g., "rex", "blaze", "tap") --}}
{{#if (or (eq agent_name "blaze") (eq agent_name "spark") (eq agent_name "tap") (eq agent_name "nova") (eq task_language "typescript") (eq task_language "javascript"))}}
{{> node-env }}
{{/if}}

{{!-- Expo environment only for Tap (Expo/React Native mobile agent) --}}
{{#if (eq agent_name "tap")}}
{{> expo-env }}
{{/if}}

{{!-- Go environment for Grizz (Go backend agent) --}}
{{#if (or (eq agent_name "grizz") (eq task_language "go"))}}
{{> go-env }}
{{/if}}

{{> config }}

{{> github-auth }}

{{> git-setup }}

{{> task-files }}

{{> tools-config }}

{{!-- Infrastructure pre-checks for Bolt infra jobs --}}
{{#if (eq job_type "infra")}}
{{> infrastructure-setup }}
{{/if}}

{{> acceptance-probe }}

# =========================================================================
# CLI Execution
# The Rust adapter injects the CLI-specific invocation here
# =========================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
{{#if (eq job_type "infra")}}
echo "║ Executing {{cli_type}} CLI - Infrastructure Mode"
echo "║ Attempt ${CURRENT_ATTEMPT:-1} of ${EXECUTION_MAX_RETRIES:-{{default_retries}}}"
{{else}}
echo "║ Executing {{cli_type}} CLI (Attempt ${CURRENT_ATTEMPT:-1} of ${EXECUTION_MAX_RETRIES:-{{default_retries}}})"
{{/if}}
echo "════════════════════════════════════════════════════════════════"
echo ""

{{> cli_execute}}
CLI_EXIT_CODE=$?

# =========================================================================
# Post-Execution Verification
# =========================================================================

if [ $CLI_EXIT_CODE -eq 0 ]; then
    echo ""
    echo "✓ CLI execution completed successfully"
    
{{#if (eq job_type "infra")}}
{{> infrastructure-verify }}
{{/if}}
    
    # Run acceptance criteria probe
    if type probe_acceptance_criteria >/dev/null 2>&1; then
        probe_acceptance_criteria
        PROBE_RESULT=$?
        
        if [ $PROBE_RESULT -ne 0 ]; then
            echo ""
            echo "⚠️ Acceptance criteria not fully met"
            echo "   Controller will evaluate retry based on policy"
        fi
    fi
else
    echo ""
    echo "❌ CLI execution failed with exit code: $CLI_EXIT_CODE"
fi

{{> completion }}
