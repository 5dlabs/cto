#!/bin/sh
# Atlas - Batch/End-of-Play Integration Check
# Ensures all PRs from a batch or entire Play workflow are cleanly integrated

INTEGRATION_TYPE="${INTEGRATION_TYPE:-end-of-play}"
BATCH_NUMBER="${BATCH_NUMBER:-}"

if [ "$INTEGRATION_TYPE" = "batch" ]; then
    echo "Atlas: Batch $BATCH_NUMBER integration check for Play workflow {{workflow_name}}"
else
    echo "Atlas: Final integration check for Play workflow {{workflow_name}}"
fi

# Source common setup
source /agent-templates/shared_task-setup-functions.sh 2>/dev/null || true

# Setup authentication
setup_github_auth

# Determine which PRs to check
if [ "$INTEGRATION_TYPE" = "batch" ] && [ -n "$BATCH_NUMBER" ]; then
    # Batch integration: Check PRs from specific batch
    BATCH_LABEL="batch-$BATCH_NUMBER"
    echo "Checking PRs with label: $BATCH_LABEL"
    PR_FILTER="--label $BATCH_LABEL"
else
    # End-of-play: Check all PRs from this workflow
    RUN_LABEL="run-{{workflow_name}}"
    SERVICE_LABEL="service-{{service}}"
    echo "Checking PRs with labels: $RUN_LABEL, $SERVICE_LABEL"
    PR_FILTER="--label $RUN_LABEL --label $SERVICE_LABEL"
fi

# Find all relevant PRs
eval "PRS=\$(gh pr list -R \"{{repository_url}}\" $PR_FILTER --json number,headRefName,mergeable,mergeStateStatus,state --jq '.[]')"

if [ -z "$PRS" ]; then
    if [ "$INTEGRATION_TYPE" = "batch" ]; then
        echo "No PRs found for batch $BATCH_NUMBER"
    else
        echo "No PRs found for this workflow run"
    fi
    exit 0
fi

TOTAL_PRS=$(echo "$PRS" | jq -s 'length')
if [ "$INTEGRATION_TYPE" = "batch" ]; then
    echo "Found $TOTAL_PRS PRs from batch $BATCH_NUMBER"
else
    echo "Found $TOTAL_PRS PRs from this Play workflow"
fi

# Check each PR status
OPEN_PRS=0
MERGED_PRS=0
CONFLICTED_PRS=0
CLEAN_PRS=0

echo "$PRS" | jq -c '.' | while read -r pr; do
    PR_NUM=$(echo "$pr" | jq -r '.number')
    PR_STATE=$(echo "$pr" | jq -r '.state')
    MERGEABLE=$(echo "$pr" | jq -r '.mergeable')
    
    echo "PR #$PR_NUM: state=$PR_STATE, mergeable=$MERGEABLE"
    
    if [ "$PR_STATE" = "MERGED" ]; then
        MERGED_PRS=$((MERGED_PRS + 1))
    elif [ "$PR_STATE" = "OPEN" ]; then
        OPEN_PRS=$((OPEN_PRS + 1))
        
        if [ "$MERGEABLE" = "CONFLICTING" ]; then
            CONFLICTED_PRS=$((CONFLICTED_PRS + 1))
            echo "  ‚ö†Ô∏è PR #$PR_NUM has conflicts - triggering Atlas conflict resolution"
            # TODO: Trigger individual Atlas CodeRun for this PR
        elif [ "$MERGEABLE" = "MERGEABLE" ]; then
            CLEAN_PRS=$((CLEAN_PRS + 1))
        fi
    fi
done

# Post summary comment to main PR or workflow tracking issue
if [ "$INTEGRATION_TYPE" = "batch" ]; then
    SUMMARY="## üîó Atlas Batch $BATCH_NUMBER Integration Report

**Play Workflow:** {{workflow_name}}
**Batch:** $BATCH_NUMBER
**Service:** {{service}}

### PR Status Summary
- **Total PRs in Batch:** $TOTAL_PRS
- **Merged:** $MERGED_PRS ‚úÖ
- **Open & Clean:** $CLEAN_PRS ‚úÖ
- **Open & Conflicted:** $CONFLICTED_PRS ‚ö†Ô∏è

### Batch Integration Status
"
else
    SUMMARY="## üîó Atlas Final Integration Report

**Play Workflow:** {{workflow_name}}
**Service:** {{service}}

### PR Status Summary
- **Total PRs:** $TOTAL_PRS
- **Merged:** $MERGED_PRS ‚úÖ
- **Open & Clean:** $CLEAN_PRS ‚úÖ
- **Open & Conflicted:** $CONFLICTED_PRS ‚ö†Ô∏è

### Final Integration Status
"
fi

if [ $CONFLICTED_PRS -eq 0 ] && [ $OPEN_PRS -eq 0 ]; then
    if [ "$INTEGRATION_TYPE" = "batch" ]; then
        SUMMARY="$SUMMARY
‚úÖ **Batch $BATCH_NUMBER complete - All PRs merged**

All tasks from batch $BATCH_NUMBER have been successfully integrated. Ready for next batch."
    else
        SUMMARY="$SUMMARY
‚úÖ **All PRs merged - Integration complete**

All tasks from this Play workflow have been successfully integrated into main."
    fi
elif [ $CONFLICTED_PRS -eq 0 ] && [ $CLEAN_PRS -gt 0 ]; then
    SUMMARY="$SUMMARY
‚úÖ **No conflicts detected - Executing coordinated merge**

All $CLEAN_PRS open PR(s) are cleanly mergeable. Atlas will now merge them in dependency order..."
    
    echo "$SUMMARY"
    
    # Get task dependencies from tasks.json in docs repo
    DOCS_REPO="{{docs_repository}}"
    DOCS_DIR="/tmp/docs-repo"
    
    if [ -n "$DOCS_REPO" ]; then
        echo "üìã Fetching task dependencies from docs repo..."
        git clone "$DOCS_REPO" "$DOCS_DIR" 2>/dev/null || true
        
        TASKS_FILE="$DOCS_DIR/.taskmaster/tasks/tasks.json"
        if [ -f "$TASKS_FILE" ]; then
            echo "‚úÖ Found tasks.json - determining merge order..."
            
            # Extract task IDs and their dependencies
            # Sort PRs by dependency order (tasks with no deps first, then their dependents)
            SORTED_PRS=$(echo "$PRS" | jq -c 'select(.state == "OPEN" and .mergeable == "MERGEABLE")' | while read -r pr; do
                PR_NUM=$(echo "$pr" | jq -r '.number')
                
                # Extract task ID from PR labels
                TASK_ID=$(gh pr view "$PR_NUM" --json labels --jq '.labels[]? | select(.name | startswith("task-")) | .name | sub("task-"; "")' 2>/dev/null || echo "999")
                
                # Get dependency count for this task
                DEP_COUNT=$(jq -r ".tasks[] | select(.id == $TASK_ID) | .dependencies | length" "$TASKS_FILE" 2>/dev/null || echo "0")
                
                echo "$DEP_COUNT $PR_NUM"
            done | sort -n | awk '{print $2}')
            
            echo "üìä Merge order (by dependency): $SORTED_PRS"
            
            # Merge PRs in dependency order
            MERGED_COUNT=0
            for PR_NUM in $SORTED_PRS; do
                echo "üöÄ Merging PR #$PR_NUM..."
                
                if gh pr merge "$PR_NUM" --squash --delete-branch 2>/dev/null; then
                    echo "‚úÖ PR #$PR_NUM merged successfully"
                    MERGED_COUNT=$((MERGED_COUNT + 1))
                    
                    # Brief pause to let GitHub process the merge
                    sleep 5
                else
                    echo "‚ö†Ô∏è Failed to merge PR #$PR_NUM - may need manual intervention"
                fi
            done
            
            SUMMARY="$SUMMARY

**Merge Results:**
- Successfully merged: $MERGED_COUNT/$CLEAN_PRS PRs
- Merge order respected task dependencies

All PRs merged in correct dependency order."
        else
            echo "‚ö†Ô∏è tasks.json not found - merging in discovery order..."
            
            # Fallback: merge in the order we discovered them
            echo "$PRS" | jq -c 'select(.state == "OPEN" and .mergeable == "MERGEABLE")' | while read -r pr; do
                PR_NUM=$(echo "$pr" | jq -r '.number')
                gh pr merge "$PR_NUM" --squash --delete-branch 2>/dev/null || echo "‚ö†Ô∏è Failed to merge PR #$PR_NUM"
                sleep 5
            done
            
            SUMMARY="$SUMMARY

**Note:** Merged in discovery order (tasks.json not available for dependency sorting)"
        fi
    else
        echo "‚ö†Ô∏è No docs repository configured - merging in discovery order..."
        
        # Merge without dependency awareness
        echo "$PRS" | jq -c 'select(.state == "OPEN" and .mergeable == "MERGEABLE")' | while read -r pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            gh pr merge "$PR_NUM" --squash --delete-branch 2>/dev/null || echo "‚ö†Ô∏è Failed to merge PR #$PR_NUM"
            sleep 5
        done
    fi
else
    SUMMARY="$SUMMARY
‚ö†Ô∏è **Conflicts detected in $CONFLICTED_PRS PR(s)**

Long-running Atlas guardians on each PR will resolve conflicts automatically. 
This coordinator will wait for them to complete before executing merges."
fi

SUMMARY="$SUMMARY

---
*Integration coordination by Atlas at $(date -u +%Y-%m-%dT%H:%M:%SZ)*"

echo "$SUMMARY"

# Post summary to workflow tracking (if available)
# TODO: Post to centralized workflow tracking issue or Slack

# Exit successfully - Atlas ran the integration check
exit 0

