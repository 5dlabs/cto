{{> header }}

{{> node-env }}

{{> config }}

{{> github-auth }}

# =========================================================================
# Intake Configuration
# =========================================================================

CONFIG_FILE="/intake-files/config.json"
PRD_FILE="/intake-files/prd.txt"
ARCH_FILE="/intake-files/architecture.md"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Configuration file not found at $CONFIG_FILE"
    exit 1
fi

echo "ðŸ“„ Loading configuration..."
PROJECT_NAME=$(jq -r '.project_name' "$CONFIG_FILE")
REPOSITORY_URL=$(jq -r '.repository_url' "$CONFIG_FILE")

# Model configuration
PRIMARY_MODEL=$(jq -r '.primary_model' "$CONFIG_FILE")

# Task generation parameters  
NUM_TASKS=$(jq -r '.num_tasks // 15' "$CONFIG_FILE")
EXPAND_TASKS=$(jq -r '.expand_tasks // true' "$CONFIG_FILE")
ANALYZE_COMPLEXITY=$(jq -r '.analyze_complexity // true' "$CONFIG_FILE")

echo "  âœ“ Project: $PROJECT_NAME"
echo "  âœ“ Repository: $REPOSITORY_URL"
echo "  âœ“ Model: $PRIMARY_MODEL"
echo "  âœ“ Tasks: ~$NUM_TASKS"

# =========================================================================
# Repository Clone
# =========================================================================

echo ""
echo "ðŸ“¦ Cloning repository..."

CLONE_DIR="/tmp/repo-$(date +%s)"
git clone "$REPOSITORY_URL" "$CLONE_DIR" || exit 1
cd "$CLONE_DIR" || exit 1

git config user.name "Morgan Intake"
git config user.email "morgan@5dlabs.com"

PROJECT_DIR_NAME=$(echo "$PROJECT_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-*//;s/-*$//')
PROJECT_DIR="$CLONE_DIR/$PROJECT_DIR_NAME"
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR" || exit 1

# =========================================================================
# Prepare Input Files
# =========================================================================

echo ""
echo "ðŸ“ Setting up input files..."

mkdir -p .tasks/docs
cp "$PRD_FILE" ".tasks/docs/prd.txt"
[ -f "$ARCH_FILE" ] && [ -s "$ARCH_FILE" ] && cp "$ARCH_FILE" ".tasks/docs/architecture.md"

# =========================================================================
# Run Intake (supports API mode or CLI mode)
# =========================================================================

echo ""
echo "ðŸš€ Running intake workflow..."

# Check intake mode from environment (default: api)
INTAKE_MODE="${INTAKE_MODE:-api}"
INTAKE_CLI="${INTAKE_CLI:-claude}"

echo "  â„¹ï¸  Mode: $INTAKE_MODE"

if [ "$INTAKE_MODE" = "cli" ]; then
    # =========================================================================
    # CLI Mode: Use AI CLI (claude, codex, etc.) to run intake
    # =========================================================================
    echo "  â„¹ï¸  CLI: $INTAKE_CLI"
    
    # Build the prompt for the CLI
    PRD_CONTENT=$(cat .tasks/docs/prd.txt)
    ARCH_CONTENT=""
    [ -f ".tasks/docs/architecture.md" ] && ARCH_CONTENT=$(cat .tasks/docs/architecture.md)
    
    PROMPT="You are Morgan, a project management AI agent. Your task is to analyze a PRD (Product Requirements Document) and generate a structured task breakdown.

## PRD Content
$PRD_CONTENT
"
    
    if [ -n "$ARCH_CONTENT" ]; then
        PROMPT="$PROMPT
## Architecture Document
$ARCH_CONTENT
"
    fi
    
    PROMPT="$PROMPT
## Instructions
1. Analyze the PRD and architecture (if provided)
2. Generate approximately $NUM_TASKS implementation tasks
3. For each task, determine the appropriate agent:
   - bolt: Infrastructure/DevOps (databases, k8s, storage)
   - rex: Rust backend development
   - grizz: Go backend development
   - nova: Node.js/Bun backend development
   - blaze: React/TypeScript frontend
   - tap: Expo/React Native mobile
   - spark: Electron desktop
4. Create task files in .tasks/ directory:
   - .tasks/tasks/tasks.json (main task list)
   - .tasks/tasks/task-N/ directories with prompt.xml, prompt.md, acceptance_criteria.md
5. Ensure tasks have proper dependencies (no circular deps)
6. Add complexity analysis if useful

Use the available tools to create the files. Start by creating the tasks.json file.
"

    # Run the specified CLI
    case "$INTAKE_CLI" in
        claude)
            echo "  â†’ Running claude CLI..."
            claude -p "$PROMPT" --dangerously-skip-permissions --output-format stream-json || exit 1
            ;;
        codex|code)
            echo "  â†’ Running code CLI..."
            code --no-approval "$PROMPT" --sandbox workspace-write || exit 1
            ;;
        gemini)
            echo "  â†’ Running gemini CLI..."
            gemini -p "$PROMPT" --output-format stream-json || exit 1
            ;;
        opencode)
            echo "  â†’ Running opencode CLI..."
            opencode -p "$PROMPT" --output-format stream-json || exit 1
            ;;
        *)
            echo "âŒ Unknown CLI: $INTAKE_CLI"
            exit 1
            ;;
    esac
else
    # =========================================================================
    # API Mode: Use tasks CLI directly (faster, default)
    # =========================================================================
    
    # Build intake command with options
    INTAKE_CMD="tasks intake --prd .tasks/docs/prd.txt --num-tasks $NUM_TASKS"

    # Add architecture if present
    [ -f ".tasks/docs/architecture.md" ] && INTAKE_CMD="$INTAKE_CMD --architecture .tasks/docs/architecture.md"

    # Add model if specified
    [ -n "$PRIMARY_MODEL" ] && [ "$PRIMARY_MODEL" != "null" ] && INTAKE_CMD="$INTAKE_CMD --model $PRIMARY_MODEL"

    # Add research flag for better results
    INTAKE_CMD="$INTAKE_CMD --research"

    # Optionally skip expansion/analysis
    [ "$EXPAND_TASKS" = "false" ] && INTAKE_CMD="$INTAKE_CMD --no-expand"
    [ "$ANALYZE_COMPLEXITY" = "false" ] && INTAKE_CMD="$INTAKE_CMD --no-analyze"

    echo "  â†’ $INTAKE_CMD"
    eval "$INTAKE_CMD" || exit 1
fi

# Verify tasks were generated
TASKS_FILE=".tasks/tasks/tasks.json"
[ ! -f "$TASKS_FILE" ] && { echo "âŒ tasks.json not found"; exit 1; }

TASK_COUNT=$(jq '.tasks | length' "$TASKS_FILE")
echo "âœ… Generated $TASK_COUNT tasks with documentation"

# Generate individual task files (optional)
tasks generate || true

# =========================================================================
# Create Pull Request
# =========================================================================

echo ""
echo "ðŸ”€ Creating Pull Request..."

cd "$CLONE_DIR" || exit 1

BRANCH_NAME="intake-${PROJECT_DIR_NAME}-$(date +%Y%m%d-%H%M%S)"
git checkout -b "$BRANCH_NAME"
git add -A
git commit -m "feat: intake for $PROJECT_NAME

- $TASK_COUNT tasks generated
- XML + Markdown documentation per task
- Agent routing hints added
- Complexity analysis: $ANALYZE_COMPLEXITY
- Task expansion: $EXPAND_TASKS

ðŸ¤– Generated by Morgan (intake mode)"

git push -u origin "$BRANCH_NAME"

gh pr create \
    --title "ðŸš€ Intake: $PROJECT_NAME" \
    --body "## Intake: $PROJECT_NAME

### Generated Structure
\`\`\`
$PROJECT_DIR_NAME/
â”œâ”€â”€ .tasks/
â”‚   â”œâ”€â”€ docs/
â”‚   â”‚   â”œâ”€â”€ prd.txt
â”‚   â”‚   â”œâ”€â”€ architecture.md (if provided)
â”‚   â”‚   â””â”€â”€ task-*/
â”‚   â”‚       â”œâ”€â”€ prompt.xml
â”‚   â”‚       â”œâ”€â”€ prompt.md
â”‚   â”‚       â””â”€â”€ acceptance.md
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â””â”€â”€ tasks.json
â”‚   â””â”€â”€ reports/
â”‚       â””â”€â”€ task-complexity-report.json
\`\`\`

### Stats
- **Tasks**: $TASK_COUNT
- **Model**: $PRIMARY_MODEL
- **Expansion**: $EXPAND_TASKS
- **Complexity**: $ANALYZE_COMPLEXITY

ðŸ¤– Generated by Morgan" \
    --head "$BRANCH_NAME" \
    --base main || echo "âš ï¸ PR creation failed, branch pushed: $BRANCH_NAME"

{{> completion }}

