{{> header }}

{{> node-env }}

{{> config }}

{{> github-auth }}

# =========================================================================
# Intake Configuration
# =========================================================================

CONFIG_FILE="/intake-files/config.json"
PRD_FILE="/intake-files/prd.txt"
ARCH_FILE="/intake-files/architecture.md"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Configuration file not found at $CONFIG_FILE"
    exit 1
fi

echo "ðŸ“„ Loading configuration..."
PROJECT_NAME=$(jq -r '.project_name' "$CONFIG_FILE")
REPOSITORY_URL=$(jq -r '.repository_url' "$CONFIG_FILE")

# Model configuration
PRIMARY_MODEL=$(jq -r '.primary_model' "$CONFIG_FILE")

# Task generation parameters  
NUM_TASKS=$(jq -r '.num_tasks // 15' "$CONFIG_FILE")
EXPAND_TASKS=$(jq -r '.expand_tasks // true' "$CONFIG_FILE")
ANALYZE_COMPLEXITY=$(jq -r '.analyze_complexity // true' "$CONFIG_FILE")

echo "  âœ“ Project: $PROJECT_NAME"
echo "  âœ“ Repository: $REPOSITORY_URL"
echo "  âœ“ Model: $PRIMARY_MODEL"
echo "  âœ“ Tasks: ~$NUM_TASKS"

# =========================================================================
# Repository Clone
# =========================================================================

echo ""
echo "ðŸ“¦ Cloning repository..."

CLONE_DIR="/tmp/repo-$(date +%s)"
git clone "$REPOSITORY_URL" "$CLONE_DIR" || exit 1
cd "$CLONE_DIR" || exit 1

git config user.name "Morgan Intake"
git config user.email "morgan@5dlabs.com"

PROJECT_DIR_NAME=$(echo "$PROJECT_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-*//;s/-*$//')
PROJECT_DIR="$CLONE_DIR/$PROJECT_DIR_NAME"
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR" || exit 1

# =========================================================================
# Prepare Input Files
# =========================================================================

echo ""
echo "ðŸ“ Setting up input files..."

mkdir -p .tasks/docs
cp "$PRD_FILE" ".tasks/docs/prd.txt"
[ -f "$ARCH_FILE" ] && [ -s "$ARCH_FILE" ] && cp "$ARCH_FILE" ".tasks/docs/architecture.md"

# =========================================================================
# Run Intake (unified command)
# =========================================================================

echo ""
echo "ðŸš€ Running intake workflow..."

# Build intake command with options
INTAKE_CMD="tasks intake --prd .tasks/docs/prd.txt --num-tasks $NUM_TASKS"

# Add architecture if present
[ -f ".tasks/docs/architecture.md" ] && INTAKE_CMD="$INTAKE_CMD --architecture .tasks/docs/architecture.md"

# Add model if specified
[ -n "$PRIMARY_MODEL" ] && [ "$PRIMARY_MODEL" != "null" ] && INTAKE_CMD="$INTAKE_CMD --model $PRIMARY_MODEL"

# Add research flag for better results
INTAKE_CMD="$INTAKE_CMD --research"

# Optionally skip expansion/analysis
[ "$EXPAND_TASKS" = "false" ] && INTAKE_CMD="$INTAKE_CMD --no-expand"
[ "$ANALYZE_COMPLEXITY" = "false" ] && INTAKE_CMD="$INTAKE_CMD --no-analyze"

echo "  â†’ $INTAKE_CMD"
eval "$INTAKE_CMD" || exit 1

# Verify tasks were generated
TASKS_FILE=".tasks/tasks/tasks.json"
[ ! -f "$TASKS_FILE" ] && { echo "âŒ tasks.json not found"; exit 1; }

TASK_COUNT=$(jq '.tasks | length' "$TASKS_FILE")
echo "âœ… Generated $TASK_COUNT tasks with documentation"

# Generate individual task files (optional)
tasks generate || true

# =========================================================================
# Create Pull Request
# =========================================================================

echo ""
echo "ðŸ”€ Creating Pull Request..."

cd "$CLONE_DIR" || exit 1

BRANCH_NAME="intake-${PROJECT_DIR_NAME}-$(date +%Y%m%d-%H%M%S)"
git checkout -b "$BRANCH_NAME"
git add -A
git commit -m "feat: intake for $PROJECT_NAME

- $TASK_COUNT tasks generated
- XML + Markdown documentation per task
- Agent routing hints added
- Complexity analysis: $ANALYZE_COMPLEXITY
- Task expansion: $EXPAND_TASKS

ðŸ¤– Generated by Morgan (intake mode)"

git push -u origin "$BRANCH_NAME"

gh pr create \
    --title "ðŸš€ Intake: $PROJECT_NAME" \
    --body "## Intake: $PROJECT_NAME

### Generated Structure
\`\`\`
$PROJECT_DIR_NAME/
â”œâ”€â”€ .tasks/
â”‚   â”œâ”€â”€ docs/
â”‚   â”‚   â”œâ”€â”€ prd.txt
â”‚   â”‚   â”œâ”€â”€ architecture.md (if provided)
â”‚   â”‚   â””â”€â”€ task-*/
â”‚   â”‚       â”œâ”€â”€ prompt.xml
â”‚   â”‚       â”œâ”€â”€ prompt.md
â”‚   â”‚       â””â”€â”€ acceptance.md
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â””â”€â”€ tasks.json
â”‚   â””â”€â”€ reports/
â”‚       â””â”€â”€ task-complexity-report.json
\`\`\`

### Stats
- **Tasks**: $TASK_COUNT
- **Model**: $PRIMARY_MODEL
- **Expansion**: $EXPAND_TASKS
- **Complexity**: $ANALYZE_COMPLEXITY

ðŸ¤– Generated by Morgan" \
    --head "$BRANCH_NAME" \
    --base main || echo "âš ï¸ PR creation failed, branch pushed: $BRANCH_NAME"

{{> completion }}
