# =========================================================================
# Claude Code CLI Invocation Partial
# 
# This partial handles the Claude CLI command building and execution.
# Include this in workflow containers using: {{> clis/claude/invoke}}
#
# Reference: https://code.claude.com/docs/en/cli-reference
#
# Required context variables:
#   - WORK_DIR: Working directory for Claude (defaults to /workspace)
#   - PROMPT_CONTENT: The prompt to send (or read from task/prompt.md)
#
# Optional context variables:
#   - model: Model to use (defaults to settings)
#   - continue_session: If true, adds --continue flag
#   - mcp_config_path: Path to MCP config (defaults to /workspace/.mcp.json)
#   - system_prompt_path: Path to system prompt file
#   - github_app: GitHub App name for system prompt lookup
# =========================================================================

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘               CLAUDE CODE CLI INVOCATION                     â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Set working directory
WORK_DIR="${WORK_DIR:-/workspace}"
cd "$WORK_DIR"

# Build Claude command with latest CLI flags (Dec 2024)
# Core flags for programmatic/CI usage
CLAUDE_CMD="claude -p"

# Output format: stream-json for programmatic parsing
CLAUDE_CMD="$CLAUDE_CMD --output-format stream-json"
CLAUDE_CMD="$CLAUDE_CMD --input-format stream-json"

# Verbose mode for debugging
CLAUDE_CMD="$CLAUDE_CMD --verbose"

# =========================================================================
# MCP Configuration
# =========================================================================
MCP_CONFIG="${mcp_config_path:-/workspace/.mcp.json}"
if [ -f "$MCP_CONFIG" ]; then
    echo "âœ“ Adding MCP configuration: $MCP_CONFIG"
    CLAUDE_CMD="$CLAUDE_CMD --mcp-config $MCP_CONFIG"
else
    echo "âš ï¸ No MCP configuration found at $MCP_CONFIG"
fi

# =========================================================================
# System Prompt Handling
# Claude supports: --system-prompt (inline) or --system-prompt-file (file)
# Priority: 1) Explicit path, 2) agents ConfigMap, 3) task-files, 4) append
# =========================================================================
{{#if system_prompt_path}}
if [ -f "{{system_prompt_path}}" ]; then
    echo "âœ“ Using explicit system prompt: {{system_prompt_path}}"
    CLAUDE_CMD="$CLAUDE_CMD --system-prompt-file {{system_prompt_path}}"
fi
{{else}}
# Look for system prompt in standard locations
if [ -f "/config/agents/{{github_app}}_system-prompt.md" ]; then
    echo "âœ“ Using system prompt from agents ConfigMap for {{github_app}}"
    CLAUDE_CMD="$CLAUDE_CMD --system-prompt-file /config/agents/{{github_app}}_system-prompt.md"
elif [ -f "/task-files/{{github_app}}_system-prompt.md" ]; then
    echo "âœ“ Using system prompt from task-files for {{github_app}}"
    CLAUDE_CMD="$CLAUDE_CMD --system-prompt-file /task-files/{{github_app}}_system-prompt.md"
elif [ -f "$WORK_DIR/task/system-prompt.md" ]; then
    echo "âœ“ Using system prompt from task directory"
    CLAUDE_CMD="$CLAUDE_CMD --system-prompt-file $WORK_DIR/task/system-prompt.md"
else
    echo "â„¹ï¸ No system prompt file found, using defaults"
    # Can use --append-system-prompt for inline additions
    {{#if append_system_prompt}}
    CLAUDE_CMD="$CLAUDE_CMD --append-system-prompt '{{append_system_prompt}}'"
    {{/if}}
fi
{{/if}}

# =========================================================================
# Model Configuration
# Model can be set via: managed-settings.json or --model flag
# =========================================================================
{{#if model}}
echo "âœ“ Model specified: {{model}}"
# Model is typically set in managed-settings.json, but can be overridden
{{/if}}

# =========================================================================
# Continue Session (for retries)
# =========================================================================
{{#if continue_session}}
CLAUDE_CMD="$CLAUDE_CMD --continue"
echo "âœ“ Adding --continue flag (attempt {{attempts}}{{#if user_requested}} - user requested{{/if}})"
{{/if}}

# =========================================================================
# Permission Mode
# --dangerously-skip-permissions: Skip all permission prompts (for CI/automation)
# =========================================================================
CLAUDE_CMD="$CLAUDE_CMD --dangerously-skip-permissions"

echo ""
echo "ðŸš€ Claude Command: $CLAUDE_CMD"
echo ""

# =========================================================================
# Execute Claude with FIFO for streaming input
# =========================================================================
FIFO_PATH="/workspace/agent-input.jsonl"
rm -f "$FIFO_PATH" 2>/dev/null || true
mkfifo "$FIFO_PATH"
chmod 666 "$FIFO_PATH" || true

# Start Claude (reader) in background
$CLAUDE_CMD < "$FIFO_PATH" &
CLAUDE_PID=$!

# Determine prompt source
if [ -n "${PROMPT_CONTENT:-}" ]; then
    USER_PROMPT="$PROMPT_CONTENT"
elif [ -f "$WORK_DIR/task/prompt.md" ]; then
    USER_PROMPT=$(cat "$WORK_DIR/task/prompt.md")
    echo "âœ“ Using prompt from task/prompt.md"
else
    echo "âŒ ERROR: No prompt content available"
    kill "$CLAUDE_PID" 2>/dev/null || true
    exit 1
fi

# JSON-escape the prompt
USER_COMBINED=$(printf "%s" "$USER_PROMPT" | jq -Rs .)

# Send prompt via sidecar HTTP endpoint (preferred) or direct FIFO
if printf '{"text":%s}\n' "$USER_COMBINED" | \
     curl -fsS -X POST http://127.0.0.1:8080/input \
       -H 'Content-Type: application/json' \
       --data-binary @- >/dev/null 2>&1; then
    echo "âœ“ Prompt sent via sidecar /input"
else
    echo "âš ï¸ Sidecar /input failed, using direct FIFO write"
    exec 9>"$FIFO_PATH"
    printf '{"type":"user","message":{"role":"user","content":[{"type":"text","text":%s}]}}\n' "$USER_COMBINED" >&9
fi

# Wait for Claude to complete
wait "$CLAUDE_PID"
CLAUDE_EXIT_CODE=$?

# Close FIFO writer if opened
exec 9>&- 2>/dev/null || true

# Request sidecar shutdown
if [ "${SKIP_MCP_SHUTDOWN:-0}" != "1" ]; then
    curl -fsS -X POST http://127.0.0.1:8080/shutdown >/dev/null 2>&1 || true
fi

echo ""
echo "âœ“ Claude execution completed (exit code: $CLAUDE_EXIT_CODE)"
