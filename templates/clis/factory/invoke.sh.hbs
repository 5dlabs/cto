# =========================================================================
# Factory (Droid) CLI Invocation Partial
# 
# This partial handles ONLY the Factory/Droid CLI command building and execution.
# Include this in workflow containers using the cli_execute partial reference.
#
# Required context variables:
#   - CLAUDE_WORK_DIR: Working directory for execution
#   - PROMPT_CONTENT: The prompt to send (or read from task/prompt.md)
#
# Optional context variables:
#   - model: Model to use (e.g., claude-opus-4-5-20251101, gpt-5.1-codex)
#   - autonomy_level: low, medium, high (default: medium)
#   - reasoning_effort: off, none, low, medium, high
#   - enabled_tools: Comma-separated list of tools to enable
#   - disabled_tools: Comma-separated list of tools to disable
#   - use_spec: If true, use specification mode (plan before executing)
# =========================================================================

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘               FACTORY (DROID) CLI INVOCATION                 â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Build Factory/Droid command with latest CLI flags (as of Dec 2024)
# Reference: https://docs.factory.ai/reference/cli-reference
FACTORY_CMD=("droid" "exec")

# Autonomy level (controls what operations the agent can perform)
# Levels: (default=read-only), low (safe edits), medium (dev work), high (CI/CD)
AUTONOMY_LEVEL="{{#if autonomy_level}}{{autonomy_level}}{{else}}medium{{/if}}"
FACTORY_CMD+=("--auto" "$AUTONOMY_LEVEL")
echo "âœ“ Autonomy level: $AUTONOMY_LEVEL"

# Output format for streaming
FACTORY_CMD+=("-o" "stream-json")

# Model selection
{{#if model}}
FACTORY_CMD+=("-m" "{{model}}")
echo "âœ“ Model: {{model}}"
{{/if}}

# Reasoning effort (off, none, low, medium, high)
{{#if reasoning_effort}}
FACTORY_CMD+=("-r" "{{reasoning_effort}}")
echo "âœ“ Reasoning effort: {{reasoning_effort}}"
{{/if}}

# Specification mode (plan before executing)
{{#if use_spec}}
FACTORY_CMD+=("--use-spec")
echo "âœ“ Specification mode enabled"
{{/if}}

# Tool configuration
{{#if enabled_tools}}
FACTORY_CMD+=("--enabled-tools" "{{enabled_tools}}")
echo "âœ“ Enabled tools: {{enabled_tools}}"
{{/if}}

{{#if disabled_tools}}
FACTORY_CMD+=("--disabled-tools" "{{disabled_tools}}")
echo "âœ“ Disabled tools: {{disabled_tools}}"
{{/if}}

# Note: --skip-permissions-unsafe conflicts with --auto, so we rely on --auto for permissions

# Working directory
FACTORY_CMD+=("--cwd" "$CLAUDE_WORK_DIR")

# Determine prompt source
if [ -n "${PROMPT_CONTENT:-}" ]; then
    PROMPT_TEXT="$PROMPT_CONTENT"
elif [ -f "$CLAUDE_WORK_DIR/task/prompt.md" ]; then
    PROMPT_TEXT=$(cat "$CLAUDE_WORK_DIR/task/prompt.md")
    echo "âœ“ Using prompt from task/prompt.md"
else
    echo "âŒ ERROR: No prompt content available"
    exit 1
fi

# Add prompt as the final argument
FACTORY_CMD+=("$PROMPT_TEXT")

echo ""
echo "ğŸš€ Factory Command:"
echo "   droid exec --auto $AUTONOMY_LEVEL -o stream-json [options] \"<prompt>\""
echo ""

# Execute Factory
echo "Starting Factory execution..."
"${FACTORY_CMD[@]}"
FACTORY_EXIT_CODE=$?

echo ""
echo "âœ“ Factory execution completed (exit code: $FACTORY_EXIT_CODE)"

