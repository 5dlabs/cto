# =========================================================================
# OpenAI Codex CLI Invocation Partial
# 
# This partial handles the Codex CLI command building and execution.
# Include this in workflow containers using: {{> clis/codex/invoke}}
#
# Reference: https://developers.openai.com/codex/cli/reference/
#
# Required context variables:
#   - WORK_DIR: Working directory for execution (defaults to /workspace)
#   - PROMPT_CONTENT: The prompt to send (or read from task/prompt.md)
#
# Optional context variables:
#   - model: Model to use (e.g., gpt-5-codex)
#   - sandbox_mode: read-only | workspace-write | danger-full-access
#   - approval_policy: untrusted | on-failure | on-request | never
#   - full_auto: If true, sets workspace-write sandbox + on-failure approvals
#   - enable_search: If true, enables web search capability
#   - add_dirs: Additional directories to grant write access
# =========================================================================

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘               OPENAI CODEX CLI INVOCATION                    â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Set working directory
WORK_DIR="${WORK_DIR:-/workspace}"

# Build Codex command array
CODEX_CMD=("codex" "exec")

# Working directory
CODEX_CMD+=("--cd" "$WORK_DIR")

# =========================================================================
# Automation Mode Configuration
# =========================================================================
{{#if full_auto}}
# Full auto mode: workspace-write sandbox + approvals on-failure
CODEX_CMD+=("--full-auto")
echo "âœ“ Full auto mode enabled"
{{else}}
# Manual sandbox and approval configuration
SANDBOX_MODE="{{#if sandbox_mode}}{{sandbox_mode}}{{else}}workspace-write{{/if}}"
CODEX_CMD+=("--sandbox" "$SANDBOX_MODE")
echo "âœ“ Sandbox mode: $SANDBOX_MODE"

APPROVAL_MODE="{{#if approval_policy}}{{approval_policy}}{{else}}on-failure{{/if}}"
CODEX_CMD+=("--ask-for-approval" "$APPROVAL_MODE")
echo "âœ“ Approval mode: $APPROVAL_MODE"
{{/if}}

# =========================================================================
# Model Override (if specified)
# =========================================================================
{{#if model}}
CODEX_CMD+=("--model" "{{model}}")
echo "âœ“ Model: {{model}}"
{{/if}}

# =========================================================================
# Output Format
# --json: Print newline-delimited JSON events
# =========================================================================
CODEX_CMD+=("--json")

# =========================================================================
# Web Search (optional)
# =========================================================================
{{#if enable_search}}
CODEX_CMD+=("--search")
echo "âœ“ Web search enabled"
{{/if}}

# =========================================================================
# Additional Directories with Write Access
# =========================================================================
{{#if add_dirs}}
{{#each add_dirs}}
CODEX_CMD+=("--add-dir" "{{this}}")
{{/each}}
echo "âœ“ Additional directories: {{add_dirs}}"
{{/if}}

# =========================================================================
# Dangerous Mode (for fully isolated environments only)
# --dangerously-bypass-approvals-and-sandbox (--yolo)
# =========================================================================
{{#if dangerous_bypass}}
CODEX_CMD+=("--dangerously-bypass-approvals-and-sandbox")
echo "âš ï¸ DANGEROUS: Bypassing all approvals and sandbox"
{{/if}}

# =========================================================================
# Skip Git Repo Check (for non-repo directories)
# =========================================================================
{{#if skip_git_check}}
CODEX_CMD+=("--skip-git-repo-check")
{{/if}}

# =========================================================================
# Determine Prompt Source
# =========================================================================
if [ -n "${PROMPT_CONTENT:-}" ]; then
    PROMPT_TEXT="$PROMPT_CONTENT"
elif [ -f "$WORK_DIR/task/prompt.md" ]; then
    PROMPT_TEXT=$(cat "$WORK_DIR/task/prompt.md")
    echo "âœ“ Using prompt from task/prompt.md"
else
    echo "âŒ ERROR: No prompt content available"
    exit 1
fi

# Add prompt as the final argument
CODEX_CMD+=("$PROMPT_TEXT")

echo ""
echo "ğŸš€ Codex Command:"
echo "   codex exec --cd $WORK_DIR [options] \"<prompt>\""
echo ""

# =========================================================================
# Execute Codex
# =========================================================================
echo "Starting Codex execution..."
"${CODEX_CMD[@]}"
CODEX_EXIT_CODE=$?

echo ""
echo "âœ“ Codex execution completed (exit code: $CODEX_EXIT_CODE)"
