# =========================================================================
# Dexter Agent CLI Invocation Partial
#
# This partial handles ONLY the Dexter CLI command building and execution.
# Dexter is a TypeScript/Bun-based autonomous financial research agent.
# https://github.com/virattt/dexter
#
# NOTE: Dexter was rewritten from Python to TypeScript/Bun in Dec 2025.
# This script now uses Bun to run the TypeScript implementation.
#
# Required context variables:
#   - DEXTER_WORK_DIR: Working directory for Dexter
#   - PROMPT_CONTENT: The prompt/query to send to Dexter (or read from task/prompt.md)
#
# Optional context variables:
#   - model: Model to use (defaults to claude-sonnet-4-20250514)
#   - max_steps: Maximum global steps (default: 20)
#   - max_steps_per_task: Maximum steps per task (default: 5)
# =========================================================================

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "â•‘               DEXTER AGENT CLI INVOCATION                    â•‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Set working directory
DEXTER_WORK_DIR="${DEXTER_WORK_DIR:-/workspace}"
cd "$DEXTER_WORK_DIR"

# Configure model (defaults to claude-sonnet-4-20250514)
{{#if model}}
export DEXTER_MODEL="{{model}}"
echo "âœ“ Using model: {{model}}"
{{else}}
export DEXTER_MODEL="${DEXTER_MODEL:-claude-sonnet-4-20250514}"
echo "âœ“ Using model: $DEXTER_MODEL"
{{/if}}

# Configure step limits for safety
{{#if max_steps}}
export DEXTER_MAX_STEPS="{{max_steps}}"
{{else}}
export DEXTER_MAX_STEPS="${DEXTER_MAX_STEPS:-20}"
{{/if}}

{{#if max_steps_per_task}}
export DEXTER_MAX_STEPS_PER_TASK="{{max_steps_per_task}}"
{{else}}
export DEXTER_MAX_STEPS_PER_TASK="${DEXTER_MAX_STEPS_PER_TASK:-5}"
{{/if}}

echo "âœ“ Max steps: $DEXTER_MAX_STEPS, Max per task: $DEXTER_MAX_STEPS_PER_TASK"

# Verify API keys
if [ -z "$OPENAI_API_KEY" ] && [ -z "$ANTHROPIC_API_KEY" ] && [ -z "$GOOGLE_API_KEY" ]; then
    echo "âŒ ERROR: No LLM API key found. Set OPENAI_API_KEY, ANTHROPIC_API_KEY, or GOOGLE_API_KEY"
    exit 1
fi
echo "âœ“ LLM API key configured"

if [ -z "$FINANCIAL_DATASETS_API_KEY" ]; then
    echo "âš ï¸ WARNING: FINANCIAL_DATASETS_API_KEY not set. Financial research tools may not work."
else
    echo "âœ“ Financial Datasets API key configured"
fi

# Optional: Tavily API key for web search
if [ -n "$TAVILY_API_KEY" ]; then
    echo "âœ“ Tavily API key configured (web search enabled)"
fi

# Determine prompt source
if [ -n "${PROMPT_CONTENT:-}" ]; then
    USER_QUERY="$PROMPT_CONTENT"
elif [ -f "$DEXTER_WORK_DIR/task/prompt.md" ]; then
    USER_QUERY=$(cat "$DEXTER_WORK_DIR/task/prompt.md")
    echo "âœ“ Using prompt from task/prompt.md"
else
    echo "âŒ ERROR: No prompt content available"
    exit 1
fi

# Truncate query display for readability
QUERY_PREVIEW="${USER_QUERY:0:100}"
if [ ${#USER_QUERY} -gt 100 ]; then
    QUERY_PREVIEW="${QUERY_PREVIEW}..."
fi

echo ""
echo "ðŸ” Query: $QUERY_PREVIEW"
echo ""
echo "ðŸš€ Starting Dexter agent (TypeScript/Bun)..."
echo ""

# Navigate to Dexter installation directory
cd /opt/dexter

# Execute Dexter using Bun
# Dexter's TypeScript implementation uses `bun start` for interactive mode
# For programmatic use, we run the index.ts directly with the query

# Create a temporary file with the query for Dexter to process
QUERY_FILE=$(mktemp)
printf '%s' "$USER_QUERY" > "$QUERY_FILE"

echo "ðŸ“Š Initializing Dexter agent..."
echo "   Model: $DEXTER_MODEL"
echo "   Max Steps: $DEXTER_MAX_STEPS"
echo "   Max Steps Per Task: $DEXTER_MAX_STEPS_PER_TASK"
echo ""

# Run Dexter with bun
# Note: Dexter's CLI reads from stdin or accepts query as argument
# The TypeScript version uses interactive terminal UI, so we pipe the query
bun run src/index.ts < "$QUERY_FILE"
DEXTER_EXIT_CODE=$?

# Cleanup
rm -f "$QUERY_FILE"

echo ""
if [ $DEXTER_EXIT_CODE -eq 0 ]; then
    echo "âœ“ Dexter execution completed successfully"
else
    echo "âŒ Dexter execution failed (exit code: $DEXTER_EXIT_CODE)"
fi

exit $DEXTER_EXIT_CODE

