---
name: Cleanup Old Workflow Runs

on:
  workflow_dispatch:
    inputs:
      keep_last:
        description: 'Number of runs to keep per workflow'
        required: true
        default: '5'
        type: string
      dry_run:
        description: 'Dry run (just count, do not delete)'
        required: true
        default: false
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const keepLast = parseInt('${{ inputs.keep_last }}', 10);
            const dryRun = ${{ inputs.dry_run }};
            
            console.log(`Keep last ${keepLast} runs per workflow, dry_run=${dryRun}`);
            
            // Get all workflows
            const workflows = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              { owner: context.repo.owner, repo: context.repo.repo }
            );
            
            let totalDeleted = 0;
            
            for (const workflow of workflows) {
              console.log(`\nProcessing workflow: ${workflow.name} (ID: ${workflow.id})`);
              
              // Get all runs for this workflow
              const runs = await github.paginate(
                github.rest.actions.listWorkflowRuns,
                { 
                  owner: context.repo.owner, 
                  repo: context.repo.repo,
                  workflow_id: workflow.id,
                  per_page: 100
                }
              );
              
              console.log(`  Found ${runs.length} runs`);
              
              // Skip the first N runs (keep them)
              const runsToDelete = runs.slice(keepLast);
              console.log(`  Will delete ${runsToDelete.length} runs`);
              
              if (!dryRun) {
                for (const run of runsToDelete) {
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id
                    });
                    totalDeleted++;
                    if (totalDeleted % 100 === 0) {
                      console.log(`    Deleted ${totalDeleted} runs so far...`);
                    }
                  } catch (e) {
                    console.log(`    Failed to delete run ${run.id}: ${e.message}`);
                  }
                }
              } else {
                totalDeleted += runsToDelete.length;
              }
            }
            
            console.log(`\nâœ… Total ${dryRun ? 'would delete' : 'deleted'}: ${totalDeleted} runs`);
