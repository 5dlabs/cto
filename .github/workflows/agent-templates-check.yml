name: Validate Agent Templates

on:
  pull_request:
    paths:
      - 'infra/charts/controller/agent-templates/**'
      - 'infra/charts/controller/scripts/generate-agent-templates-configmaps-split.sh'
      - 'infra/charts/controller/templates/agent-templates-*.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
      - name: Determine repository context
        id: context
        run: |
          if [ "${HEAD_REPO}" = "${BASE_REPO}" ]; then
            echo "same_repo=true" >> "$GITHUB_OUTPUT"
          else
            echo "same_repo=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          BASE_REPO: ${{ github.repository }}
      - name: Generate split ConfigMaps
        run: bash infra/charts/controller/scripts/generate-agent-templates-configmaps-split.sh
      - name: Detect drift
        id: detect
        run: |
          if git diff --quiet -- infra/charts/controller/templates/agent-templates-*.yaml; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No drift detected."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Drift detected in agent templates ConfigMaps"
            git --no-pager diff -- infra/charts/controller/templates/agent-templates-*.yaml || true
          fi
      - name: Auto-heal generated artifact
        if: steps.detect.outputs.changed == 'true' && steps.context.outputs.same_repo == 'true'
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail
          git config user.name "5DLabs Automation"
          git config user.email "automation@5dlabs.ai"
          git fetch origin "$BRANCH"
          git add infra/charts/controller/templates/agent-templates-*.yaml
          if git diff --cached --quiet; then
            echo "No staged changes to commit after regeneration."
            exit 0
          fi
          git commit -m 'chore(chart): regenerate agent templates ConfigMaps'
          git pull --rebase origin "$BRANCH"
          git push origin HEAD:"$BRANCH"
          echo "Auto-healed drift by committing regenerated ConfigMap."
      - name: Fail if drift remains
        run: |
          if git diff --quiet -- infra/charts/controller/templates/agent-templates-static.yaml; then
            echo "Templates validated successfully."
          else
            echo '::error::Generated ConfigMap is out of sync. Run scripts/update-templates.sh locally to refresh before committing.'
            exit 1
          fi
