---
# Composite action for building and pushing Docker images
name: Docker Build & Push
description: |
  Build and push Docker images to GitHub Container Registry.
  Handles login, buildx setup, and multi-tag pushes.
  
  Supports branch-based tagging:
  - main branch: tagged as 'latest'
  - develop branch: tagged as 'develop'
  - other branches: tagged with branch name (sanitized)

inputs:
  image-name:
    description: 'Image name (without registry prefix)'
    required: true
  context:
    description: 'Docker build context path'
    required: false
    default: '.'
  dockerfile:
    description: 'Path to Dockerfile'
    required: true
  version:
    description: 'Version for tagging (without v prefix)'
    required: true
  short-sha:
    description: 'Short git SHA for tagging'
    required: false
    default: ''
  registry:
    description: 'Container registry'
    required: false
    default: 'ghcr.io'
  image-base:
    description: 'Image base path (org name)'
    required: false
    default: '5dlabs'
  github-token:
    description: 'GitHub token for registry login'
    required: true
  push:
    description: 'Whether to push the image'
    required: false
    default: 'true'
  platforms:
    description: 'Target platforms'
    required: false
    default: 'linux/amd64'
  build-args:
    description: 'Docker build arguments (newline-separated)'
    required: false
    default: 'BUILDKIT_INLINE_CACHE=1'
  cache-from:
    description: 'Cache sources'
    required: false
    default: ''
  cache-to:
    description: 'Cache destinations'
    required: false
    default: ''
  provenance:
    description: 'Enable SLSA provenance attestations (requires id-token: write permission)'
    required: false
    default: 'false'
  sbom:
    description: 'Enable SBOM attestations (requires id-token: write permission)'
    required: false
    default: 'false'
  # New inputs for branch-based tagging
  branch-tag:
    description: 'Branch-based tag (e.g., develop, feature-xyz). If empty, uses latest for main.'
    required: false
    default: ''
  tag-latest:
    description: 'Whether to tag as latest (default: true for main branch builds)'
    required: false
    default: 'auto'

outputs:
  image-tags:
    description: 'Full image tags (newline-separated)'
    value: ${{ steps.meta.outputs.tags }}
  image-digest:
    description: 'Image digest'
    value: ${{ steps.build.outputs.digest }}

runs:
  using: composite
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

    - name: Log in to Container Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ github.actor }}
        password: ${{ inputs.github-token }}

    - name: Generate image tags
      id: meta
      shell: bash
      run: |
        REGISTRY="${{ inputs.registry }}"
        BASE="${{ inputs.image-base }}"
        IMAGE="${{ inputs.image-name }}"
        VERSION="${{ inputs.version }}"
        SHA="${{ inputs.short-sha }}"
        BRANCH_TAG="${{ inputs.branch-tag }}"
        TAG_LATEST="${{ inputs.tag-latest }}"
        
        # Determine branch from github context
        GITHUB_REF="${{ github.ref }}"
        GITHUB_REF_NAME="${{ github.ref_name }}"
        
        TAGS=""
        
        # Branch-based primary tag
        if [ -n "$BRANCH_TAG" ]; then
          # Explicit branch tag provided
          TAGS="${REGISTRY}/${BASE}/${IMAGE}:${BRANCH_TAG}"
        elif [ "$GITHUB_REF" = "refs/heads/main" ]; then
          # Main branch - use 'latest'
          TAGS="${REGISTRY}/${BASE}/${IMAGE}:latest"
        elif [ "$GITHUB_REF" = "refs/heads/develop" ]; then
          # Develop branch - use 'develop'
          TAGS="${REGISTRY}/${BASE}/${IMAGE}:develop"
        else
          # Other branches - sanitize branch name and use as tag
          SANITIZED_BRANCH=$(echo "$GITHUB_REF_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | cut -c1-128)
          TAGS="${REGISTRY}/${BASE}/${IMAGE}:${SANITIZED_BRANCH}"
        fi
        
        # Add version tag
        TAGS+=$'\n'"${REGISTRY}/${BASE}/${IMAGE}:v${VERSION}"
        
        # Add SHA tag if provided
        if [ -n "$SHA" ]; then
          TAGS+=$'\n'"${REGISTRY}/${BASE}/${IMAGE}:${SHA}"
        fi
        
        # Optionally add 'latest' tag for non-main branches if explicitly requested
        if [ "$TAG_LATEST" = "true" ] && [ "$GITHUB_REF" != "refs/heads/main" ]; then
          TAGS+=$'\n'"${REGISTRY}/${BASE}/${IMAGE}:latest"
        fi
        
        echo "tags<<EOF" >> "$GITHUB_OUTPUT"
        echo "$TAGS" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"
        
        echo "ðŸ“¦ Image tags:"
        echo "$TAGS"

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        platforms: ${{ inputs.platforms }}
        push: ${{ inputs.push }}
        # Attestations disabled by default - avoids GHCR permission issues
        # Enable with provenance: true if id-token: write permission is available
        provenance: ${{ inputs.provenance }}
        sbom: ${{ inputs.sbom }}
        tags: ${{ steps.meta.outputs.tags }}
        build-args: ${{ inputs.build-args }}
        cache-from: ${{ inputs.cache-from }}
        cache-to: ${{ inputs.cache-to }}

    - name: Image summary
      shell: bash
      run: |
        {
          echo "## ðŸ³ Docker Image Built"
          echo ""
          echo "**Image:** \`${{ inputs.registry }}/${{ inputs.image-base }}/${{ inputs.image-name }}\`"
          echo ""
          echo "**Tags:**"
          echo "${{ steps.meta.outputs.tags }}" | while read -r tag; do
            [ -n "$tag" ] && echo "- \`$tag\`"
          done
        } >> "$GITHUB_STEP_SUMMARY"
