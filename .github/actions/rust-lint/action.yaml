---
# Composite action for Rust linting (format + clippy pedantic)
name: Rust Lint
description: |
  Run cargo fmt and clippy with pedantic warnings on a Rust package.
  Enforces consistent code style and catches common issues.

inputs:
  package:
    description: 'Cargo package name to lint'
    required: true
  working-directory:
    description: 'Working directory for cargo commands'
    required: false
    default: '.'
  clippy-args:
    description: 'Additional clippy arguments'
    required: false
    default: '-D warnings -W clippy::pedantic'
  use-sccache:
    description: 'Whether to use sccache (for k8s-runner)'
    required: false
    default: 'false'

outputs:
  format-needed:
    description: 'Whether formatting changes were needed'
    value: ${{ steps.fmt.outputs.format-needed }}

runs:
  using: composite
  steps:
    - name: Check formatting
      id: fmt
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîß Checking cargo fmt for ${{ inputs.package }}..."
        if ! cargo fmt -p ${{ inputs.package }} -- --check; then
          echo "üìù Formatting issues detected"
          echo "format-needed=true" >> "$GITHUB_OUTPUT"
        else
          echo "format-needed=false" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Code formatting is correct"
        fi

    - name: Run Clippy (pedantic)
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        RUSTC_WRAPPER: ${{ inputs.use-sccache == 'true' && 'sccache' || '' }}
        CARGO_INCREMENTAL: ${{ inputs.use-sccache == 'true' && '0' || '1' }}
      run: |
        echo "üîç Running clippy with pedantic warnings on ${{ inputs.package }}..."
        cargo clippy -p ${{ inputs.package }} --all-targets -- ${{ inputs.clippy-args }}
        echo "‚úÖ Clippy passed"

