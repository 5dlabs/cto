---
# Composite action for building Rust release binaries
name: Rust Build
description: |
  Build a Rust release binary with optimizations.
  Supports both k8s-runner (with sccache) and GitHub-hosted runners.

inputs:
  package:
    description: 'Cargo package name to build'
    required: true
  binary:
    description: 'Binary name to build (defaults to package name)'
    required: false
    default: ''
  working-directory:
    description: 'Working directory for cargo commands'
    required: false
    default: '.'
  output-path:
    description: 'Path to copy the built binary (optional)'
    required: false
    default: ''
  use-sccache:
    description: 'Whether to use sccache (for k8s-runner)'
    required: false
    default: 'false'

outputs:
  binary-path:
    description: 'Path to the built binary'
    value: ${{ steps.build.outputs.binary-path }}

runs:
  using: composite
  steps:
    - name: Build release binary
      id: build
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        RUSTC_WRAPPER: ${{ inputs.use-sccache == 'true' && 'sccache' || '' }}
        CARGO_INCREMENTAL: '0'
        CARGO_NET_GIT_FETCH_WITH_CLI: 'true'
        CARGO_REGISTRIES_CRATES_IO_PROTOCOL: 'sparse'
      run: |
        BINARY="${{ inputs.binary }}"
        if [ -z "$BINARY" ]; then
          BINARY="${{ inputs.package }}"
        fi

        echo "ðŸ”¨ Building $BINARY from ${{ inputs.package }}..."

        # Build with --bin if binary name differs from package
        if [ "$BINARY" != "${{ inputs.package }}" ]; then
          cargo build -p ${{ inputs.package }} --release --bin "$BINARY"
        else
          cargo build -p ${{ inputs.package }} --release
        fi

        # Determine binary path
        BINARY_PATH="target/release/$BINARY"
        echo "binary-path=$BINARY_PATH" >> "$GITHUB_OUTPUT"
        echo "âœ… Built: $BINARY_PATH"
        ls -lh "$BINARY_PATH"

        # Copy to output path if specified
        if [ -n "${{ inputs.output-path }}" ]; then
          cp "$BINARY_PATH" "${{ inputs.output-path }}"
          chmod +x "${{ inputs.output-path }}"
          echo "ðŸ“¦ Copied to: ${{ inputs.output-path }}"
        fi

    - name: Show sccache stats
      if: inputs.use-sccache == 'true'
      shell: bash
      run: |
        echo "ðŸ“Š Final sccache stats:"
        sccache --show-stats || true

