# Utils

Micro utilities for GitHub operations and other common tasks.

## Installation

```bash
cargo install --path utils
```

Or build directly:

```bash
cargo build --release -p utils
```

## CLI Usage

```bash
utils <COMMAND> [OPTIONS]
```

### Global Options

| Option | Description |
|--------|-------------|
| `-f, --format <FORMAT>` | Output format: `text` (default), `json` |
| `-v, --verbose` | Enable verbose logging |
| `-h, --help` | Print help |
| `-V, --version` | Print version |

---

## Commands

### `alerts` - Fetch PR Check Run Annotations

Retrieves check run annotations (the "Alerts" shown in GitHub's PR UI) for a pull request.

```bash
utils alerts --repo <OWNER/REPO> --pr <NUMBER> [OPTIONS]
```

#### Options

| Option | Description |
|--------|-------------|
| `-r, --repo <REPO>` | Repository in `owner/repo` format (required) |
| `-p, --pr <NUMBER>` | Pull request number (required) |
| `-l, --level <LEVEL>` | Filter by level: `notice`, `warning`, `failure` |
| `-s, --summary` | Show only check run summary (counts, no details) |

#### Examples

```bash
# Get all annotations for a PR
utils alerts --repo 5dlabs/cto --pr 1864

# Get only failures
utils alerts --repo 5dlabs/cto --pr 1864 --level failure

# Get summary of check runs with annotations
utils alerts --repo 5dlabs/cto --pr 1864 --summary

# Output as JSON
utils alerts --repo 5dlabs/cto --pr 1864 --format json
```

#### Sample Output

**Text format:**
```
Annotations for PR #1864 (3 total):

[FAILURE] heal/src/main.rs:4581
  variables can be used directly in the `format!` string

[WARNING] src/lib.rs:42
  unused import: `std::collections::HashMap`

[NOTICE] tests/integration.rs:15
  consider using `#[expect]` instead of `#[allow]`
```

**JSON format:**
```json
[
  {
    "path": "heal/src/main.rs",
    "start_line": 4581,
    "end_line": 4581,
    "annotation_level": "failure",
    "message": "variables can be used directly in the `format!` string",
    "title": "",
    "raw_details": ""
  }
]
```

---

### `post-alerts` - Post CI Failures as PR Comment

Fetches failure alerts from a PR and posts them as a formatted markdown comment on the PR. Useful for surfacing CI issues directly in the PR conversation.

```bash
utils post-alerts --repo <OWNER/REPO> --pr <NUMBER> [OPTIONS]
```

#### Options

| Option | Description |
|--------|-------------|
| `-r, --repo <REPO>` | Repository in `owner/repo` format (required) |
| `-p, --pr <NUMBER>` | Pull request number (required) |
| `-w, --warnings` | Include warnings in addition to failures |
| `-d, --dry-run` | Print comment instead of posting (preview mode) |

#### Examples

```bash
# Post failures as a comment
utils post-alerts --repo 5dlabs/cto --pr 1864

# Include warnings too
utils post-alerts --repo 5dlabs/cto --pr 1864 --warnings

# Preview the comment without posting
utils post-alerts --repo 5dlabs/cto --pr 1864 --dry-run
```

#### Sample Comment Output

The posted comment looks like this:

```markdown
## ðŸš¨ CI Alerts Summary

**2** failure(s) Â· **1** warning(s)

### âŒ Failures

**`heal/src/main.rs`** ([L4581])
> variables can be used directly in the `format!` string

**`src/lib.rs`** ([L10])
> unused variable: `x`

### âš ï¸ Warnings

**`tests/test.rs`** ([L25])
> unused import

---
*Generated by `utils post-alerts`*
```

---

## LLM Tool Instructions

This section provides instructions for AI agents/LLMs on how to use the utils CLI.

### Overview

The `utils` CLI provides micro-utilities for GitHub operations. Use it to programmatically fetch information that would otherwise require manual inspection of the GitHub UI.

### When to Use

| Tool | Use Case |
|------|----------|
| `utils alerts` | When you need to see CI/CD failures, warnings, or notices on a PR |
| `utils post-alerts` | When you want to surface CI failures as a visible PR comment |

### Tool: `utils alerts`

**Purpose:** Fetch check run annotations (errors, warnings, notices) from GitHub PR checks.

**When to use:**
- CI checks failed and you need to see the specific errors
- You want to understand what warnings a PR has
- You need to programmatically process PR feedback

**Command pattern:**
```bash
utils alerts --repo <owner/repo> --pr <number> --format json
```

**Always use `--format json`** for machine-readable output that can be parsed.

**Example workflow:**

1. User mentions a PR has failing checks
2. Fetch the alerts:
   ```bash
   utils alerts --repo 5dlabs/cto --pr 1864 --format json
   ```
3. Parse the JSON response to identify issues
4. Address each annotation based on its `path`, `start_line`, and `message`

**Response structure:**
```json
{
  "path": "string",        // File path relative to repo root
  "start_line": "number",  // Line number where issue starts
  "end_line": "number",    // Line number where issue ends
  "annotation_level": "string", // "notice" | "warning" | "failure"
  "message": "string",     // Description of the issue
  "title": "string",       // Optional title
  "raw_details": "string"  // Optional additional details
}
```

**Filtering tips:**
- Use `--level failure` to focus on blocking issues first
- Use `--summary` to get a quick overview before fetching details
- Annotations are grouped by check run, so similar issues often appear together

### Tool: `utils post-alerts`

**Purpose:** Fetch CI failures and post them as a formatted PR comment for visibility.

**When to use:**
- After CI fails and you want to make failures visible in the PR conversation
- When you want to provide a summary of issues that need to be fixed
- To communicate CI status to reviewers or the PR author

**Command pattern:**
```bash
utils post-alerts --repo <owner/repo> --pr <number>
```

**Dry run first** - Use `--dry-run` to preview the comment before posting:
```bash
utils post-alerts --repo 5dlabs/cto --pr 1864 --dry-run
```

**Example workflow:**

1. CI fails on a PR
2. Preview what would be posted:
   ```bash
   utils post-alerts --repo 5dlabs/cto --pr 1864 --dry-run
   ```
3. If the output looks correct, post it:
   ```bash
   utils post-alerts --repo 5dlabs/cto --pr 1864
   ```

**Options:**
- Use `--warnings` to include warnings in addition to failures
- The command automatically formats annotations into a readable markdown comment
- If no failures are found, posts a "âœ… No CI Failures" message

**Comment format:**
- Groups by severity: Failures first, then Warnings, then Notices
- Shows file path and line number for each issue
- Includes the error message in a quote block
- Includes a count summary at the top

### Prerequisites

- The `gh` CLI must be installed and authenticated
- The authenticated user must have read access to the repository

### Error Handling

If the command fails:
1. Check that `gh auth status` shows a valid login
2. Verify the repository exists and is accessible
3. Confirm the PR number is valid

---

## Library Usage

The utils crate can also be used as a Rust library:

```rust
use utils::{PrAlerts, PrComment, format_alerts_comment};

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    let alerts = PrAlerts::new("5dlabs", "cto");
    
    // Fetch all annotations
    let annotations = alerts.fetch(1864).await?;
    
    // Or fetch only failures
    let failures = alerts.fetch_failures(1864).await?;
    
    // Format as markdown comment
    let comment_body = format_alerts_comment(&failures);
    
    // Post to PR
    let comment = PrComment::new("5dlabs", "cto");
    comment.post(1864, &comment_body).await?;
    
    Ok(())
}
```

## Requirements

- Rust 1.70+
- `gh` CLI installed and authenticated (`gh auth login`)

