# Tool Catalog & Documentation Generation Plan

## Current State Analysis

### Existing Tool Catalog ConfigMap ✅
- **Name**: `toolman-tool-catalog`
- **Namespace**: `orchestrator`
- **Content**: JSON with complete tool information from local and remote servers
- **Current Mount**: `/etc/tool-catalog` in task jobs
- **Structure**:
  ```json
  {
    "last_updated": "timestamp",
    "local": {
      "filesystem": {
        "description": "File operations...",
        "tools": [
          {
            "name": "read_file",
            "description": "Read file contents...",
            "category": "file-operations",
            "use_cases": ["retrieving information"],
            "input_schema": { /* full JSON schema */ }
          }
        ]
      }
    },
    "remote": {
      "kubernetes": {
        "description": "K8s management...",
        "endpoint": "http://...",
        "tools": [
          {
            "name": "listResources",
            "description": "List K8s resources...",
            "category": "kubernetes",
            "use_cases": ["retrieving information"],
            "input_schema": { /* full JSON schema */ }
          }
        ]
      }
    }
  }
  ```

### Current Problems ❌
1. **Docs Agent Issue**: Generating wrong structure (`"localTools": ["filesystem"]`) instead of correct `localServers` structure
2. **Missing Local Tool Config**: Tool catalog lacks command/transport info needed for `localServers` config

- **Example Bad Output**:
  ```json
  {
    "localTools": ["filesystem"],
    "remoteTools": []
  }
  ```
- **Expected Good Output** (correct structure):
  ```json
  {
    "remoteTools": ["kubernetes_listResources", "memory_create_entities"],
    "localServers": {
      "filesystem": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"],
        "tools": ["read_file", "write_file", "list_directory", "edit_file"],
        "workingDirectory": "project_root"
      }
    }
  }
  ```

- **Missing from Catalog**:
  ```json
  {
    "local": {
      "filesystem": {
        "description": "File operations...",
        "tools": [...],
        // MISSING:
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"],
        "transport": "stdio",
        "workingDirectory": "project_root"
      }
    }
  }
  ```

## Solution Architecture

### 1. Master Tools Documentation (Generated Once)
**Location**: `/workspace/tool-catalog/tools-master-documentation.md`
**Source**: Generated from `toolman-tool-catalog` ConfigMap JSON
**Purpose**: Complete reference guide for docs agent to understand all available tools

**Content Structure**:
```markdown
# Available MCP Tools

## Local Tools

### Filesystem Server
**Description**: File system operations for reading, writing, and managing files

#### Available Tools

##### read_file
- **Description**: Read the complete contents of a file
- **Category**: file-operations
- **Use Cases**: retrieving information
- **Input Schema**:
  ```json
  {
    "path": "string (required)"
  }
  ```
- **Example Usage**: Read configuration files, source code, documentation

##### write_file
- **Description**: Create or overwrite a file with new content
- **Category**: file-operations
- **Use Cases**: creating resources
- **Input Schema**:
  ```json
  {
    "path": "string (required)",
    "content": "string (required)"
  }
  ```

#### Configuration for Local Tools
```json
{
  "localServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"],
      "tools": ["read_file", "write_file", "list_directory"],
      "workingDirectory": "project_root"
    }
  }
}
```

## Remote Tools

### Kubernetes Server
**Description**: Kubernetes cluster management and Helm operations
**Endpoint**: http://k8s-mcp-k8s-mcp-server.mcp.svc.cluster.local:8080/sse

#### Available Tools

##### listResources
- **Description**: List all resources in the Kubernetes cluster of a specific type
- **Category**: kubernetes
- **Use Cases**: retrieving information
- **Input Schema**:
  ```json
  {
    "Kind": "string (required)",
    "namespace": "string (optional)",
    "labelSelector": "string (optional)"
  }
  ```

#### Configuration for Remote Tools
```json
{
  "remoteTools": ["kubernetes_listResources", "kubernetes_createResource"]
}
```
```

### 2. Task-Specific Files (Generated by Docs Agent)

#### A. Client Configuration
**Location**: `/workspace/.taskmaster/docs/task-X/client-config.json`
**Purpose**: Machine-readable config for code agent
**Example**:
```json
{
  "remoteTools": ["kubernetes_listResources", "memory_create_entities"],
  "localServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"],
      "tools": ["read_file", "write_file"],
      "workingDirectory": "project_root"
    }
  }
}
```

#### B. Task Tools Documentation
**Location**: `/workspace/.taskmaster/docs/task-X/tools-documentation.md`
**Purpose**: Human-readable guide for code agent with ONLY the selected tools
**Example**:
```markdown
# Tools Available for This Task

## Local Tools

### read_file
Read the complete contents of a file from the file system.

**Input Schema**:
```json
{
  "path": "string (required)"
}
```

**Example**: `{"path": "src/main.rs"}`

### write_file
Create or overwrite a file with new content.

**Input Schema**:
```json
{
  "path": "string (required)",
  "content": "string (required)"
}
```

## Remote Tools

### kubernetes_listResources
List all resources in the Kubernetes cluster of a specific type.

**Input Schema**:
```json
{
  "Kind": "string (required)",
  "namespace": "string (optional)"
}
```

**Example**: `{"Kind": "Pod", "namespace": "default"}`
```

## Implementation Steps

### Step 0: Fix Tool Catalog to Include Local Server Config
**Problem**: Current tool catalog missing command/transport info for local tools
**Solution**: Update tool catalog generation to include:
```json
{
  "local": {
    "filesystem": {
      "description": "File system operations...",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"],
      "transport": "stdio",
      "workingDirectory": "project_root",
      "tools": [...]
    }
  }
}
```

### Step 1: Update ConfigMap Mount Point
**File**: `orchestrator/core/src/controllers/task_controller/resources.rs`
**Change**:
```rust
// FROM:
volume_mounts.push(json!({
    "name": "tool-catalog",
    "mountPath": "/etc/tool-catalog",
    "readOnly": true
}));

// TO:
volume_mounts.push(json!({
    "name": "tool-catalog",
    "mountPath": "/workspace/tool-catalog",
    "readOnly": true
}));
```

### Step 2: Create Master Documentation Generator
**New File**: `orchestrator/tools/src/cli/tool_catalog_docs.rs`
**Purpose**: Generate markdown from tool catalog JSON
**Function**: `generate_master_tools_documentation(catalog_json: &str) -> String`

### Step 3: Include Master Doc in Template Files
**File**: Template that includes the master documentation
**Method**: Copy generated markdown to task workspace alongside other template files

### Step 4: Update Docs Agent Logic
**Target**: Docs agent prompt/logic to:
- Read master documentation to understand available tools
- Select specific tools based on task requirements
- Generate correct `client-config.json` structure:
  - `remoteTools`: Array of specific tool names
  - `localServers`: Object with server configs (command, args, tools array)
- Generate task-specific `tools-documentation.md` with only selected tools

### Step 5: Test with Code Agent
**Verify**:
- Code agent receives proper `client-config.json` with specific tools
- Code agent can read task-specific documentation
- Tools work as expected in code implementation

## Key Benefits

1. **Single Source of Truth**: Tool catalog ConfigMap contains all tool information
2. **Agent-Friendly**: Master documentation is easy for AI agents to parse and understand
3. **Task-Specific**: Each task gets only the tools it needs with clear documentation
4. **Maintainable**: Changes to tool catalog automatically propagate to documentation
5. **Clear Separation**: Local vs remote tools clearly distinguished with proper config examples

## Success Criteria

- ✅ Master documentation generated from tool catalog
- ✅ Mount point moved to working directory
- ✅ Docs agent selects specific tools (not servers)
- ✅ Task-specific config and documentation generated
- ✅ Code agent successfully uses selected tools
- ✅ No more `"localTools": ["filesystem"]` - should be correct `localServers` structure
- ✅ Tools arrays contain specific tool names, not server names