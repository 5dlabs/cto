---
# Composite action for running Rust tests with cargo-nextest
name: Rust Test
description: |
  Run tests on a Rust package using cargo-nextest for ~35% faster execution.
  Falls back to cargo test if nextest is unavailable.

inputs:
  package:
    description: 'Cargo package name to test'
    required: true
  working-directory:
    description: 'Working directory for cargo commands'
    required: false
    default: '.'
  features:
    description: 'Features to enable (comma-separated or "all")'
    required: false
    default: ''
  test-args:
    description: 'Additional test arguments (--all-targets included by default)'
    required: false
    default: '--all-targets'
  use-sccache:
    description: 'Whether to use sccache (for k8s-runner)'
    required: false
    default: 'false'
  use-nextest:
    description: 'Use cargo-nextest for faster tests (default: true)'
    required: false
    default: 'true'

runs:
  using: composite
  steps:
    - name: Install cargo-nextest
      if: inputs.use-nextest == 'true'
      shell: bash
      run: |
        if ! command -v cargo-nextest &>/dev/null; then
          echo "ðŸ“¦ Installing cargo-nextest..."
          # Use pre-built binary for speed (no compilation needed)
          curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C /home/runner/.cargo/bin 2>/dev/null || \
            cargo install cargo-nextest --locked
        else
          echo "âœ… cargo-nextest already installed"
        fi

    - name: Run tests
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        RUSTC_WRAPPER: ${{ inputs.use-sccache == 'true' && 'sccache' || '' }}
        CARGO_INCREMENTAL: ${{ inputs.use-sccache == 'true' && '0' || '1' }}
      run: |
        echo "ðŸ§ª Running tests for ${{ inputs.package }}..."

        FEATURES_ARG=""
        if [ "${{ inputs.features }}" = "all" ]; then
          FEATURES_ARG="--all-features"
        elif [ -n "${{ inputs.features }}" ]; then
          FEATURES_ARG="--features ${{ inputs.features }}"
        fi

        # Use nextest if available and enabled, otherwise fall back to cargo test
        if [ "${{ inputs.use-nextest }}" = "true" ] && command -v cargo-nextest &>/dev/null; then
          echo "ðŸš€ Using cargo-nextest for ~35% faster test execution"
          cargo nextest run -p ${{ inputs.package }} $FEATURES_ARG ${{ inputs.test-args }}
        else
          echo "ðŸ“‹ Using cargo test"
          cargo test -p ${{ inputs.package }} $FEATURES_ARG ${{ inputs.test-args }}
        fi

        echo "âœ… All tests passed"

