apiVersion: apps/v1
kind: Deployment
metadata:
  name: heal
  namespace: cto
  labels:
    app: heal
spec:
  replicas: 1
  selector:
    matchLabels:
      app: heal
  template:
    metadata:
      labels:
        app: heal
    spec:
      serviceAccountName: cto
      containers:
      # Main heal container
      - name: heal
        image: ghcr.io/5dlabs/heal:dev
        imagePullPolicy: Always
        command:
        - heal
        args:
        - alert-watch
        - --namespace
        - cto
        - --prompts-dir
        - /app/prompts
        env:
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: cto-secrets
              key: ANTHROPIC_API_KEY
        volumeMounts:
        - name: workspace
          mountPath: /workspace/watch
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      
      # Log tailer sidecar - tails all factory output logs
      - name: log-tailer
        image: busybox:1.36
        command:
        - /bin/sh
        - -c
        - |
          echo "ðŸ“‹ Log tailer starting - watching /workspace/watch/logs/"
          mkdir -p /workspace/watch/logs
          # Create a marker file so tail -f has something to watch initially
          touch /workspace/watch/logs/.tailer-started
          echo "Waiting for log files..."
          # Tail all .log files, following new files as they appear
          while true; do
            # Find and tail all log files
            if ls /workspace/watch/logs/*.log 1>/dev/null 2>&1; then
              tail -F /workspace/watch/logs/*.log 2>/dev/null &
              TAIL_PID=$!
              # Check for new files every 5 seconds
              sleep 5
              kill $TAIL_PID 2>/dev/null
            else
              echo "No log files yet, waiting..."
              sleep 5
            fi
          done
        volumeMounts:
        - name: workspace
          mountPath: /workspace/watch
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "50m"
      
      volumes:
      - name: workspace
        emptyDir: {}
      imagePullSecrets:
      - name: ghcr-secret
