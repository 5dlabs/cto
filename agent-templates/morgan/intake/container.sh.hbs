{{> header }}

{{> node-env }}

{{> config }}

{{> github-auth }}

# =========================================================================
# Intake Configuration
# =========================================================================

CONFIG_FILE="/intake-files/config.json"
PRD_FILE="/intake-files/prd.txt"
ARCH_FILE="/intake-files/architecture.md"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Configuration file not found at $CONFIG_FILE"
    exit 1
fi

echo "ðŸ“„ Loading configuration..."
PROJECT_NAME=$(jq -r '.project_name' "$CONFIG_FILE")
REPOSITORY_URL=$(jq -r '.repository_url' "$CONFIG_FILE")

# Model configuration
PRIMARY_MODEL=$(jq -r '.primary_model' "$CONFIG_FILE")
PRIMARY_PROVIDER=$(jq -r '.primary_provider' "$CONFIG_FILE")
# RESEARCH_MODEL available for future use
# RESEARCH_MODEL=$(jq -r '.research_model' "$CONFIG_FILE")

# Task generation parameters  
NUM_TASKS=$(jq -r '.num_tasks // 50' "$CONFIG_FILE")
EXPAND_TASKS=$(jq -r '.expand_tasks // true' "$CONFIG_FILE")
ANALYZE_COMPLEXITY=$(jq -r '.analyze_complexity // true' "$CONFIG_FILE")
# ENRICH_CONTEXT available for future use  
# ENRICH_CONTEXT=$(jq -r '.enrich_context // true' "$CONFIG_FILE")

echo "  âœ“ Project: $PROJECT_NAME"
echo "  âœ“ Repository: $REPOSITORY_URL"
echo "  âœ“ Model: $PRIMARY_MODEL ($PRIMARY_PROVIDER)"
echo "  âœ“ Tasks: ~$NUM_TASKS"

# =========================================================================
# Repository Clone
# =========================================================================

echo ""
echo "ðŸ“¦ Cloning repository..."

CLONE_DIR="/tmp/repo-$(date +%s)"
git clone "$REPOSITORY_URL" "$CLONE_DIR" || exit 1
cd "$CLONE_DIR" || exit 1

git config user.name "Morgan Intake"
git config user.email "morgan@5dlabs.com"

PROJECT_DIR_NAME=$(echo "$PROJECT_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-*//;s/-*$//')
PROJECT_DIR="$CLONE_DIR/$PROJECT_DIR_NAME"
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR" || exit 1

# =========================================================================
# Tasks Initialization
# =========================================================================

echo ""
echo "ðŸš€ Initializing tasks project..."

tasks init --yes || {
    mkdir -p .taskmaster/docs .taskmaster/tasks .taskmaster/reports
}

mkdir -p .taskmaster/docs
cp "$PRD_FILE" ".taskmaster/docs/prd.txt"
[ -f "$ARCH_FILE" ] && [ -s "$ARCH_FILE" ] && cp "$ARCH_FILE" ".taskmaster/docs/architecture.md"

# =========================================================================
# PRD Parsing
# =========================================================================

echo ""
echo "ðŸ“„ Parsing PRD to generate tasks..."
echo "  â†’ Model: $PRIMARY_MODEL"
echo "  â†’ Target: ~$NUM_TASKS tasks"

tasks parse-prd ".taskmaster/docs/prd.txt" \
    --num-tasks "$NUM_TASKS" \
    --research \
    --model "$PRIMARY_MODEL" 2>&1 || exit 1

TASKS_FILE=".taskmaster/tasks/tasks.json"
[ ! -f "$TASKS_FILE" ] && TASKS_FILE=$(find .taskmaster -maxdepth 2 -name tasks.json | head -n 1)
[ ! -f "$TASKS_FILE" ] && { echo "âŒ tasks.json not found"; exit 1; }

echo "âœ… Tasks generated: $(jq '.tasks | length' "$TASKS_FILE") tasks"

# Analyze complexity if requested
if [ "$ANALYZE_COMPLEXITY" = "true" ]; then
    echo "ðŸ” Analyzing task complexity..."
    tasks analyze-complexity --model "$PRIMARY_MODEL" || true
fi

# Expand tasks if requested
if [ "$EXPAND_TASKS" = "true" ]; then
    echo "ðŸŒ³ Expanding tasks with subtasks..."
    tasks expand-all --force --model "$PRIMARY_MODEL" || true
fi

# =========================================================================
# Agent Routing Hints
# =========================================================================

echo "ðŸŽ¯ Adding agent routing hints..."

jq '
  def is_frontend: (.title + " " + (.description // "")) | test("frontend|react|ui|css|component"; "i");
  def is_mobile: (.title + " " + (.description // "")) | test("mobile|react.native|ios|android"; "i");
  def is_desktop: (.title + " " + (.description // "")) | test("electron|desktop|native"; "i");
  def is_rust: (.title + " " + (.description // "")) | test("rust|cargo|backend|api"; "i");
  def is_go: (.title + " " + (.description // "")) | test("\\bgo\\b|golang|goroutine"; "i");
  def is_node: (.title + " " + (.description // "")) | test("node|express|fastify|nest"; "i");
  def is_test: (.title + " " + (.description // "")) | test("test|qa|quality|validation"; "i");
  def is_security: (.title + " " + (.description // "")) | test("security|auth|encrypt|oauth"; "i");
  def is_deploy: (.title + " " + (.description // "")) | test("deploy|ci.cd|kubernetes|helm"; "i");
  def is_integration: (.title + " " + (.description // "")) | test("merge|conflict|integration"; "i");
  
  if .tasks then .tasks |= map(
    if .agentHint then .
    elif is_mobile then . + {"agentHint": "tap"}
    elif is_desktop then . + {"agentHint": "spark"}
    elif is_frontend then . + {"agentHint": "blaze"}
    elif is_rust then . + {"agentHint": "rex"}
    elif is_go then . + {"agentHint": "grizz"}
    elif is_node then . + {"agentHint": "nova"}
    elif is_test then . + {"agentHint": "tess"}
    elif is_security then . + {"agentHint": "cipher"}
    elif is_deploy then . + {"agentHint": "bolt"}
    elif is_integration then . + {"agentHint": "atlas"}
    else . + {"agentHint": "rex"} end
  ) else . end
' "$TASKS_FILE" > "$TASKS_FILE.tmp" && mv "$TASKS_FILE.tmp" "$TASKS_FILE"

# =========================================================================
# Documentation Generation (XML + Markdown)
# =========================================================================

echo ""
echo "ðŸ“š Generating documentation for each task..."

# Helper function for XML escaping
xml_escape() {
    echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g'
}

infer_role() {
    local content="$1"
    if echo "$content" | grep -qiE 'frontend|ui|react|css'; then
        echo "Senior Frontend Engineer with expertise in React, TypeScript, and modern UI/UX"
    elif echo "$content" | grep -qiE 'mobile|react.native'; then
        echo "Senior Mobile Engineer with expertise in React Native and cross-platform development"
    elif echo "$content" | grep -qiE 'electron|desktop'; then
        echo "Senior Desktop Engineer with expertise in Electron and native integrations"
    elif echo "$content" | grep -qiE 'rust|cargo|backend'; then
        echo "Senior Rust Engineer with expertise in systems programming and APIs"
    elif echo "$content" | grep -qiE '\\bgo\\b|golang'; then
        echo "Senior Go Engineer with expertise in concurrent systems and microservices"
    elif echo "$content" | grep -qiE 'node|express|fastify'; then
        echo "Senior Node.js Engineer with expertise in server-side JavaScript and APIs"
    elif echo "$content" | grep -qiE 'devops|deploy|kubernetes'; then
        echo "Senior DevOps Engineer with expertise in Kubernetes, GitOps, and CI/CD"
    elif echo "$content" | grep -qiE 'test|qa|quality'; then
        echo "Senior QA Engineer with expertise in test automation and quality assurance"
    elif echo "$content" | grep -qiE 'security|auth|encrypt'; then
        echo "Senior Security Engineer with expertise in authentication and secure coding"
    else
        echo "Senior Software Engineer"
    fi
}

jq -c '.tasks[]' "$TASKS_FILE" | while IFS= read -r task_json; do
    task_id=$(echo "$task_json" | jq -r '.id')
    title=$(echo "$task_json" | jq -r '.title // "No Title"')
    description=$(echo "$task_json" | jq -r '.description // ""')
    details=$(echo "$task_json" | jq -r '.details // ""')
    test_strategy=$(echo "$task_json" | jq -r '.testStrategy // ""')
    priority=$(echo "$task_json" | jq -r '.priority // "medium"')
    dependencies=$(echo "$task_json" | jq -r '.dependencies // [] | join(", ")')
    agent_hint=$(echo "$task_json" | jq -r '.agentHint // "rex"')
    
    [ -z "$task_id" ] || [ "$task_id" = "null" ] && continue
    
    echo "  ðŸ“ Task $task_id: $title â†’ $agent_hint"
    
    task_dir=".taskmaster/docs/task-$task_id"
    mkdir -p "$task_dir"
    
    role=$(infer_role "$title $description")
    
    # Escape for XML
    title_esc=$(xml_escape "$title")
    desc_esc=$(xml_escape "$description")
    details_esc=$(xml_escape "$details")
    test_esc=$(xml_escape "$test_strategy")
    
    # Primary: task.xml (consolidated, structured)
    cat > "$task_dir/task.xml" << XMLEOF
<?xml version="1.0" encoding="UTF-8"?>
<task id="$task_id" priority="$priority" agent="$agent_hint">
    <meta>
        <title>$title_esc</title>
        <priority>$priority</priority>
        <dependencies>${dependencies:-}</dependencies>
        <agent_hint>$agent_hint</agent_hint>
    </meta>

    <role>You are a $role. Implement Task $task_id with production-quality code.</role>

    <context>
        <overview>$desc_esc</overview>
        <background>Review PRD and architecture in .taskmaster/docs/ for full context.</background>
    </context>

    <requirements>
        <description>$details_esc</description>
        <constraints>
            <constraint>Match existing codebase patterns</constraint>
            <constraint>Create PR with atomic commits</constraint>
            <constraint>Include unit tests</constraint>
            <constraint>PR title: feat(task-$task_id): $title_esc</constraint>
        </constraints>
    </requirements>

    <acceptance_criteria>
        <criterion>All requirements implemented</criterion>
        <criterion>Tests passing with adequate coverage</criterion>
        <criterion>Code follows project conventions</criterion>
        <criterion>$test_esc</criterion>
    </acceptance_criteria>

    <validation>
        <command>cargo test (Rust)</command>
        <command>cargo clippy -- -D warnings (Rust)</command>
        <command>go test ./... (Go)</command>
        <command>npm test (Node.js)</command>
    </validation>

    <deliverables>
        <deliverable>Working implementation</deliverable>
        <deliverable>Unit tests</deliverable>
        <deliverable>Pull request</deliverable>
    </deliverables>
</task>
XMLEOF

    # Fallback: prompt.md (for CLIs preferring markdown)
    cat > "$task_dir/prompt.md" << MDEOF
# Task $task_id: $title

## Role
You are a $role implementing Task $task_id.

## Goal
$description

## Requirements
$details

## Acceptance Criteria
$test_strategy

## Constraints
- Match codebase patterns
- Create PR with atomic commits  
- Include unit tests
- PR title: \`feat(task-$task_id): $title\`
MDEOF

    # Probe target: acceptance-criteria.md
    cat > "$task_dir/acceptance-criteria.md" << ACEOF
# Acceptance Criteria: Task $task_id

- [ ] $description
- [ ] $test_strategy
- [ ] All requirements implemented
- [ ] Tests passing
- [ ] Code follows conventions
- [ ] PR created and ready for review
ACEOF

done

echo "âœ… Documentation generated"

# Generate individual task files
tasks generate

# =========================================================================
# Create Pull Request
# =========================================================================

echo ""
echo "ðŸ”€ Creating Pull Request..."

cd "$CLONE_DIR" || exit 1

BRANCH_NAME="intake-${PROJECT_DIR_NAME}-$(date +%Y%m%d-%H%M%S)"
git checkout -b "$BRANCH_NAME"
git add -A
git commit -m "feat: intake for $PROJECT_NAME

- $(jq '.tasks | length' "$PROJECT_DIR/$TASKS_FILE") tasks generated
- XML + Markdown documentation
- Agent routing hints added
- Complexity analysis: $ANALYZE_COMPLEXITY
- Task expansion: $EXPAND_TASKS

ðŸ¤– Generated by Morgan (intake mode)"

git push -u origin "$BRANCH_NAME"

gh pr create \
    --title "ðŸš€ Intake: $PROJECT_NAME" \
    --body "## Intake: $PROJECT_NAME

### Generated Structure
\`\`\`
$PROJECT_DIR_NAME/
â”œâ”€â”€ .taskmaster/
â”‚   â”œâ”€â”€ docs/
â”‚   â”‚   â”œâ”€â”€ prd.txt
â”‚   â”‚   â””â”€â”€ task-*/
â”‚   â”‚       â”œâ”€â”€ task.xml (primary)
â”‚   â”‚       â”œâ”€â”€ prompt.md (fallback)
â”‚   â”‚       â””â”€â”€ acceptance-criteria.md
â”‚   â””â”€â”€ tasks/
â”‚       â””â”€â”€ tasks.json
\`\`\`

### Stats
- **Tasks**: $(jq '.tasks | length' "$PROJECT_DIR/$TASKS_FILE")
- **Model**: $PRIMARY_MODEL
- **Expansion**: $EXPAND_TASKS
- **Complexity**: $ANALYZE_COMPLEXITY

ðŸ¤– Generated by Morgan" \
    --head "$BRANCH_NAME" \
    --base main || echo "âš ï¸ PR creation failed, branch pushed: $BRANCH_NAME"

{{> completion }}

