# =========================================================================
# Retry Loop with Model Rotation and Acceptance Verification
# =========================================================================

# Retry configuration from environment or template defaults
MAX_RETRIES="${EXECUTION_MAX_RETRIES:-{{default_retries}}}"
CURRENT_ATTEMPT="${CURRENT_ATTEMPT:-1}"

echo ""
echo "ðŸ”„ Retry Configuration:"
echo "   Max Retries: $MAX_RETRIES"
echo "   Current Attempt: $CURRENT_ATTEMPT"
if [ "${MODEL_ROTATION_ENABLED:-false}" = "true" ]; then
    echo "   Model Rotation: ENABLED"
    echo "   Models: $(echo "$MODEL_ROTATION_MODELS" | jq -r 'join(" â†’ ")' 2>/dev/null || echo "$MODEL_ROTATION_MODELS")"
fi
echo ""

# Run CLI with retry awareness and model rotation
run_with_retry() {
    local attempt=1
    local max_attempts=$((MAX_RETRIES + 1))  # +1 for initial attempt
    
    while [ "$attempt" -le "$max_attempts" ]; do
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Get model for this attempt (handles rotation if enabled)
        local current_model
        if type get_model_for_attempt >/dev/null 2>&1; then
            current_model=$(get_model_for_attempt "$attempt")
        else
            current_model="${CURRENT_MODEL:-{{model}}}"
        fi
        
        echo "â•‘ Attempt $attempt of $max_attempts"
        if [ "${MODEL_ROTATION_ENABLED:-false}" = "true" ]; then
            echo "â•‘ Model: $current_model (rotated)"
        else
            echo "â•‘ Model: $current_model"
        fi
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        # Export current model for CLI adapters to use
        export ACTIVE_MODEL="$current_model"
        export CURRENT_ATTEMPT="$attempt"

        # Execute the CLI (adapter should read ACTIVE_MODEL)
        {{cli_execute}}
        CLI_EXIT_CODE=$?

        if [ $CLI_EXIT_CODE -ne 0 ]; then
            echo "âŒ CLI execution failed with exit code: $CLI_EXIT_CODE"
            
            if [ "$attempt" -lt "$max_attempts" ]; then
                if [ "${MODEL_ROTATION_ENABLED:-false}" = "true" ]; then
                    local next_model
                    next_model=$(get_model_for_attempt "$((attempt + 1))")
                    echo "ðŸ”„ Retrying with model: $next_model in 5 seconds..."
                else
                    echo "ðŸ”„ Retrying in 5 seconds..."
                fi
                sleep 5
                attempt=$((attempt + 1))
                continue
            else
                echo "âŒ Max retries exhausted"
                return 1
            fi
        fi

        # CLI succeeded - now verify acceptance criteria
        if type probe_acceptance_criteria >/dev/null 2>&1; then
            if probe_acceptance_criteria; then
                echo "âœ… Task complete - acceptance criteria verified"
                echo "   Model used: $current_model"
                echo "   Attempt: $attempt of $max_attempts"
                return 0
            else
                if [ "$attempt" -lt "$max_attempts" ]; then
                    if [ "${MODEL_ROTATION_ENABLED:-false}" = "true" ]; then
                        local next_model
                        next_model=$(get_model_for_attempt "$((attempt + 1))")
                        echo "ðŸ”„ Acceptance criteria not met - retrying with model: $next_model"
                    else
                        echo "ðŸ”„ Acceptance criteria not met - retrying..."
                    fi
                    attempt=$((attempt + 1))
                    # Continue session flag for retry
                    export CONTINUE_SESSION="true"
                    continue
                else
                    echo "âŒ Max retries exhausted - acceptance criteria not fully met"
                    echo "   Final model tried: $current_model"
                    # Return success if CLI completed, let controller decide on retry
                    return 0
                fi
            fi
        else
            echo "âš ï¸ No acceptance probe available - treating CLI success as completion"
            return 0
        fi
    done

    return 1
}

# Export for use
export -f run_with_retry 2>/dev/null || true

