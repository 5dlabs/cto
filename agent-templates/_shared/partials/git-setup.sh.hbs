# =========================================================================
# Repository Setup
# =========================================================================

REPO_URL="{{repository_url}}"
WORK_DIR="{{working_directory}}"
if [ -z "$WORK_DIR" ] || [ "$WORK_DIR" = "null" ]; then
  WORK_DIR="{{service}}"
fi

cd /workspace

# Parse repo name from URL
REPO_NAME=$(echo "$REPO_URL" | sed 's|.*/||' | sed 's|\.git$||')
REPO_ROOT="/workspace/$REPO_NAME"

git config --global --add safe.directory "$REPO_ROOT"
git config --global user.name "$GIT_AUTHOR_NAME"
git config --global user.email "$GIT_AUTHOR_EMAIL"

# Clone or fetch repository
if [ -d "$REPO_NAME/.git" ]; then
  echo "ðŸ” Repository exists, fetching latest"
  cd "$REPO_NAME"
  git fetch --all --prune || true
else
  echo "â¬‡ï¸ Cloning repository"
  git clone "$REPO_URL" "$REPO_NAME"
  cd "$REPO_NAME"
fi

# Branch setup
BASE_BRANCH="${PR_BASE_BRANCH:-main}"
if ! git show-ref --verify --quiet "refs/remotes/origin/$BASE_BRANCH"; then
  BASE_BRANCH="master"
fi

FEATURE_BRANCH="feature/task-{{task_id}}-{{job_type}}"
if git show-ref --verify --quiet "refs/heads/$FEATURE_BRANCH"; then
  git checkout "$FEATURE_BRANCH"
else
  git checkout -b "$FEATURE_BRANCH" "origin/$BASE_BRANCH" 2>/dev/null || git checkout -b "$FEATURE_BRANCH"
fi

git config --local push.autoSetupRemote true
export FEATURE_BRANCH
export BASE_BRANCH
export REPO_ROOT

# Working directory
CLI_WORK_DIR="$REPO_ROOT"
if [ "$WORK_DIR" != "$REPO_NAME" ]; then
  CLI_WORK_DIR="$REPO_ROOT/$WORK_DIR"
  mkdir -p "$CLI_WORK_DIR"
fi
cd "$CLI_WORK_DIR"
export CLI_WORK_DIR

echo "âœ“ Working directory: $CLI_WORK_DIR"
echo "âœ“ Branch: $FEATURE_BRANCH (base: $BASE_BRANCH)"

