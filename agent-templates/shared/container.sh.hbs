#!/bin/bash
set -euo pipefail

# =========================================================================
# Universal Agent Container
# Agent: {{agent_name}}
# Job: {{job_type}}
# Task: {{task_id}}
# Service: {{service}}
# =========================================================================

echo "════════════════════════════════════════════════════════════════"
echo "║ {{agent_name}} - {{job_type}} workflow starting"
echo "════════════════════════════════════════════════════════════════"

# =========================================================================
# Environment Bootstrap
# =========================================================================

# Source Rust environment if available
if [ -f "$HOME/.cargo/env" ]; then
  . "$HOME/.cargo/env"
fi
if [ -f "/root/.cargo/env" ]; then
  . "/root/.cargo/env"
fi

# Ensure stable toolchain
if command -v rustup >/dev/null 2>&1; then
  rustup default stable 2>/dev/null || true
fi

echo "PATH: $PATH"

# =========================================================================
# Configuration
# =========================================================================

MAX_RETRIES=${EXECUTION_MAX_RETRIES:-{{default_retries}}}
echo ""
echo "🤖 CLI: {{cli_type}}"
echo "🎯 Model: {{model}}"
echo "🔄 Max iterations: $MAX_RETRIES"
echo ""

# =========================================================================
# GitHub Authentication
# =========================================================================

GITHUB_APP="{{github_app}}"
GH_HOST="${GH_HOST:-github.com}"

# Export GitHub token
if [ -z "${GH_TOKEN:-}" ]; then
  export GH_TOKEN="${GITHUB_TOKEN:-}"
fi

# Git author configuration
GIT_AUTHOR_NAME="${GITHUB_APP} Agent"
GIT_AUTHOR_EMAIL="${GITHUB_APP}[bot]@users.noreply.github.com"

export GIT_AUTHOR_NAME
export GIT_AUTHOR_EMAIL
export GIT_COMMITTER_NAME="$GIT_AUTHOR_NAME"
export GIT_COMMITTER_EMAIL="$GIT_AUTHOR_EMAIL"
export GIT_TERMINAL_PROMPT=0

# =========================================================================
# Repository Setup
# =========================================================================

REPO_URL="{{repository_url}}"
WORK_DIR="{{working_directory}}"
if [ -z "$WORK_DIR" ] || [ "$WORK_DIR" = "null" ]; then
  WORK_DIR="{{service}}"
fi

cd /workspace

# Parse repo name from URL
REPO_NAME=$(echo "$REPO_URL" | sed 's|.*/||' | sed 's|\.git$||')
REPO_ROOT="/workspace/$REPO_NAME"

git config --global --add safe.directory "$REPO_ROOT"
git config --global user.name "$GIT_AUTHOR_NAME"
git config --global user.email "$GIT_AUTHOR_EMAIL"

# Clone or fetch repository
if [ -d "$REPO_NAME/.git" ]; then
  echo "🔁 Repository exists, fetching latest"
  cd "$REPO_NAME"
  git fetch --all --prune || true
else
  echo "⬇️ Cloning repository"
  git clone "$REPO_URL" "$REPO_NAME"
  cd "$REPO_NAME"
fi

# Branch setup
BASE_BRANCH="${PR_BASE_BRANCH:-main}"
if ! git show-ref --verify --quiet "refs/remotes/origin/$BASE_BRANCH"; then
  BASE_BRANCH="master"
fi

FEATURE_BRANCH="feature/task-{{task_id}}-{{job_type}}"
if git show-ref --verify --quiet "refs/heads/$FEATURE_BRANCH"; then
  git checkout "$FEATURE_BRANCH"
else
  git checkout -b "$FEATURE_BRANCH" "origin/$BASE_BRANCH" 2>/dev/null || git checkout -b "$FEATURE_BRANCH"
fi

git config --local push.autoSetupRemote true
export FEATURE_BRANCH
export BASE_BRANCH
export REPO_ROOT

# Working directory
CLI_WORK_DIR="$REPO_ROOT"
if [ "$WORK_DIR" != "$REPO_NAME" ]; then
  CLI_WORK_DIR="$REPO_ROOT/$WORK_DIR"
  mkdir -p "$CLI_WORK_DIR"
fi
cd "$CLI_WORK_DIR"
export CLI_WORK_DIR

echo "✓ Working directory: $CLI_WORK_DIR"
echo "✓ Branch: $FEATURE_BRANCH (base: $BASE_BRANCH)"

# =========================================================================
# Task Files
# =========================================================================

mkdir -p "$CLI_WORK_DIR/task"
cp -R /task-files/* "$CLI_WORK_DIR/task/" 2>/dev/null || true

if [ -f /task-files/AGENTS.md ]; then
  cp /task-files/AGENTS.md "$CLI_WORK_DIR/"
fi

# =========================================================================
# CLI Execution
# The Rust adapter injects the CLI-specific invocation here
# =========================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "║ Executing {{cli_type}} CLI"
echo "════════════════════════════════════════════════════════════════"
echo ""

{{cli_execute}}

# =========================================================================
# Completion
# =========================================================================

touch /workspace/.agent_done 2>/dev/null || true

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "║ ✅ {{agent_name}} {{job_type}} complete"
echo "════════════════════════════════════════════════════════════════"

exit 0


