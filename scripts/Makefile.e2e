# E2E Testing Makefile targets
# Include this in your main Makefile: include scripts/Makefile.e2e

.PHONY: e2e-reset e2e-reset-quick e2e-reset-full e2e-reset-advanced e2e-help

# Quick reset (includes GitHub reset)
e2e-reset-quick:
	@echo "ðŸ”„ Quick E2E Reset..."
	@./scripts/quick-e2e-reset.sh

# Quick reset (same as e2e-reset-quick, alias for convenience)
e2e-reset:
	@echo "ðŸ”„ Quick E2E Reset..."
	@./scripts/quick-e2e-reset.sh

# Standard reset with template
e2e-reset-full:
	@echo "ðŸ“¦ Full E2E Reset with Template..."
	@./scripts/reset-e2e-environment.sh

# Advanced reset with options
e2e-reset-advanced:
	@echo "âš™ï¸ Advanced E2E Reset..."
	@./scripts/reset-e2e-advanced.sh $(ARGS)

# Reset with submodule strategy
e2e-reset-submodule:
	@echo "ðŸ”— E2E Reset with Submodule..."
	@./scripts/reset-e2e-advanced.sh --strategy submodule

# Reset with minimal strategy
e2e-reset-minimal:
	@echo "ðŸ“„ E2E Reset with Minimal Setup..."
	@./scripts/reset-e2e-advanced.sh --strategy minimal

# Force reset without confirmations
e2e-reset-force:
	@echo "âš¡ Force E2E Reset..."
	@./scripts/reset-e2e-advanced.sh --force --strategy template

# Check E2E environment status
e2e-status:
	@echo "ðŸ“Š E2E Environment Status"
	@echo "========================="
	@echo ""
	@echo "Kubernetes Resources (agent-platform namespace):"
	@echo "-------------------------------------------------"
	@echo "Workflows: $$(kubectl get workflows -n agent-platform --no-headers 2>/dev/null | wc -l || echo 0)"
	@echo "Pods: $$(kubectl get pods -n agent-platform --no-headers 2>/dev/null | wc -l || echo 0)"
	@echo "ConfigMaps (test): $$(kubectl get cm -n agent-platform --no-headers 2>/dev/null | grep -E 'play-|test-|coderun-|docsrun-' | wc -l || echo 0)"
	@echo "PVCs (test): $$(kubectl get pvc -n agent-platform --no-headers 2>/dev/null | grep -E 'workspace-play-|workspace-test-' | wc -l || echo 0)"
	@echo ""
	@echo "GitHub Repository:"
	@echo "-----------------"
	@gh repo view 5dlabs/cto-parallel-test --json name,visibility,updatedAt --template "Name: {{.name}}\nVisibility: {{.visibility}}\nLast Updated: {{.updatedAt}}\n" 2>/dev/null || echo "Repository does not exist"
	@echo ""
	@echo "Local Repository:"
	@echo "----------------"
	@if [ -d "/Users/jonathonfritz/code/work-projects/5dlabs/cto-parallel-test" ]; then \
		echo "Path: /Users/jonathonfritz/code/work-projects/5dlabs/cto-parallel-test"; \
		echo "Status: EXISTS"; \
		cd /Users/jonathonfritz/code/work-projects/5dlabs/cto-parallel-test && \
		echo "Branch: $$(git branch --show-current 2>/dev/null || echo 'not a git repo')"; \
		echo "Files: $$(find . -type f -not -path './.git/*' 2>/dev/null | wc -l || echo 0)"; \
	else \
		echo "Local repository does not exist"; \
	fi

# Run E2E test after reset
e2e-test: e2e-reset
	@echo "ðŸš€ Starting E2E Test..."
	@echo "Run: cto play --task-id 1"
	@echo "Monitor with: make e2e-logs"

# Watch E2E logs
e2e-logs:
	@echo "ðŸ“œ Following E2E Workflow Logs..."
	kubectl logs -f -l workflow -n agent-platform

# Help for E2E commands
e2e-help:
	@echo "E2E Testing Commands"
	@echo "===================="
	@echo ""
	@echo "Reset Commands:"
	@echo "  make e2e-reset-quick    - Quick K8s cleanup only"
	@echo "  make e2e-reset         - Quick reset including GitHub (default)"
	@echo "  make e2e-reset-full    - Full reset with template preservation"
	@echo "  make e2e-reset-force   - Force reset without confirmations"
	@echo ""
	@echo "Strategy Commands:"
	@echo "  make e2e-reset-submodule - Reset using Git submodule"
	@echo "  make e2e-reset-minimal   - Reset with minimal structure"
	@echo "  make e2e-reset-advanced ARGS='--strategy template' - Custom options"
	@echo ""
	@echo "Monitoring Commands:"
	@echo "  make e2e-status        - Check current environment status"
	@echo "  make e2e-logs          - Follow workflow logs"
	@echo ""
	@echo "Test Commands:"
	@echo "  make e2e-test          - Reset and prepare for testing"
	@echo ""
	@echo "Examples:"
	@echo "  make e2e-reset         # Most common: quick full reset"
	@echo "  make e2e-status        # Check what needs cleaning"
	@echo "  make e2e-reset-force   # Skip all confirmations"
	@echo "  make e2e-logs          # Watch test execution"



