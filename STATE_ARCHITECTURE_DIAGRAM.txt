╔══════════════════════════════════════════════════════════════════════════════╗
║           CROSS-CLI WORKFLOW STATE PERSISTENCE ARCHITECTURE                  ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ WORKFLOW LIFECYCLE WITH STATE PERSISTENCE                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                   GitHub Event                    GitHub Event
                   PR Created                      PR Approved
                       │                               │
                       ▼                               ▼
    ┌─────────────────────────────┐    ┌──────────────────────────────┐
    │  Workflow: play-task-5-abc  │    │  Workflow: play-task-5-xyz   │
    │  Labels:                    │    │  Labels: (SAME)              │
    │  ├─ task-id: 5              │    │  ├─ task-id: 5               │
    │  ├─ repository: 5dlabs-cto  │    │  ├─ repository: 5dlabs-cto   │
    │  ├─ current-stage: impl     │    │  ├─ current-stage: waiting-qa│
    │  └─ workflow-type: play     │    │  └─ workflow-type: play      │
    │                             │    │                              │
    │  Status: Running → Suspended│    │  Status: Recreated → Running │
    └─────────────────────────────┘    └──────────────────────────────┘
            (DELETED)                          (RESUMED BY SENSOR)
                 │                                     ▲
                 │                                     │
                 └─────── SAME LABELS ────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE STORAGE LAYERS (PERSISTENT ACROSS WORKFLOW DELETION)                 │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────┐
  │  WORKFLOW LABELS     │
  │  (K8s Metadata)      │
  ├──────────────────────┤
  │ task-id: 5           │◄────┐
  │ repository: 5dlabs   │     │ Restored from ConfigMap
  │ current-stage: impl  │     │ during workflow recreation
  │ updated-at: TS       │◄────┘
  └──────────────────────┘

  ┌──────────────────────┐
  │  CONFIGMAP           │
  │  play-progress-      │
  │  5dlabs-cto          │
  ├──────────────────────┤
  │ repository: ...      │ ◄──── PRIMARY STATE STORE
  │ current-task-id: 5   │       (SURVIVES WORKFLOW DELETE)
  │ workflow-name: xyz   │
  │ stage: impl          │
  │ status: in-progress  │
  │ started-at: TS       │
  │ last-updated: TS     │
  └──────────────────────┘

  ┌──────────────────────┐
  │  PVCs (PERSISTENT)   │
  │  (Kubernetes Volumes)│
  ├──────────────────────┤
  │ workspace-cto        │◄──── SHARED (Rex/Blaze)
  │  ├─ implementation/   │      - CLAUDE.md
  │  ├─ code/             │      - Previous work
  │  └─ git/              │      - Shared context
  │                       │
  │ workspace-cto-cleo   │◄──── ISOLATED (Cleo)
  │  ├─ quality-checks/   │      - Clean workspace
  │  └─ CLEO.md           │      - Own memory
  │                       │
  │ workspace-cto-tess   │◄──── ISOLATED (Tess)
  │  ├─ test-results/     │      - Clean workspace
  │  └─ TESS.md           │      - Own memory
  └──────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ AGENT PROGRESSION & PVC ALLOCATION STRATEGY                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    Implementation Agents          Quality/Testing Agents
    (Share Workspace)              (Isolated Workspace)
    
    ┌─────────────────┐            ┌──────────────────┐
    │  5DLabs-Rex     │            │  5DLabs-Cleo     │
    │  (Claude)       │            │  (Claude)        │
    │                 │            │                  │
    │  PVC:           │            │  PVC:            │
    │  workspace-cto  │            │  workspace-cto-  │
    │  (SHARED)       │            │  cleo            │
    │                 │            │  (ISOLATED)      │
    │  Mount: /wks/   │            │  Mount: /wks/    │
    │  Read: CLAUDE.md│            │  Read: Impl code │
    │  Write: Code    │            │  Write: Reviews  │
    │  Create: PR     │            │  Create: CLEO.md │
    └────────┬────────┘            └──────────────────┘
             │                              ▲
             │                              │
    ┌────────▼────────┐            GitHub Review Event
    │ 5DLabs-Blaze    │
    │ (Factory)       │            ┌──────────────────┐
    │                 │            │  5DLabs-Tess     │
    │ PVC:            │            │  (Claude)        │
    │ workspace-cto   │            │                  │
    │ (SHARED)        │            │  PVC:            │
    │                 │            │  workspace-cto-  │
    │ Mount: /wks/    │            │  tess            │
    │ Read: CLAUDE.md │            │  (ISOLATED)      │
    │ Read: Rex code  │            │  Mount: /wks/    │
    │ Write: Frontend │            │  Read: Impl+QA   │
    │ Update: CLAUDE.md           │  Write: Test     │
    └─────────────────┘            └──────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ STAGE PROGRESSION WITH SENSOR RESUME LOGIC                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                                    GitHub Events
                                    (Async)
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                    ▼                   ▼                   ▼
            PR Created Event      PR Review Event      PR Merged Event
            pull_request.opened   approved by cleo     pull_request.merged


Current Stage: implementation   current-stage: waiting-pr-created
    │                               │
    │ Rex completes                 │ Sensor detects PR created event
    ▼                               ▼
Update label: waiting-pr-created    Find workflow by labels:
    │                               ├─ task-id=5 ✓
    │                               ├─ repository=5dlabs-cto ✓
    ▼                               ├─ workflow-type=play ✓
Suspend: true                       │
    │                               └─ Check current-stage
    │                                  current-stage == "waiting-pr-created"? YES
    │                                  │
    │                                  ▼
    │                               Resume: suspend=false
    │                               │
    │                               ▼
    │                    ┌──────────────────────┐
    │                    │  Workflow Resumes    │
    │                    │  Continue to Cleo    │
    │                    │  stage               │
    │                    └──────────────────────┘
    │
    └─── Current Stage: code-quality
         │
         │ Cleo completes
         ▼
    Update label: waiting-quality-complete
         │
         ▼
    Suspend: true
         │
         └─── Sensor waits for PR approval by Cleo[bot]
              │
              └─ When approved:
                 ├─ Check current-stage == "waiting-quality-complete"
                 ├─ YES: Resume workflow
                 └─ Continue to Tess stage


┌─────────────────────────────────────────────────────────────────────────────┐
│ CROSS-CLI TRANSITION (WHERE RESUME MAGIC HAPPENS)                           │
└─────────────────────────────────────────────────────────────────────────────┘

Step 1: OLD WORKFLOW (Claude with Rex)
    
    Workflow: play-task-5-abc
    ├─ CodeRun → Job → Pod
    ├─ Container: claude-image
    ├─ GitHub App: 5DLabs-Rex
    ├─ Mount: workspace-cto
    │   ├─ CLAUDE.md (created)
    │   ├─ implementation/
    │   └─ git/
    ├─ Stage: waiting-pr-created
    └─ Delete: kubectl delete workflow ...


Step 2: NEW WORKFLOW (Factory with Blaze) — SAME TASK
    
    Workflow: play-task-5-xyz (new name)
    ├─ Labels: (RESTORED FROM CONFIGMAP)
    │  ├─ task-id: 5 ← SAME
    │  ├─ repository: 5dlabs-cto ← SAME
    │  ├─ current-stage: waiting-pr-created ← RECOVERED
    │  └─ workflow-type: play ← SAME
    │
    ├─ CodeRun → Job → Pod
    ├─ Container: factory-image (DIFFERENT CLI)
    ├─ GitHub App: 5DLabs-Blaze (DIFFERENT AGENT)
    │
    ├─ Mount: workspace-cto (SAME PVC)
    │   ├─ CLAUDE.md (AVAILABLE - not deleted!)
    │   ├─ implementation/
    │   └─ git/
    │
    ├─ CodeRun.continueSession: true
    │   ↓ reads CLAUDE.md
    │   ↓ loads previous context
    │
    └─ Agent (Blaze) resumes from where Rex left off


Step 3: SENSOR RESUME (GitHub Event Detection)
    
    GitHub: PR #314 created
        ↓
    Sensor: stage-aware-pr-created triggers
        ↓
    Extract: task-id=5 from PR labels
        ↓
    Find: kubectl get workflows \
        -l task-id=5,repository=5dlabs-cto
        ↓
    Get: current-stage from workflow labels
        ↓
    If: current-stage == "waiting-pr-created"
        ├─ YES: Resume (suspend: false)
        └─ NO: Skip (prevents wrong stage progression)


┌─────────────────────────────────────────────────────────────────────────────┐
│ KEY INSIGHT: STATE IS CLI-AGNOSTIC                                          │
└─────────────────────────────────────────────────────────────────────────────┘

What the system DOES NOT track:
  ✗ "Claude ran stage 1" → doesn't matter
  ✗ "Codex ran stage 2" → doesn't matter
  ✗ "Which container image" → doesn't matter
  
What the system DOES track:
  ✓ Agent name extracted from GitHub App (Rex, Blaze, Cleo, Tess)
  ✓ Current stage (implementation, code-quality, testing, etc.)
  ✓ Workflow labels (task-id, repository, current-stage)
  ✓ PVC name (derived from agent role, not CLI)
  ✓ GitHub events (PR created, approved, merged)

Resume Magic Formula:
  workflow_labels + pvc_persistence + stage_verification + github_events
  = Universal Cross-CLI Resume


┌─────────────────────────────────────────────────────────────────────────────┐
│ FAILURE PREVENTION: STAGE VERIFICATION                                      │
└─────────────────────────────────────────────────────────────────────────────┘

Scenario: Workflow deleted mid-stage
    
    Original: current-stage: implementation
    Deleted workflow
    Recreate: pick up from ConfigMap
    New workflow starts with: current-stage: implementation
    
    GitHub event arrives: "PR created"
    Sensor logic:
    
        if current-stage == "waiting-pr-created":
            resume = true
        else
            echo "Wrong stage! Preventing incorrect progression"
            resume = false
    
    Result: Even though sensor received event,
            it won't resume if stage is wrong.
            This prevents skipping stages!


┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE PERSISTENCE GUARANTEES                                                │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────┐
    │ PERSIST (Never deleted automatically)       │
    ├─────────────────────────────────────────────┤
    │ ✓ PVCs (workspace-*)                        │
    │ ✓ ConfigMaps (play-progress-*)              │
    │ ✓ Secrets (GitHub App credentials)          │
    │ ✓ Argo Events (GitHub webhooks setup)       │
    └─────────────────────────────────────────────┘
    
    ┌─────────────────────────────────────────────┐
    │ EPHEMERAL (Deleted with workflow)           │
    ├─────────────────────────────────────────────┤
    │ ✗ Workflow CRD                              │
    │ ✗ Pods                                      │
    │ ✗ Jobs                                      │
    │ ✗ Task execution state                      │
    │                                             │
    │ But label/state recoverable from ConfigMap! │
    └─────────────────────────────────────────────┘


