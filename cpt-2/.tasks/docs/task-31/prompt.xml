<?xml version="1.0" encoding="UTF-8"?>
<task id="31" priority="medium" agent="cipher">
    <meta>
        <title>Implement CSRF protection</title>
        <priority>medium</priority>
        <dependencies>23</dependencies>
        <agent_hint>cipher</agent_hint>
    </meta>

    <role>You are a Senior Security Engineer with expertise in authentication and secure coding. Implement Task 31 with production-quality code.</role>

    <context>
        <overview>Add CSRF protection for state-changing authentication operations</overview>
        <background>Review PRD and architecture in .tasks/docs/ for full context.</background>
    </context>

    <requirements>
        <description>1. Install and configure csurf middleware
2. Generate CSRF tokens for forms
3. Validate CSRF tokens on POST requests
4. Handle CSRF token errors gracefully
5. Exclude OAuth callback routes from CSRF validation</description>
        <constraints>
            <constraint>Match existing codebase patterns</constraint>
            <constraint>Create PR with atomic commits</constraint>
            <constraint>Include unit tests</constraint>
            <constraint>PR title: feat(task-31): Implement CSRF protection</constraint>
        </constraints>
    </requirements>

    <acceptance_criteria>
        <criterion>All requirements implemented</criterion>
        <criterion>Tests passing with adequate coverage</criterion>
        <criterion>Code follows project conventions</criterion>
        <criterion>Test CSRF protection blocks unauthorized requests and allows valid ones</criterion>
    </acceptance_criteria>

    <validation>
        <command>cargo test (Rust)</command>
        <command>cargo clippy -- -D warnings (Rust)</command>
        <command>go test ./... (Go)</command>
        <command>npm test (Node.js)</command>
    </validation>

    <deliverables>
        <deliverable>Working implementation</deliverable>
        <deliverable>Unit tests</deliverable>
        <deliverable>Pull request</deliverable>
    </deliverables>
</task>
